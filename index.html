<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Панквеб Planner — Нагрузка, Проекты, Команда, Аналитика</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --app-header-h:56px; --left-col-w:220px; --grid-gap:12px; }
    .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; } .no-scrollbar::-webkit-scrollbar{ display:none; }
    .btn{ border-radius:.75rem; border:1px solid rgb(212 212 216); background:#fff; padding:.25rem .75rem; box-shadow:0 1px 1px rgba(0,0,0,.05); transition:box-shadow .15s, transform .06s; user-select:none; }
    .btn:hover{ box-shadow:0 2px 6px rgba(0,0,0,.08);} .btn:active{ transform:translateY(1px);} .btn-sm{ padding:.2rem .55rem; border-radius:.65rem; font-size:.85rem;}
    .segmented{ display:flex; align-items:center; gap:.5rem; background:#f5f5f5; border:1px solid #e5e7eb; border-radius:1rem; padding:.25rem .35rem; box-shadow:0 1px 1px rgba(0,0,0,.04); white-space:nowrap;}
    .segmented>button{ padding:.25rem .6rem; border-radius:.75rem; margin:0 1px; transition:background .15s, box-shadow .15s; font-size:.92rem;}
    .segmented>button.active{ background:#fff; box-shadow:0 1px 1px rgba(0,0,0,.05);} .segmented>button.idle:hover{ background:rgba(255,255,255,.7);}
    .pressable{ cursor:pointer; user-select:none;} .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    @media print{ header,.segmented,.no-print{ display:none!important;} body{ background:#fff !important;} .print-p-0{ padding:0!important; margin:0!important;} .shadow-sm,.shadow-lg,.shadow-xl{ box-shadow:none!important;} .border-neutral-200,.border{ border-color:#bbb!important; } }
    .option-dot{ font-size:10px; opacity:.75; }
  </style>
</head>
<body class="bg-[#F7F8FA] no-scrollbar">
<div id="root"></div>

<script type="text/babel" data-presets="env,react">
const {useState,useEffect,useMemo,useRef,Fragment}=React;

/* ===== Utils / Const ===== */
const HOURS_PER_WEEK=40, BAR_MAX_HOURS=40, MAX_FTE=1.2, VISIBLE_WEEKS=16, WEEK_COL_PX=72;
const TEAM_BAR_COLOR="#22c55e", FACT_LINE_COLOR="#ef4444", COLOR_50="#FFF7ED", COLOR_70="#FFE4E6", COLOR_100="#FECDD3", VAT_RATE=.2;
const fmtMoney=n=>"₽ "+(Math.round(Number(n)||0)).toLocaleString("ru-RU");
const fmtHours=h=>String(Math.max(0,Math.round(Number(h)||0)));
const fteToHours=fte=>Math.round((Number(fte)||0)*HOURS_PER_WEEK);
const hoursToFte=hours=>{const h=Math.max(0,Math.round(Number(hours)||0));return h/HOURS_PER_WEEK;};
const fillRatio=h=>{const v=Math.min(Math.max(0,Math.round(Number(h)||0)),BAR_MAX_HOURS);return v/BAR_MAX_HOURS;};
const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
const scaleRatio=(v,max=MAX_FTE)=>clamp(v/max,0,1);
const fmtFTE1=n=>(Math.round(n*10)/10).toFixed(1);
const addDays=(d,n)=>{const x=new Date(d);x.setDate(x.getDate()+n);x.setHours(0,0,0,0);return x;};
const addWeeks=(d,n)=>addDays(d,n*7);
const fmtISO=date=>date.toISOString().slice(0,10);
const pad2=n=>(n<10?("0"+n):String(n));
const fmtDM=d=>pad2(d.getDate())+"."+pad2(d.getMonth()+1);
const RU_MONTHS=["янв","фев","мар","апр","май","июн","июл","авг","сен","окт","ноя","дек"];
const ruMonthShort=m=>RU_MONTHS[m]||"";
const ruMonthFull=["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"];
const startOfISOWeek=d=>{const day=d.getDay();const diff=(day===0?-6:1)-day;const x=new Date(d);x.setDate(x.getDate()+diff);x.setHours(0,0,0,0);return x;};
const weekRangeLabel=iso=>{const d=new Date(iso),e=addDays(d,6);return fmtDM(d)+"–"+fmtDM(e);};
const yearWeekMondays=year=>{let m=startOfISOWeek(new Date(year,0,1)),end=new Date(year,11,31);end.setHours(0,0,0,0);const list=[];while(m<=end){list.push(fmtISO(m));m=addDays(m,7);}return list;};
const rndId=()=>{try{if(window?.crypto?.randomUUID)return window.crypto.randomUUID();}catch{} return Math.random().toString(36).slice(2)+"_"+Date.now();};
const isWeekEnded=weekISO=>{const end=addDays(new Date(weekISO),6);const today=new Date();today.setHours(0,0,0,0);return today>end;};
const parseDate=s=>{if(!s)return null;const d=new Date(s);if(isNaN(d))return null;d.setHours(0,0,0,0);return d;};
const overlap=(a1,a2,b1,b2)=>a1<=b2 && b1<=a2;

/* --- helpers for contracts: support gross (with VAT) or net (without VAT) --- */
function contractToNetVat(c){
  // Back-compat: if legacy field amountNet exists, treat it as net; else amount is gross when amountIsGross=true
  if(c && (c.amountNet!=null) && (c.amountNet!==undefined)){
    const net=Math.round(Math.max(0,Number(c.amountNet)||0));
    const vat=Math.round(net*VAT_RATE);
    return {net,vat,gross:net+vat};
  }
  const gross=Math.round(Math.max(0,Number(c.amount)||0));
  if(c && c.amountIsGross===false){
    const net=Math.round(Math.max(0,Number(c.amount)||0));
    const vat=Math.round(net*VAT_RATE);
    return {net,vat,gross:net+vat};
  }
  const net=Math.round(Math.floor(gross/(1+VAT_RATE))); // convert gross -> net
  const vat=gross-net;
  return {net,vat,gross};
}

/* ===== Storage ===== */
const LS_KEY="fteplanner.v1";
const loadAll=()=>{try{return JSON.parse(localStorage.getItem(LS_KEY)||"{}");}catch{return {};}}
const saveAll=data=>{try{localStorage.setItem(LS_KEY,JSON.stringify(data));}catch{}}
const loadJSON=(key,fallback)=>{const all=loadAll();return (all&&key in all)?all[key]:fallback;}
const saveJSON=patch=>{const all=loadAll();saveAll(Object.assign({},all,patch));}
const toSet=v=> (v instanceof Set ? v : new Set(v||[]));
const toSetMap=obj=>{const out={}; for(const k in (obj||{})){ if(Object.prototype.hasOwnProperty.call(obj,k)){ out[k]=toSet(obj[k]); } } return out;}

/* ===== Seed ===== */
const baseMonday=startOfISOWeek(new Date());
const initialWeeks=Array.from({length:28},(_,i)=>fmtISO(addWeeks(baseMonday,i-6)));
const seedPeople=[{id:"p1",name:"Саша",role:"manager",capacityPerWeek:1,active:true,external:false,rateInternal:1500,rateExternal:2500},{id:"p2",name:"Катя К.",role:"designer",capacityPerWeek:1,active:true,external:false,rateInternal:1400,rateExternal:2600},{id:"p3",name:"Игорь",role:"dev",capacityPerWeek:1,active:true,external:false,rateInternal:1800,rateExternal:3200}];
const seedProjects=[{id:"pr1",name:"HR Подкасты",status:"active",color:"#3b82f6",budgetWithVAT:0,budgetWithoutVAT:0,projectType:"external",costEditable:0,costEditableTouched:false,startDate:"",endDate:"",contracts:[]},{id:"pr2",name:"Арктика Медиа",status:"onhold",color:"#f43f5e",budgetWithVAT:0,budgetWithoutVAT:0,projectType:"external",costEditable:0,costEditableTouched:false,startDate:"",endDate:"",contracts:[]},{id:"pr3",name:"Падел-теннис",status:"planned",color:"#06b6d4",budgetWithVAT:0,budgetWithoutVAT:0,projectType:"internal",costEditable:0,costEditableTouched:false,startDate:"",endDate:"",contracts:[]},{id:"pr4",name:"Сайт.Бета",status:"active",color:"#10b981",budgetWithVAT:0,budgetWithoutVAT:0,projectType:"external",costEditable:0,costEditableTouched:false,startDate:"",endDate:"",contracts:[]},];
const seedAssignments=[{id:"a1",personId:"p1",projectId:"pr1",weekStart:initialWeeks[6],fte:.3},{id:"a2",personId:"p1",projectId:"pr2",weekStart:initialWeeks[7],fte:.2},{id:"a3",personId:"p2",projectId:"pr2",weekStart:initialWeeks[7],fte:.4},{id:"a4",personId:"p3",projectId:"pr4",weekStart:initialWeeks[8],fte:.5},{id:"a5",personId:"p3",projectId:"pr1",weekStart:initialWeeks[10],fte:.2},];
const seedRoles=["designer","dev","manager","pm","other"];

/* ===== Aggregators ===== */
const personWeekTotal=(as,pid,w)=>as.filter(a=>a.personId===pid&&a.weekStart===w).reduce((s,a)=>s+a.fte,0);
const effectiveFactHours=(a,w)=>{const has=(a&&a.factHours!=null&&!isNaN(a.factHours)); if(has) return Math.max(0,Math.round(Number(a.factHours)||0)); if(isWeekEnded(w)) return Math.max(0,Math.round(fteToHours(a.fte))); return 0;};
const personWeekFactTotal=(as,pid,w)=>as.filter(a=>a.personId===pid&&a.weekStart===w).reduce((s,a)=>s+effectiveFactHours(a,w),0);
const fteFor=(as,pid,pr,w)=>as.filter(a=>a.personId===pid&&a.projectId===pr&&a.weekStart===w).reduce((s,a)=>s+a.fte,0);
const personProjectWeekFact=(as,pid,pr,w)=>as.filter(a=>a.personId===pid&&a.projectId===pr&&a.weekStart===w).reduce((sum,a)=>sum+effectiveFactHours(a,w),0);
const sumFactForPersonProject=(as,pid,pr,weeks)=>weeks.reduce((acc,w)=>acc+personProjectWeekFact(as,pid,pr,w),0);

/* ===== Icons ===== */
function StatusIcon({status}){const props={width:16,height:16,viewBox:"0 0 24 24",fill:"white","aria-hidden":"true"}; if(status==="active")return(<svg {...props}><polygon points="8,5 19,12 8,19"/></svg>); if(status==="onhold")return(<svg {...props}><rect x="6" y="5" width="4" height="14"/><rect x="14" y="5" width="4" height="14"/></svg>); if(status==="done")return(<svg {...props}><rect x="6" y="6" width="12" height="12" rx="2"/></svg>); return(<svg {...props}><circle cx="12" cy="12" r="6"/></svg>); }
const MinusIcon=({className=""})=>(<svg className={className} width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>);
const PencilIcon=({className=""})=>(<svg className={className} width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/></svg>);
const CrossIcon=({className=""})=>(<svg className={className} width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="5" x2="19" y2="19"></line><line x1="19" y1="5" x2="5" y2="19"></line></svg>);
const EyedropperIcon=({className=""})=>(<svg className={className} width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 2l3 3-7.5 7.5"/><path d="M16 5l3 3"/><path d="M9 11l-6 6v3h3l6-6"/></svg>);

const WeekHeader=({iso})=>{const d=new Date(iso),w=1+Math.floor((d.getDate()-1)/7),m=ruMonthShort(d.getMonth());return(<div className="h-[40px] flex items-center justify-center text-neutral-700"><span className="block text-center leading-tight" style={{width:WEEK_COL_PX}}><div className="text-xs font-medium">{w} нед</div><div className="text-[10px]">{m}</div></span></div>);}

/* ===== Charts ===== */
function ChartLineDual({plan=[],fact=[],width=400,height=120,padX=12,padY=10,yTicks=[0,20,40,60,80],green=TEAM_BAR_COLOR,red=FACT_LINE_COLOR,title=""}){
  const n=Math.max(plan.length,fact.length),w=Math.max(width,40),h=Math.max(height,60),innerW=Math.max(10,w-padX*2),innerH=Math.max(10,h-padY*2),maxVal=Math.max(HOURS_PER_WEEK,10,...plan.concat(fact).map(x=>Number(x)||0));
  const yFor=v=>padY+(innerH*(1-(Math.max(0,Number(v)||0)/maxVal))),xFor=i=>n<=1?padX+innerW/2:padX+i*(innerW/(n-1));
  const pathFor=arr=>{const pts=[];for(let i=0;i<n;i++){const v=(arr[i]==null?0:arr[i]);pts.push([xFor(i),yFor(v)]);} if(!pts.length) return ""; let d="M"+pts[0][0]+","+pts[0][1]; for(let j=1;j<pts.length;j++){d+=" L"+pts[j][0]+","+pts[j][1];} return d;};
  return(<svg width={w} height={h} role="img" aria-label={title}><rect x="0" y="0" width={w} height={h} rx="14" ry="14" fill="#fff" stroke="#e5e7eb"/>{yTicks.map(t=>(<line key={t} x1={padX} y1={yFor(t)} x2={w-padX} y2={yFor(t)} stroke="#e5e7eb"/>))}<path d={pathFor(plan)} fill="none" stroke={green} strokeWidth="2.5"/><path d={pathFor(fact)} fill="none" stroke={red} strokeWidth="2.5"/>{plan.map((v,i)=>(<circle key={"pc"+i} cx={xFor(i)} cy={yFor(v)} r="2.5" fill={green}/>))}{fact.map((v,i)=>(<circle key={"fc"+i} cx={xFor(i)} cy={yFor(v)} r="2.5" fill={red}/>))}<g><rect x={w-150} y={6} width="142" height="20" rx="6" ry="6" fill="white" stroke="#e5e7eb"/><line x1={w-140} y1={16} x2={w-120} y2={16} stroke={green} strokeWidth="2.5"/><text x={w-116} y={19} fontSize="10" fill="#111827">План</text><line x1={w-74} y1={16} x2={w-54} y2={16} stroke={red} strokeWidth="2.5"/><text x={w-50} y={19} fontSize="10" fill="#111827">Факт</text></g></svg>);
}
function ChartBarsMoney({plan=0,fact=0,width=300,height=130,title="",planLabel="Бюджет с НДС",factLabel="Себестоимость (факт)"}){
  const w=Math.max(width,220),h=Math.max(height,120),padX=18,padY=22,innerW=w-padX*2,innerH=h-padY*2,maxVal=Math.max(10,plan,fact),yFor=v=>padY+(innerH*(1-(Math.max(0,Number(v)||0)/maxVal))),barW=innerW/3.2,xPlan=padX+innerW*.5-barW*1.2,xFact=padX+innerW*.5+barW*.2,grid=[0,.25,.5,.75,1].map((r,i)=>(<line key={i} x1={padX} y1={padY+innerH*r} x2={w-padX} y2={padY+innerH*r} stroke="#f1f5f9"/>));
  return(<svg width={w} height={h} role="img" aria-label={title}><rect x="0" y="0" width={w} height={h} rx="14" ry="14" fill="#fff" stroke="#e5e7eb"/>{grid}<rect x={xPlan} y={yFor(plan)} width={barW} height={padY+innerH-yFor(plan)} fill="#16a34a" opacity=".85"/><rect x={xFact} y={yFor(fact)} width={barW} height={padY+innerH-yFor(fact)} fill="#ef4444" opacity=".85"/><text x={xPlan+barW/2} y={yFor(plan)-6} fontSize="10" fill="#14532d" textAnchor="middle">{fmtMoney(plan)}</text><text x={xFact+barW/2} y={yFor(fact)-6} fontSize="10" fill="#7f1d1d" textAnchor="middle">{fmtMoney(fact)}</text><text x={xPlan+barW/2} y={padY+innerH+14} fontSize="10" fill="#0f172a" textAnchor="middle">{planLabel}</text><text x={xFact+barW/2} y={padY+innerH+14} fontSize="10" fill="#0f172a" textAnchor="middle">{factLabel}</text></svg>);
}
function ChartBarsTriple({a=0,b=0,c=0,width=820,height=260,labels=["Бюджет с НДС","Бюджет без НДС","Себестоимость, факт"]}){
  const w=Math.max(width,640),h=Math.max(height,220),padX=28,padY=30,innerW=w-padX*2,innerH=h-padY*2,maxVal=Math.max(10,a,b,c),yFor=v=>padY+(innerH*(1-(Math.max(0,Number(v)||0)/maxVal))),colW=innerW/5,xs=[padX+innerW*.17-colW/2,padX+innerW*.5-colW/2,padX+innerW*.83-colW/2],colors=["#16a34a","#2563eb","#ef4444"],vals=[a,b,c],baselineY=padY+innerH,grid=[0,.25,.5,.75,1].map((r,i)=>(<line key={i} x1={padX} y1={padY+innerH*r} x2={w-padX} y2={padY+innerH*r} stroke="#eef2f7"/>));
  return(<svg width={w} height={h} role="img" aria-label="Воронка Панквеб — суммарные показатели"><rect x="0" y="0" width={w} height={h} rx="16" ry="16" fill="#fff" stroke="#e5e7eb"/>{grid}<line x1={padX} y1={baselineY} x2={w-padX} y2={baselineY} stroke="#cbd5e1" strokeWidth="3"/>{vals.map((v,i)=>(<g key={i}><rect x={xs[i]} y={yFor(v)} width={colW} height={baselineY-yFor(v)} fill={colors[i]} opacity=".88"/><text x={xs[i]+colW/2} y={yFor(v)-8} fontSize="12" fill="#111827" textAnchor="middle" fontWeight="600">{fmtMoney(v)}</text></g>))}{labels.map((t,i)=>(<text key={t} x={xs[i]+colW/2} y={baselineY+18} fontSize="12" fill="#0f172a" textAnchor="middle">{t}</text>))}</svg>);
}
function ChartBarsMonthlyDual({income=[],expense=[],widthPerGroup=68,height=280,yearLabel=""}){
  const groups=Math.max(income.length,expense.length,12),padX=28,padY=30,groupGap=16,colW=Math.max(10,Math.floor((widthPerGroup-8)/2)),w=padX*2+groups*widthPerGroup+(groups-1)*groupGap,h=Math.max(height,220),innerH=h-padY*2,vals=Array.from({length:groups},(_,i)=>Math.max(0,income[i]||0,expense[i]||0)),maxVal=Math.max(10,...vals),yFor=v=>padY+(innerH*(1-(Math.max(0,Number(v)||0)/maxVal))),baselineY=padY+innerH,xGroup=i=>padX+i*(widthPerGroup+groupGap),grid=[0,.25,.5,.75,1].map((r,i)=>(<line key={i} x1={padX} y1={padY+innerH*r} x2={w-padX} y2={padY+innerH*r} stroke="#eef2f7"/>));
  return(<svg width={w} height={h} role="img" aria-label={"Воронка Панквеб — статистика по месяцам "+yearLabel}><rect x="0" y="0" width={w} height={h} rx="16" ry="16" fill="#fff" stroke="#e5e7eb"/>{grid}<line x1={padX} y1={baselineY} x2={w-padX} y2={baselineY} stroke="#cbd5e1" strokeWidth="2"/>{Array.from({length:groups}).map((_,i)=>{const x=xGroup(i),inc=Math.max(0,income[i]||0),exp=Math.max(0,expense[i]||0),yi=yFor(inc),ye=yFor(exp);return(<g key={i}><rect x={x} y={yi} width={colW} height={baselineY-yi} fill="#16a34a" opacity=".9"/><rect x={x+colW+8} y={ye} width={colW} height={baselineY-ye} fill="#ef4444" opacity=".9"/><text x={x+colW/2} y={yi-6} fontSize="10" textAnchor="middle" fill="#14532d">{inc>0?fmtMoney(inc):""}</text><text x={x+colW+8+colW/2} y={ye-6} fontSize="10" textAnchor="middle" fill="#7f1d1d">{exp>0?fmtMoney(exp):""}</text><text x={x+colW} y={baselineY+14} fontSize="11" textAnchor="middle" fill="#0f172a">{ruMonthShort(i)}</text></g>);})}<g><rect x={w-190} y={8} width="170" height="22" rx="6" ry="6" fill="white" stroke="#e5e7eb"/><rect x={w-182} y={12} width="12" height="12" fill="#16a34a"/><text x={w-166} y={21} fontSize="11" fill="#111827">Доходы</text><rect x={w-110} y={12} width="12" height="12" fill="#ef4444"/><text x={w-94} y={21} fontSize="11" fill="#111827">Расходы</text></g></svg>);
}

/* ===== Window hook ===== */
function useWeeksWindow(){
  const [weeks,setWeeks]=useState(loadJSON("weeks",initialWeeks));
  const savedFirstISO=loadJSON("firstWeekISO",weeks[0]);
  const initIdx=Math.max(0,weeks.indexOf(savedFirstISO));
  const [firstIdx,setFirstIdx]=useState(initIdx);
  const ensureRange=needIdx=>{
    if(needIdx<0){const first=new Date(weeks[0]);const addCount=Math.ceil((-needIdx)/8)*8;const prepend=[];for(let i=0;i<addCount;i++)prepend.push(fmtISO(addWeeks(first,-(i+1))));prepend.reverse();const next=prepend.concat(weeks);setWeeks(next);return {weeks:next,firstIdx:needIdx+prepend.length};}
    if(needIdx+VISIBLE_WEEKS>=weeks.length){const last=new Date(weeks[weeks.length-1]);const more=[];for(let j=0;j<16;j++)more.push(fmtISO(addWeeks(last,j+1)));const next=weeks.concat(more);setWeeks(next);return {weeks:next,firstIdx:needIdx};}
    return {weeks,firstIdx:needIdx};
  };
  const goLeft=()=>{const r=ensureRange(firstIdx-1);setFirstIdx(r.firstIdx);saveJSON({firstWeekISO:r.weeks[r.firstIdx],weeks:r.weeks});};
  const goRight=()=>{const r=ensureRange(firstIdx+1);setFirstIdx(r.firstIdx);saveJSON({firstWeekISO:r.weeks[r.firstIdx],weeks:r.weeks});};
  const goToday=()=>{const todayISO=fmtISO(startOfISOWeek(new Date()));let idx=weeks.indexOf(todayISO);let next=weeks.slice();if(idx<0){const needLen=Math.max(VISIBLE_WEEKS,24),need=[];for(let k=0;k<needLen;k++)need.push(fmtISO(addWeeks(new Date(todayISO),k)));const set={};for(let z=0;z<next.length;z++)set[next[z]]=true;for(let q=0;q<need.length;q++)if(!set[need[q]]){next.push(need[q]);set[need[q]]=true;}next.sort();setWeeks(next);saveJSON({weeks:next});idx=next.indexOf(todayISO);}setFirstIdx(idx);saveJSON({firstWeekISO:next[idx]});};
  const visible=useMemo(()=>weeks.slice(firstIdx,firstIdx+VISIBLE_WEEKS),[weeks,firstIdx]);
  return {weeks,setWeeks,firstIdx,setFirstIdx,visible,goLeft,goRight,goToday};
}

/* ===== Auth ===== */
function LoginPage({onLogin}){
  const [login,setLogin]=useState(""),[pass,setPass]=useState(""),[remember,setRemember]=useState(false),[err,setErr]=useState("");
  useEffect(()=>{const saved=loadAll();if(saved?.rememberAuth){setRemember(true);if(saved.rememberLogin)setLogin(saved.rememberLogin);if(saved.rememberPass)setPass(saved.rememberPass);}},[]);
  const submit=e=>{e&&e.preventDefault(); if(!login.trim()||!pass.trim()) return setErr("Введите логин и пароль"); if(remember){saveJSON({rememberAuth:true,rememberLogin:login.trim(),rememberPass:pass});} else {saveJSON({rememberAuth:false,rememberLogin:"",rememberPass:""});} saveJSON({authed:true,currentUser:login.trim()}); onLogin&&onLogin(login.trim());};
  return(<div className="min-h-screen grid place-items-center bg-[#F7F8FA]"><div className="bg-white w-[380px] rounded-2xl shadow-lg border border-neutral-200 p-6"><div className="text-center mb-4"><div className="text-2xl font-semibold text-green-600">Панквеб Planner</div><div className="text-sm text-neutral-500 mt-1">Авторизация</div></div><form onSubmit={submit} className="space-y-3"><div><label className="block text-sm mb-1">Логин</label><input value={login} onChange={e=>setLogin(e.target.value)} className="w-full border border-neutral-300 rounded-xl px-3 py-2 text-sm" autoFocus/></div><div><label className="block text-sm mb-1">Пароль</label><input type="password" value={pass} onChange={e=>setPass(e.target.value)} className="w-full border border-neutral-300 rounded-xl px-3 py-2 text-sm"/></div><label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={remember} onChange={e=>setRemember(e.target.checked)} />Запомнить</label>{err?(<div className="text-xs text-red-600">{err}</div>):null}<div className="pt-1 text-right"><button type="submit" className="btn btn-sm">Войти</button></div></form></div></div>);
}

/* ===== App ===== */
function App(){
  /* data */
  const [people,setPeople]=useState(loadJSON("people",seedPeople));
  const [projects,setProjects]=useState(loadJSON("projects",seedProjects));
  const [assignments,setAssignments]=useState(loadJSON("assignments",seedAssignments));
  const [roles,setRoles]=useState(loadJSON("roles",[...seedRoles]));
  const [projectTeams,setProjectTeams]=useState(()=>{const saved=loadJSON("projectTeams",{}),map=toSetMap(saved); if(Object.keys(map).length===0){seedProjects.forEach(p=>map[p.id]=new Set()); seedAssignments.forEach(a=>{map[a.projectId]??=new Set(); map[a.projectId].add(a.personId);});} return map;});
  const [projectMemberHours,setProjectMemberHours]=useState(loadJSON("projectMemberHours",{}));
  const [vacations,setVacations]=useState(()=>toSetMap(loadJSON("vacations",{})));
  const [personProjectOrder,setPersonProjectOrder]=useState(loadJSON("personProjectOrder",{}));
  const [teamOrder,setTeamOrder]=useState(loadJSON("teamOrder",seedPeople.map(p=>p.id)));
  const [authed,setAuthed]=useState(loadJSON("authed",false));
  const [view,setView]=useState(loadJSON("view","team"));
  useEffect(()=>saveJSON({view}),[view]);

  const [selectedPersonId,setSelectedPersonId]=useState(null);
  const {weeks,setWeeks,visible,goLeft,goRight,goToday}=useWeeksWindow();

  /* lazy fact fill after week end */
  useEffect(()=>{setAssignments(prev=>{let changed=false;const next=prev.map(a=>{const has=(a&&a.factHours!=null&&!isNaN(a.factHours)); if(!has && isWeekEnded(a.weekStart)){const v=Math.max(0,Math.round(fteToHours(a.fte))); if(a.factHours!==v){changed=true;return Object.assign({},a,{factHours:v});}} return a;}); return changed?next:prev;});},[weeks]);

  /* persist */
  useEffect(()=>saveJSON({people}),[people]);
  useEffect(()=>saveJSON({projects}),[projects]);
  useEffect(()=>saveJSON({assignments}),[assignments]);
  useEffect(()=>saveJSON({roles}),[roles]);
  useEffect(()=>{const obj={}; for(const k in projectTeams){ if(Object.prototype.hasOwnProperty.call(projectTeams,k)){ obj[k]=Array.from(projectTeams[k]); } } saveJSON({projectTeams:obj});},[projectTeams]);
  useEffect(()=>saveJSON({projectMemberHours}),[projectMemberHours]);
  useEffect(()=>{const obj={}; for(const k in vacations){ if(Object.prototype.hasOwnProperty.call(vacations,k)){ obj[k]=Array.from(vacations[k]); } } saveJSON({vacations:obj});},[vacations]);
  useEffect(()=>saveJSON({personProjectOrder}),[personProjectOrder]);
  useEffect(()=>saveJSON({teamOrder}),[teamOrder]);

  /* filters/order */
  const [roleFilter,setRoleFilter]=useState(loadJSON("roleFilter","all"));
  useEffect(()=>saveJSON({roleFilter}),[roleFilter]);
  const peopleForTeam=useMemo(()=>people.filter(p=>p.active&&!p.external),[people]);
  const peopleActiveAll=useMemo(()=>people.filter(p=>p.active),[people]);
  useEffect(()=>setTeamOrder(prev=>{const seen=new Set(prev); const next=peopleForTeam.map(p=>p.id); const inactive=prev.filter(id=>!next.includes(id)); return next.concat(inactive.filter(id=>people.some(x=>x.id===id)));}),[peopleForTeam]);
  const activeTeamIds=useMemo(()=>teamOrder.filter(id=>peopleForTeam.some(p=>p.id===id)),[teamOrder,peopleForTeam]);
  const filteredTeamIds=useMemo(()=>activeTeamIds.filter(id=>roleFilter==="all"||people.find(x=>x.id===id)?.role===roleFilter),[activeTeamIds,roleFilter,people]);

  /* rate helpers */
  const rateFor=(person,projectType)=>projectType==="internal"?(person.rateInternal||0):(person.rateExternal||0);
  const sumPlanCostForProject=projectId=>{const pr=projects.find(p=>p.id===projectId); if(!pr) return 0; const teamSet=projectTeams[projectId]||new Set(); let sum=0; teamSet.forEach(pid=>{const person=people.find(p=>p.id===pid); if(!person)return; const h=Number(projectMemberHours?.[projectId]?.[pid]||0); sum+=h*rateFor(person,pr.projectType||"external");}); return Math.round(sum);};
  const sumFactCostForProject=projectId=>{const pr=projects.find(p=>p.id===projectId); if(!pr) return 0; const teamSet=projectTeams[projectId]||new Set(); let sum=0; teamSet.forEach(pid=>{const person=people.find(p=>p.id===pid); if(!person)return; const factH=sumFactForPersonProject(assignments,pid,projectId,weeks); sum+=factH*rateFor(person,pr.projectType||"external");}); return Math.round(sum);};
  const sumFactCostForProjectWeeks=(projectId,weekList)=>{const pr=projects.find(p=>p.id===projectId); if(!pr) return 0; const teamSet=projectTeams[projectId]||new Set(); let sum=0; teamSet.forEach(pid=>{const person=people.find(p=>p.id===pid); if(!person)return; const factH=sumFactForPersonProject(assignments,pid,projectId,weekList); sum+=factH*rateFor(person,pr.projectType||"external");}); return Math.round(sum);};

  /* recompute editable cost plan once inputs change (only if untouched) */
  useEffect(()=>{setProjects(prev=>{let changed=false;const next=prev.map(p=>{if(p.costEditableTouched) return p; const auto=sumPlanCostForProject(p.id); if((p.costEditable||0)!==auto){changed=true; return Object.assign({},p,{costEditable:auto});} return p;}); return changed?next:prev;});},[projectMemberHours,projectTeams,people,weeks]);

  function deletePerson(pid){
    if(!confirm("Удалить сотрудника?")) return;
    setPeople(prev=>prev.filter(p=>p.id!==pid));
    setAssignments(prev=>prev.filter(a=>a.personId!==pid));
    setVacations(prev=>{const c={}; for(const k in prev){ if(Object.prototype.hasOwnProperty.call(prev,k)){ c[k]=toSet(prev[k]); } } c[pid]=new Set(); return c;});
    setProjectTeams(prev=>{const c={}; for(const k in prev){ if(Object.prototype.hasOwnProperty.call(prev,k)){ c[k]=toSet(prev[k]); c[k].delete(pid);} } return c;});
    setProjectMemberHours(prev=>{const c={...prev}; for(const pr in c){ if(Object.prototype.hasOwnProperty.call(c,pr)){ const inner={...c[pr]}; delete inner[pid]; c[pr]=inner; } } return c;});
    setTeamOrder(prev=>prev.filter(id=>id!==pid)); if(selectedPersonId===pid) setSelectedPersonId(null);
  }
  function deleteProject(prid){
    if(!confirm("Удалить проект?")) return;
    setProjects(prev=>prev.filter(p=>p.id!==prid));
    setAssignments(prev=>prev.filter(a=>a.projectId!==prid));
    setProjectTeams(prev=>{const c={}; for(const k in prev){ if(Object.prototype.hasOwnProperty.call(prev,k)){ if(k!==prid) c[k]=toSet(prev[k]); } } return c;});
    setProjectMemberHours(prev=>{const c={...prev}; delete c[prid]; return c;});
    setPersonProjectOrder(prev=>{const out={}; for(const pid in prev){ if(Object.prototype.hasOwnProperty.call(prev,pid)){ out[pid]=(prev[pid]||[]).filter(x=>x!==prid);} } return out;});
  }

  const dragProjectIndex=useRef(null);
  const onProjectDragStart=i=>dragProjectIndex.current=i;
  const onProjectDrop=i=>{
    const from=dragProjectIndex.current; dragProjectIndex.current=null; if(from==null||from===i) return;
    setProjects(prev=>{const arr=prev.slice(); const moved=arr.splice(from,1)[0]; arr.splice(i,0,moved); return arr;});
  };

  const [createPersonOpen,setCreatePersonOpen]=useState(false);
  const [newPersonName,setNewPersonName]=useState(""),[newPersonRole,setNewPersonRole]=useState("other"),[newPersonExternal,setNewPersonExternal]=useState(false);
  function submitNewPerson(){const name=(newPersonName||"").trim(); if(!name) return; const id=rndId(); setPeople(p=>p.concat([{id,name,role:newPersonRole||"other",capacityPerWeek:1,active:true,external:!!newPersonExternal,rateInternal:1200,rateExternal:2200}])); setCreatePersonOpen(false); setNewPersonName(""); setNewPersonRole("other"); setNewPersonExternal(false);}
  const [createProjectOpen,setCreateProjectOpen]=useState(false);
  const [newProjectName,setNewProjectName]=useState(""),[newProjectColor,setNewProjectColor]=useState("#3b82f6"),[newProjectStatus,setNewProjectStatus]=useState("active");
  function submitNewProject(){const name=(newProjectName||"").trim(); if(!name) return; const id=rndId(),color=newProjectColor||"#64748b",status=newProjectStatus; setProjects(ps=>ps.concat([{id,name,color,status,budgetWithVAT:0,budgetWithoutVAT:0,projectType:"external",costEditable:0,costEditableTouched:false,startDate:"",endDate:"",contracts:[]}])); setProjectTeams(pt=>{const copy={}; for(const k in pt){ if(Object.prototype.hasOwnProperty.call(pt,k)){ copy[k]=toSet(pt[k]); } } copy[id]=new Set(); return copy;}); setProjectMemberHours(prev=>{const c={...prev}; c[id]={}; return c;}); setCreateProjectOpen(false); setNewProjectName(""); setNewProjectStatus("active"); setView("project");}

  const Legend=()=>(
    <div className="text-[11px] text-neutral-600">
      <span className="inline-flex items-center gap-1 mr-3"><span className="w-3 h-3 inline-block rounded" style={{background:TEAM_BAR_COLOR}}></span> план (ч)</span>
      <span className="inline-flex items-center gap-1"><span className="w-3 h-3 inline-block rounded" style={{background:FACT_LINE_COLOR}}></span> факт (ч)</span>
    </div>
  );

  /* filter for projects by person */
  const [projectPersonFilter,setProjectPersonFilter]=useState(loadJSON("projectPersonFilter","all"));
  useEffect(()=>saveJSON({projectPersonFilter}),[projectPersonFilter]);

  if(!authed) return <LoginPage onLogin={()=>{setAuthed(true); setView("team");}}/>;

  /* drag helper for team rows */
  const dragRow=useRef(null);

  return(
  <div className="min-h-screen bg-[#F7F8FA] text-neutral-900">
    <header className="sticky top-0 z-50 border-b border-neutral-200 bg-white/90 backdrop-blur" style={{height:'var(--app-header-h)'}}>
      <div className="max-w-screen-2xl mx-auto px-4 h-full flex items-center gap-3">
        <div className="text-lg font-semibold tracking-tight text-green-600">Панквеб Planner</div>
        <div className="ml-4 segmented" role="tablist" aria-label="Навигация">
          <button className={view==="team"?"active":"idle"} onClick={()=>setView("team")} role="tab" aria-selected={view==="team"}>Нагрузка</button>
          <button className={view==="project"?"active":"idle"} onClick={()=>setView("project")} role="tab" aria-selected={view==="project"}>Проекты</button>
          <button className={view==="employees"?"active":"idle"} onClick={()=>setView("employees")} role="tab" aria-selected={view==="employees"}>Команда</button>
          <button className={view==="analyticsTeam"?"active":"idle"} onClick={()=>setView("analyticsTeam")} role="tab" aria-selected={view==="analyticsTeam"}>Аналитика</button>
          <button className={view==="analyticsProjects"?"active":"idle"} onClick={()=>setView("analyticsProjects")} role="tab" aria-selected={view==="analyticsProjects"}>Воронка</button>
          <button className={view==="analyticsMonthly"?"active":"idle"} onClick={()=>setView("analyticsMonthly")} role="tab" aria-selected={view==="analyticsMonthly"}>Статистика по месяцам</button>
        </div>
        <div className="ml-auto flex items-center gap-2">
          <button onClick={()=>setCreateProjectOpen(true)} className="btn btn-sm">+ Проект</button>
          <button onClick={()=>setCreatePersonOpen(true)} className="btn btn-sm">+ Сотрудник</button>
        </div>
      </div>
    </header>

    <main className="max-w-screen-2xl mx-auto p-4">
      {(view==="team"||view==="analyticsTeam")&&(
        <WeekNavigator onLeft={goLeft} onRight={goRight} onToday={goToday} showRoleFilter={true} roleFilter={roleFilter} setRoleFilter={setRoleFilter} roles={roles} leftNode={view==="analyticsTeam"?<Legend/>:null}/>
      )}

      {/* TEAM */}
      {view==="team"&&(
        <div className="grid" style={{gridTemplateColumns:"var(--left-col-w) repeat("+visible.length+", "+WEEK_COL_PX+"px)"}}>
          <div className="sticky left-0 z-50 bg-[#F7F8FA] backdrop-blur border-r border-neutral-200 p-2 text-sm font-medium" />
          {visible.map(w=>(<div key={w} className="border-b border-neutral-200"><WeekHeader iso={w}/></div>))}
          {filteredTeamIds.map((pid,rowIdx)=>{
            const person=people.find(p=>p.id===pid);
            return(
              <Fragment key={pid}>
                <div className="sticky left-0 z-50 bg-[#F7F8FA] backdrop-blur border-r border-neutral-200 p-1"
                  draggable onDragStart={()=>{dragRow.current=rowIdx;}}
                  onDragOver={e=>e.preventDefault()}
                  onDrop={()=>{const from=dragRow.current; dragRow.current=null; if(from==null||from===rowIdx) return;
                    const arr=filteredTeamIds.slice(); const id=arr.splice(from,1)[0]; arr.splice(rowIdx,0,id);
                    const inactive=teamOrder.filter(x=>!filteredTeamIds.includes(x)); setTeamOrder(arr.concat(inactive));}}>
                  <div role="button" tabIndex={0} onClick={()=>setSelectedPersonId(person.id)} onKeyDown={e=>{if(e.key==='Enter'||e.key===' '){setSelectedPersonId(person.id)}}} className="w-full text-left">
                    <div className="relative bg-white rounded-2xl shadow-sm h-[120px] flex flex-col justify-center pl-5 pr-8 hover:shadow-md hover:bg-blue-50/70 transition">
                      <div className="font-medium truncate" title="Открыть карточку сотрудника">{person.name}</div>
                      <div className="mt-1 text-[11px] text-neutral-600">{String(person.role||"").toUpperCase()}</div>
                    </div>
                  </div>
                </div>
                {visible.map(week=>{
                  const totalFte=personWeekTotal(assignments,person.id,week),totalHoursPlan=Math.round(totalFte*HOURS_PER_WEEK),ratio=fillRatio(totalHoursPlan),vac=!!(vacations[person.id]?.has?.(week)),over=totalHoursPlan>HOURS_PER_WEEK,factSum=personWeekFactTotal(assignments,person.id,week),hasFactOrEnded=(factSum>0||isWeekEnded(week));
                  return(<div key={week+pid} className="p-1 bg-transparent h-[120px] relative">
                    <div className={"bg-white rounded-2xl shadow-sm h-full flex items-end
