```html
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FTE Planner</title>
  
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root {
      --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      --bg-main: #F8F9FC;
      --bg-panel: #FFFFFF;
      --bg-panel-secondary: #F1F3F9;
      --bg-header: rgba(255, 255, 255, 0.85);
      --border-color: #E2E8F0;
      --text-primary: #1A202C;
      --text-secondary: #4A5568;
      --text-tertiary: #718096;
      --accent-blue: #3B82F6;
      --accent-blue-light: #EFF6FF;
      --accent-red: #EF4444;
      --accent-yellow: #F59E0B;
      --accent-green: #10B981;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --header-h: 60px;
      --left-panel-w: 320px;
      --right-panel-w: 360px;
      --timeline-header-h: 64px;
      --timeline-row-h: 56px;
      --timeline-cell-w: 100px;
      --color-conflict-overload: #FECACA; /* red-200 */
      --color-conflict-warning: #FEF3C7; /* yellow-200 */
      --color-conflict-underload: #DBEAFE; /* blue-200 */
      --color-vacation: #E5E7EB; /* gray-200 */
    }
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; padding: 0; }
    body {
      font-family: var(--font-sans);
      background-color: var(--bg-main);
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      font-size: 14px;
    }
    #root { height: 100%; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .no-scrollbar::-webkit-scrollbar { display: none; }

    /* Login Page */
    .login-container {
      display: grid;
      place-items: center;
      height: 100vh;
      background-color: var(--bg-main);
    }
    .login-box {
      width: 360px;
      padding: 32px;
      background-color: var(--bg-panel);
      border-radius: 16px;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-color);
    }
    .login-box h1 {
      font-size: 24px;
      font-weight: 600;
      text-align: center;
      margin: 0 0 24px;
    }
    .login-form .form-group { margin-bottom: 16px; }
    .login-form label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 6px; }
    .login-form input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 14px;
      transition: box-shadow 0.2s;
    }
    .login-form input:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 500;
      border: 1px solid transparent;
      cursor: pointer;
      transition: background-color 0.2s, box-shadow 0.2s;
      font-size: 14px;
      white-space: nowrap;
    }
    .btn-primary {
      background-color: var(--accent-blue);
      color: white;
      border-color: var(--accent-blue);
    }
    .btn-primary:hover { background-color: #2563EB; }
    .btn-secondary {
        background-color: var(--bg-panel);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow-sm);
    }
    .btn-secondary:hover { background-color: var(--bg-panel-secondary); }
    .btn-block { width: 100%; padding-top: 12px; padding-bottom: 12px; }
    .login-error { color: var(--accent-red); text-align: center; margin-top: 16px; font-size: 13px; }

    /* Main App Layout */
    .app-layout {
      display: grid;
      grid-template-rows: var(--header-h) 1fr;
      grid-template-columns: var(--left-panel-w) 1fr;
      height: 100vh;
      overflow: hidden;
    }
    .app-header {
      grid-column: 1 / 3;
      display: flex;
      align-items: center;
      padding: 0 24px;
      background: var(--bg-header);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--border-color);
      z-index: 100;
    }
    .app-header .logo { font-size: 20px; font-weight: 700; color: var(--accent-blue); }
    .app-header .header-controls { display: flex; align-items: center; gap: 12px; margin-left: auto; }
    
    .left-sidebar {
      grid-row: 2 / 3;
      background-color: var(--bg-panel);
      border-right: 1px solid var(--border-color);
      padding: 16px;
      overflow-y: auto;
    }
    
    .main-content {
      grid-row: 2 / 3;
      grid-column: 2 / 3;
      overflow: auto;
      background-color: var(--bg-main);
      display: flex;
      flex-direction: column;
    }

    .main-view-controls {
      padding: 12px 24px;
      border-bottom: 1px solid var(--border-color);
      background: var(--bg-panel);
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .segmented-control {
      display: flex;
      background-color: var(--bg-panel-secondary);
      border-radius: 8px;
      padding: 4px;
    }
    .segmented-control button {
      padding: 4px 12px;
      border: none;
      background: transparent;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      color: var(--text-secondary);
      transition: all 0.2s;
    }
    .segmented-control button.active {
      background: var(--bg-panel);
      color: var(--text-primary);
      box-shadow: var(--shadow-sm);
    }
    
    .timeline-container {
      flex-grow: 1;
      overflow: auto;
      position: relative;
    }

    .timeline-grid {
      display: grid;
      grid-template-columns: 240px 1fr; /* User column + timeline */
    }
    
    .timeline-header, .timeline-body {
      display: grid;
      grid-template-columns: subgrid;
      grid-column: 1 / 3;
    }

    .timeline-header-users, .timeline-header-weeks {
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--bg-panel-secondary);
    }

    .timeline-header-users {
      border-right: 1px solid var(--border-color);
      border-bottom: 1px solid var(--border-color);
      height: var(--timeline-header-h);
      display: flex;
      align-items: center;
      padding-left: 16px;
      font-weight: 600;
    }

    .timeline-header-weeks-wrapper {
        overflow: hidden;
    }

    .timeline-header-weeks {
      display: flex;
      border-bottom: 1px solid var(--border-color);
    }

    .timeline-header-weeks .week-cell {
      min-width: var(--timeline-cell-w);
      width: var(--timeline-cell-w);
      height: var(--timeline-header-h);
      border-right: 1px solid var(--border-color);
      text-align: center;
      padding: 8px 0;
      font-size: 12px;
      color: var(--text-secondary);
    }
    .week-cell .week-num { font-weight: 600; font-size: 14px; color: var(--text-primary); }

    .timeline-body-users, .timeline-body-weeks {
      display: flex;
      flex-direction: column;
    }
    .timeline-body-users {
      border-right: 1px solid var(--border-color);
    }
    .timeline-body-users .user-row {
      height: var(--timeline-row-h);
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 0 16px;
      border-bottom: 1px solid var(--border-color);
      background: var(--bg-panel);
    }
    .user-row .user-name { font-weight: 500; }
    .user-row .user-fte { font-size: 11px; color: var(--text-tertiary); }
    
    .timeline-body-weeks .user-timeline {
      height: var(--timeline-row-h);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      position: relative; /* For allocations */
    }
    .user-timeline .week-cell {
      min-width: var(--timeline-cell-w);
      width: var(--timeline-cell-w);
      border-right: 1px solid var(--border-color);
    }

    .allocation-bar {
      position: absolute;
      top: 10px;
      bottom: 10px;
      height: calc(var(--timeline-row-h) - 20px);
      border-radius: 6px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 0 8px;
      font-size: 11px;
      color: white;
      cursor: grab;
      user-select: none;
      box-shadow: var(--shadow-sm);
      border: 1px solid rgba(0,0,0,0.1);
    }
    .allocation-bar-title { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
    .allocation-bar-subtitle { opacity: 0.8; }
    .allocation-vacation {
        background-color: var(--color-vacation);
        background-image: repeating-linear-gradient(-45deg, transparent, transparent 5px, rgba(0,0,0,0.05) 5px, rgba(0,0,0,0.05) 10px);
    }


    /* Matrix View */
    .matrix-table {
      width: 100%;
      border-collapse: collapse;
    }
    .matrix-table th, .matrix-table td {
      border: 1px solid var(--border-color);
      padding: 8px;
      text-align: center;
      font-size: 13px;
    }
    .matrix-table th {
      background: var(--bg-panel-secondary);
      position: sticky;
      top: 0;
    }
    .matrix-table th:first-child, .matrix-table td:first-child {
      position: sticky;
      left: 0;
      background: var(--bg-panel-secondary);
      text-align: left;
      font-weight: 500;
      min-width: 200px;
    }
    .matrix-cell {
      height: 48px;
      cursor: pointer;
      position: relative;
    }
    .matrix-cell .util-bar {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      height: 4px;
      background-color: var(--accent-blue);
    }
    .matrix-cell[data-util-level="over"] .util-bar { background-color: var(--accent-red); }
    .matrix-cell[data-util-level="warn"] .util-bar { background-color: var(--accent-yellow); }

    /* Accordion */
    .accordion-item {
      border-bottom: 1px solid var(--border-color);
    }
    .accordion-header {
      width: 100%;
      background: none;
      border: none;
      padding: 16px 8px;
      text-align: left;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .accordion-content {
      padding: 0 8px 16px;
    }
    .accordion-header .icon { transition: transform 0.2s; }
    .accordion-header.open .icon { transform: rotate(90deg); }

    /* Task Card */
    .task-card {
      padding: 12px;
      background: var(--bg-panel);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: grab;
      box-shadow: var(--shadow-sm);
    }
    .task-card:active {
      cursor: grabbing;
      box-shadow: var(--shadow-md);
    }
    .task-card-title { font-weight: 500; }
    .task-card-meta {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-secondary);
    }
    .tag {
      background: var(--bg-panel-secondary);
      padding: 2px 6px;
      border-radius: 4px;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      display: grid;
      place-items: center;
    }
    .modal-content {
      background: var(--bg-panel);
      padding: 24px;
      border-radius: 12px;
      min-width: 500px;
      max-width: 90vw;
      box-shadow: var(--shadow-lg);
    }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .modal-title { font-size: 20px; font-weight: 600; }
    .modal-close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-tertiary); }
    .modal-body .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .modal-body .form-group { display: flex; flex-direction: column; }
    .modal-body .form-group-full { grid-column: 1 / 3; }
    .modal-body label { font-weight: 500; margin-bottom: 6px; font-size: 13px; }
    .modal-body input, .modal-body select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 14px;
    }
    .modal-footer { margin-top: 24px; display: flex; justify-content: flex-end; gap: 12px; }

    /* Utility classes */
    .text-sm { font-size: 12px; }
    .font-semibold { font-weight: 600; }
    .ml-auto { margin-left: auto; }
    .d-flex { display: flex; }
    .align-items-center { align-items: center; }
    .gap-2 { gap: 8px; }
    .gap-3 { gap: 12px; }

  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef, useCallback, createContext, useContext } = React;

    // ---------- CONTEXT ----------
    const AppContext = createContext(null);
    
    // ---------- CONSTANTS & HELPERS ----------
    const LS_KEY = 'fte_planner_data_v2';
    const GHOST_ELEMENT_ID = 'drag-ghost';
    const WEEK_MILLISECONDS = 7 * 24 * 60 * 60 * 1000;
    const DAY_MILLISECONDS = 24 * 60 * 60 * 1000;
    const ROLES = { ADMIN: 'Admin', PM: 'PM', VIEWER: 'Viewer' };
    const PERMISSIONS = {
      [ROLES.ADMIN]: { canEditUsers: true, canEditProjects: true, canEditAllocations: true },
      [ROLES.PM]: { canEditUsers: false, canEditProjects: true, canEditAllocations: true },
      [ROLES.VIEWER]: { canEditUsers: false, canEditProjects: false, canEditAllocations: false },
    };

    // Date helpers
    const getStartOfWeek = (date) => {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is sunday
      return new Date(new Date(d.setDate(diff)).setHours(0, 0, 0, 0));
    };
    const addDays = (date, days) => new Date(date.getTime() + days * DAY_MILLISECONDS);
    const formatDate = (date) => date.toISOString().split('T')[0];
    const getWeekNumber = (d) => {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
        var weekNo = Math.ceil((((d - yearStart) / DAY_MILLISECONDS) + 1)/7);
        return weekNo;
    }

    // ---------- SEED DATA ----------
    const seedData = {
      users: [
        { id: 'u1', name: 'Иван Петров', role: ROLES.ADMIN, skills: ['frontend', 'backend'], fte: 1.0, weeklyHours: 40, password: 'admin123', email: 'admin@fte' },
        { id: 'u2', name: 'Мария Сидорова', role: ROLES.PM, skills: ['management'], fte: 1.0, weeklyHours: 40, password: 'pm123', email: 'pm@fte' },
        { id: 'u3', name: 'Алексей Иванов', role: ROLES.VIEWER, skills: ['qa'], fte: 1.0, weeklyHours: 40, password: 'viewer123', email: 'viewer@fte' },
        { id: 'u4', name: 'Елена Кузнецова', role: ROLES.PM, skills: ['backend', 'devops'], fte: 1.0, weeklyHours: 40, password: '1', email: 'elena@fte'},
        { id: 'u5', name: 'Дмитрий Смирнов', role: ROLES.PM, skills: ['frontend'], fte: 0.5, weeklyHours: 40, password: '1', email: 'dmitry@fte'},
      ],
      projects: [
        { id: 'p1', name: 'Корпоративный портал', status: 'В работе', priority: 'High', pmId: 'u2', startDate: '2025-10-01', endDate: '2025-12-31', color: '#3B82F6' },
        { id: 'p2', name: 'Мобильное приложение', status: 'План', priority: 'Medium', pmId: 'u4', startDate: '2025-11-01', endDate: '2026-02-28', color: '#10B981' },
        { id: 'p3', name: 'Рефакторинг легаси', status: 'Пауза', priority: 'Low', pmId: 'u2', startDate: '2025-09-01', endDate: '2025-11-30', color: '#F59E0B' },
      ],
      tasks: [
        { id: 't1', projectId: 'p1', name: 'Авторизация OAuth2', type: 'Фича', requiredSkill: 'backend', effortHours: 80, deadline: '2025-10-30' },
        { id: 't2', projectId: 'p1', name: 'Дизайн главной страницы', type: 'Дизайн', requiredSkill: 'frontend', effortHours: 40, deadline: '2025-10-20' },
        { id: 't3', projectId: 'p2', name: 'Настройка CI/CD', type: 'Техдолг', requiredSkill: 'devops', effortHours: 60, deadline: '2025-11-15' },
        { id: 't4', projectId: 'p2', name: 'Проектирование API', type: 'BA', requiredSkill: 'backend', effortHours: 120, deadline: '2025-11-30' },
      ],
      allocations: {
        'base': [
          { id: 'a1', taskId: 't1', userId: 'u4', startDate: '2025-10-06', endDate: '2025-10-17', hoursPerWeek: 20 },
          { id: 'a2', taskId: 't2', userId: 'u5', startDate: '2025-10-06', endDate: '2025-10-17', hoursPerWeek: 20 },
          { id: 'a3', taskId: 't1', userId: 'u1', startDate: '2025-10-20', endDate: '2025-10-31', hoursPerWeek: 20 },
        ]
      },
      scenarios: [ { id: 'base', name: 'Основной план' } ],
      activeScenarioId: 'base',
      calendar: {
          holidays: [],
          vacations: [
              { id: 'v1', userId: 'u5', startDate: '2025-10-20', endDate: '2025-10-24', type: 'Отпуск' }
          ],
      }
    };

    // ---------- CORE LOGIC (CALCULATOR) ----------
    const FTECalculator = {
      getUserAvailableHours(user, weekStartDate, calendar) {
        if (!user) return 0;
        let baseHours = user.weeklyHours * user.fte;
        // Subtract vacation hours
        const weekEndDate = addDays(weekStartDate, 6);
        for (const vac of calendar.vacations) {
            if (vac.userId === user.id) {
                const vacStart = new Date(vac.startDate);
                const vacEnd = new Date(vac.endDate);
                if (weekStartDate <= vacEnd && weekEndDate >= vacStart) {
                    // Simple logic: assume full day is 8 hours, 5 days a week.
                    // A more complex implementation would check day by day.
                    baseHours -= user.weeklyHours; // For simplicity, a week of vacation zeroes out availability
                    if (baseHours < 0) baseHours = 0;
                }
            }
        }
        return baseHours;
      },
      getUserAllocatedHours(userId, weekStartDate, allocations, tasks) {
        let totalHours = 0;
        const weekEndDate = addDays(weekStartDate, 6);

        for (const alloc of allocations) {
          if (alloc.userId === userId) {
            const allocStart = new Date(alloc.startDate);
            const allocEnd = new Date(alloc.endDate);
            if (weekStartDate <= allocEnd && weekEndDate >= allocStart) {
              totalHours += alloc.hoursPerWeek || 0;
            }
          }
        }
        return totalHours;
      },
      getUtilization(allocated, available) {
        if (available <= 0) return allocated > 0 ? 200 : 0; // Handle division by zero
        return Math.round((allocated / available) * 100);
      },
      getConflictLevel(utilization) {
        if (utilization > 100) return 'over';
        if (utilization >= 80) return 'warn';
        if (utilization > 0 && utilization < 50) return 'under';
        return 'normal';
      }
    };
    
    // ---------- COMPONENTS ----------

    function App() {
      const [data, setData] = useState(() => {
        try {
          const stored = localStorage.getItem(LS_KEY);
          return stored ? JSON.parse(stored) : seedData;
        } catch (e) {
          return seedData;
        }
      });
      const [currentUser, setCurrentUser] = useState(null);

      useEffect(() => {
        try {
          localStorage.setItem(LS_KEY, JSON.stringify(data));
        } catch (e) {
          console.error("Failed to save to localStorage", e);
        }
      }, [data]);

      const permissions = useMemo(() => currentUser ? PERMISSIONS[currentUser.role] : {}, [currentUser]);

      const login = (email, password) => {
        const user = data.users.find(u => u.email === email && u.password === password);
        if (user) {
          setCurrentUser(user);
          return true;
        }
        return false;
      };

      const logout = () => {
        setCurrentUser(null);
      };

      const appContextValue = {
        data,
        setData,
        currentUser,
        permissions,
        logout
      };

      if (!currentUser) {
        return <LoginPage onLogin={login} />;
      }
      
      return (
        <AppContext.Provider value={appContextValue}>
          <PlannerPage />
        </AppContext.Provider>
      );
    }
    
    function LoginPage({ onLogin }) {
      const [email, setEmail] = useState('admin@fte');
      const [password, setPassword] = useState('admin123');
      const [error, setError] = useState('');

      const handleSubmit = (e) => {
        e.preventDefault();
        setError('');
        if (!onLogin(email, password)) {
          setError('Неверный логин или пароль');
        }
      };
      
      return (
        <div className="login-container">
          <div className="login-box">
            <h1>FTE Planner</h1>
            <form onSubmit={handleSubmit} className="login-form">
              <div className="form-group">
                <label htmlFor="email">Логин (email)</label>
                <input id="email" type="email" value={email} onChange={e => setEmail(e.target.value)} required />
              </div>
              <div className="form-group">
                <label htmlFor="password">Пароль</label>
                <input id="password" type="password" value={password} onChange={e => setPassword(e.target.value)} required />
              </div>
              {error && <p className="login-error">{error}</p>}
              <button type="submit" className="btn btn-primary btn-block" style={{marginTop: '24px'}}>Войти</button>
            </form>
          </div>
        </div>
      );
    }

    function PlannerPage() {
      const { data, setData, currentUser, permissions, logout } = useContext(AppContext);
      const [view, setView] = useState('gantt'); // gantt | matrix
      const [dateRange, setDateRange] = useState({
          start: getStartOfWeek(new Date()),
          end: addDays(getStartOfWeek(new Date()), 12 * 7 - 1)
      });
      const [draggedTask, setDraggedTask] = useState(null);

      const weeks = useMemo(() => {
        const list = [];
        let current = new Date(dateRange.start);
        while (current <= dateRange.end) {
          list.push(current);
          current = addDays(current, 7);
        }
        return list;
      }, [dateRange]);

      const handleTaskDrop = (userId, weekStartDate) => {
        if (!draggedTask || !permissions.canEditAllocations) return;
        
        const task = data.tasks.find(t => t.id === draggedTask.taskId);
        if (!task) return;

        // Default to a 2 week allocation
        const endDate = formatDate(addDays(weekStartDate, 13));
        const newAllocation = {
            id: 'alloc_' + Date.now(),
            taskId: task.id,
            userId: userId,
            startDate: formatDate(weekStartDate),
            endDate: endDate,
            hoursPerWeek: (task.effortHours / (task.effortHours/20)) || 20 // Simple distribution
        };
        
        setData(prev => {
            const newAllocs = [...(prev.allocations[prev.activeScenarioId] || []), newAllocation];
            return {
                ...prev,
                allocations: { ...prev.allocations, [prev.activeScenarioId]: newAllocs }
            };
        });
        setDraggedTask(null);
      };

      const handleExportJSON = () => {
        const jsonString = `data:text/json;charset=utf-8,${encodeURIComponent(JSON.stringify(data))}`;
        const link = document.createElement("a");
        link.href = jsonString;
        link.download = "fte-planner-backup.json";
        link.click();
      };

      return (
        <div className="app-layout">
          <header className="app-header">
            <div className="logo">FTE Planner</div>
            <div className="header-controls">
              <span className="text-sm">Пользователь: <b>{currentUser.name}</b> ({currentUser.role})</span>
              <button className="btn btn-secondary" onClick={handleExportJSON}>Экспорт JSON</button>
              <button className="btn btn-secondary" onClick={logout}>Выйти</button>
            </div>
          </header>

          <aside className="left-sidebar no-scrollbar">
            <LeftSidebar setDraggedTask={setDraggedTask} />
          </aside>

          <main className="main-content no-scrollbar">
            <div className="main-view-controls">
              <div className="segmented-control">
                  <button className={view === 'gantt' ? 'active' : ''} onClick={() => setView('gantt')}>Гантт</button>
                  <button className={view === 'matrix' ? 'active' : ''} onClick={() => setView('matrix')}>Матрица</button>
              </div>
            </div>
            <div className="timeline-container">
              {view === 'gantt' && <GanttView weeks={weeks} onTaskDrop={handleTaskDrop} />}
              {view === 'matrix' && <MatrixView weeks={weeks} />}
            </div>
          </main>
        </div>
      );
    }
    
    function LeftSidebar({ setDraggedTask }) {
      const [openAccordion, setOpenAccordion] = useState('tasks');
      const { data } = useContext(AppContext);

      const unallocatedTasks = useMemo(() => {
          const allocatedTaskIds = new Set(data.allocations[data.activeScenarioId].map(a => a.taskId));
          return data.tasks.filter(t => !allocatedTaskIds.has(t.id));
      }, [data.tasks, data.allocations, data.activeScenarioId]);

      const toggleAccordion = (id) => setOpenAccordion(openAccordion === id ? null : id);

      return (
        <div>
            <Accordion title="Задачи" id="tasks" isOpen={openAccordion === 'tasks'} onToggle={toggleAccordion}>
                {unallocatedTasks.map(task => 
                    <TaskCard key={task.id} task={task} setDraggedTask={setDraggedTask} />
                )}
            </Accordion>
            <Accordion title="Проекты" id="projects" isOpen={openAccordion === 'projects'} onToggle={toggleAccordion}>
                {data.projects.map(project => (
                    <div key={project.id} className="task-card">
                        <div className="task-card-title" style={{ borderLeft: `4px solid ${project.color}`, paddingLeft: '8px' }}>{project.name}</div>
                        <div className="task-card-meta">
                            <span className="tag">{project.status}</span>
                            <span className="tag">{project.priority}</span>
                        </div>
                    </div>
                ))}
            </Accordion>
            <Accordion title="Команда" id="team" isOpen={openAccordion === 'team'} onToggle={toggleAccordion}>
                {data.users.map(user => (
                    <div key={user.id} className="task-card">
                        <div className="task-card-title">{user.name}</div>
                        <div className="task-card-meta">
                            <span className="tag">{user.role}</span>
                            <span className="tag">FTE: {user.fte}</span>
                        </div>
                    </div>
                ))}
            </Accordion>
        </div>
      );
    }

    function Accordion({ id, title, isOpen, onToggle, children }) {
        return (
            <div className="accordion-item">
                <button className={`accordion-header ${isOpen ? 'open' : ''}`} onClick={() => onToggle(id)}>
                    {title}
                    <span className="icon">▶</span>
                </button>
                {isOpen && <div className="accordion-content">{children}</div>}
            </div>
        )
    }

    function TaskCard({ task, setDraggedTask }) {
        const { data } = useContext(AppContext);
        const project = data.projects.find(p => p.id === task.projectId);

        const handleDragStart = (e) => {
            setDraggedTask({ taskId: task.id });
            e.dataTransfer.effectAllowed = 'move';
        };

        return (
            <div 
                className="task-card" 
                draggable="true"
                onDragStart={handleDragStart}
                onDragEnd={() => setDraggedTask(null)}
            >
                <div className="task-card-title">{task.name}</div>
                <div className="task-card-meta">
                    <span className="tag" style={{ borderLeft: `3px solid ${project?.color}`}}>{project?.name}</span>
                    <span className="tag">#{task.requiredSkill}</span>
                    <span className="tag">{task.effortHours}ч</span>
                </div>
            </div>
        );
    }

    function GanttView({ weeks, onTaskDrop }) {
      const { data } = useContext(AppContext);
      const timelineBodyRef = useRef(null);

      const users = data.users;
      const currentAllocations = data.allocations[data.activeScenarioId] || [];

      const handleDragOver = (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
      };

      return (
        <div className="timeline-grid">
            <div className="timeline-header">
                <div className="timeline-header-users">Команда</div>
                <div className="timeline-header-weeks-wrapper">
                  <div className="timeline-header-weeks">
                      {weeks.map(week => (
                          <div key={week.toISOString()} className="week-cell">
                              <div className="week-num">Неделя {getWeekNumber(week)}</div>
                              <div>{formatDate(week).slice(5)}</div>
                          </div>
                      ))}
                  </div>
                </div>
            </div>

            <div className="timeline-body" ref={timelineBodyRef}>
                <div className="timeline-body-users">
                    {users.map(user => (
                        <div key={user.id} className="user-row">
                            <div className="user-name">{user.name}</div>
                            <div className="user-fte">{user.role}, FTE: {user.fte}</div>
                        </div>
                    ))}
                </div>
                <div className="timeline-body-weeks">
                    {users.map(user => (
                        <div 
                            key={user.id} 
                            className="user-timeline"
                            onDragOver={handleDragOver}
                            onDrop={(e) => {
                                const rect = e.currentTarget.getBoundingClientRect();
                                const x = e.clientX - rect.left;
                                const weekIndex = Math.floor((x + timelineBodyRef.current.parentElement.parentElement.scrollLeft) / 100);
                                const targetWeek = weeks[weekIndex];
                                if (targetWeek) {
                                    onTaskDrop(user.id, targetWeek);
                                }
                            }}
                        >
                            <GanttAllocations user={user} weeks={weeks} allocations={currentAllocations} />
                            {weeks.map(week => <div key={week.toISOString()} className="week-cell"></div>)}
                        </div>
                    ))}
                </div>
            </div>
        </div>
      );
    }

    function GanttAllocations({ user, weeks, allocations }) {
      const { data } = useContext(AppContext);
      const timelineStart = weeks[0].getTime();
      const weekWidth = 100; // Corresponds to --timeline-cell-w

      const userAllocations = useMemo(() => {
          return allocations.filter(a => a.userId === user.id);
      }, [user, allocations]);
      
      const userVacations = useMemo(() => {
          return data.calendar.vacations.filter(v => v.userId === user.id);
      }, [user.id, data.calendar.vacations]);
      
      const allItems = [...userAllocations, ...userVacations];

      return (
        <>
        {allItems.map(item => {
            const startDate = new Date(item.startDate);
            const endDate = new Date(item.endDate);
            const isVacation = !!item.type;

            const startOffset = (getStartOfWeek(startDate).getTime() - timelineStart) / WEEK_MILLISECONDS * weekWidth;
            const durationDays = (endDate - startDate) / DAY_MILLISECONDS + 1;
            const width = (durationDays / 7) * weekWidth;
            
            if (startOffset < -width || startOffset > weeks.length * weekWidth) return null;
            
            const task = !isVacation ? data.tasks.find(t => t.id === item.taskId) : null;
            const project = task ? data.projects.find(p => p.id === task.projectId) : null;
            
            return (
                <div
                    key={item.id}
                    className={`allocation-bar ${isVacation ? 'allocation-vacation' : ''}`}
                    style={{
                        left: `${startOffset}px`,
                        width: `${width}px`,
                        backgroundColor: !isVacation ? project?.color : undefined,
                    }}
                    title={isVacation ? `${item.type}: ${item.startDate} - ${item.endDate}` : `${project?.name} - ${task?.name}\n${item.hoursPerWeek} ч/нед`}
                >
                    <div className="allocation-bar-title">{isVacation ? item.type : task?.name}</div>
                    <div className="allocation-bar-subtitle">{!isVacation && `${item.hoursPerWeek} ч/нед`}</div>
                </div>
            );
        })}
        </>
      )
    }
    
    function MatrixView({ weeks }) {
      const { data } = useContext(AppContext);
      const currentAllocations = data.allocations[data.activeScenarioId] || [];

      return (
        <div className="timeline-container">
            <table className="matrix-table">
                <thead>
                    <tr>
                        <th>Сотрудник</th>
                        {weeks.map(week => (
                            <th key={week.toISOString()}>
                                Н{getWeekNumber(week)}<br/>
                                <span className="text-sm text-tertiary">{formatDate(week).slice(5)}</span>
                            </th>
                        ))}
                    </tr>
                </thead>
                <tbody>
                    {data.users.map(user => (
                        <tr key={user.id}>
                            <td>{user.name}</td>
                            {weeks.map(week => {
                                const available = FTECalculator.getUserAvailableHours(user, week, data.calendar);
                                const allocated = FTECalculator.getUserAllocatedHours(user.id, week, currentAllocations, data.tasks);
                                const utilization = FTECalculator.getUtilization(allocated, available);
                                const conflictLevel = FTECalculator.getConflictLevel(utilization);
                                
                                return (
                                    <td 
                                        key={week.toISOString()} 
                                        className="matrix-cell"
                                        data-util-level={conflictLevel}
                                        title={`Загрузка: ${allocated} / ${available} ч.`}
                                    >
                                        <span>{utilization}%</span>
                                        <div className="util-bar" style={{width: `${Math.min(utilization, 100)}%`}}></div>
                                    </td>
                                );
                            })}
                        </tr>
                    ))}
                </tbody>
            </table>
        </div>
      );
    }
    
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);

  </script>
</body>
</html>
```
