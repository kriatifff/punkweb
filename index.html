<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FTE Planner</title>
  
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root {
      --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      --bg-main: #F7F8FA;
      --bg-panel: #FFFFFF;
      --bg-panel-secondary: #F1F3F9;
      --bg-header: rgba(255, 255, 255, 0.85);
      --border-color: #E2E8F0;
      --text-primary: #1A202C;
      --text-secondary: #4A5568;
      --text-tertiary: #718096;
      --accent-blue: #3B82F6;
      --accent-blue-light: #EFF6FF;
      --accent-red: #EF4444;
      --accent-red-light: #FFEBEB;
      --accent-yellow: #F59E0B;
      --accent-green: #10B981;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --header-h: 60px;
      --left-col-w: 240px;
      --week-col-px: 80px;
    }
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; padding: 0; }
    body {
      font-family: var(--font-sans);
      background-color: var(--bg-main);
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      font-size: 14px;
    }
    #root { height: 100%; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .no-scrollbar::-webkit-scrollbar { display: none; }

    /* Login Page */
    .login-container { display: grid; place-items: center; height: 100vh; }
    .login-box {
      width: 360px; padding: 32px; background-color: var(--bg-panel); border-radius: 16px;
      box-shadow: var(--shadow-lg); border: 1px solid var(--border-color);
    }
    .login-box h1 { font-size: 24px; font-weight: 600; text-align: center; margin: 0 0 24px; }
    .login-form .form-group { margin-bottom: 16px; }
    .login-form label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 6px; }
    .login-form input {
      width: 100%; padding: 10px 12px; border: 1px solid var(--border-color);
      border-radius: 8px; font-size: 14px; transition: box-shadow 0.2s;
    }
    .login-form input:focus {
      outline: none; border-color: var(--accent-blue);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }
    .login-form .checkbox-group { display: flex; align-items: center; gap: 8px; font-size: 14px; }
    .login-error { color: var(--accent-red); text-align: center; margin-top: 16px; font-size: 13px; }

    /* Buttons & Controls */
    .btn {
      display: inline-flex; align-items: center; justify-content: center; padding: 8px 16px;
      border-radius: 8px; font-weight: 500; border: 1px solid transparent; cursor: pointer;
      transition: background-color 0.2s, box-shadow 0.2s; font-size: 14px; white-space: nowrap;
    }
    .btn-primary { background-color: var(--accent-blue); color: white; border-color: var(--accent-blue); }
    .btn-primary:hover { background-color: #2563EB; }
    .btn-secondary {
        background-color: var(--bg-panel); color: var(--text-primary);
        border: 1px solid var(--border-color); box-shadow: var(--shadow-sm);
    }
    .btn-secondary:hover { background-color: var(--bg-panel-secondary); }
    .btn-block { width: 100%; padding-top: 12px; padding-bottom: 12px; }
    .btn-danger { background-color: var(--accent-red-light); color: var(--accent-red); border-color: var(--accent-red-light)}
    .btn-danger:hover { background-color: #FEE2E2; }
    
    .segmented-control {
      display: flex; background-color: var(--bg-panel-secondary);
      border-radius: 8px; padding: 4px; box-shadow: var(--shadow-sm);
    }
    .segmented-control button {
      padding: 6px 16px; border: none; background: transparent; border-radius: 6px;
      cursor: pointer; font-weight: 500; color: var(--text-secondary); transition: all 0.2s;
    }
    .segmented-control button.active {
      background: var(--bg-panel); color: var(--text-primary); box-shadow: var(--shadow-md);
    }

    /* Main Layout */
    .app-header {
      position: sticky; top: 0; z-index: 100;
      display: flex; align-items: center; padding: 0 24px; height: var(--header-h);
      background: var(--bg-header); backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--border-color);
    }
    .app-header .logo { font-size: 20px; font-weight: 700; color: var(--accent-blue); }
    .app-header .header-controls { display: flex; align-items: center; gap: 12px; margin-left: auto; }
    .app-container { max-width: 90rem; margin: 0 auto; padding: 1.5rem; }

    /* Common Card Styles */
    .card {
      background: var(--bg-panel);
      border-radius: 12px;
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
      transition: box-shadow .2s, border-color .2s;
    }
    .card:hover { box-shadow: var(--shadow-md); }
    
    /* Team View (Planner) */
    .planner-grid {
      display: grid;
      grid-template-columns: var(--left-col-w) 1fr;
      position: relative;
    }
    .planner-grid .left-col, .planner-grid .timeline-col {
      display: grid;
      grid-template-columns: 1fr;
    }
    .planner-grid .header {
      position: sticky; top: var(--header-h); z-index: 50;
      background: var(--bg-main);
      padding-bottom: 8px;
    }
    .planner-grid .header-content {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        padding: 8px 0;
        height: 56px;
    }
    .planner-grid .week-header {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 56px;
      text-align: center;
      font-size: 12px;
    }
    .week-header .week-num { font-weight: 600; font-size: 14px; color: var(--text-primary); }
    .planner-grid .person-card {
      height: 100px;
      margin-bottom: 8px;
      padding: 16px;
      cursor: pointer;
    }
    .planner-grid .person-card .person-name { font-weight: 600; }
    .planner-grid .person-card .person-role { font-size: 11px; color: var(--text-tertiary); margin-top: 4px; text-transform: uppercase; }
    
    .planner-grid .timeline-row {
      display: flex;
      height: 100px;
      margin-bottom: 8px;
    }
    .planner-grid .week-cell {
      width: var(--week-col-px);
      min-width: var(--week-col-px);
      padding: 4px;
    }
    .planner-grid .util-cell {
      height: 100%;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      align-items: center;
      position: relative;
    }
    .planner-grid .util-bar-wrapper {
      width: 50px;
      height: calc(100% - 24px);
      background-color: var(--bg-panel-secondary);
      border-radius: 6px;
      overflow: hidden;
      position: relative;
    }
    .planner-grid .util-bar {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      background-color: var(--accent-green);
      transition: height .2s;
    }
    .planner-grid .util-value {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 13px;
      font-weight: 600;
    }
    .planner-grid .util-cell.overload .util-bar { background-color: var(--accent-red); }
    .planner-grid .util-cell.vacation .util-bar-wrapper { background-color: #e5e7eb; }


    /* Project & Employee Views */
    .management-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 16px;
    }
    .management-card {
        padding: 16px;
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 16px;
        align-items: center;
    }
    .management-card .info-block { display: flex; align-items: center; gap: 16px; }
    .management-card .color-swatch {
        width: 32px; height: 32px; border-radius: 8px; display: flex;
        justify-content: center; align-items: center; color: white;
    }
    .management-card .name { font-weight: 600; font-size: 16px; }
    .management-card .meta { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
    .management-card .actions { display: flex; justify-content: flex-end; align-items: center; gap: 8px; }
    
    .team-pills { display: flex; flex-wrap: wrap; gap: 8px; }
    .pill {
      display: inline-flex; align-items: center; gap: 6px; background-color: var(--accent-blue-light);
      color: var(--accent-blue); font-size: 13px; font-weight: 500;
      padding: 4px 10px; border-radius: 99px;
    }
    .pill button {
      background: none; border: none; cursor: pointer; color: inherit;
      opacity: 0.6; font-size: 16px; line-height: 1; padding: 0;
    }
    .pill button:hover { opacity: 1; }

    /* Modal */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000;
      display: grid; place-items: center; animation: fadeIn .2s;
    }
    .modal-content {
      background: var(--bg-panel); padding: 24px; border-radius: 12px;
      min-width: 480px; max-width: 90vw; box-shadow: var(--shadow-lg);
      animation: slideIn .2s;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .modal-title { font-size: 20px; font-weight: 600; }
    .modal-close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-tertiary); }
    .modal-body .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .modal-body .form-group { display: flex; flex-direction: column; }
    .modal-body .form-group-full { grid-column: 1 / 3; }
    .modal-body label { font-weight: 500; margin-bottom: 6px; font-size: 13px; }
    .modal-body input, .modal-body select {
      width: 100%; padding: 8px 12px; border: 1px solid var(--border-color);
      border-radius: 8px; font-size: 14px; background-color: var(--bg-main);
    }
    .modal-body input[type="color"] { padding: 2px; height: 40px; }
    .modal-footer { margin-top: 24px; display: flex; justify-content: flex-end; gap: 12px; }

    /* Person Page */
    .person-page-overlay {
        position: fixed; inset: 0;
        z-index: 200;
        background-color: var(--bg-main);
        overflow-y: auto;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef, useCallback, createContext, useContext, Fragment } = React;

    // ---------- CONTEXT ----------
    const AppContext = createContext(null);
    
    // ---------- CONSTANTS & HELPERS ----------
    const LS_KEY = 'fteplanner.v2_merged';
    const MAX_FTE = 1.2;
    const WEEK_COL_PX = 80;
    const VISIBLE_WEEKS = 16;
    const TEAM_BAR_COLOR = "#22c55e";

    // Date/format helpers
    const fmtISO = (date) => date.toISOString().slice(0,10);
    const addDays = (d, n) => { const x=new Date(d); x.setDate(x.getDate()+n); x.setHours(0,0,0,0); return x; };
    const pad2 = (n) => (n<10 ? `0${n}` : String(n));
    const startOfISOWeek = (d) => { const day=d.getDay(); const diff=(day===0?-6:1)-day; const m=new Date(d); m.setDate(d.getDate()+diff); m.setHours(0,0,0,0); return m; };
    const addWeeks = (m, n) => { const d=new Date(m); d.setDate(d.getDate()+n*7); d.setHours(0,0,0,0); return d; };
    const rndId = () => (globalThis.crypto && crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2));
    const fmtFTE1 = (n) => (Math.round(n*10)/10).toFixed(1);
    const RU_MONTHS = ["янв","фев","мар","апр","май","июн","июл","авг","сен","окт","ноя","дек"];
    const ruMonthShort = (m) => RU_MONTHS[m] ?? "";
    const weekLabelParts = (iso) => { const d=new Date(iso); const w=1+Math.floor((d.getDate()-1)/7); return { top:`${w} нед`, bot:ruMonthShort(d.getMonth()) }; };
    const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
    const scaleRatio = (v, max=MAX_FTE) => clamp(v/max, 0, 1);
    
    // Aggregations
    const personWeekTotal = (allocs, pid, w) => allocs.filter(a=>a.personId===pid && a.weekStart===w).reduce((s,a)=>s+a.fte,0);
    const fteFor = (allocs, pid, pr, w) => allocs.filter(a=>a.personId===pid && a.projectId===pr && a.weekStart===w).reduce((s,a)=>s+a.fte,0);

    // Order merge helper
    const mergeOrder = (existing, nextIds) => {
      const seen=new Set(); const res=[];
      for(const id of (existing||[])) if(nextIds.includes(id) && !seen.has(id)){ res.push(id); seen.add(id); }
      for(const id of nextIds) if(!seen.has(id)){ res.push(id); seen.add(id); }
      return res;
    };
    
    // ---------- SEED DATA ----------
    const base = startOfISOWeek(new Date());
    const initialWeeks = Array.from({length:24}, (_,i)=> fmtISO(addWeeks(base, i-4)));
    const seedData = {
        people: [
            { id:"p1", name:"Саша", role:"manager", capacityPerWeek:1, active:true, external:false },
            { id:"p2", name:"Катя К.", role:"designer", capacityPerWeek:1, active:true, external:false },
            { id:"p3", name:"Иван П.", role:"dev", capacityPerWeek:1, active:true, external:true },
        ],
        projects: [
            { id:"pr1", name:"HR Подкасты", status:"active", color:"#3b82f6" },
            { id:"pr2", name:"Арктика Медиа", status:"active", color:"#f43f5e" },
            { id:"pr3", name:"Падел-теннис", status:"planned", color:"#06b6d4" },
        ],
        allocations: [
            { id:"a1", personId:"p1", projectId:"pr1", weekStart: initialWeeks[4], fte:0.3 },
            { id:"a2", personId:"p1", projectId:"pr2", weekStart: initialWeeks[4], fte:0.2 },
            { id:"a3", personId:"p2", projectId:"pr2", weekStart: initialWeeks[5], fte:0.4 },
        ],
        roles: ["designer","dev","manager","pm","other"],
        projectTeams: {
            "pr1": ["p1"], "pr2": ["p1", "p2"], "pr3": []
        },
        vacations: {},
        weeks: initialWeeks,
        teamOrder: ["p1", "p2", "p3"]
    };

    // ---------- DATA PERSISTENCE HOOK ----------
    function usePersistentState(key, defaultValue) {
        const [state, setState] = useState(() => {
            try {
                const storedValue = localStorage.getItem(key);
                if (storedValue) {
                    const parsed = JSON.parse(storedValue);
                    // Handle Set objects serialization
                    if (parsed.vacations) {
                        Object.keys(parsed.vacations).forEach(k => {
                            parsed.vacations[k] = new Set(parsed.vacations[k]);
                        });
                    }
                    if (parsed.projectTeams) {
                        Object.keys(parsed.projectTeams).forEach(k => {
                            parsed.projectTeams[k] = new Set(parsed.projectTeams[k]);
                        });
                    }
                    return parsed;
                }
            } catch (error) {
                console.error("Error reading from localStorage", error);
            }
            return defaultValue;
        });

        useEffect(() => {
            try {
                // Handle Set objects for JSON.stringify
                const toStore = { ...state };
                if (toStore.vacations) {
                    const serializableVacations = {};
                    Object.entries(toStore.vacations).forEach(([key, value]) => {
                        serializableVacations[key] = Array.from(value);
                    });
                    toStore.vacations = serializableVacations;
                }
                if (toStore.projectTeams) {
                    const serializableTeams = {};
                    Object.entries(toStore.projectTeams).forEach(([key, value]) => {
                        serializableTeams[key] = Array.from(value);
                    });
                    toStore.projectTeams = serializableTeams;
                }
                localStorage.setItem(key, JSON.stringify(toStore));
            } catch (error) {
                console.error("Error writing to localStorage", error);
            }
        }, [key, state]);

        return [state, setState];
    }
    
    // ---------- MAIN APP COMPONENT ----------
    function App() {
      const [appData, setAppData] = usePersistentState(LS_KEY, seedData);
      const [authed, setAuthed] = useState(() => !!localStorage.getItem(LS_KEY + '_authed'));
      const [view, setView] = useState('team'); // team | projects | employees
      const [selectedPersonId, setSelectedPersonId] = useState(null);

      const updateData = (key, value) => {
        setAppData(prev => ({ ...prev, [key]: value }));
      };
      
      const appContextValue = {
        ...appData,
        updateData,
        setAppData,
        view, setView,
        selectedPersonId, setSelectedPersonId
      };

      if (!authed) {
        return <LoginPage onAuthSuccess={(remember) => {
            if (remember) localStorage.setItem(LS_KEY + '_authed', 'true');
            setAuthed(true);
        }} />;
      }
      
      return (
        <AppContext.Provider value={appContextValue}>
            <AppHeader onLogout={() => {
                localStorage.removeItem(LS_KEY + '_authed');
                setAuthed(false);
            }}/>
            <main className="app-container">
                {view === 'team' && <TeamView />}
                {view === 'projects' && <ProjectsView />}
                {view === 'employees' && <EmployeesView />}
            </main>
            {selectedPersonId && <PersonPage />}
        </AppContext.Provider>
      );
    }
    
    function LoginPage({ onAuthSuccess }) {
      const [login, setLogin] = useState("панквеб");
      const [pass, setPass] = useState("");
      const [remember, setRemember] = useState(true);
      const [error, setError] = useState('');

      const submit = (e) => { 
        e.preventDefault(); 
        if(login.trim().toLowerCase()==="панквеб" && pass==="123455"){ 
          onAuthSuccess(remember); 
        } else { 
          setError("Неверные данные");
        } 
      };

      return (
        <div className="login-container">
          <div className="login-box">
            <h1>FTE Planner</h1>
            <form onSubmit={submit} className="login-form">
              <div className="form-group">
                <label>Логин</label>
                <input value={login} onChange={e=>setLogin(e.target.value)} />
              </div>
              <div className="form-group">
                <label>Пароль</label>
                <input type="password" value={pass} onChange={e=>setPass(e.target.value)} />
              </div>
              <div className="checkbox-group">
                <input type="checkbox" id="remember" checked={remember} onChange={e=>setRemember(e.target.checked)} />
                <label htmlFor="remember">Запомнить данные</label>
              </div>
              {error && <p className="login-error">{error}</p>}
              <button className="btn btn-primary btn-block" style={{marginTop: '24px'}}>Войти</button>
            </form>
          </div>
        </div>
      );
    }

    function AppHeader({ onLogout }) {
        const { view, setView } = useContext(AppContext);
        const [isCreatePersonOpen, setCreatePersonOpen] = useState(false);
        const [isCreateProjectOpen, setCreateProjectOpen] = useState(false);

        return (
            <>
            <header className="app-header">
                <div className="logo">FTE Planner</div>
                <div style={{ margin: '0 auto' }}>
                    <div className="segmented-control">
                        <button className={view === "team" ? "active" : ""} onClick={()=>setView("team")}>Нагрузка</button>
                        <button className={view === "projects" ? "active" : ""} onClick={()=>setView("projects")}>Проекты</button>
                        <button className={view === "employees" ? "active" : ""} onClick={()=>setView("employees")}>Команда</button>
                    </div>
                </div>
                <div className="header-controls">
                    <button className="btn btn-secondary" onClick={() => setCreateProjectOpen(true)}>+ Проект</button>
                    <button className="btn btn-secondary" onClick={() => setCreatePersonOpen(true)}>+ Сотрудник</button>
                    <button className="btn btn-secondary" onClick={onLogout}>Выйти</button>
                </div>
            </header>
            {isCreatePersonOpen && <CreatePersonModal onClose={() => setCreatePersonOpen(false)} />}
            {isCreateProjectOpen && <CreateProjectModal onClose={() => setCreateProjectOpen(false)} />}
            </>
        )
    }

    function WeekNavigator({ onLeft, onRight, onToday }) {
        return (
            <div className="header-content">
                <div className="segmented-control">
                    <button onClick={onLeft}>‹</button>
                    <button onClick={onToday}>Сегодня</button>
                    <button onClick={onRight}>›</button>
                </div>
            </div>
        )
    }

    function TeamView() {
        const { people, allocations, vacations, teamOrder, setSelectedPersonId } = useContext(AppContext);
        // Weeks window logic
        const [weeks, setWeeks] = useState(initialWeeks);
        const [firstIdx, setFirstIdx] = useState(4); // Start with a bit of history
        const visibleWeeks = useMemo(() => weeks.slice(firstIdx, firstIdx + VISIBLE_WEEKS), [weeks, firstIdx]);

        const goLeft = () => setFirstIdx(p => Math.max(0, p - 1));
        const goRight = () => setFirstIdx(p => Math.min(weeks.length - VISIBLE_WEEKS, p + 1));
        const goToday = () => {
            const todayISO = fmtISO(startOfISOWeek(new Date()));
            const idx = weeks.indexOf(todayISO);
            if (idx > -1) setFirstIdx(Math.max(0, idx));
        }

        const activePeople = useMemo(() => teamOrder.map(id => people.find(p => p.id === id)).filter(Boolean), [teamOrder, people]);
        
        return (
            <div className="planner-grid">
                <div className="left-col">
                    <div className="header"></div>
                    <div>
                        {activePeople.map(person => (
                            <div key={person.id} className="card person-card" onClick={() => setSelectedPersonId(person.id)}>
                                <div className="person-name">{person.name}</div>
                                <div className="person-role">{person.role}</div>
                            </div>
                        ))}
                    </div>
                </div>
                <div className="timeline-col" style={{overflowX: 'auto'}}>
                    <div className="header">
                        <WeekNavigator onLeft={goLeft} onRight={goRight} onToday={goToday} />
                    </div>
                    <div className="header" style={{top: `calc(var(--header-h) + 56px)`}}>
                        <div style={{display: 'flex'}}>
                            {visibleWeeks.map(w => (
                                <div key={w} className="week-header" style={{width: WEEK_COL_PX}}>
                                    <div>
                                        <div className="week-num">{weekLabelParts(w).top}</div>
                                        <div>{weekLabelParts(w).bot}</div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                    <div>
                        {activePeople.map(person => (
                            <div key={person.id} className="timeline-row">
                                {visibleWeeks.map(week => {
                                    const total = personWeekTotal(allocations, person.id, week);
                                    const ratio = scaleRatio(total);
                                    const isVac = vacations[person.id]?.has(week);
                                    return (
                                        <div key={week} className="week-cell">
                                            <div className={`util-cell card ${total > 1 ? 'overload' : ''} ${isVac ? 'vacation' : ''}`}>
                                                <div className="util-bar-wrapper">
                                                    {!isVac && <div className="util-bar" style={{height: `${ratio*100}%`}} />}
                                                </div>
                                                <div className="util-value">{isVac ? '🏖' : fmtFTE1(total)}</div>
                                            </div>
                                        </div>
                                    )
                                })}
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        );
    }
    
    function ProjectsView() {
        const { projects, people, projectTeams, setAppData } = useContext(AppContext);
        
        const deleteProject = (id) => {
            if (!confirm("Удалить проект?")) return;
            setAppData(prev => ({
                ...prev,
                projects: prev.projects.filter(p => p.id !== id),
                allocations: prev.allocations.filter(a => a.projectId !== id),
            }))
        }

        return (
            <div className="management-grid">
                {projects.map(project => (
                    <div key={project.id} className="card management-card">
                        <div className="info-block">
                            <div className="color-swatch" style={{backgroundColor: project.color}}></div>
                            <div>
                                <div className="name">{project.name}</div>
                                <div className="meta">{project.status}</div>
                            </div>
                        </div>
                        <div className="team-pills">
                            {(Array.from(projectTeams[project.id] || [])).map(pid => {
                                const person = people.find(p => p.id === pid);
                                return person ? <span key={pid} className="pill">{person.name}</span> : null;
                            })}
                        </div>
                        <div className="actions">
                            <button className="btn btn-secondary">Редактировать</button>
                            <button className="btn btn-danger" onClick={() => deleteProject(project.id)}>Удалить</button>
                        </div>
                    </div>
                ))}
            </div>
        )
    }
    
    function EmployeesView() {
        const { people, setAppData } = useContext(AppContext);
        
        const deletePerson = (id) => {
            if (!confirm("Удалить сотрудника?")) return;
            setAppData(prev => ({
                ...prev,
                people: prev.people.filter(p => p.id !== id),
                allocations: prev.allocations.filter(a => a.personId !== id),
            }))
        }
        
        return (
            <div className="management-grid">
                {people.map(person => (
                    <div key={person.id} className="card management-card">
                        <div className="info-block">
                             <div>
                                <div className="name">{person.name}</div>
                                <div className="meta">{person.role} {person.external && '(Внешний)'}</div>
                            </div>
                        </div>
                        <div> {/* Placeholder for projects */} </div>
                        <div className="actions">
                            <button className="btn btn-secondary">Редактировать</button>
                            <button className="btn btn-danger" onClick={() => deletePerson(person.id)}>Удалить</button>
                        </div>
                    </div>
                ))}
            </div>
        )
    }

    function PersonPage() {
        // This is a simplified version for brevity. A full implementation would be much larger.
        const { selectedPersonId, setSelectedPersonId, people, projects, allocations } = useContext(AppContext);
        const person = people.find(p => p.id === selectedPersonId);
        
        if (!person) return null;

        const personProjects = useMemo(() => {
            const projectIds = new Set(allocations.filter(a => a.personId === person.id).map(a => a.projectId));
            return projects.filter(p => projectIds.has(p.id));
        }, [person.id, allocations, projects]);
        
        return (
            <div className="person-page-overlay no-scrollbar">
                <AppHeader onLogout={() => {}} />
                <div className="app-container">
                    <div style={{display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '24px'}}>
                        <h1>{person.name} <span className="meta" style={{fontSize: '16px'}}>{person.role}</span></h1>
                        <button className="btn btn-secondary" onClick={() => setSelectedPersonId(null)}>Закрыть</button>
                    </div>
                    
                    <div className="card" style={{padding: '24px'}}>
                        <h3>Проекты сотрудника</h3>
                        <p>Здесь будет детальная сетка загрузки по проектам, как в исходном файле index3.html</p>
                        <ul>
                            {personProjects.map(p => <li key={p.id}>{p.name}</li>)}
                        </ul>
                    </div>
                </div>
            </div>
        )
    }

    function CreatePersonModal({ onClose }) {
        const { setAppData, roles } = useContext(AppContext);
        const [name, setName] = useState('');
        const [role, setRole] = useState(roles[0] || 'other');
        const [external, setExternal] = useState(false);

        const handleSubmit = () => {
            if (!name.trim()) return;
            const newPerson = {
                id: rndId(), name: name.trim(), role,
                capacityPerWeek: 1, active: true, external,
            };
            setAppData(prev => ({ ...prev, people: [...prev.people, newPerson] }));
            onClose();
        };

        return (
            <div className="modal-overlay" onClick={onClose}>
                <div className="modal-content" onClick={e => e.stopPropagation()}>
                    <div className="modal-header">
                        <h2 className="modal-title">Новый сотрудник</h2>
                        <button onClick={onClose} className="modal-close-btn">&times;</button>
                    </div>
                    <div className="modal-body">
                        <div className="form-group">
                            <label>Имя</label>
                            <input value={name} onChange={e => setName(e.target.value)} autoFocus/>
                        </div>
                        <div className="form-group">
                            <label>Роль</label>
                            <select value={role} onChange={e => setRole(e.target.value)}>
                                {roles.map(r => <option key={r} value={r}>{r}</option>)}
                            </select>
                        </div>
                        <label style={{display:'flex', alignItems:'center', gap: '8px', marginTop: '8px'}}>
                            <input type="checkbox" checked={external} onChange={e => setExternal(e.target.checked)} />
                            Внешний сотрудник
                        </label>
                    </div>
                    <div className="modal-footer">
                        <button className="btn btn-secondary" onClick={onClose}>Отмена</button>
                        <button className="btn btn-primary" onClick={handleSubmit}>Создать</button>
                    </div>
                </div>
            </div>
        )
    }
    
    function CreateProjectModal({ onClose }) {
        const { setAppData } = useContext(AppContext);
        const [name, setName] = useState('');
        const [status, setStatus] = useState('active');
        const [color, setColor] = useState('#3B82F6');

        const handleSubmit = () => {
            if (!name.trim()) return;
            const newProject = {
                id: rndId(), name: name.trim(), status, color
            };
            setAppData(prev => ({
                ...prev,
                projects: [...prev.projects, newProject],
                projectTeams: { ...prev.projectTeams, [newProject.id]: new Set() }
            }));
            onClose();
        }

        return (
            <div className="modal-overlay" onClick={onClose}>
                <div className="modal-content" onClick={e => e.stopPropagation()}>
                    <div className="modal-header">
                        <h2 className="modal-title">Новый проект</h2>
                        <button onClick={onClose} className="modal-close-btn">&times;</button>
                    </div>
                    <div className="modal-body">
                         <div className="form-grid">
                            <div className="form-group form-group-full">
                                <label>Название</label>
                                <input value={name} onChange={e => setName(e.target.value)} autoFocus/>
                            </div>
                            <div className="form-group">
                                <label>Статус</label>
                                <select value={status} onChange={e => setStatus(e.target.value)}>
                                    <option value="active">Active</option>
                                    <option value="planned">Planned</option>
                                    <option value="onhold">On Hold</option>
                                    <option value="done">Done</option>
                                </select>
                            </div>
                            <div className="form-group">
                                <label>Цвет</label>
                                <input type="color" value={color} onChange={e => setColor(e.target.value)} />
                            </div>
                        </div>
                    </div>
                    <div className="modal-footer">
                        <button className="btn btn-secondary" onClick={onClose}>Отмена</button>
                        <button className="btn btn-primary" onClick={handleSubmit}>Создать</button>
                    </div>
                </div>
            </div>
        )
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);

  </script>
</body>
</html>
