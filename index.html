<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ü–∞–Ω–∫–≤–µ–± FTE Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --app-header-h:56px;
      --left-col-w:280px;
      --row-h:120px;
      --week-col:120px;
      --green:#16a34a;
      --green-50:#ecfdf5;
      --green-600:#16a34a;
    }
    .btn{ padding:8px 12px; border-radius:12px; font-size:14px; font-weight:500; border:1px solid var(--green-600); color:#065f46; background:#fff; transition:.15s; }
    .btn:hover{ background:var(--green-50);}
    .nav-btn{ padding:8px 12px; border-radius:12px; font-size:14px; font-weight:700; transition:.15s; border:1px solid #d1d5db; background:#fff; color:#111827; }
    .nav-btn.active{ background:var(--green); color:#fff; border-color:var(--green);}
    .tag{ padding:2px 8px; border-radius:8px; font-size:12px; border:1px solid #e5e7eb; background:#fafafa; color:#374151; }
    .card{ background:#fff; border:1px solid #e5e7eb; border-radius:16px; box-shadow:0 1px 1px rgba(0,0,0,.03); }
    .cell-input{ outline:none; }
    .segmented{ display:flex; gap:6px; padding:6px; border:1px solid #e5e7eb; border-radius:9999px; background:#f3f4f6; }
    .segmented button{ padding:6px 12px; border-radius:12px; }
    .segmented .active{ background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.06); }
  </style>
</head>
<body class="bg-[#F7F8FA] text-neutral-900">
  <div id="root"></div>

  <!-- React/Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const {useState, useMemo, useEffect, useRef, Fragment} = React;

    /* ======================= CONFIG & HELPERS ======================= */
    const WEEK_COL_PX = 120; // –≤–∏–∑—É–∞–ª—å–Ω–æ –∫–∞–∫ —É –≤–∞—Å
    const MAX_FTE = 1.2;
    const TEAM_BAR_COLOR = "#22c55e";
    const VISIBLE_WEEKS = 12;

    const LS_KEY = "fteplanner.v2"; // –µ–¥–∏–Ω—ã–π –∫–ª—é—á —Ö—Ä–∞–Ω–µ–Ω–∏—è

    const loadAll = ()=>{ try{ return JSON.parse(localStorage.getItem(LS_KEY)||"{}"); }catch{ return {}; } };
    const saveAll = (patch)=>{ try{ const all=loadAll(); localStorage.setItem(LS_KEY, JSON.stringify({...all, ...patch})); }catch{} };
    const lget = (k, def)=>{ const all=loadAll(); return (k in all)? all[k] : def; };

    const startOfISOWeek = (d)=>{ const x=new Date(d); const day=x.getDay(); const diff=(day===0?-6:1-day); x.setDate(x.getDate()+diff); x.setHours(0,0,0,0); return x; };
    const addDays = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); x.setHours(0,0,0,0); return x; };
    const addWeeks = (d,n)=> addDays(d, n*7);
    const iso = (d)=>{ const x=new Date(d); x.setHours(0,0,0,0); return x.toISOString().slice(0,10); };
    const clamp = (v,min,max)=> Math.max(min, Math.min(max, v));
    const fmtFTE1 = (n)=> (Math.round((n||0)*10)/10).toFixed(1);
    const fmtFTE2 = (n)=> (Math.round((n||0)*100)/100).toFixed(2);
    const rndId = ()=> (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2));

    const RU_MONTHS = ["–Ø–Ω–≤–∞—Ä—å","–§–µ–≤—Ä–∞–ª—å","–ú–∞—Ä—Ç","–ê–ø—Ä–µ–ª—å","–ú–∞–π","–ò—é–Ω—å","–ò—é–ª—å","–ê–≤–≥—É—Å—Ç","–°–µ–Ω—Ç—è–±—Ä—å","–û–∫—Ç—è–±—Ä—å","–ù–æ—è–±—Ä—å","–î–µ–∫–∞–±—Ä—å"];
    function weekIndexInMonth(weekISO){
      const w = startOfISOWeek(new Date(weekISO));
      const mStart = new Date(w.getFullYear(), w.getMonth(), 1);
      let first = startOfISOWeek(mStart);
      if(first.getMonth() !== mStart.getMonth()){
        const tmp = addDays(first, 7);
        if(tmp.getMonth() === mStart.getMonth()) first = tmp;
      }
      const diffDays = Math.floor((w - first)/(1000*60*60*24));
      const idx = Math.floor(diffDays/7) + 1;
      return idx < 1 ? 1 : idx;
    }

    /* ======================= SEED DATA (–∏–∑ Index3) ======================= */
    const base = startOfISOWeek(new Date());
    const initialWeeks = Array.from({length:24}, (_,i)=> iso(addWeeks(base, i-4)));

    const seedPeople = [
      { id:"p1", name:"–°–∞—à–∞", role:"manager", capacityPerWeek:1, active:true, external:false },
      { id:"p2", name:"–ö–∞—Ç—è –ö.", role:"designer", capacityPerWeek:1, active:true, external:false },
    ];
    const seedProjects = [
      { id:"pr1", name:"HR –ü–æ–¥–∫–∞—Å—Ç—ã", status:"active", color:"#3b82f6" },
      { id:"pr2", name:"–ê—Ä–∫—Ç–∏–∫–∞ –ú–µ–¥–∏–∞", status:"active", color:"#f43f5e" },
      { id:"pr3", name:"–ü–∞–¥–µ–ª-—Ç–µ–Ω–Ω–∏—Å", status:"planned", color:"#06b6d4" },
    ];
    const seedAssignments = [
      { id:"a1", personId:"p1", projectId:"pr1", weekStart: initialWeeks[4], fte:0.3 },
      { id:"a2", personId:"p1", projectId:"pr2", weekStart: initialWeeks[4], fte:0.2 },
      { id:"a3", personId:"p2", projectId:"pr2", weekStart: initialWeeks[5], fte:0.4 },
    ];
    const seedRoles = ["designer","dev","manager","pm","other"];

    /* ======================= AGGREGATIONS (–∫–∞–∫ –≤ Index3) ======================= */
    const personWeekTotal = (as, pid, w) => as.filter(a=>a.personId===pid && a.weekStart===w).reduce((s,a)=>s+a.fte,0);
    const fteFor = (as, pid, pr, w) => as.filter(a=>a.personId===pid && a.projectId===pr && a.weekStart===w).reduce((s,a)=>s+a.fte,0);
    const mergeOrder = (existing, nextIds) => {
      const seen=new Set(); const res=[];
      for(const id of (existing||[])) if(nextIds.includes(id) && !seen.has(id)){ res.push(id); seen.add(id); }
      for(const id of nextIds) if(!seen.has(id)){ res.push(id); seen.add(id); }
      return res;
    };
    const yearWeekMondays = (year) => { let m=startOfISOWeek(new Date(year,0,1)); const end=new Date(year,11,31); end.setHours(0,0,0,0); const list=[]; while(m<=end){ list.push(iso(m)); m=addDays(m,7);} return list; };
    const weekRangeLabel = (mISO)=>{ const d=new Date(mISO); const e=addDays(d,6); const pad=(n)=> n<10?`0${n}`:n; return `${pad(d.getDate())}.${pad(d.getMonth()+1)}‚Äì${pad(e.getDate())}.${pad(e.getMonth()+1)}`; };

    /* ======================= HEADER ======================= */
    function AppHeader({ tab, setTab, onAddProject, onAddPerson }){
      const NB = ({active, onClick, children}) =>
        <button className={`nav-btn ${active?"active":""}`} onClick={onClick}>{children}</button>;
      return (
        <header className="sticky top-0 z-50 bg-white/90 backdrop-blur border-b border-neutral-200">
          <div className="max-w-screen-2xl mx-auto px-4 h-[var(--app-header-h)] flex items-center justify-between gap-4">
            <div className="flex items-center gap-3">
              <div className="font-semibold tracking-wide mr-2 text-[var(--green)]">–ü–∞–Ω–∫–≤–µ–± FTE Planner</div>
              <div className="flex items-center gap-2">
                <NB active={tab==='load'} onClick={()=>setTab('load')}>–ù–∞–≥—Ä—É–∑–∫–∞</NB>
                <NB active={tab==='projects'} onClick={()=>setTab('projects')}>–ü—Ä–æ–µ–∫—Ç—ã</NB>
                <NB active={tab==='team'} onClick={()=>setTab('team')}>–ö–æ–º–∞–Ω–¥–∞</NB>
              </div>
            </div>
            <div className="flex items-center gap-2">
              <button className="btn" onClick={onAddProject}>+ –ü—Ä–æ–µ–∫—Ç</button>
              <button className="btn" onClick={onAddPerson}>+ –°–æ—Ç—Ä—É–¥–Ω–∏–∫</button>
            </div>
          </div>
        </header>
      );
    }

    /* ======================= WEEK WINDOW (–∏–∑ Index3) ======================= */
    function useWeeksWindow(){
      const [weeks, setWeeks] = useState(lget("weeks", initialWeeks));
      const savedFirstISO = lget("firstWeekISO", weeks[0]);
      const initIdx = Math.max(0, weeks.indexOf(savedFirstISO));
      const [firstIdx, setFirstIdx] = useState(initIdx);

      const ensureRange = (needIdx) => {
        if(needIdx < 0){
          const first = new Date(weeks[0]);
          const prepend = Array.from({length: Math.ceil((-needIdx)/8)*8 }, (_,i)=> iso(addWeeks(first, -(i+1)))).reverse();
          const next = [...prepend, ...weeks];
          setWeeks(next);
          return { weeks: next, firstIdx: needIdx + prepend.length };
        }
        if(needIdx + VISIBLE_WEEKS >= weeks.length){
          const last = new Date(weeks[weeks.length-1]);
          const more = Array.from({length:16}, (_,i)=> iso(addWeeks(last, i+1)));
          const next = [...weeks, ...more];
          setWeeks(next);
          return { weeks: next, firstIdx: needIdx };
        }
        return { weeks, firstIdx: needIdx };
      };

      const goLeft = () => {
        const {weeks: w2, firstIdx: f2} = ensureRange(firstIdx-1);
        setFirstIdx(f2); saveAll({firstWeekISO: w2[f2], weeks: w2});
      };
      const goRight = () => {
        const {weeks: w2, firstIdx: f2} = ensureRange(firstIdx+1);
        setFirstIdx(f2); saveAll({firstWeekISO: w2[f2], weeks: w2});
      };
      const goToday = () => {
        const todayISO = iso(startOfISOWeek(new Date()));
        let idx = weeks.indexOf(todayISO);
        if(idx<0){
          let m = startOfISOWeek(new Date(todayISO));
          const end = addWeeks(m, 200);
          const set = new Set(weeks);
          const add = [];
          while(m<=end){ const s=iso(m); if(!set.has(s)) add.push(s); m = addDays(m,7); }
          const next = [...weeks, ...add].sort();
          setWeeks(next);
          idx = next.indexOf(todayISO);
          saveAll({weeks: next});
        }
        const {weeks: w2, firstIdx: f2} = ensureRange(idx);
        setFirstIdx(f2); saveAll({firstWeekISO: w2[f2]});
      };

      const visible = useMemo(()=> weeks.slice(firstIdx, firstIdx+VISIBLE_WEEKS), [weeks, firstIdx]);

      return {weeks, setWeeks, visible, goLeft, goRight, goToday};
    }

    /* ======================= CALENDAR HEADER ======================= */
    function CalendarHeader({visibleWeeks, leftLabel, stickyTopClass="top-[var(--app-header-h)]", badgeByISO=null}){
      const years=[]; let cy=null, c=0;
      visibleWeeks.forEach((isoW,i)=>{ const y=new Date(isoW).getFullYear();
        if(cy===null){ cy=y; c=1; } else if(y===cy){ c++; } else { years.push({year:cy,count:c}); cy=y; c=1; }
        if(i===visibleWeeks.length-1) years.push({year:cy,count:c});
      });
      const months=[]; let key=null, cnt=0, y0=null, m0=null;
      visibleWeeks.forEach((isoW,i)=>{ const d=new Date(isoW), y=d.getFullYear(), m=d.getMonth(), k=`${y}-${m}`;
        if(k!==key){ if(key!==null) months.push({key, year:y0, month:m0, count:cnt}); key=k; cnt=1; y0=y; m0=m; }
        else cnt++;
        if(i===visibleWeeks.length-1) months.push({key, year:y0, month:m0, count:cnt});
      });

      const gridCols = `var(--left-col-w) repeat(${visibleWeeks.length}, ${WEEK_COL_PX}px)`;
      return (
        <div className={`sticky ${stickyTopClass} z-40`}>
          <div className="grid" style={{gridTemplateColumns:gridCols, rowGap:'6px'}}>
            <div className="sticky left-0 z-50 bg-[#F7F8FA] border-r border-neutral-200 p-1" style={{gridRow:"span 3 / span 3"}}>
              <div className="h-full rounded-2xl bg-white border border-neutral-200 shadow-sm flex items-center pl-5 text-sm text-neutral-700">
                {leftLabel}
              </div>
            </div>

            {years.map(g=>(
              <div key={`y-${g.year}`} style={{gridColumn:`span ${g.count}`}}>
                <div className="mx-1 rounded-xl px-3 py-1 text-center text-white text-sm font-medium bg-neutral-900">{g.year} –≥.</div>
              </div>
            ))}
            {months.map(g=>(
              <div key={g.key} style={{gridColumn:`span ${g.count}`}}>
                <div className="mx-1 rounded-xl px-3 py-1.5 text-center text-[13px] font-medium bg-neutral-100 text-neutral-800 border border-neutral-200">
                  {RU_MONTHS[g.month]}
                </div>
              </div>
            ))}
            {visibleWeeks.map((w)=>(
              <div key={`w-${w}`} className="relative">
                <div className="mx-1 rounded-md px-2 py-1 text-center text-[12px] text-neutral-800 bg-white border border-neutral-200 shadow-sm">
                  –ù–µ–¥. {weekIndexInMonth(w)}
                </div>
                {badgeByISO && badgeByISO[w]!=null && (
                  <div className="absolute -right-1 -top-2 translate-x-1/2">
                    <span className="px-2 py-0.5 rounded-full text-[11px] font-bold border border-neutral-300 bg-neutral-50 text-neutral-800 shadow-sm">
                      {badgeByISO[w]}
                    </span>
                  </div>
                )}
              </div>
            ))}
          </div>
        </div>
      );
    }

    /* ======================= WEEK NAV ======================= */
    function WeekNavigator({ onLeft, onRight, onToday, showToday=true, leftNode=null, stickyTopClass="top-[var(--app-header-h)]", roleFilter, setRoleFilter, roles=[] }){
      return (
        <div className={`sticky ${stickyTopClass} z-30 bg-white/80 backdrop-blur border-b border-neutral-200`}>
          <div className="max-w-screen-2xl mx-auto px-4 h-[44px] flex items-center justify-between">
            <div className="flex items-center gap-2">
              {leftNode}
              {setRoleFilter && (
                <div className="flex items-center gap-2 ml-2">
                  <label className="text-sm text-neutral-700">–†–æ–ª—å</label>
                  <select className="border border-neutral-300 rounded-xl px-2 py-1 text-sm"
                          value={roleFilter} onChange={e=>setRoleFilter(e.target.value)}>
                    <option value="all">–í—Å–µ</option>
                    {roles.map(r => (<option key={r} value={r}>{r}</option>))}
                  </select>
                </div>
              )}
            </div>
            <div className="flex items-center gap-2">
              <button className="btn" onClick={onLeft} title="–ù–∞–∑–∞–¥">‚Äπ</button>
              {showToday && <button className="btn" onClick={onToday}>–°–µ–≥–æ–¥–Ω—è</button>}
              <button className="btn" onClick={onRight} title="–í–ø–µ—Ä—ë–¥">‚Ä∫</button>
            </div>
          </div>
        </div>
      );
    }

    /* ======================= ROLE MANAGER (–∏–∑ Index3) ======================= */
    function RoleManager({roles, setRoles, setRoleFilter, people, setPeople, stickyTopClass='top-[var(--app-header-h)]'}){
      const [adding, setAdding] = useState("");
      const [editing, setEditing] = useState(null);
      const [val, setVal] = useState("");

      const add = ()=>{ const x=adding.trim(); if(!x || roles.includes(x)) return; setRoles([...roles, x]); setAdding(""); };
      const startEdit = (r)=>{ setEditing(r); setVal(r); };
      const commit = ()=>{ if(!editing) return; const x=val.trim(); if(!x){ setEditing(null); return; } setRoles(roles.map(r => r===editing ? x : r)); setEditing(null); if(x) setRoleFilter(x); };
      const remove = (r)=>{
        if(!confirm(`–£–¥–∞–ª–∏—Ç—å —Ä–æ–ª—å ¬´${r}¬ª? –õ—é–¥—è–º —Å —ç—Ç–æ–π —Ä–æ–ª—å—é –±—É–¥–µ—Ç –ø—Ä–æ—Å—Ç–∞–≤–ª–µ–Ω–æ OTHER.`)) return;
        setRoles(roles.filter(x=>x!==r));
        setPeople(prev => prev.map(p => p.role===r ? {...p, role:"other"} : p));
        setRoleFilter("all");
      };

      return (
        <div className={`bg-white rounded-2xl border border-neutral-200 shadow-sm p-3 sticky ${stickyTopClass} z-50`}>
          <div className="text-sm font-medium">–†–æ–ª–∏</div>
          <div className="mt-2 flex flex-wrap gap-2">
            {roles.map(r => (
              <span key={r} className="inline-flex items-center gap-2 px-2 py-1 rounded-full border border-neutral-200 bg-neutral-50 text-xs">
                {editing===r ? (
                  <input autoFocus value={val} onChange={e=>setVal(e.target.value)} onBlur={commit} onKeyDown={e=>{ if(e.key==='Enter') e.currentTarget.blur(); if(e.key==='Escape') setEditing(null); }} className="px-1 py-0.5 border border-neutral-300 rounded"/>
                ) : (
                  <>
                    <button className="hover:underline" onClick={()=>setRoleFilter(r)}>{r}</button>
                    <button className="text-neutral-500 hover:text-neutral-800" title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å —Ä–æ–ª—å" onClick={()=>startEdit(r)}>‚úé</button>
                    <button className="text-neutral-500 hover:text-red-600" title="–£–¥–∞–ª–∏—Ç—å —Ä–æ–ª—å" onClick={()=>remove(r)}>üóë</button>
                  </>
                )}
              </span>
            ))}
            <span className="inline-flex items-center gap-1">
              <input value={adding} onChange={e=>setAdding(e.target.value)} placeholder="–î–æ–±–∞–≤–∏—Ç—å —Ä–æ–ª—å" className="px-2 py-1 text-sm border border-neutral-300 rounded-lg"/>
              <button className="btn" onClick={add}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </span>
          </div>
        </div>
      );
    }

    /* ======================= LOAD PAGE ======================= */
    function LoadPage({people, setPeople, projects, assignments, vacations, visible, openPerson, roleFilter, setRoleFilter, roles}){
      const {goLeft, goRight, goToday} = useWeeksWindow(); // –ª–æ–∫–∞–ª—å–Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º weeks –∑–¥–µ—Å—å
      const gridCols = `var(--left-col-w) repeat(${visible.length}, ${WEEK_COL_PX}px)`;

      const peopleForTeam = useMemo(()=> people.filter(p=>p.active && !p.external), [people]);
      const [teamOrder, setTeamOrder] = useState(lget("teamOrder", peopleForTeam.map(p=>p.id)));
      useEffect(()=> setTeamOrder(prev => mergeOrder(prev, peopleForTeam.map(p=>p.id))), [peopleForTeam]);
      useEffect(()=> saveAll({teamOrder}), [teamOrder]);

      const activeTeamIds = useMemo(()=> teamOrder.filter(id => peopleForTeam.some(p=>p.id===id)), [teamOrder, peopleForTeam]);
      const filteredTeamIds = useMemo(()=> activeTeamIds.filter(id => roleFilter==="all" ? true : (people.find(p=>p.id===id)?.role===roleFilter)), [activeTeamIds, roleFilter, people]);

      const dragRow = useRef(null);

      return (
        <div className="pb-24">
          <WeekNavigator onLeft={goLeft} onRight={goRight} onToday={goToday} showToday leftNode={null} roleFilter={roleFilter} setRoleFilter={setRoleFilter} roles={roles}/>
          <div className="max-w-screen-2xl mx-auto px-4">
            <CalendarHeader visibleWeeks={visible} leftLabel="–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏" />
            <div className="grid" style={{gridTemplateColumns:gridCols}}>
              {filteredTeamIds.map((pid, rowIdx)=>{
                const person = people.find(p=>p.id===pid);
                return (
                  <Fragment key={pid}>
                    <div className="sticky left-0 z-20 bg-[#F7F8FA] border-r border-neutral-200 p-1"
                         draggable
                         onDragStart={()=>{ dragRow.current=rowIdx; }}
                         onDragOver={(e)=>e.preventDefault()}
                         onDrop={()=>{
                           const from=dragRow.current; const to=rowIdx; if(from==null || from===to) return;
                           const arr=[...filteredTeamIds]; const id=arr.splice(from,1)[0]; arr.splice(to,0,id);
                           const inactive = teamOrder.filter(id => !filteredTeamIds.includes(id));
                           setTeamOrder([...arr, ...inactive]); dragRow.current=null;
                         }}
                         onClick={()=>openPerson(person.id)} role="button">
                      <div className="card h-[var(--row-h)] flex items-center justify-between pl-5 pr-3 hover:bg-neutral-50 transition">
                        <div className="min-w-0">
                          <div className="font-medium truncate">{person.name}</div>
                          <div className="text-[11px] text-neutral-600">{String(person.role||"").toUpperCase()} {person.external? "¬∑ –í–ù–ï–®–ù–ò–ô": ""}</div>
                        </div>
                        <span className="text-neutral-400">‚ãÆ‚ãÆ</span>
                      </div>
                    </div>
                    {visible.map(week=>{
                      const total = personWeekTotal(assignments, person.id, week);
                      const vac = !!(vacations[person.id]?.has?.(week));
                      const ratio = clamp(total/MAX_FTE,0,1);
                      return (
                        <div key={person.id+week} className="p-1">
                          <div className={`card h-[var(--row-h)] flex items-end justify-center relative ${total>1.0001?"ring-1 ring-red-300":""}`}>
                            {vac ? (
                              <div className="absolute inset-0 flex items-center justify-center text-2xl">üèñ</div>
                            ) : (
                              <>
                                <div className="relative w-10 h-[92%] rounded-lg bg-neutral-200 overflow-hidden">
                                  <div className="absolute bottom-0 left-0 right-0" style={{height:`${ratio*100}%`, background:TEAM_BAR_COLOR}}></div>
                                </div>
                                <div className="absolute inset-0 flex items-center justify-center text-sm font-semibold text-neutral-800" title={fmtFTE1(total)}>{fmtFTE1(total)}</div>
                              </>
                            )}
                          </div>
                        </div>
                      );
                    })}
                  </Fragment>
                );
              })}
            </div>
          </div>
        </div>
      );
    }

    /* ======================= PROJECTS PAGE (–∫–æ–º–∞–Ω–¥—ã –ø—Ä–æ–µ–∫—Ç–æ–≤) ======================= */
    function ProjectsPage({projects, setProjects, people, projectTeams, setProjectTeams, roles, setRoles, roleFilter, setRoleFilter, setPeople}){
      const [dragIndex, setDragIndex] = useState(null);
      const onDragStart = (i)=> setDragIndex(i);
      const onDrop = (i)=> {
        if(dragIndex==null || dragIndex===i) return;
        setProjects(prev => { const arr=[...prev]; const [m]=arr.splice(dragIndex,1); arr.splice(i,0,m); return arr; });
        setDragIndex(null);
      };

      const [search, setSearch] = useState("");
      const peopleActiveAll = useMemo(()=> people.filter(p=>p.active), [people]);

      const addToTeam = (prid, pid)=>{
        setProjectTeams(prev=>{
          const copy={}; Object.entries(prev).forEach(([k,v])=> (copy[k]=new Set(v)));
          (copy[prid]=copy[prid]||new Set()).add(pid);
          return copy;
        });
      };
      const removeFromTeam = (prid, pid)=>{
        setProjectTeams(prev=>{
          const copy={}; Object.entries(prev).forEach(([k,v])=> (copy[k]=new Set(v)));
          copy[prid]?.delete(pid);
          return copy;
        });
      };

      return (
        <div className="max-w-screen-2xl mx-auto px-4 py-4 space-y-3">
          <RoleManager roles={roles} setRoles={setRoles} setRoleFilter={setRoleFilter} people={people} setPeople={setPeople}/>
          <div className="grid" style={{gridTemplateColumns:`300px 1fr`}}>
            {projects.map((pr, idx)=>(
              <Fragment key={pr.id}>
                <div className="sticky left-0 z-40 bg-[#F7F8FA] border-r border-neutral-200 p-1"
                     draggable onDragStart={()=>onDragStart(idx)} onDragOver={(e)=>e.preventDefault()} onDrop={()=>onDrop(idx)}>
                  <div className="relative card p-3 min-w-0 h-[120px] flex items-center gap-3 cursor-grab active:cursor-grabbing">
                    <button className="w-6 h-6 rounded-lg" style={{background:pr.color}} title="–¶–≤–µ—Ç/—Å—Ç–∞—Ç—É—Å"
                            onClick={()=> setProjects(prev => prev.map(p => p.id===pr.id ? {...p, status:(p.status==="active"?"onhold": p.status==="onhold"?"done": p.status==="done"?"planned":"active")} : p))}/>
                    <div className="font-medium truncate" title={pr.name}>{pr.name}</div>
                    <input type="color" className="absolute right-10 top-2 w-7 h-7 opacity-60 hover:opacity-100"
                           value={pr.color} onChange={e=> setProjects(prev => prev.map(p => p.id===pr.id ? {...p, color:e.target.value} : p))}/>
                    <button className="absolute right-2 top-2 btn" onClick={()=>{
                      if(!confirm("–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç?")) return;
                      setProjects(prev=> prev.filter(x=>x.id!==pr.id));
                      setProjectTeams(prev=>{ const copy={}; Object.entries(prev).forEach(([k,v])=>{ if(k!==pr.id) copy[k]=new Set(v); }); return copy; });
                    }}>–£–¥–∞–ª–∏—Ç—å</button>
                  </div>
                </div>
                <div className="border border-neutral-200 p-3">
                  <div className="card p-3">
                    <input className="w-full px-3 py-2 border border-neutral-300 rounded-xl bg-white"
                           placeholder="–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞‚Ä¶" value={search} onChange={e=>setSearch(e.target.value)} />
                    {search && (
                      <div className="mt-2 border border-neutral-200 rounded-xl overflow-hidden">
                        {peopleActiveAll.filter(p => p.name.toLowerCase().includes(search.toLowerCase()) && !(projectTeams[pr.id]?.has(p.id))).slice(0,8).map(p=>(
                          <button key={p.id} className="w-full text-left px-3 py-2 hover:bg-green-50"
                                  onClick={()=>{ addToTeam(pr.id, p.id); setSearch(""); }}>
                            {p.name} <span className="text-[10px] text-neutral-500">{String(p.role).toUpperCase()}</span> {p.external && <span className="ml-1 text-[10px] text-amber-700">(–≤–Ω–µ—à–Ω.)</span>}
                          </button>
                        ))}
                        {peopleActiveAll.filter(p => p.name.toLowerCase().includes(search.toLowerCase()) && !(projectTeams[pr.id]?.has(p.id))).length===0 && (
                          <div className="px-3 py-2 text-xs text-neutral-500">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</div>
                        )}
                      </div>
                    )}
                    <div className="mt-3 flex flex-wrap gap-2">
                      {Array.from(projectTeams[pr.id]||new Set()).map(pid=>{
                        const p = people.find(x=>x.id===pid); if(!p) return null;
                        return (
                          <span key={pid} className="tag inline-flex items-center gap-1">
                            {p.name}{p.external && <span className="ml-1 text-amber-700">(–≤–Ω–µ—à–Ω.)</span>}
                            <button className="ml-1 text-neutral-500 hover:text-red-600" onClick={()=>removeFromTeam(pr.id, pid)}>√ó</button>
                          </span>
                        );
                      })}
                    </div>
                  </div>
                </div>
              </Fragment>
            ))}
          </div>
        </div>
      );
    }

    /* ======================= TEAM PAGE (—Å–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤) ======================= */
    function TeamPage({people, setPeople, projects, projectTeams, setProjectTeams}){
      const [q,setQ]=useState("");
      const list = useMemo(()=> people.filter(p => p.active && p.name.toLowerCase().includes(q.toLowerCase())), [people, q]);

      const removeFromAllProjects = (pid)=>{
        setProjectTeams(prev => {
          const copy={}; Object.entries(prev).forEach(([k,v])=> (copy[k]=new Set(v)));
          Object.keys(copy).forEach(k=> copy[k].delete(pid));
          return copy;
        });
      };

      return (
        <div className="max-w-screen-2xl mx-auto px-4 py-6 space-y-3">
          <input className="w-full px-3 py-2 border border-neutral-300 rounded-xl bg-white"
                 placeholder="–ù–∞–π—Ç–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞‚Ä¶" value={q} onChange={e=>setQ(e.target.value)} />
          <div className="grid" style={{gridTemplateColumns:`300px 1fr`}}>
            {list.map(p=>(
              <Fragment key={p.id}>
                <div className="sticky left-0 z-40 bg-[#F7F8FA] border-r border-neutral-200 p-1">
                  <div className="card p-3 min-w-0 h-[120px] flex flex-col justify-center">
                    <div className="flex items-center gap-2">
                      <span className="font-medium truncate">{p.name}</span>
                      <button className="text-neutral-500 hover:text-red-600 ml-auto" title="–£–¥–∞–ª–∏—Ç—å"
                              onClick={()=>{
                                if(!confirm("–£–¥–∞–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞?")) return;
                                setPeople(prev => prev.filter(x=>x.id!==p.id));
                                removeFromAllProjects(p.id);
                              }}>üóë</button>
                    </div>
                    <div className="mt-2 flex items-center gap-2">
                      <select value={p.role||"other"} onChange={e=> setPeople(prev => prev.map(x => x.id===p.id ? {...x, role:e.target.value} : x))}
                              className="text-[12px] px-2 py-1 rounded-full bg-neutral-100 border border-neutral-200">
                        {["designer","dev","manager","pm","other"].map(r => (<option key={r} value={r}>{r.toUpperCase()}</option>))}
                      </select>
                      <label className="text-xs flex items-center gap-1 ml-2">
                        <input type="checkbox" checked={!!p.external} onChange={e=> setPeople(prev => prev.map(x => x.id===p.id ? {...x, external:e.target.checked} : x))}/>
                        –í–Ω–µ—à–Ω–∏–π
                      </label>
                    </div>
                    <div className="mt-1 text-[11px] text-neutral-500">ID: {p.id.slice(0,6)}‚Ä¶</div>
                  </div>
                </div>
                <div className="border border-neutral-200 p-3">
                  <div className="card p-3">
                    <PersonProjectsEditor person={p} projects={projects} projectTeams={projectTeams} setProjectTeams={setProjectTeams}/>
                  </div>
                </div>
              </Fragment>
            ))}
          </div>
        </div>
      );
    }

    function PersonProjectsEditor({person, projects, projectTeams, setProjectTeams}){
      const [search, setSearch] = useState("");
      const memberOf = useMemo(()=>{
        const ids = [];
        for(const pr of projects) if(projectTeams[pr.id]?.has(person.id)) ids.push(pr.id);
        return new Set(ids);
      }, [projects, projectTeams, person.id]);

      const pool = useMemo(()=> projects.filter(pr => !memberOf.has(pr.id) && pr.name.toLowerCase().includes(search.toLowerCase())).slice(0,8), [projects, memberOf, search]);

      const add = (prid) => setProjectTeams(prev => { const copy={}; Object.entries(prev).forEach(([k,v])=> (copy[k]=new Set(v))); (copy[prid]=copy[prid]||new Set()).add(person.id); return copy; });
      const remove = (prid) => setProjectTeams(prev => { const copy={}; Object.entries(prev).forEach(([k,v])=> (copy[k]=new Set(v))); copy[prid]?.delete(person.id); return copy; });

      return (
        <div>
          <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç..." className="w-full max-w-sm border border-neutral-300 rounded-xl px-3 py-2 text-sm outline-none"/>
          {search && (
            <div className="mt-2 border border-neutral-200 rounded-xl overflow-hidden">
              {pool.length>0 ? pool.map(pr => (
                <button key={pr.id} className="w-full text-left px-3 py-2 hover:bg-green-50" onClick={()=>{ add(pr.id); setSearch(""); }}>
                  <span className="inline-flex items-center gap-2">
                    <span className="w-3 h-3 rounded" style={{background:pr.color}}></span>
                    {pr.name}
                  </span>
                </button>
              )) : <div className="px-3 py-2 text-xs text-neutral-500">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</div>}
            </div>
          )}

          <div className="mt-3 flex flex-wrap gap-2">
            {Array.from(memberOf).map(prid => {
              const pr = projects.find(p=>p.id===prid); if(!pr) return null;
              return (
                <span key={prid} className="inline-flex items-center gap-2 px-2 py-1 rounded-full text-xs bg-blue-50 text-blue-800 border border-blue-200">
                  <span className="w-3 h-3 rounded" style={{background:pr.color}}></span>
                  {pr.name}
                  <button className="ml-1 text-blue-700/70 hover:text-blue-900" onClick={()=>remove(prid)}>√ó</button>
                </span>
              );
            })}
          </div>
        </div>
      );
    }

    /* ======================= PERSON PAGE ======================= */
    function PersonPage({ personId, back, people, setPeople, projects, assignments, setAssignments, vacations, setVacations, projectTeams, visible, setView }){
      const person = people.find(p=>p.id===personId);
      const {goLeft, goRight, goToday} = useWeeksWindow();
      const gridCols = `var(--left-col-w) repeat(${visible.length}, ${WEEK_COL_PX}px)`;

      const myProjects = useMemo(()=>{
        const ids = new Set();
        assignments.forEach(a => { if(a.personId===person.id) ids.add(a.projectId); });
        Object.entries(projectTeams).forEach(([pr,set])=>{ if(set.has(person.id)) ids.add(pr); });
        return projects.filter(pr => ids.has(pr.id));
      }, [projects, projectTeams, assignments, person.id]);

      const [order, setOrder] = useState(lget("personProjectOrder", {})[person.id] || myProjects.map(p=>p.id));
      useEffect(()=>{
        const merged = mergeOrder(order, myProjects.map(p=>p.id));
        setOrder(merged);
      }, [myProjects]);
      useEffect(()=>{
        const all = lget("personProjectOrder", {});
        saveAll({personProjectOrder:{...all, [person.id]: order}});
      }, [order, person.id]);

      const totals = visible.map(w => (vacations[person.id]?.has?.(w) ? 0 : assignments.filter(a=>a.personId===person.id && a.weekStart===w).reduce((s,a)=>s+a.fte,0)));
      const badgeByISO = {}; visible.forEach((w,i)=> badgeByISO[w] = `Œ£ ${fmtFTE2(totals[i])}`);

      const [editKey, setEditKey] = useState(null);
      const [editVal, setEditVal] = useState("");
      const beginEdit = (pid, w, cur)=>{ if(vacations[person.id]?.has?.(w)) return; setEditKey(`${pid}|${w}`); setEditVal(fmtFTE1(cur||0)); };
      const commitEdit = (pid, w)=>{
        const k=`${pid}|${w}`; if(editKey!==k) return;
        const next = parseFloat((editVal||"").replace(",", "."));
        setEditKey(null);
        if(isNaN(next) || next<0 || next>MAX_FTE) return;
        setAssignments(prev => { const rest = prev.filter(a => !(a.personId===person.id && a.projectId===pid && a.weekStart===w)); return [...rest, { id:rndId(), personId:person.id, projectId:pid, weekStart:w, fte:next }]; });
      };

      const [vacOpen, setVacOpen] = useState(false);
      const [personVac, setPersonVac] = useState(()=> new Set(vacations[person.id] || []));
      const [vacTab, setVacTab] = useState("range");
      const [vFrom, setVFrom] = useState("");
      const [vTo, setVTo] = useState("");
      useEffect(()=>{ setPersonVac(new Set(vacations[person.id] || [])); }, [person.id, vacations]);
      const saveVac = () => {
        let setToSave = new Set(personVac);
        if(vFrom && vTo){
          const d1=new Date(vFrom), d2=new Date(vTo);
          if(!(isNaN(d1) || isNaN(d2) || d1>d2)){
            let m1=startOfISOWeek(d1); const m2=startOfISOWeek(d2);
            while(m1<=m2){ setToSave.add(iso(m1)); m1=addDays(m1,7); }
          }
        }
        setVacations(prev => { const c={}; Object.entries(prev).forEach(([k,v])=> (c[k]=new Set(v))); c[person.id]=setToSave; return c; });
        setAssignments(prev => prev.filter(a => !(a.personId===person.id && setToSave.has(a.weekStart))));
        setVacOpen(false);
      };
      const clearVacationWeek = (week) => setVacations(prev => { const c={}; Object.entries(prev).forEach(([k,v])=> (c[k]=new Set(v))); const s=new Set(c[person.id]||[]); s.delete(week); c[person.id]=s; return c; });

      const dragIndex = useRef(null);
      const onDragStart = (i)=>{ dragIndex.current=i; };
      const onDrop = (i)=>{ const from=dragIndex.current; dragIndex.current=null; if(from==null || from===i) return; const arr=[...order]; const [moved]=arr.splice(from,1); arr.splice(i,0,moved); setOrder(arr); };

      return (
        <div className="pb-24">
          <WeekNavigator onLeft={goLeft} onRight={goRight} onToday={goToday} showToday
            leftNode={<div className="flex items-center gap-2">
              <button className="btn" onClick={back}>‚Üê –ù–∞–∑–∞–¥</button>
              <EditableName person={person} setPeople={setPeople}/>
              <EditableRole person={person} setPeople={setPeople}/>
              <button className="inline-flex items-center gap-1 text-sm px-2 py-1 rounded-lg border border-amber-300 bg-amber-50 text-amber-800"
                      onClick={()=>setVacOpen(true)}>üèñ –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—É—Å–∫</button>
            </div>}
          />
          <div className="max-w-screen-2xl mx-auto px-4">
            <CalendarHeader visibleWeeks={visible} leftLabel="–ü—Ä–æ–µ–∫—Ç—ã" badgeByISO={badgeByISO}/>
            <div className="grid pb-4" style={{gridTemplateColumns:gridCols}}>
              {order.map((pid, idx)=>{
                const pr = projects.find(p=>p.id===pid); if(!pr) return null;
                return (
                  <Fragment key={pid}>
                    <div className="sticky left-0 z-20 bg-[#F7F8FA] border-r border-neutral-200 p-1"
                         draggable onDragStart={()=>onDragStart(idx)} onDragOver={(e)=>e.preventDefault()} onDrop={()=>onDrop(idx)}>
                      <div className="card h-[var(--row-h)] flex items-center gap-2 pl-5 pr-3 cursor-grab active:cursor-grabbing select-none">
                        <span className="text-neutral-400">‚ãÆ‚ãÆ</span>
                        <div className="w-6 h-6 rounded-lg" style={{background:pr.color}} title="–¶–≤–µ—Ç –ø—Ä–æ–µ–∫—Ç–∞"></div>
                        <div className="font-medium truncate" title={pr.name}>{pr.name}</div>
                      </div>
                    </div>
                    {visible.map(week=>{
                      const fte = fteFor(assignments, person.id, pid, week);
                      const ratio = clamp(fte/MAX_FTE,0,1);
                      const vac = vacations[person.id]?.has?.(week);
                      const k=`${pid}|${week}`;
                      const editing = editKey===k;
                      return (
                        <div key={pid+week} className="p-1">
                          <div className="card h-[var(--row-h)] flex items-end justify-center relative">
                            <div className="relative w-10 h-[92%] rounded-lg bg-neutral-200 overflow-hidden">
                              {!vac && <div className="absolute bottom-0 left-0 right-0" style={{height:`${ratio*100}%`, background:pr.color}}/>}
                            </div>
                            {!vac ? (!editing ? (
                              <button className="absolute inset-0 text-sm font-semibold text-neutral-800 flex items-center justify-center" title={fmtFTE1(fte)} onClick={()=>beginEdit(pid, week, fte)}>{fmtFTE1(fte)}</button>
                            ) : (
                              <input autoFocus inputMode="decimal"
                                     className="absolute inset-0 m-auto h-8 w-16 text-center text-sm font-semibold border border-neutral-300 rounded-md bg-white shadow-sm"
                                     value={editVal}
                                     onChange={e=>setEditVal(e.target.value)}
                                     onBlur={()=>commitEdit(pid, week)}
                                     onKeyDown={(e)=>{ if(e.key==="Enter") e.currentTarget.blur(); if(e.key==="Escape") setEditKey(null); }}/>
                            )) : (
                              <button className="absolute inset-0 flex items-center justify-center text-2xl" onClick={()=>clearVacationWeek(week)} title="–°–Ω—è—Ç—å –æ—Ç–ø—É—Å–∫">üèñ</button>
                            )}
                          </div>
                        </div>
                      );
                    })}
                  </Fragment>
                );
              })}
            </div>
          </div>

          {vacOpen && (
            <div className="fixed inset-0 z-50 flex items-center justify-center" onClick={()=>setVacOpen(false)}>
              <div className="absolute inset-0 bg-black/40"/>
              <div className="relative bg-white rounded-2xl shadow-xl border border-neutral-200 w-[720px] max-h-[80vh] overflow-auto p-4" onClick={(e)=>e.stopPropagation()}>
                <div className="text-base font-semibold mb-3">–û—Ç–ø—É—Å–∫ ‚Äî {person.name}</div>
                <div className="mb-3 inline-flex items-center gap-1 rounded-xl border border-neutral-200 p-1">
                  <button className={`px-3 py-1 rounded-lg text-sm ${vacTab==="range" ? "bg-neutral-100 shadow":""}`} onClick={()=>setVacTab("range")}>–î–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç</button>
                  <button className={`px-3 py-1 rounded-lg text-sm ${vacTab==="weeks" ? "bg-neutral-100 shadow":""}`} onClick={()=>setVacTab("weeks")}>–ü–æ –Ω–µ–¥–µ–ª—è–º</button>
                </div>
                {vacTab==="range" && (
                  <div className="space-y-3">
                    <div className="flex items-center gap-2">
                      <label className="text-sm text-neutral-700">–°</label>
                      <input type="date" value={vFrom} onChange={e=>setVFrom(e.target.value)} className="border border-neutral-300 rounded-lg px-2 py-1"/>
                      <label className="text-sm text-neutral-700">–ø–æ</label>
                      <input type="date" value={vTo} onChange={e=>setVTo(e.target.value)} className="border border-neutral-300 rounded-lg px-2 py-1"/>
                    </div>
                    {(vFrom && vTo) && (<div className="text-xs text-neutral-600">–ù–µ–¥–µ–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.</div>)}
                  </div>
                )}
                {vacTab==="weeks" && (
                  <div className="space-y-3">
                    <div className="text-sm text-neutral-600">–û—Ç–º–µ—Ç—å—Ç–µ –Ω–µ–¥–µ–ª–∏ (–¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç):</div>
                    <div className="grid grid-cols-3 gap-2">
                      {yearWeekMondays(new Date().getFullYear()).map(m => (
                        <label key={m} className="flex items-center gap-2 p-2 border border-neutral-200 rounded-xl hover:bg-amber-50">
                          <input type="checkbox" checked={personVac.has(m)} onChange={()=> setPersonVac(prev=>{ const s=new Set(prev); if(s.has(m)) s.delete(m); else s.add(m); return s; }) } />
                          <span className="text-sm">{weekRangeLabel(m)}</span>
                          {personVac.has(m) && (<button className="ml-auto text-amber-700" title="–£–±—Ä–∞—Ç—å" onClick={()=> setPersonVac(prev=>{ const s=new Set(prev); s.delete(m); return s; })}>‚àí</button>)}
                        </label>
                      ))}
                    </div>
                  </div>
                )}
                {Array.from(personVac).length>0 && (
                  <div className="mt-3">
                    <div className="text-sm mb-1">–í—ã–±—Ä–∞–Ω–æ –Ω–µ–¥–µ–ª—å:</div>
                    <div className="flex flex-wrap gap-2">
                      {Array.from(personVac).map(w => (
                        <span key={w} className="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs bg-blue-50 text-blue-800 border border-blue-200">
                          {weekRangeLabel(w)}
                          <button className="ml-1" title="–£–¥–∞–ª–∏—Ç—å" onClick={()=> setPersonVac(prev=>{ const s=new Set(prev); s.delete(w); return s; }) }>√ó</button>
                        </span>
                      ))}
                    </div>
                  </div>
                )}
                <div className="mt-4 flex justify-end gap-2">
                  <button className="btn" onClick={()=>setVacOpen(false)}>–û—Ç–º–µ–Ω–∞</button>
                  <button className="rounded-xl border border-amber-300 bg-amber-50 text-amber-800 px-3 py-1" onClick={saveVac}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    function EditableName({person, setPeople}){
      const [editing, setEditing] = useState(false);
      const [val, setVal] = useState(person.name);
      useEffect(()=> setVal(person.name), [person.id, person.name]);
      const commit = () => { const name=(val||"").trim(); setEditing(false); if(!name || name===person.name) return; setPeople(prev => prev.map(p => p.id===person.id ? {...p, name} : p)); };
      return editing ? (
        <input autoFocus value={val} onChange={e=>setVal(e.target.value)} onBlur={commit}
               onKeyDown={e=>{ if(e.key==="Enter") e.currentTarget.blur(); if(e.key==="Escape"){ setEditing(false); setVal(person.name);} }}
               className="text-lg font-semibold leading-tight border border-neutral-300 rounded-md px-2 py-0.5"/>
      ) : (
        <button className="text-lg font-semibold leading-tight hover:underline" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–º—è" onClick={()=>setEditing(true)}>{person.name}</button>
      );
    }
    function EditableRole({person, setPeople}){
      const [editing, setEditing] = useState(false);
      const [val, setVal] = useState(person.role || "other");
      useEffect(()=> setVal(person.role || "other"), [person.id, person.role]);
      const commit = ()=>{ const role = val || "other"; setEditing(false); if(role===person.role) return; setPeople(prev => prev.map(p => p.id===person.id ? {...p, role} : p)); };
      return editing ? (
        <select autoFocus value={val} onChange={e=>setVal(e.target.value)} onBlur={commit} className="text-[11px] px-2 py-0.5 rounded-full bg-neutral-100 border border-neutral-200">
          {["designer","dev","manager","pm","other"].map(r => (<option key={r} value={r}>{r.toUpperCase()}</option>))}
        </select>
      ) : (
        <button className="inline-flex items-center gap-1 text-[11px] px-2 py-0.5 rounded-full bg-neutral-100 border border-neutral-200 text-neutral-700" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–æ–ª–∂–Ω–æ—Å—Ç—å" onClick={()=>setEditing(true)}>
          {(person.role||"OTHER").toUpperCase()}
        </button>
      );
    }

    /* ======================= MODALS: CREATE PERSON / PROJECT ======================= */
    function CreatePersonModal({open, onClose, onSubmit, roles}){
      const [name, setName] = useState("");
      const [role, setRole] = useState(roles[0]||"other");
      const [external, setExternal] = useState(false);
      if(!open) return null;
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center" onClick={onClose}>
          <div className="absolute inset-0 bg-black/40"/>
          <div className="relative bg-white rounded-2xl shadow-xl border border-neutral-200 w-[460px] p-4" onClick={(e)=>e.stopPropagation()}>
            <div className="text-base font-semibold mb-3">–ù–æ–≤—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫</div>
            <div className="space-y-3">
              <div>
                <label className="block text-sm mb-1">–ò–º—è</label>
                <input value={name} onChange={e=>setName(e.target.value)} className="w-full border border-neutral-300 rounded-lg px-3 py-2"/>
              </div>
              <div>
                <label className="block text-sm mb-1">–†–æ–ª—å</label>
                <select value={role} onChange={e=>setRole(e.target.value)} className="w-full border border-neutral-300 rounded-lg px-3 py-2">
                  {roles.map(r => (<option key={r} value={r}>{r}</option>))}
                </select>
              </div>
              <label className="flex items-center gap-2 text-sm">
                <input type="checkbox" checked={external} onChange={e=>setExternal(e.target.checked)} />
                –í–Ω–µ—à–Ω–∏–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ (–Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤–æ ¬´–ù–∞–≥—Ä—É–∑–∫–∞¬ª)
              </label>
            </div>
            <div className="mt-4 flex justify-end gap-2">
              <button className="btn" onClick={onClose}>–û—Ç–º–µ–Ω–∞</button>
              <button className="rounded-xl border border-green-300 bg-green-50 text-green-800 px-3 py-1" onClick={()=>{ onSubmit({name, role, external}); onClose(); }}>–°–æ–∑–¥–∞—Ç—å</button>
            </div>
          </div>
        </div>
      );
    }

    function CreateProjectModal({open, onClose, onSubmit, people}){
      const [name, setName] = useState("");
      const [color, setColor] = useState("#16a34a");
      const [status, setStatus] = useState("active");
      const [search, setSearch] = useState("");
      const [teamSel, setTeamSel] = useState(new Set());
      const suggestions = useMemo(()=> people.filter(p => p.active && p.name.toLowerCase().includes(search.toLowerCase()) && !teamSel.has(p.id)).slice(0,8), [people, search, teamSel]);

      if(!open) return null;
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center" onClick={onClose}>
          <div className="absolute inset-0 bg-black/40"/>
          <div className="relative bg-white rounded-2xl shadow-xl border border-neutral-200 w-[560px] max-h-[80vh] overflow-auto p-4" onClick={(e)=>e.stopPropagation()}>
            <div className="text-base font-semibold mb-3">–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</div>
            <div className="grid grid-cols-2 gap-3">
              <div>
                <label className="block text-sm mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input value={name} onChange={e=>setName(e.target.value)} className="w-full border border-neutral-300 rounded-lg px-3 py-2"/>
              </div>
              <div>
                <label className="block text-sm mb-1">–°—Ç–∞—Ç—É—Å</label>
                <select value={status} onChange={e=>setStatus(e.target.value)} className="w-full border border-neutral-300 rounded-lg px-3 py-2">
                  <option value="active">active</option>
                  <option value="onhold">onhold</option>
                  <option value="done">done</option>
                  <option value="planned">planned</option>
                </select>
              </div>
              <div>
                <label className="block text-sm mb-1">–¶–≤–µ—Ç</label>
                <input type="color" value={color} onChange={e=>setColor(e.target.value)} className="w-16 h-10 p-0 border border-neutral-300 rounded-lg"/>
              </div>
            </div>

            <div className="mt-4">
              <div className="text-sm font-medium mb-2">–ö–æ–º–∞–Ω–¥–∞</div>
              <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞..." className="w-full border border-neutral-300 rounded-xl px-3 py-2 text-sm outline-none"/>
              {search && (
                <div className="my-2 border border-neutral-200 rounded-xl overflow-hidden">
                  {suggestions.length>0 ? suggestions.map(s => (
                    <button key={s.id} className="w-full text-left px-3 py-2 hover:bg-green-50" onClick={()=>{ const c=new Set(teamSel); c.add(s.id); setTeamSel(c); setSearch(""); }}>
                      {s.name} <span className="text-[10px] text-neutral-500">{String(s.role).toUpperCase()}</span> {s.external && <span className="ml-1 text-[10px] text-amber-700">–≤–Ω–µ—à–Ω.</span>}
                    </button>
                  )) : <div className="px-3 py-2 text-xs text-neutral-500">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</div>}
                </div>
              )}
              <div className="flex flex-wrap gap-2">
                {Array.from(teamSel).map(pid => { const p = people.find(x=>x.id===pid); if(!p) return null; return (
                  <span key={pid} className="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs bg-blue-50 text-blue-800 border border-blue-200">
                    {p.name}{p.external && <span className="ml-1 text-amber-700">(–≤–Ω–µ—à–Ω.)</span>}
                    <button className="ml-1 text-blue-700/70 hover:text-blue-900" onClick={()=>{ const c=new Set(teamSel); c.delete(pid); setTeamSel(c); }}>√ó</button>
                  </span>
                );})}
              </div>
            </div>

            <div className="mt-4 flex justify-end gap-2">
              <button className="btn" onClick={onClose}>–û—Ç–º–µ–Ω–∞</button>
              <button className="rounded-xl border border-green-300 bg-green-50 text-green-800 px-3 py-1" onClick={()=>{ onSubmit({name, color, status, teamSel}); onClose(); }}>–°–æ–∑–¥–∞—Ç—å</button>
            </div>
          </div>
        </div>
      );
    }

    /* ======================= AUTH (–∏–∑ Index3) ======================= */
    function AuthView({onSuccess}){
      const [login, setLogin] = useState("");
      const [pass, setPass] = useState("");
      const [remember, setRemember] = useState(false);
      const submit = (e)=>{ e.preventDefault(); if(login.trim().toLowerCase()==="–ø–∞–Ω–∫–≤–µ–±" && pass==="123455"){ onSuccess(remember); } else { alert("–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"); } };
      return (
        <div className="min-h-screen grid place-items-center bg-[#F7F8FA]">
          <div className="bg-white w-[360px] rounded-2xl shadow-lg border border-neutral-200 p-5">
            <div className="text-center mb-4"><div className="text-2xl font-semibold">–í—Ö–æ–¥</div></div>
            <form onSubmit={submit} className="space-y-3">
              <div>
                <label className="block text-sm mb-1">–õ–æ–≥–∏–Ω</label>
                <input value={login} onChange={e=>setLogin(e.target.value)} className="w-full border border-neutral-300 rounded-lg px-3 py-2"/>
              </div>
              <div>
                <label className="block text-sm mb-1">–ü–∞—Ä–æ–ª—å</label>
                <input type="password" value={pass} onChange={e=>setPass(e.target.value)} className="w-full border border-neutral-300 rounded-lg px-3 py-2"/>
              </div>
              <label className="flex items-center gap-2 text-sm select-none">
                <input type="checkbox" checked={remember} onChange={e=>setRemember(e.target.checked)} />
                –ó–∞–ø–æ–º–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
              </label>
              <button className="w-full rounded-xl border border-green-300 bg-green-50 text-green-800 py-2">–í–æ–π—Ç–∏</button>
            </form>
          </div>
        </div>
      );
    }

    /* ======================= APP ROOT ======================= */
    function App(){
      const [authed, setAuthed] = useState(lget("authed", false));

      const [tab, setTab] = useState(lget("view", "load")); // load | projects | team | person
      useEffect(()=> saveAll({view:tab}), [tab]);

      const [people, setPeople] = useState(lget("people", seedPeople));
      const [projects, setProjects] = useState(lget("projects", seedProjects));
      const [assignments, setAssignments] = useState(lget("assignments", seedAssignments));
      const [roles, setRoles] = useState(lget("roles", [...seedRoles]));
      const [projectTeams, setProjectTeams] = useState(()=>{
        const saved = lget("projectTeams", {});
        const map = {};
        Object.keys(saved).forEach(k => (map[k]=new Set(saved[k])));
        if(Object.keys(map).length===0){
          for(const p of seedProjects) map[p.id]=new Set();
          for(const a of seedAssignments) (map[a.projectId] = map[a.projectId] || new Set()).add(a.personId);
        }
        return map;
      });
      const [vacations, setVacations] = useState(()=>{
        const saved = lget("vacations", {});
        const map = {}; Object.keys(saved).forEach(k => (map[k] = new Set(saved[k])));
        return map;
      });

      // —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
      useEffect(()=> saveAll({people}), [people]);
      useEffect(()=> saveAll({projects}), [projects]);
      useEffect(()=> saveAll({assignments}), [assignments]);
      useEffect(()=> saveAll({roles}), [roles]);
      useEffect(()=>{ const obj={}; Object.entries(projectTeams).forEach(([k,v])=> obj[k]=Array.from(v)); saveAll({projectTeams:obj}); }, [projectTeams]);
      useEffect(()=>{ const obj={}; Object.entries(vacations).forEach(([k,v])=> obj[k]=Array.from(v)); saveAll({vacations:obj}); }, [vacations]);

      const {weeks, setWeeks, visible, goLeft, goRight, goToday} = useWeeksWindow();

      const [roleFilter, setRoleFilter] = useState(lget("roleFilter","all"));
      useEffect(()=> saveAll({roleFilter}), [roleFilter]);

      const [personId, setPersonId] = useState(null);

      const openPerson = (id)=>{ setPersonId(id); setTab("person"); };
      const backFromPerson = ()=>{ setTab("load"); setPersonId(null); };

      const [createPersonOpen, setCreatePersonOpen] = useState(false);
      const [createProjectOpen, setCreateProjectOpen] = useState(false);

      const onAddPerson = ({name, role, external})=>{
        if(!name) return;
        const id = rndId();
        setPeople(prev => [...prev, {id, name, role:role||"other", capacityPerWeek:1, active:true, external: !!external }]);
      };
      const onAddProject = ({name, color, status, teamSel})=>{
        if(!name) return;
        const id = rndId();
        setProjects(prev => [...prev, {id, name, color: color||"#16a34a", status: status||"active"}]);
        setProjectTeams(prev => { const copy={}; Object.entries(prev).forEach(([k,v])=> (copy[k]=new Set(v))); copy[id] = new Set(teamSel||[]); return copy; });
      };

      if(!authed){
        return <AuthView onSuccess={(remember)=>{ if(remember){ saveAll({authed:true, remember:true}); } else { saveAll({remember:false, authed:false}); } setAuthed(true); }}/>;
      }

      let page=null;
      if(tab==="load"){
        page = (
          <LoadPage
            people={people} setPeople={setPeople}
            projects={projects}
            assignments={assignments}
            vacations={vacations}
            visible={visible}
            openPerson={openPerson}
            roleFilter={roleFilter} setRoleFilter={setRoleFilter} roles={roles}
          />
        );
      } else if(tab==="projects"){
        page = (
          <ProjectsPage
            projects={projects} setProjects={setProjects}
            people={people}
            projectTeams={projectTeams} setProjectTeams={setProjectTeams}
            roles={roles} setRoles={setRoles}
            roleFilter={roleFilter} setRoleFilter={setRoleFilter}
            setPeople={setPeople}
          />
        );
      } else if(tab==="team"){
        page = <TeamPage people={people} setPeople={setPeople} projects={projects} projectTeams={projectTeams} setProjectTeams={setProjectTeams} />;
      } else if(tab==="person" && personId){
        page = (
          <PersonPage
            personId={personId} back={backFromPerson}
            people={people} setPeople={setPeople}
            projects={projects}
            assignments={assignments} setAssignments={setAssignments}
            vacations={vacations} setVacations={setVacations}
            projectTeams={projectTeams}
            visible={visible}
            setView={setTab}
          />
        );
      }

      return (
        <div>
          <AppHeader tab={tab} setTab={setTab}
                     onAddProject={()=>setCreateProjectOpen(true)}
                     onAddPerson={()=>setCreatePersonOpen(true)} />
          {page}
          <CreatePersonModal open={createPersonOpen} onClose={()=>setCreatePersonOpen(false)} onSubmit={onAddPerson} roles={roles}/>
          <CreateProjectModal open={createProjectOpen} onClose={()=>setCreateProjectOpen(false)} onSubmit={onAddProject} people={people}/>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
