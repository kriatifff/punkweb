<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Панквеб FTE Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --app-header-h:56px;
      --left-col-w:280px;
      --row-h:120px;
      --week-col:120px;
      --green:#16a34a; /* основной зелёный */
      --green-50:#ecfdf5;
      --green-600:#16a34a;
    }
    .btn{ padding:8px 12px; border-radius:12px; font-size:14px; font-weight:500; border:1px solid var(--green-600); color:#065f46; background:#fff; transition:.15s; }
    .btn:hover{ background:var(--green-50);}
    .nav-btn{ padding:8px 12px; border-radius:12px; font-size:14px; font-weight:700; transition:.15s; border:1px solid #d1d5db; background:#fff; color:#111827; }
    .nav-btn.active{ background:var(--green); color:#fff; border-color:var(--green);}
    .tag{ padding:2px 8px; border-radius:8px; font-size:12px; border:1px solid #e5e7eb; background:#fafafa; color:#374151; }
    .card{ background:#fff; border:1px solid #e5e7eb; border-radius:16px; box-shadow:0 1px 1px rgba(0,0,0,.03); }
    .cell-input{ outline:none; }
  </style>
</head>
<body class="bg-[#F7F8FA] text-neutral-900">
  <div id="root"></div>

  <!-- React/Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const {useState, useMemo, useEffect, Fragment} = React;

    /* ======================= HELPERS / STORAGE ======================= */
    const WEEK_COL_PX = 120;

    const loadJSON = (k, def) => { try{ const v=localStorage.getItem(k); if(v) return JSON.parse(v);}catch{} return def; };
    const saveJSON = (k,v) => { try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} };

    const startOfISOWeek = (d)=>{ const x=new Date(d); const day=x.getDay(); const diff=(day===0?-6:1-day); x.setDate(x.getDate()+diff); x.setHours(0,0,0,0); return x; };
    const addDays = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); x.setHours(0,0,0,0); return x; };
    const addWeeksISO = (iso, n)=> addDays(new Date(iso), n*7).toISOString();
    const weeksRange = (anchorISO, count=12)=>{ const a=startOfISOWeek(new Date(anchorISO)); const arr=[]; for(let i=0;i<count;i++){ const d=new Date(a); d.setDate(a.getDate()+i*7); arr.push(d.toISOString()); } return arr; };

    const RU_MONTHS = ["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"];
    const fmtFTE2 = (f)=> (Math.round((f||0)*100)/100).toFixed(2); // до сотых
    const clamp = (v,min,max)=> Math.max(min, Math.min(max, v));

    // нумерация недели внутри месяца (фикс для концов месяца)
    function weekIndexInMonth(weekISO){
      const w = startOfISOWeek(new Date(weekISO));
      const mStart = new Date(w.getFullYear(), w.getMonth(), 1);
      let first = startOfISOWeek(mStart);
      if(first.getMonth() !== mStart.getMonth()){ // если «ушёл» в прошлый месяц — сдвигаем
        const tmp = addDays(first, 7);
        if(tmp.getMonth() === mStart.getMonth()) first = tmp;
      }
      const diffDays = Math.floor((w - first)/(1000*60*60*24));
      const idx = Math.floor(diffDays/7) + 1;
      return idx < 1 ? 1 : idx;
    }

    /* ======================= INITIAL DATA (как в INDEX3) ======================= */
    const defaultPeople = [
      {id:"p1", name:"Саша К.", role:"manager", external:false, order:0},
      {id:"p2", name:"Аня П.", role:"frontend", external:false, order:1},
      {id:"p3", name:"Игорь С.", role:"backend", external:false, order:2},
      {id:"p4", name:"Лена М.", role:"qa", external:false, order:3},
    ];
    const defaultProjects = [
      {id:"pr1", name:"Маркетинг-сайт", color:"#16a34a", status:"active"},
      {id:"pr2", name:"ЛК Партнёра", color:"#059669", status:"active"},
      {id:"pr3", name:"Мобильное приложение", color:"#10b981", status:"paused"},
    ];
    // команды проекта (projectId -> Set(personId))
    const defaultTeams = {
      pr1:new Set(["p1","p2","p4"]),
      pr2:new Set(["p1","p3"]),
      pr3:new Set(["p2","p3"]),
    };
    // назначения: Map(`${personId}|${projectId}|${weekISO}`, number)
    const defaultAssignments = new Map();
    const defaultVacations = new Set();

    const anchor = startOfISOWeek(new Date());
    const initialWeeks = weeksRange(anchor.toISOString(), 12);
    for(const w of initialWeeks){
      defaultAssignments.set(`p2|pr1|${w}`, 0.60);
      defaultAssignments.set(`p4|pr1|${w}`, 0.40);
      defaultAssignments.set(`p3|pr2|${w}`, 0.70);
      defaultAssignments.set(`p2|pr3|${w}`, 0.30);
    }

    const mapLoad = (arr)=> new Map(arr);
    const setLoad = (arr)=> new Set(arr);
    const mapSave = (m)=> [...m.entries()];
    const setSave = (s)=> [...s.values()];

    /* ======================= ICONS ======================= */
    const StatusDot = ({status})=>{
      const color = status==="active" ? "bg-green-600" : status==="paused" ? "bg-yellow-500" : "bg-neutral-400";
      return <span className={`inline-block w-2.5 h-2.5 rounded-full ${color}`} title={status}></span>;
    };

    /* ======================= HEADER ======================= */
    function AppHeader({ tab, setTab, onAddProject, onAddPerson }){
      const NB = ({active, onClick, children}) =>
        <button className={`nav-btn ${active?"active":""}`} onClick={onClick}>{children}</button>;
      return (
        <header className="sticky top-0 z-50 bg-white/90 backdrop-blur border-b border-neutral-200">
          <div className="max-w-screen-2xl mx-auto px-4 h-[var(--app-header-h)] flex items-center justify-between gap-4">
            <div className="flex items-center gap-3">
              <div className="font-semibold tracking-wide mr-2 text-[var(--green)]">Панквеб FTE Planner</div>
              {/* три независимые кнопки без контейнера */}
              <div className="flex items-center gap-2">
                <NB active={tab==='load'} onClick={()=>setTab('load')}>Нагрузка</NB>
                <NB active={tab==='team'} onClick={()=>setTab('team')}>Команда</NB>
                <NB active={tab==='projects'} onClick={()=>setTab('projects')}>Проекты</NB>
              </div>
            </div>
            <div className="flex items-center gap-2">
              <button className="btn" onClick={onAddProject}>+ Проект</button>
              <button className="btn" onClick={onAddPerson}>+ Сотрудник</button>
            </div>
          </div>
        </header>
      );
    }

    /* ======================= CALENDAR HEADER ======================= */
    function CalendarHeader({visibleWeeks, leftLabel, stickyTopClass="top-[var(--app-header-h)]", badgeByISO=null}){
      // группы по годам
      const years=[]; let cy=null, c=0;
      visibleWeeks.forEach((iso,i)=>{ const y=new Date(iso).getFullYear();
        if(cy===null){ cy=y; c=1; } else if(y===cy){ c++; } else { years.push({year:cy,count:c}); cy=y; c=1; }
        if(i===visibleWeeks.length-1) years.push({year:cy,count:c});
      });
      // группы по месяцам
      const months=[]; let key=null, cnt=0, y0=null, m0=null;
      visibleWeeks.forEach((iso,i)=>{ const d=new Date(iso), y=d.getFullYear(), m=d.getMonth(), k=`${y}-${m}`;
        if(k!==key){ if(key!==null) months.push({key, year:y0, month:m0, count:cnt}); key=k; cnt=1; y0=y; m0=m; }
        else cnt++;
        if(i===visibleWeeks.length-1) months.push({key, year:y0, month:m0, count:cnt});
      });

      const gridCols = `var(--left-col-w) repeat(${visibleWeeks.length}, ${WEEK_COL_PX}px)`;
      return (
        <div className={`sticky ${stickyTopClass} z-40`}>
          <div className="grid" style={{gridTemplateColumns:gridCols, rowGap:'6px'}}>
            {/* левый лейбл */}
            <div className="sticky left-0 z-50 bg-[#F7F8FA] border-r border-neutral-200 p-1" style={{gridRow:"span 3 / span 3"}}>
              <div className="h-full rounded-2xl bg-white border border-neutral-200 shadow-sm flex items-center pl-5 text-sm text-neutral-700">
                {leftLabel}
              </div>
            </div>

            {/* Годы */}
            {years.map(g=>(
              <div key={`y-${g.year}`} style={{gridColumn:`span ${g.count}`}}>
                <div className="mx-1 rounded-xl px-3 py-1 text-center text-white text-sm font-medium bg-neutral-900">{g.year} г.</div>
              </div>
            ))}
            {/* Месяцы */}
            {months.map(g=>(
              <div key={g.key} style={{gridColumn:`span ${g.count}`}}>
                <div className="mx-1 rounded-xl px-3 py-1.5 text-center text-[13px] font-medium bg-neutral-100 text-neutral-800 border border-neutral-200">
                  {RU_MONTHS[g.month]}
                </div>
              </div>
            ))}
            {/* Недели — узкие плашки */}
            {visibleWeeks.map((iso)=>(
              <div key={`w-${iso}`} className="relative">
                <div className="mx-1 rounded-md px-2 py-1 text-center text-[12px] text-neutral-800 bg-white border border-neutral-200 shadow-sm">
                  Нед. {weekIndexInMonth(iso)}
                </div>
                {badgeByISO && badgeByISO[iso]!=null && (
                  <div className="absolute -right-1 -top-2 translate-x-1/2">
                    <span className="px-2 py-0.5 rounded-full text-[11px] font-bold border border-neutral-300 bg-neutral-50 text-neutral-800 shadow-sm">
                      {badgeByISO[iso]}
                    </span>
                  </div>
                )}
              </div>
            ))}
          </div>
        </div>
      );
    }

    /* ======================= WEEK NAV ======================= */
    function WeekNavigator({ onLeft, onRight, onToday, showToday=false, leftNode=null, stickyTopClass="top-[var(--app-header-h)]"}){
      return (
        <div className={`sticky ${stickyTopClass} z-30 bg-white/80 backdrop-blur border-b border-neutral-200`}>
          <div className="max-w-screen-2xl mx-auto px-4 h-[44px] flex items-center justify-between">
            <div className="flex items-center gap-2">{leftNode}</div>
            <div className="flex items-center gap-2">
              <button className="btn" onClick={onLeft} title="Назад">‹</button>
              {showToday && <button className="btn" onClick={onToday}>Сегодня</button>}
              <button className="btn" onClick={onRight} title="Вперёд">›</button>
            </div>
          </div>
        </div>
      );
    }

    /* ======================= ASSIGNMENTS ======================= */
    const fteFor = (assignments, personId, projectId, weekISO)=> assignments.get(`${personId}|${projectId}|${weekISO}`) || 0;
    const setFteFor = (assignments, personId, projectId, weekISO, val)=>{
      const next = new Map(assignments);
      const k=`${personId}|${projectId}|${weekISO}`;
      const num = Math.max(0, Math.min(1, +val||0));
      if(num>0) next.set(k, +num); else next.delete(k);
      return next;
    };
    const totalFTEForPersonWeek = (assignments, personId, weekISO, projects)=>
      projects.reduce((s,pr)=> s + (assignments.get(`${personId}|${pr.id}|${weekISO}`)||0), 0);

    /* ======================= LOAD PAGE ======================= */
    function LoadPage({people, setPeople, projects, assignments, vacations, setAssignments, visible, setVisible, openPerson}){
      const goLeft = ()=> setVisible(prev => prev.map(w => addWeeksISO(w,-1)));
      const goRight= ()=> setVisible(prev => prev.map(w => addWeeksISO(w, 1)));
      const goToday= ()=> setVisible(weeksRange(startOfISOWeek(new Date()).toISOString(), visible.length));
      const gridCols = `var(--left-col-w) repeat(${visible.length}, ${WEEK_COL_PX}px)`;

      // перетаскивание сотрудников
      const [dragIdx, setDragIdx] = useState(null);
      const ordered = useMemo(()=> [...people].sort((a,b)=>(a.order??0)-(b.order??0)), [people]);
      const onDragStart = (i)=> setDragIdx(i);
      const onDrop = (i)=>{
        if(dragIdx==null || dragIdx===i) return;
        const arr=[...ordered];
        const [m] = arr.splice(dragIdx,1);
        arr.splice(i,0,m);
        const next = arr.map((p,idx)=> ({...p, order:idx}));
        setPeople(next);
        setDragIdx(null);
      };

      return (
        <div className="pb-24">
          <WeekNavigator onLeft={goLeft} onRight={goRight} onToday={goToday} showToday={false} />
          <div className="max-w-screen-2xl mx-auto px-4">
            <CalendarHeader visibleWeeks={visible} leftLabel="Сотрудники" />
            <div className="grid" style={{gridTemplateColumns:gridCols}}>
              {ordered.map((person, idx)=>(
                <Fragment key={person.id}>
                  {/* кликабельная/перетаскиваемая карточка сотрудника */}
                  <div className="sticky left-0 z-20 bg-[#F7F8FA] border-r border-neutral-200 p-1"
                       draggable onDragStart={()=>onDragStart(idx)} onDragOver={(e)=>e.preventDefault()} onDrop={()=>onDrop(idx)}
                       onClick={()=>openPerson(person.id)} role="button">
                    <div className="card h-[var(--row-h)] flex items-center justify-between pl-5 pr-3 hover:bg-neutral-50 transition">
                      <div className="min-w-0">
                        <div className="font-medium truncate">{person.name}</div>
                        <div className="text-[11px] text-neutral-600">{String(person.role||"").toUpperCase()} {person.external? "· ВНЕШНИЙ": ""}</div>
                      </div>
                      <span className="text-neutral-400">⋮⋮</span>
                    </div>
                  </div>
                  {/* бары по неделям (серый фон + зелёная заливка), число редактируется инлайн до сотых */}
                  {visible.map(week=>{
                    const total = totalFTEForPersonWeek(assignments, person.id, week, projects);
                    const vac = vacations.has(`${person.id}|${week}`);
                    return (
                      <div key={person.id+week} className="p-1">
                        <div className="card h-[var(--row-h)] flex items-end justify-center relative">
                          {vac ? (
                            <div className="absolute inset-0 flex items-center justify-center text-2xl">🏖</div>
                          ) : (
                            <>
                              <div className="relative w-10 h-[92%] rounded-lg bg-neutral-200 overflow-hidden">
                                {/* суммарная заливка (в зелёном) — визуальный индикатор общей загрузки */}
                                <div className="absolute bottom-0 left-0 right-0" style={{height:`${clamp(total,0,1)*100}%`, background:"var(--green)"}}></div>
                              </div>
                              <InlineEditNumber
                                value={fmtFTE2(total)}
                                onChange={(val)=>{
                                  // равномерно распределять не будем — total это агрегат; на нагрузке вводим total запрещаем,
                                  // редактирование делаем на странице сотрудника по конкретным проектам (как в INDEX3).
                                  // Поэтому здесь просто показываем значение без изменения.
                                }}
                                readOnly
                              />
                            </>
                          )}
                        </div>
                      </div>
                    );
                  })}
                </Fragment>
              ))}
            </div>
          </div>
        </div>
      );
    }

    /* ======================= TEAM PAGE ======================= */
    function TeamPage({people, setPeople}){
      const toggleExternal = (id)=>{
        setPeople(prev => prev.map(p => p.id===id ? {...p, external:!p.external} : p));
      };
      const editPerson = (id)=>{
        const p = people.find(x=>x.id===id);
        const name = prompt("Имя", p?.name||""); if(name===null) return;
        const role = prompt("Роль", p?.role||""); if(role===null) return;
        setPeople(prev => prev.map(x => x.id===id ? {...x, name, role} : x));
      };
      const removePerson = (id)=>{ if(!confirm("Удалить сотрудника?")) return; setPeople(prev => prev.filter(p=>p.id!==id)); };

      return (
        <div className="max-w-screen-2xl mx-auto px-4 py-6">
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
            {people.map(p=>(
              <div key={p.id} className="card p-4">
                <div className="flex items-center justify-between">
                  <div>
                    <div className="font-medium">{p.name}</div>
                    <div className="text-sm text-neutral-500">{(p.role||"other").toUpperCase()}</div>
                  </div>
                  <div className="flex items-center gap-2">
                    <button className="btn" onClick={()=>editPerson(p.id)}>Редактировать</button>
                    <button className="btn" onClick={()=>removePerson(p.id)}>Удалить</button>
                  </div>
                </div>
                <label className="mt-3 inline-flex items-center gap-2 text-sm text-neutral-700">
                  <input type="checkbox" checked={!!p.external} onChange={()=>toggleExternal(p.id)} />
                  Внешний сотрудник
                </label>
              </div>
            ))}
          </div>
        </div>
      );
    }

    /* ======================= PROJECTS PAGE ======================= */
    function ProjectsPage({projects, setProjects, people, teams, setTeams}){
      const setColor = (id, color)=> setProjects(prev => prev.map(p => p.id===id ? {...p, color} : p));
      const cycleStatus = (id)=>{
        setProjects(prev => prev.map(p=>{
          if(p.id!==id) return p;
          const order=["active","paused","done"];
          const i=order.indexOf(p.status); const nx=order[(i+1)%order.length];
          return {...p, status:nx};
        }));
      };
      const removeProject = (id)=>{ if(!confirm("Вы уверены, что хотите удалить проект?")) return;
        setProjects(prev => prev.filter(p=>p.id!==id));
        const t={...teams}; delete t[id]; setTeams(t);
      };

      const [q,setQ]=useState("");
      const filteredPeople = useMemo(
        ()=> people.filter(p => p.name.toLowerCase().includes(q.toLowerCase())).slice(0,10),
        [people,q]
      );

      const toggleMember = (prid, pid)=>{
        const cur = teams[prid] || new Set();
        const next = {...teams, [prid]:new Set(cur)};
        if(next[prid].has(pid)) next[prid].delete(pid); else next[prid].add(pid);
        setTeams(next);
      };

      return (
        <div className="max-w-screen-2xl mx-auto px-4 py-6 grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
          {projects.map(pr=>(
            <div key={pr.id} className="card p-4">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <StatusDot status={pr.status}/>
                  <div className="font-medium">{pr.name}</div>
                </div>
                <button className="btn" onClick={()=>removeProject(pr.id)}>Удалить проект</button>
              </div>
              <div className="mt-3 flex items-center gap-3">
                <label className="text-sm text-neutral-700">Цвет:</label>
                <input type="color" value={pr.color} onChange={e=>setColor(pr.id, e.target.value)} />
                <button className="btn" onClick={()=>cycleStatus(pr.id)}>Сменить статус</button>
              </div>
              <div className="mt-4">
                <div className="text-sm text-neutral-700 mb-2">Добавить участников:</div>
                <input className="w-full px-3 py-2 border border-neutral-300 rounded-xl bg-white"
                       placeholder="Поиск по имени…" value={q} onChange={e=>setQ(e.target.value)} />
                <div className="mt-2 flex flex-wrap gap-2">
                  {filteredPeople.map(p=>{
                    const on = (teams[pr.id]||new Set()).has(p.id);
                    return (
                      <button key={p.id} className={"tag "+(on?"bg-green-50 border-green-600":"")} onClick={()=>toggleMember(pr.id, p.id)}>
                        {on?"✓ ":""}{p.name}
                      </button>
                    );
                  })}
                </div>
                <div className="mt-3 text-sm text-neutral-700">Участники проекта:</div>
                <div className="mt-1 flex flex-wrap gap-2">
                  {[...(teams[pr.id]||new Set())].map(pid=>{
                    const person = people.find(x=>x.id===pid); if(!person) return null;
                    return (
                      <span key={pid} className="tag">{person.name}</span>
                    );
                  })}
                </div>
              </div>
            </div>
          ))}
        </div>
      );
    }

    /* ======================= INLINE NUMBER EDIT ======================= */
    function InlineEditNumber({value, onChange, readOnly=false}){
      const [editing, setEditing] = useState(false);
      const [val, setVal] = useState(value);
      useEffect(()=>setVal(value),[value]);

      if(readOnly) return (
        <div className="absolute inset-0 flex items-center justify-center text-sm font-semibold text-neutral-800">
          {value}
        </div>
      );

      return editing ? (
        <input
          autoFocus
          className="absolute inset-0 m-auto h-8 w-16 text-center text-sm font-semibold border border-neutral-300 rounded-md bg-white shadow-sm cell-input"
          value={val}
          inputMode="decimal"
          onChange={e=>{
            // допускаем формат 0.05
            const t = e.target.value.replace(",",".");
            if(/^(\d+(\.\d{0,2})?)?$/.test(t)) setVal(t);
          }}
          onBlur={()=>{ onChange(val===""?0:parseFloat(val)); setEditing(false); }}
          onKeyDown={(e)=>{ if(e.key==="Enter") e.currentTarget.blur(); if(e.key==="Escape"){ setVal(value); setEditing(false);} }}
        />
      ) : (
        <button className="absolute inset-0 flex items-center justify-center text-sm font-semibold"
                onClick={()=>setEditing(true)}>{value}</button>
      );
    }

    /* ======================= PERSON PAGE ======================= */
    function PersonPage({ personId, back, people, projects, teams, assignments, setAssignments, vacations, setVacations, visible, setVisible }){
      const person = people.find(p=>p.id===personId);
      const goLeft = ()=> setVisible(prev => prev.map(w => addWeeksISO(w,-1)));
      const goRight= ()=> setVisible(prev => prev.map(w => addWeeksISO(w, 1)));
      const goToday= ()=> setVisible(weeksRange(startOfISOWeek(new Date()).toISOString(), visible.length));
      const gridCols = `var(--left-col-w) repeat(${visible.length}, ${WEEK_COL_PX}px)`;

      // только проекты, где участвует сотрудник
      const myProjects = useMemo(()=>{
        return projects.filter(pr => (teams[pr.id]||new Set()).has(personId));
      }, [projects, teams, personId]);

      const [order, setOrder] = useState(myProjects.map(p=>p.id));
      useEffect(()=> setOrder(myProjects.map(p=>p.id)), [myProjects]);

      // Σ FTE бейджи по неделям
      const totals = visible.map(w => totalFTEForPersonWeek(assignments, person.id, w, projects));
      const badgeByISO = {}; visible.forEach((w,i)=> badgeByISO[w] = `Σ ${fmtFTE2(totals[i])}`);

      const [dragIdx, setDragIdx] = useState(null);
      const onDragStart = (i)=> setDragIdx(i);
      const onDrop = (i)=>{
        if(dragIdx==null || dragIdx===i) return;
        const next=[...order]; const [m]=next.splice(dragIdx,1); next.splice(i,0,m); setOrder(next); setDragIdx(null);
      };

      const onEdit = (pid, weekISO, newVal)=>{
        const next = setFteFor(assignments, person.id, pid, weekISO, newVal);
        setAssignments(next);
      };

      const toggleVacation = (weekISO)=>{
        const key=`${person.id}|${weekISO}`;
        const next = new Set(vacations);
        if(next.has(key)) next.delete(key); else next.add(key);
        setVacations(next);
      };

      return (
        <div className="pb-24">
          <WeekNavigator onLeft={goLeft} onRight={goRight} onToday={goToday} showToday={false}
            leftNode={<div className="flex items-center gap-2"><button className="btn" onClick={back}>← Назад</button><div className="text-sm text-neutral-600">{person?.name}</div></div>} />
          <div className="max-w-screen-2xl mx-auto px-4">
            <CalendarHeader visibleWeeks={visible} leftLabel="Проекты" badgeByISO={badgeByISO}/>
            <div className="grid pb-4" style={{gridTemplateColumns:gridCols}}>
              {order.map((pid, idx)=>{
                const pr = projects.find(p=>p.id===pid); if(!pr) return null;
                return (
                  <Fragment key={pid}>
                    {/* проект слева — перетаскиваемый */}
                    <div className="sticky left-0 z-20 bg-[#F7F8FA] border-r border-neutral-200 p-1"
                         draggable onDragStart={()=>onDragStart(idx)} onDragOver={(e)=>e.preventDefault()} onDrop={()=>onDrop(idx)}>
                      <div className="card h-[var(--row-h)] flex items-center gap-2 pl-5 pr-3 cursor-grab active:cursor-grabbing select-none">
                        <span className="text-neutral-400">⋮⋮</span>
                        <div className="w-6 h-6 rounded-lg" style={{background:pr.color}} title="Цвет проекта"></div>
                        <div className="font-medium truncate" title={pr.name}>{pr.name}</div>
                      </div>
                    </div>
                    {/* клетки по неделям — серый фон + зелёная заливка проекта, инлайн редактирование до сотых */}
                    {visible.map(week=>{
                      const fte = fteFor(assignments, person.id, pid, week);
                      const vac = vacations.has(`${person.id}|${week}`);
                      const ratio = clamp(fte,0,1);
                      return (
                        <div key={pid+week} className="p-1">
                          <div className="card h-[var(--row-h)] flex items-end justify-center relative">
                            <div className="relative w-10 h-[92%] rounded-lg bg-neutral-200 overflow-hidden">
                              {!vac && <div className="absolute bottom-0 left-0 right-0" style={{height:`${ratio*100}%`, background:pr.color}}/>}
                            </div>
                            {!vac ? (
                              <InlineEditNumber value={fmtFTE2(fte)} onChange={(v)=>onEdit(pid, week, v)} />
                            ) : (
                              <button className="absolute inset-0 flex items-center justify-center text-2xl" onClick={()=>toggleVacation(week)}>🏖</button>
                            )}
                          </div>
                          {/* компактная Σ под клеткой для узких экранов */}
                          <div className="mt-1 text-center text-[11px] text-neutral-600 sm:hidden">{badgeByISO[week]}</div>
                        </div>
                      );
                    })}
                  </Fragment>
                );
              })}
            </div>
          </div>
        </div>
      );
    }

    /* ======================= APP ROOT ======================= */
    function App(){
      const [tab, setTab] = useState("load"); // load | team | projects | person
      const [people, setPeople] = useState(loadJSON("people", defaultPeople));
      const [projects, setProjects] = useState(loadJSON("projects", defaultProjects));
      const [teams, setTeams] = useState(()=>{
        const raw = loadJSON("teams", null);
        if(raw){ const obj={}; for(const k of Object.keys(raw)) obj[k]=new Set(raw[k]); return obj; }
        return defaultTeams;
      });
      const [assignments, setAssignments] = useState(()=>{
        const raw = loadJSON("assignments", null);
        return raw ? mapLoad(raw) : defaultAssignments;
      });
      const [vacations, setVacations] = useState(()=>{
        const raw = loadJSON("vacations", null);
        return raw ? setLoad(raw) : defaultVacations;
      });
      const [visible, setVisible] = useState(loadJSON("weeks", initialWeeks));
      const [personId, setPersonId] = useState(null);

      useEffect(()=>saveJSON("people", people), [people]);
      useEffect(()=>saveJSON("projects", projects), [projects]);
      useEffect(()=>{ const obj={}; for(const k of Object.keys(teams)) obj[k]=[...teams[k]]; saveJSON("teams", obj); }, [teams]);
      useEffect(()=>saveJSON("assignments", mapSave(assignments)), [assignments]);
      useEffect(()=>saveJSON("vacations", setSave(vacations)), [vacations]);
      useEffect(()=>saveJSON("weeks", visible), [visible]);

      const openPerson = (id)=>{ setPersonId(id); setTab("person"); };

      const onAddProject = ()=>{
        const name = prompt("Название проекта"); if(!name) return;
        const id = "pr" + Math.random().toString(36).slice(2,7);
        setProjects(prev => [...prev, {id, name, color:"#16a34a", status:"active"}]);
        setTeams(prev => ({...prev, [id]:new Set()}));
      };
      const onAddPerson = ()=>{
        const name = prompt("Имя сотрудника"); if(!name) return;
        const role = prompt("Роль (frontend/backend/manager/qa)","frontend") || "other";
        const id = "p" + Math.random().toString(36).slice(2,7);
        const maxOrder = people.reduce((m,p)=>Math.max(m, p.order??0), 0);
        setPeople(prev => [...prev, {id, name, role, external:false, order:maxOrder+1}]);
      };

      let page=null;
      if(tab==="load"){
        page = (
          <LoadPage
            people={people} setPeople={setPeople}
            projects={projects}
            assignments={assignments} vacations={vacations} setAssignments={setAssignments}
            visible={visible} setVisible={setVisible}
            openPerson={openPerson}
          />
        );
      } else if(tab==="team"){
        page = <TeamPage people={people} setPeople={setPeople} />;
      } else if(tab==="projects"){
        page = <ProjectsPage projects={projects} setProjects={setProjects} people={people} teams={teams} setTeams={setTeams} />;
      } else if(tab==="person"){
        page = (
          <PersonPage
            personId={personId} back={()=>setTab("load")}
            people={people} projects={projects} teams={teams}
            assignments={assignments} setAssignments={setAssignments}
            vacations={vacations} setVacations={setVacations}
            visible={visible} setVisible={setVisible}
          />
        );
      }

      return (
        <div>
          <AppHeader tab={tab} setTab={setTab} onAddProject={onAddProject} onAddPerson={onAddPerson}/>
          {page}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
