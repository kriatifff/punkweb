<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1,viewport-fit=cover"
  />
  <title>FTE Planner — Trello/Apple-like</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Tailwind design tokens
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'ui-sans-serif', 'system-ui', 'Segoe UI', 'Roboto'],
          },
          colors: {
            primary: {
              50: '#eef6ff',
              100: '#d9ebff',
              200: '#b6d7ff',
              300: '#8fc1ff',
              400: '#5ea4ff',
              500: '#3b82f6', // main
              600: '#2f6bd9',
              700: '#2656b3',
              800: '#214a94',
              900: '#1f3f78',
            },
            success: { 500: '#16a34a' },
            warning: { 500: '#f59e0b' },
            danger: { 500: '#ef4444' },
            ink: {
              50: '#fafafa',
              100: '#f5f5f5',
              200: '#e5e5e5',
              300: '#d4d4d4',
              400: '#a3a3a3',
              500: '#737373',
              600: '#525252',
              700: '#404040',
              800: '#262626',
              900: '#171717',
            },
          },
          boxShadow: {
            soft: '0 8px 30px rgba(0,0,0,0.06)',
          },
          borderRadius: {
            xl2: '1rem',
          },
        },
      },
    };
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <style>
    html, body, #root { height: 100%; }
    /* hide number input spinners for clean Apple-like look */
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
  </style>
</head>
<body class="bg-ink-50 text-ink-800 font-sans antialiased">
  <div id="root"></div>

  <!-- React 18 UMD + Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;

    // -----------------------------
    // Utilities (dates & storage)
    // -----------------------------
    const MAX_FTE = 1.2;
    const STORAGE_KEY = "fte_planner_state_v2";

    const clamp = (n, min, max) => Math.min(Math.max(n, min), max);

    const startOfISOWeek = (d) => {
      const date = new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()));
      const day = date.getUTCDay() || 7;
      if (day !== 1) date.setUTCDate(date.getUTCDate() - (day - 1));
      date.setUTCHours(0,0,0,0);
      return date;
    };

    const addDays = (d, days) => {
      const c = new Date(d);
      c.setUTCDate(c.getUTCDate() + days);
      return c;
    };

    const addWeeks = (d, weeks) => addDays(d, weeks * 7);

    const isoDate = (d) => d.toISOString().slice(0,10); // YYYY-MM-DD

    const formatNice = (d) =>
      d.toLocaleDateString('ru-RU', { day: '2-digit', month: 'short' }).replace('.', '');

    const weekLabel = (start) => {
      const end = addDays(start, 6);
      return `${formatNice(start)} — ${formatNice(end)}`;
    };

    const range = (n) => [...Array(n).keys()];

    function useLocalState(initial) {
      const [state, setState] = useState(() => {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          return raw ? JSON.parse(raw) : initial;
        } catch {
          return initial;
        }
      });
      useEffect(() => {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      }, [state]);
      return [state, setState];
    }

    // -----------------------------
    // Design System
    // -----------------------------
    const Button = ({ as = 'button', className = '', variant = 'primary', size='md', ...props }) => {
      const Comp = as;
      const base =
        'inline-flex items-center justify-center rounded-xl font-medium transition focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-400 disabled:opacity-50 disabled:cursor-not-allowed';
      const sizes = {
        sm: 'h-8 px-3 text-sm',
        md: 'h-10 px-4 text-[15px]',
      };
      const variants = {
        primary: 'bg-primary-500 text-white hover:bg-primary-600 active:bg-primary-700',
        secondary: 'bg-white text-ink-800 border border-ink-200 hover:bg-ink-100',
        ghost: 'bg-transparent text-ink-700 hover:bg-ink-100',
        danger: 'bg-danger-500 text-white hover:bg-red-600',
      };
      return <Comp className={`${base} ${sizes[size]} ${variants[variant]} ${className}`} {...props} />;
    };

    const Segmented = ({ value, onChange, options }) => {
      return (
        <div className="inline-flex bg-white rounded-xl p-1 border border-ink-200 shadow-soft">
          {options.map((opt) => {
            const active = opt.value === value;
            return (
              <button
                key={opt.value}
                onClick={() => onChange(opt.value)}
                className={
                  'px-3 h-9 rounded-lg text-[15px] transition ' +
                  (active
                    ? 'bg-primary-500 text-white'
                    : 'text-ink-700 hover:bg-ink-100')
                }
                aria-pressed={active}
              >
                {opt.label}
              </button>
            );
          })}
        </div>
      );
    };

    const Input = React.forwardRef(({ className='', ...props }, ref) => (
      <input
        ref={ref}
        className={`h-10 px-3 rounded-xl border border-ink-200 bg-white text-[15px] focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-400 ${className}`}
        {...props}
      />
    ));
    Input.displayName = 'Input';

    const Select = ({ className='', ...props }) => (
      <select
        className={`h-10 px-3 rounded-xl border border-ink-200 bg-white text-[15px] focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-400 ${className}`}
        {...props}
      />
    );

    const Tag = ({ color = '#bbb', children }) => (
      <span className="inline-flex items-center gap-2 px-2.5 h-8 rounded-full bg-white border border-ink-200 text-sm">
        <span className="w-2.5 h-2.5 rounded-full" style={{ background: color }} />
        <span>{children}</span>
      </span>
    );

    const SectionCard = ({ title, actions, children }) => (
      <div className="bg-white rounded-2xl shadow-soft border border-ink-200">
        <div className="px-4 sm:px-6 py-3 flex items-center justify-between border-b border-ink-100">
          <h3 className="text-lg font-semibold">{title}</h3>
          <div className="flex items-center gap-2">{actions}</div>
        </div>
        <div className="p-4 sm:p-6">{children}</div>
      </div>
    );

    // -----------------------------
    // Demo Data (initial seed)
    // -----------------------------
    const initialState = {
      people: [
        { id: 'p1', name: 'Анна', role: 'Frontend', external: false },
        { id: 'p2', name: 'Игорь', role: 'Backend', external: false },
        { id: 'p3', name: 'Мария', role: 'QA', external: true },
      ],
      projects: [
        { id: 'pr1', name: 'Новый сайт', color: '#22c55e', status: 'active', team: ['p1','p2'] },
        { id: 'pr2', name: 'Мобильное приложение', color: '#3b82f6', status: 'planned', team: ['p1','p3'] },
      ],
      // assignments: { [isoWeekStart]: { [personId]: { [projectId]: fte } } }
      assignments: {},
      // vacations: { [personId]: Array<{ fromIso, toIso }> }
      vacations: { p2: [], p1: [], p3: [] },
      ui: {
        visibleWeeks: 16,
      }
    };

    // -----------------------------
    // App State Hook
    // -----------------------------
    function useAppState() {
      const [state, setState] = useLocalState(initialState);

      const setPeople = (fn) => setState(s => ({ ...s, people: fn(s.people) }));
      const setProjects = (fn) => setState(s => ({ ...s, projects: fn(s.projects) }));
      const setAssignments = (fn) => setState(s => ({ ...s, assignments: fn(s.assignments) }));
      const setVacations = (fn) => setState(s => ({ ...s, vacations: fn(s.vacations) }));
      const setUI = (fn) => setState(s => ({ ...s, ui: fn(s.ui) }));

      return {
        state, setState,
        setPeople, setProjects, setAssignments, setVacations, setUI
      };
    }

    // -----------------------------
    // Hash Router
    // -----------------------------
    function parseHash() {
      const hash = window.location.hash.replace(/^#/, '');
      const url = new URL('http://x/' + (hash || 'load'));
      const path = url.pathname.replace(/^\//,'') || 'load';
      const params = Object.fromEntries(url.searchParams.entries());
      return { path, params };
    }

    function useHashRoute() {
      const [route, setRoute] = useState(parseHash());
      useEffect(() => {
        const onHash = () => setRoute(parseHash());
        window.addEventListener('hashchange', onHash);
        if (!window.location.hash) {
          const today = isoDate(startOfISOWeek(new Date()));
          window.location.hash = `#load?week=${today}&visible=16`;
        }
        return () => window.removeEventListener('hashchange', onHash);
      }, []);
      return [route, (p) => window.location.hash = p];
    }

    // -----------------------------
    // Week Navigator
    // -----------------------------
    function WeekNavigator({ weekStartIso, visible = 16, onChange }) {
      const weekStart = useMemo(() => new Date(weekStartIso + 'T00:00:00.000Z'), [weekStartIso]);
      return (
        <div className="flex flex-wrap items-center gap-2">
          <Button variant="secondary" onClick={() => {
            const today = isoDate(startOfISOWeek(new Date()));
            onChange({ week: today, visible });
          }}>Сегодня</Button>
          <Button variant="ghost" onClick={() => {
            const prev = isoDate(addWeeks(weekStart, -1));
            onChange({ week: prev, visible });
          }}>← Неделя</Button>
          <div className="text-ink-600 text-sm select-none">
            Диапазон: {weekLabel(weekStart)} … {weekLabel(addWeeks(weekStart, Math.max(1, Math.floor(visible-1))))}
          </div>
          <Button variant="ghost" onClick={() => {
            const next = isoDate(addWeeks(weekStart, 1));
            onChange({ week: next, visible });
          }}>Неделя →</Button>
          <Select
            value={String(visible)}
            onChange={(e) => onChange({ week: weekStartIso, visible: parseInt(e.target.value, 10) })}
          >
            {[8,12,16,24].map(n => <option key={n} value={n}>{n} недель</option>)}
          </Select>
          <Input
            type="date"
            value={weekStartIso}
            onChange={(e) => {
              const d = startOfISOWeek(new Date(e.target.value + 'T00:00:00.000Z'));
              onChange({ week: isoDate(d), visible });
            }}
          />
        </div>
      );
    }

    // -----------------------------
    // Header (Sticky)
    // -----------------------------
    function Header({ currentTab, onTab, route, setRoute }) {
      const params = route.params;
      const week = params.week || isoDate(startOfISOWeek(new Date()));
      const visible = parseInt(params.visible || '16', 10);

      const handleWeekChange = ({ week, visible }) => {
        setRoute(`#${currentTab}?week=${week}&visible=${visible}`);
      };

      return (
        <header className="sticky top-0 z-50 bg-ink-50/60 backdrop-blur border-b border-ink-200">
          <div className="max-w-7xl mx-auto px-4 sm:px-6 py-3">
            <div className="flex items-center justify-between gap-3">
              <div className="flex items-center gap-3">
                <div className="flex items-center gap-2">
                  <div className="w-8 h-8 rounded-xl bg-primary-500 text-white grid place-items-center font-bold">F</div>
                  <div className="text-ink-900 font-semibold tracking-tight">FTE Planner</div>
                </div>
                <Segmented
                  value={currentTab}
                  onChange={(tab) => setRoute(`#${tab}?week=${week}&visible=${visible}`)}
                  options={[
                    { value: 'load', label: 'Нагрузка' },
                    { value: 'projects', label: 'Проекты' },
                    { value: 'people', label: 'Команда' },
                  ]}
                />
              </div>
              <WeekNavigator weekStartIso={week} visible={visible} onChange={handleWeekChange}/>
            </div>
          </div>
        </header>
      );
    }

    // -----------------------------
    // Grid Helpers
    // -----------------------------
    function WeeksHeader({ start, count }) {
      const weeks = useMemo(() => range(count).map(i => addWeeks(start, i)), [start, count]);
      return (
        <div className="grid" style={{ gridTemplateColumns: `240px repeat(${count}, minmax(120px, 1fr))` }}>
          <div />
          {weeks.map((w, idx) => (
            <div key={idx} className="px-3 py-2 text-xs text-ink-600">{weekLabel(w)}</div>
          ))}
        </div>
      );
    }

    function FTECell({ value, onCommit }) {
      const [editing, setEditing] = useState(false);
      const [val, setVal] = useState(value ?? '');

      useEffect(() => { if (!editing) setVal(value ?? ''); }, [value, editing]);

      const inputRef = useRef(null);
      useEffect(() => { if (editing && inputRef.current) inputRef.current.focus(); }, [editing]);

      return (
        <div
          className={`px-3 py-2 h-12 bg-white border border-ink-200 rounded-xl flex items-center hover:border-primary-400 transition`}
          onClick={() => setEditing(true)}
          role="button"
          tabIndex={0}
          onKeyDown={(e) => { if (e.key === 'Enter') setEditing(true); }}
        >
          {editing ? (
            <input
              ref={inputRef}
              type="number"
              step="0.1"
              min="0"
              max={MAX_FTE}
              value={val}
              onChange={(e) => setVal(e.target.value)}
              onBlur={() => { setEditing(false); onCommit(val === '' ? null : clamp(parseFloat(val), 0, MAX_FTE)); }}
              onKeyDown={(e) => {
                if (e.key === 'Enter') { e.currentTarget.blur(); }
                if (e.key === 'Escape') { setEditing(false); setVal(value ?? ''); }
              }}
              className="w-full outline-none"
            />
          ) : (
            <span className="text-[15px]">{value ?? ''}</span>
          )}
        </div>
      );
    }

    // -----------------------------
    // Views
    // -----------------------------
    function LoadView({ app, route }) {
      const { state, setAssignments } = app;
      const week = new Date((route.params.week || isoDate(startOfISOWeek(new Date()))) + 'T00:00:00.000Z');
      const visible = parseInt(route.params.visible || state.ui.visibleWeeks || '16', 10);

      const weeks = useMemo(() => range(visible).map(i => addWeeks(week, i)), [week, visible]);

      const commitFTE = (weekIso, personId, projectId, fte) => {
        setAssignments((as) => {
          const ws = { ...(as[weekIso] || {}) };
          const personRec = { ...(ws[personId] || {}) };
          if (fte === null || isNaN(fte)) {
            delete personRec[projectId];
          } else {
            personRec[projectId] = fte;
          }
          ws[personId] = personRec;
          return { ...as, [weekIso]: ws };
        });
      };

      const rowSum = (weekIso, personId) => {
        const ws = state.assignments[weekIso] || {};
        const pr = ws[personId] || {};
        return Object.values(pr).reduce((a,b)=>a+(b||0),0);
      };

      // simple filters
      const [q, setQ] = useState('');
      const filteredPeople = state.people
        .filter(p => p.name.toLowerCase().includes(q.toLowerCase()) || p.role.toLowerCase().includes(q.toLowerCase()));

      return (
        <div className="max-w-7xl mx-auto px-4 sm:px-6 py-6 space-y-4">
          <div className="flex items-center gap-3">
            <Input placeholder="Поиск по имени или роли…" value={q} onChange={(e)=>setQ(e.target.value)} />
            <span className="text-sm text-ink-600">Всего: {filteredPeople.length}</span>
          </div>

          <div className="grid" style={{ gridTemplateColumns: `240px repeat(${visible}, minmax(120px, 1fr))`, gap: '12px' }}>
            <div />
            {weeks.map((w,i)=>(
              <div key={i} className="text-xs text-ink-600 px-1">{weekLabel(w)}</div>
            ))}

            {filteredPeople.map(person => (
              <React.Fragment key={person.id}>
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 rounded-xl bg-ink-200 grid place-items-center">{person.name[0]}</div>
                  <div>
                    <div className="font-medium">{person.name}</div>
                    <div className="text-xs text-ink-600">{person.role}{person.external ? ' · внешний' : ''}</div>
                  </div>
                </div>
                {weeks.map((w,i)=>{
                  const wIso = isoDate(w);
                  // choose first project from person's teams for demo purpose
                  const personProjects = app.state.projects.filter(pr => pr.team.includes(person.id));
                  const firstProject = personProjects[0]?.id;
                  const current = (state.assignments[wIso]?.[person.id]?.[firstProject]) ?? null;
                  return (
                    <FTECell
                      key={i}
                      value={current}
                      onCommit={(val) => firstProject && commitFTE(wIso, person.id, firstProject, val)}
                    />
                  );
                })}
              </React.Fragment>
            ))}
          </div>

          <SectionCard
            title="Сводка перегрузок"
            actions={<></>}
          >
            <div className="grid md:grid-cols-2 gap-3">
              {filteredPeople.map((p)=> {
                const over = weeks.some(w => rowSum(isoDate(w), p.id) > 1.0);
                return (
                  <div key={p.id} className="flex items-center justify-between bg-ink-100 rounded-xl px-4 py-3">
                    <div className="flex items-center gap-3">
                      <div className="w-8 h-8 rounded-lg bg-white border border-ink-200 grid place-items-center">{p.name[0]}</div>
                      <div>
                        <div className="font-medium">{p.name}</div>
                        <div className="text-xs text-ink-600">{p.role}</div>
                      </div>
                    </div>
                    <div className={"text-sm font-medium " + (over ? "text-danger-500" : "text-ink-600")}>
                      {over ? "Есть недели > 1.0" : "OK"}
                    </div>
                  </div>
                );
              })}
            </div>
          </SectionCard>
        </div>
      );
    }

    function ProjectsView({ app }) {
      const { state, setProjects } = app;
      const [name, setName] = useState('');
      const [color, setColor] = useState('#3b82f6');
      const [status, setStatus] = useState('active');
      const [q, setQ] = useState('');

      const addProject = () => {
        if (!name.trim()) return;
        setProjects((arr) => [
          ...arr,
          { id: 'pr_' + Math.random().toString(36).slice(2,9), name: name.trim(), color, status, team: [] }
        ]);
        setName('');
      };

      const filtered = state.projects.filter(pr =>
        pr.name.toLowerCase().includes(q.toLowerCase()) ||
        pr.status.toLowerCase().includes(q.toLowerCase())
      );

      const setProject = (id, patch) => {
        setProjects(list => list.map(p => p.id === id ? { ...p, ...patch } : p));
      };

      const removeFromTeam = (prId, pid) => {
        setProjects(list => list.map(p => p.id === prId ? { ...p, team: p.team.filter(i => i !== pid)} : p));
      };
      const addToTeam = (prId, pid) => {
        setProjects(list => list.map(p => p.id === prId ? { ...p, team: Array.from(new Set([...p.team, pid])) } : p));
      };

      return (
        <div className="max-w-7xl mx-auto px-4 sm:px-6 py-6 grid lg:grid-cols-[360px_1fr] gap-6">
          <SectionCard
            title="Новый проект"
            actions={null}
          >
            <div className="space-y-3">
              <Input placeholder="Название проекта" value={name} onChange={(e)=>setName(e.target.value)} />
              <div className="flex items-center gap-3">
                <label className="text-sm w-24">Цвет</label>
                <input type="color" value={color} onChange={(e)=>setColor(e.target.value)} className="h-10 w-16 rounded-xl border border-ink-200"/>
              </div>
              <div className="flex items-center gap-3">
                <label className="text-sm w-24">Статус</label>
                <Select value={status} onChange={(e)=>setStatus(e.target.value)}>
                  <option value="active">active</option>
                  <option value="planned">planned</option>
                  <option value="onhold">onhold</option>
                  <option value="done">done</option>
                </Select>
              </div>
              <Button onClick={addProject}>Добавить проект</Button>
            </div>
          </SectionCard>

          <SectionCard
            title="Проекты"
            actions={
              <div className="flex items-center gap-2">
                <Input placeholder="Поиск…" value={q} onChange={(e)=>setQ(e.target.value)} />
              </div>
            }
          >
            <div className="space-y-4">
              {filtered.map(p => (
                <div key={p.id} className="bg-ink-50 border border-ink-200 rounded-xl p-4">
                  <div className="flex flex-wrap items-center gap-3 justify-between">
                    <div className="flex items-center gap-3">
                      <Tag color={p.color}>{p.name}</Tag>
                      <span className="text-xs text-ink-600">[{p.status}]</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <Input
                        value={p.name}
                        onChange={(e)=>setProject(p.id, { name: e.target.value })}
                        className="h-8"
                      />
                      <input type="color" value={p.color} onChange={(e)=>setProject(p.id, { color: e.target.value })} className="h-8 w-12 rounded-md border border-ink-200"/>
                      <Select value={p.status} onChange={(e)=>setProject(p.id, { status: e.target.value })} className="h-8">
                        <option value="active">active</option>
                        <option value="planned">planned</option>
                        <option value="onhold">onhold</option>
                        <option value="done">done</option>
                      </Select>
                    </div>
                  </div>

                  <div className="mt-3">
                    <div className="text-sm text-ink-600 mb-2">Команда проекта</div>
                    <div className="flex flex-wrap gap-2">
                      {p.team.map(pid => {
                        const person = app.state.people.find(x => x.id === pid);
                        return (
                          <span key={pid} className="inline-flex items-center gap-2 text-sm px-2.5 h-8 rounded-full bg-white border border-ink-200">
                            <span className="w-5 h-5 rounded-full bg-ink-200 grid place-items-center text-xs">{person?.name?.[0] || '?'}</span>
                            {person?.name || '—'}
                            <button
                              className="ml-1 text-ink-500 hover:text-danger-500"
                              onClick={()=>removeFromTeam(p.id, pid)}
                              title="Удалить из проекта"
                            >✕</button>
                          </span>
                        );
                      })}
                    </div>
                    <div className="mt-3 flex items-center gap-2">
                      <Select defaultValue="" onChange={(e)=>{ const pid = e.target.value; if (pid) addToTeam(p.id, pid); e.target.value='';}}>
                        <option value="">Добавить сотрудника…</option>
                        {app.state.people
                          .filter(pe => !p.team.includes(pe.id))
                          .map(pe => <option key={pe.id} value={pe.id}>{pe.name} — {pe.role}</option>)}
                      </Select>
                    </div>
                  </div>
                </div>
              ))}
              {!filtered.length && <div className="text-sm text-ink-600">Ничего не найдено…</div>}
            </div>
          </SectionCard>
        </div>
      );
    }

    function PeopleView({ app, setRoute }) {
      const { state, setPeople } = app;
      const [q, setQ] = useState('');
      const [name, setName] = useState('');
      const [role, setRole] = useState('Frontend');
      const [external, setExternal] = useState(false);

      const filtered = state.people.filter(p =>
        p.name.toLowerCase().includes(q.toLowerCase()) || p.role.toLowerCase().includes(q.toLowerCase())
      );

      const addPerson = () => {
        if (!name.trim()) return;
        setPeople(arr => [...arr, { id: 'p_'+Math.random().toString(36).slice(2,9), name: name.trim(), role, external }]);
        setName('');
        setExternal(false);
      };

      const setPerson = (id, patch) => setPeople(list => list.map(p => p.id === id ? { ...p, ...patch } : p));

      return (
        <div className="max-w-7xl mx-auto px-4 sm:px-6 py-6 grid lg:grid-cols-[360px_1fr] gap-6">
          <SectionCard title="Новый сотрудник">
            <div className="space-y-3">
              <Input placeholder="Имя" value={name} onChange={(e)=>setName(e.target.value)} />
              <Select value={role} onChange={(e)=>setRole(e.target.value)}>
                <option>Frontend</option>
                <option>Backend</option>
                <option>QA</option>
                <option>PM</option>
                <option>Design</option>
              </Select>
              <label className="inline-flex items-center gap-2 text-sm">
                <input type="checkbox" checked={external} onChange={(e)=>setExternal(e.target.checked)} />
                Внешний
              </label>
              <Button onClick={addPerson}>Добавить</Button>
            </div>
          </SectionCard>

          <SectionCard
            title="Команда"
            actions={<Input placeholder="Поиск…" value={q} onChange={(e)=>setQ(e.target.value)} />}
          >
            <div className="grid md:grid-cols-2 gap-4">
              {filtered.map(p => (
                <div key={p.id} className="bg-ink-50 border border-ink-200 rounded-xl p-4">
                  <div className="flex items-center gap-3 justify-between">
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 rounded-xl bg-white border border-ink-200 grid place-items-center">{p.name[0]}</div>
                      <div>
                        <Input className="h-8 w-48" value={p.name} onChange={(e)=>setPerson(p.id, { name: e.target.value })} />
                        <div className="flex items-center gap-2 mt-2">
                          <Select className="h-8" value={p.role} onChange={(e)=>setPerson(p.id, { role: e.target.value })}>
                            <option>Frontend</option><option>Backend</option><option>QA</option><option>PM</option><option>Design</option>
                          </Select>
                          <label className="inline-flex items-center gap-2 text-xs text-ink-700">
                            <input type="checkbox" checked={p.external} onChange={(e)=>setPerson(p.id, { external: e.target.checked })} />
                            внешний
                          </label>
                        </div>
                      </div>
                    </div>
                    <Button
                      variant="ghost"
                      onClick={()=> setRoute(`#person?id=${p.id}`)}
                      title="Открыть профиль"
                    >Открыть →</Button>
                  </div>
                </div>
              ))}
            </div>
          </SectionCard>
        </div>
      );
    }

    function PersonView({ app, route, setRoute }) {
      const pid = route.params.id;
      const person = app.state.people.find(p => p.id === pid);
      const back = () => setRoute(`#people`);

      const week = new Date((route.params.week || isoDate(startOfISOWeek(new Date()))) + 'T00:00:00.000Z');
      const visible = parseInt(route.params.visible || '16', 10);
      const weeks = useMemo(() => range(visible).map(i => addWeeks(week, i)), [week, visible]);

      const projects = app.state.projects.filter(pr => pr.team.includes(pid));

      const commit = (weekIso, projectId, fte) => {
        app.setAssignments((as) => {
          const ws = { ...(as[weekIso] || {}) };
          const personRec = { ...(ws[pid] || {}) };
          if (fte === null || isNaN(fte)) { delete personRec[projectId]; } else { personRec[projectId] = fte; }
          ws[pid] = personRec;
          return { ...as, [weekIso]: ws };
        });
      };

      const addVacation = () => {
        const from = prompt('Отпуск: с (YYYY-MM-DD)');
        const to = prompt('Отпуск: по (YYYY-MM-DD)');
        if (!from || !to) return;
        app.setVacations(vs => {
          const arr = vs[pid] || [];
          return { ...vs, [pid]: [...arr, { fromIso: from, toIso: to }] };
        });
      };

      if (!person) {
        return (
          <div className="max-w-4xl mx-auto px-4 sm:px-6 py-10">
            <SectionCard title="Сотрудник не найден">
              <Button variant="secondary" onClick={back}>Назад к списку</Button>
            </SectionCard>
          </div>
        );
      }

      return (
        <>
          <div className="border-b border-ink-200 bg-white/70 backdrop-blur">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-8 h-8 rounded-xl bg-primary-500 text-white grid place-items-center font-bold">F</div>
                <div className="text-ink-900 font-semibold tracking-tight">FTE Planner</div>
                <div className="ml-4">
                  <Tag color="#999">{person.role}</Tag>
                </div>
              </div>
              <div className="flex items-center gap-2">
                <Button variant="secondary" onClick={back}>← Назад</Button>
                <Button onClick={addVacation}>Добавить отпуск</Button>
              </div>
            </div>
          </div>

          <div className="max-w-7xl mx-auto px-4 sm:px-6 py-6 space-y-4">
            <div className="flex items-center gap-3">
              <div className="w-12 h-12 rounded-2xl bg-white border border-ink-200 grid place-items-center text-lg">{person.name[0]}</div>
              <div>
                <div className="text-xl font-semibold">{person.name}</div>
                <div className="text-sm text-ink-600">{person.role}{person.external ? ' · внешний' : ''}</div>
              </div>
            </div>

            <SectionCard
              title="Нагрузка по проектам"
              actions={null}
            >
              <div className="grid" style={{ gridTemplateColumns: `240px repeat(${visible}, minmax(120px, 1fr))`, gap: '12px' }}>
                <div />
                {weeks.map((w,i)=>(
                  <div key={i} className="text-xs text-ink-600 px-1">{weekLabel(w)}</div>
                ))}

                {projects.map(pr => (
                  <React.Fragment key={pr.id}>
                    <div className="flex items-center gap-3">
                      <span className="w-3 h-3 rounded-full" style={{ background: pr.color }} />
                      <div className="font-medium">{pr.name}</div>
                    </div>
                    {weeks.map((w,i)=>{
                      const wIso = isoDate(w);
                      const current = (app.state.assignments[wIso]?.[pid]?.[pr.id]) ?? null;
                      return (
                        <FTECell key={i} value={current} onCommit={(v)=>commit(wIso, pr.id, v)} />
                      );
                    })}
                  </React.Fragment>
                ))}
              </div>
            </SectionCard>

            <SectionCard title="Отпуска" actions={null}>
              <div className="flex flex-wrap gap-2">
                {(app.state.vacations[pid]||[]).map((v, i)=>(
                  <span key={i} className="inline-flex items-center gap-2 px-3 h-8 rounded-full bg-ink-100 border border-ink-200 text-sm">
                    {v.fromIso} → {v.toIso}
                    <button
                      className="text-ink-500 hover:text-danger-500"
                      onClick={()=>{
                        app.setVacations(vs=>{
                          const arr = (vs[pid]||[]).slice();
                          arr.splice(i,1);
                          return { ...vs, [pid]: arr };
                        });
                      }}
                      title="Удалить"
                    >✕</button>
                  </span>
                ))}
                {!(app.state.vacations[pid]||[]).length && <span className="text-sm text-ink-600">Нет отпусков</span>}
              </div>
            </SectionCard>
          </div>
        </>
      );
    }

    // -----------------------------
    // App
    // -----------------------------
    function App() {
      const app = useAppState();
      const [route, setRoute] = useHashRoute();
      const currentTab = ['load','projects','people'].includes(route.path) ? route.path : 'load';

      return (
        <div className="min-h-full">
          <Header currentTab={currentTab} onTab={()=>{}} route={route} setRoute={setRoute} />
          {route.path === 'load' && <LoadView app={app} route={route} />}
          {route.path === 'projects' && <ProjectsView app={app} route={route} />}
          {route.path === 'people' && <PeopleView app={app} route={route} setRoute={setRoute} />}
          {route.path === 'person' && <PersonView app={app} route={route} setRoute={setRoute} />}
          <footer className="max-w-7xl mx-auto px-4 sm:px-6 py-10 text-xs text-ink-500">
            Построено в стиле Trello/Apple • Локальное сохранение • Введите значения FTE по ячейке (Enter/Blur), Esc — отмена
          </footer>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>

