<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ü–∞–Ω–∫–≤–µ–± FTE Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- React & Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --app-header-h: 56px;
      --left-col-w: 220px;
      --emerald-50:#ecfdf5; --emerald-100:#d1fae5; --emerald-300:#86efac;
      --emerald-600:#059669; --emerald-700:#047857; --emerald-900:#064e3b;
    }
    .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }
    .no-scrollbar::-webkit-scrollbar{ display:none; }

     /* –¢—Ä–µ–ª–ª–æ-–ø–æ–¥–æ–±–Ω—ã–π —Å–µ–≥–º–µ–Ω—Ç */
    .segmented{
      @apply inline-flex items-center gap-1 p-1 rounded-2xl bg-neutral-100 border border-neutral-200;
      box-shadow: inset 0 1px 2px rgba(0,0,0,.04);
    }
    .segmented button{
      @apply px-3 py-1 rounded-xl border border-transparent bg-white text-neutral-800 transition;
    }
    .segmented button:not(.active){ @apply hover:bg-white/90; }
    .segmented .active{
      background: var(--emerald-50);
      color: var(--emerald-700);
      border-color: var(--emerald-300);
      box-shadow: 0 0 0 1px rgba(134,239,172,.5) inset, 0 1px 0 rgba(4,120,87,.08);
    }

    .btn{
      @apply rounded-xl border border-neutral-300 bg-white px-3 py-1 shadow-sm hover:shadow transition;
    }
  </style>
</head>
<body class="bg-[#F7F8FA] no-scrollbar">
  <div id="root"></div>

  <script type="text/babel">
    const {useState, useEffect, useMemo, useRef, Fragment} = React;

    /* ---------------- Base helpers ---------------- */
    const MAX_FTE = 1.2;
    const WEEK_COL_PX = 72;
    const VISIBLE_WEEKS = 16;
    const TEAM_BAR_COLOR = "#22c55e";

    const LS_KEY = "fteplanner.v1";
    const loadAll = ()=>{ try{ return JSON.parse(localStorage.getItem(LS_KEY)||"{}"); }catch{ return {}; } };
    const loadJSON = (k,f)=>{ const a=loadAll(); return (k in a)?a[k]:f; };
    const saveJSON = (patch)=>{ try{ const a=loadAll(); localStorage.setItem(LS_KEY, JSON.stringify({...a,...patch})); }catch{} };

    const fmtISO = (date) => date.toISOString().slice(0,10);
    const addDays = (d, n) => { const x=new Date(d); x.setDate(x.getDate()+n); x.setHours(0,0,0,0); return x; };
    const startOfISOWeek = (d) => { const day=d.getDay(); const diff=(day===0?-6:1)-day; const m=new Date(d); m.setDate(d.getDate()+diff); m.setHours(0,0,0,0); return m; };
    const addWeeks = (m, n) => { const d=new Date(m); d.setDate(d.getDate()+n*7); d.setHours(0,0,0,0); return d; };
    const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
    const scaleRatio = (v, max=MAX_FTE) => clamp(v/max, 0, 1);
    const fmtFTE1 = (n) => (Math.round(n*10)/10).toFixed(1);
    const RU_MONTHS_FULL = ["–Ø–Ω–≤–∞—Ä—å","–§–µ–≤—Ä–∞–ª—å","–ú–∞—Ä—Ç","–ê–ø—Ä–µ–ª—å","–ú–∞–π","–ò—é–Ω—å","–ò—é–ª—å","–ê–≤–≥—É—Å—Ç","–°–µ–Ω—Ç—è–±—Ä—å","–û–∫—Ç—è–±—Ä—å","–ù–æ—è–±—Ä—å","–î–µ–∫–∞–±—Ä—å"];

    /* ---------------- Seed data (–∫–∞–∫ –≤ index3) ---------------- */
    const base = startOfISOWeek(new Date());
    const initialWeeks = Array.from({length:24}, (_,i)=> fmtISO(addWeeks(base, i-4)));
    const seedPeople = [
      { id:"p1", name:"–°–∞—à–∞", role:"manager", capacityPerWeek:1, active:true, external:false },
      { id:"p2", name:"–ö–∞—Ç—è –ö.", role:"designer", capacityPerWeek:1, active:true, external:false },
    ];
    const seedProjects = [
      { id:"pr1", name:"HR –ü–æ–¥–∫–∞—Å—Ç—ã", status:"active", color:"#3b82f6" },
      { id:"pr2", name:"–ê—Ä–∫—Ç–∏–∫–∞ –ú–µ–¥–∏–∞", status:"active", color:"#f43f5e" },
      { id:"pr3", name:"–ü–∞–¥–µ–ª-—Ç–µ–Ω–Ω–∏—Å", status:"planned", color:"#06b6d4" },
    ];
    const seedAssignments = [
      { id:"a1", personId:"p1", projectId:"pr1", weekStart: initialWeeks[4], fte:0.3 },
      { id:"a2", personId:"p1", projectId:"pr2", weekStart: initialWeeks[4], fte:0.2 },
      { id:"a3", personId:"p2", projectId:"pr2", weekStart: initialWeeks[5], fte:0.4 },
    ];
    const seedRoles = ["designer","dev","manager","pm","other"];

    /* ---------------- Aggregations ---------------- */
    const personWeekTotal = (as, pid, w) => as.filter(a=>a.personId===pid && a.weekStart===w).reduce((s,a)=>s+a.fte,0);
    const fteFor = (as, pid, pr, w) => as.filter(a=>a.personId===pid && a.projectId===pr && a.weekStart===w).reduce((s,a)=>s+a.fte,0);
    const mergeOrder = (existing, nextIds) => {
      const seen=new Set(); const res=[];
      for(const id of (existing||[])) if(nextIds.includes(id) && !seen.has(id)){ res.push(id); seen.add(id); }
      for(const id of nextIds) if(!seen.has(id)){ res.push(id); seen.add(id); }
      return res;
    };

    /* ---------------- Icons ---------------- */
    const StatusIcon = ({status})=>{
      const p = {width:16,height:16,viewBox:"0 0 24 24",fill:"white"};
      if(status==="active") return (<svg {...p}><polygon points="8,5 19,12 8,19"/></svg>);
      if(status==="onhold") return (<svg {...p}><rect x="6" y="5" width="4" height="14"/><rect x="14" y="5" width="4" height="14"/></svg>);
      if(status==="done") return (<svg {...p}><rect x="6" y="6" width="12" height="12" rx="2"/></svg>);
      return (<svg {...p}><circle cx="12" cy="12" r="6"/></svg>);
    };

    /* ---------------- Weeks window ---------------- */
    function useWeeksWindow(){
      const [weeks, setWeeks] = useState(loadJSON("weeks", initialWeeks));
      const savedFirstISO = loadJSON("firstWeekISO", weeks[0]);
      const initIdx = Math.max(0, weeks.indexOf(savedFirstISO));
      const [firstIdx, setFirstIdx] = useState(initIdx);

      const ensureRange = (needIdx) => {
        if(needIdx < 0){
          const first = new Date(weeks[0]);
          const prepend = Array.from({length: Math.ceil((-needIdx)/8)*8 }, (_,i)=> fmtISO(addWeeks(first, -(i+1)))).reverse();
          const next = [...prepend, ...weeks];
          setWeeks(next);
          return { weeks: next, firstIdx: needIdx + prepend.length };
        }
        if(needIdx + VISIBLE_WEEKS >= weeks.length){
          const last = new Date(weeks[weeks.length-1]);
          const more = Array.from({length:16}, (_,i)=> fmtISO(addWeeks(last, i+1)));
          const next = [...weeks, ...more];
          setWeeks(next);
          return { weeks: next, firstIdx: needIdx };
        }
        return { weeks, firstIdx: needIdx };
      };

      const goLeft = () => {
        const {weeks: w2, firstIdx: f2} = ensureRange(firstIdx-1);
        setFirstIdx(f2); saveJSON({firstWeekISO: w2[f2]}); saveJSON({weeks: w2});
      };
      const goRight = () => {
        const {weeks: w2, firstIdx: f2} = ensureRange(firstIdx+1);
        setFirstIdx(f2); saveJSON({firstWeekISO: w2[f2]}); saveJSON({weeks: w2});
      };
      const goToday = () => {
        const todayISO = fmtISO(startOfISOWeek(new Date()));
        let idx = weeks.indexOf(todayISO);
        if(idx<0){
          let m = startOfISOWeek(new Date(todayISO));
          const end = addWeeks(m, 200);
          const s = new Set(weeks);
          const add = [];
          while(m<=end){ const iso=fmtISO(m); if(!s.has(iso)) add.push(iso); m = addDays(m,7); }
          const next = [...weeks, ...add].sort();
          setWeeks(next);
          idx = next.indexOf(todayISO);
          saveJSON({weeks: next});
        }
        const {weeks: w2, firstIdx: f2} = ensureRange(idx);
        setFirstIdx(f2); saveJSON({firstWeekISO: w2[f2]});
      };

      const visible = useMemo(()=> weeks.slice(firstIdx, firstIdx+VISIBLE_WEEKS), [weeks, firstIdx]);
      return {weeks, setWeeks, firstIdx, setFirstIdx, visible, goLeft, goRight, goToday};
    }

    /* ---------------- CalendarHeader: –ì–æ–¥ ‚Üí –ú–µ—Å—è—Ü—ã ‚Üí –ù–æ–º–µ—Ä–∞ –Ω–µ–¥–µ–ª—å ---------------- */
    function CalendarHeader({visible, leftLabel="–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏", weekBadgeByISO=null}){
      // year groups
      const yearGroups = [];
      let cy=null, ccount=0;
      visible.forEach((iso, i)=>{
        const y = new Date(iso).getFullYear();
        if(cy===null){ cy=y; ccount=1; }
        else if(y===cy){ ccount++; }
        else { yearGroups.push({year:cy, count:ccount}); cy=y; ccount=1; }
        if(i===visible.length-1) yearGroups.push({year:cy, count:ccount});
      });

      // month groups
      const monthGroups = [];
      let key=null, count=0, y0=null, m0=null;
      visible.forEach((iso,i)=>{
        const d=new Date(iso), y=d.getFullYear(), m=d.getMonth();
        const k=`${y}-${m}`;
        if(k!==key){
          if(key!==null) monthGroups.push({key, year:y0, month:m0, count});
          key=k; count=1; y0=y; m0=m;
        } else count++;
        if(i===visible.length-1) monthGroups.push({key, year:y0, month:m0, count});
      });

      // –Ω–µ–¥–µ–ª—è N –≤–Ω—É—Ç—Ä–∏ –º–µ—Å—è—Ü–∞
      const weekIndexInMonth = [];
      monthGroups.forEach(g => { for(let i=1;i<=g.count;i++) weekIndexInMonth.push(i); });

      return (
        <div className="space-y-1">
          <div className="grid" style={{gridTemplateColumns:`var(--left-col-w) repeat(${visible.length}, ${WEEK_COL_PX}px)`, rowGap:'6px'}}>
            {/* –ª–µ–≤—ã–π —Å—Ç–æ–ª–±–∏–∫-–ø–ª–∞—à–∫–∞ (—Ç—è–Ω–µ—Ç—Å—è –Ω–∞ 3 —Ä—è–¥–∞) */}
            <div className="sticky left-0 z-50 bg-[#F7F8FA] border-r border-neutral-200 p-1" style={{gridRow:"span 3 / span 3"}}>
              <div className="h-full rounded-2xl bg-white border border-neutral-200 shadow-sm flex items-center justify-center text-sm text-neutral-700">
                {leftLabel}
              </div>
            </div>

            {/* –†—è–¥ 1: –ì–æ–¥—ã (–∫–∞–∂–¥—ã–π —Å–æ —Å–≤–æ–∏–º span) */}
            {yearGroups.map(g=>(
              <div key={`y-${g.year}`} style={{gridColumn:`span ${g.count}`}}>
                <div className="mx-1 rounded-xl px-3 py-1 text-center text-white text-sm font-medium"
                     style={{background:"var(--emerald-900)"}}>
                  {g.year} –≥.
                </div>
              </div>
            ))}

            {/* –†—è–¥ 2: –ú–µ—Å—è—Ü—ã */}
            {monthGroups.map(g=>(
              <div key={g.key} style={{gridColumn:`span ${g.count}`}}>
                <div className="mx-1 rounded-xl px-3 py-2 text-center text-sm font-medium"
                     style={{background:"var(--emerald-100)", color:"var(--emerald-700)"}}>
                  {RU_MONTHS_FULL[g.month]}
                </div>
              </div>
            ))}

            {/* –†—è–¥ 3: –ù–æ–º–µ—Ä–∞ –Ω–µ–¥–µ–ª—å (1..N –≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞) + –æ–ø—Ü –±–µ–π–¥–∂ —Å–ø—Ä–∞–≤–∞ */}
            {visible.map((iso, i)=>(
              <div key={`w-${iso}`} className="relative">
                <div className="mx-1 rounded-md px-2 py-1 text-center text-[12px] text-neutral-800 bg-white border border-neutral-200 shadow-sm">
                  {weekIndexInMonth[i]}
                </div>
                {weekBadgeByISO && weekBadgeByISO[iso]!=null && (
                  <div className="absolute -right-1 -top-2 translate-x-1/2">
                    <span className="px-2 py-0.5 rounded-full text-[11px] font-semibold border border-neutral-200 bg-neutral-50 text-neutral-700 shadow-sm">
                      {weekBadgeByISO[iso]}
                    </span>
                  </div>
                )}
              </div>
            ))}
          </div>
        </div>
      );
    }

    /* ---------------- App ---------------- */
    function App(){
      const [people, setPeople] = useState(loadJSON("people", seedPeople));
      const [projects, setProjects] = useState(loadJSON("projects", seedProjects));
      const [assignments, setAssignments] = useState(loadJSON("assignments", seedAssignments));
      const [roles, setRoles] = useState(loadJSON("roles",[...seedRoles]));
      const [projectTeams, setProjectTeams] = useState(()=>{
        const saved = loadJSON("projectTeams", {});
        const map = {}; Object.keys(saved).forEach(k => (map[k]=new Set(saved[k])));
        if(Object.keys(map).length===0){
          for(const p of seedProjects) map[p.id]=new Set();
          for(const a of seedAssignments) (map[a.projectId] = map[a.projectId] || new Set()).add(a.personId);
        }
        return map;
      });
      const [vacations, setVacations] = useState(()=>{
        const saved = loadJSON("vacations", {});
        const map = {}; Object.keys(saved).forEach(k => (map[k]=new Set(saved[k])));
        return map;
      });
      const [personProjectOrder, setPersonProjectOrder] = useState(loadJSON("personProjectOrder", {}));
      const [teamOrder, setTeamOrder] = useState(()=> loadJSON("teamOrder", people.map(p=>p.id)));

      const [authed, setAuthed] = useState(loadJSON("authed", false));
      const [view, setView] = useState(loadJSON("view","team")); // team | project | employees
      useEffect(()=> saveJSON({view}), [view]);

      const [selectedPersonId, setSelectedPersonId] = useState(null);

      const {weeks, visible, goLeft, goRight, goToday} = useWeeksWindow();

      // persist
      useEffect(()=> saveJSON({people}), [people]);
      useEffect(()=> saveJSON({projects}), [projects]);
      useEffect(()=> saveJSON({assignments}), [assignments]);
      useEffect(()=> saveJSON({roles}), [roles]);
      useEffect(()=>{ const o={}; Object.entries(projectTeams).forEach(([k,v])=>o[k]=Array.from(v)); saveJSON({projectTeams:o}); }, [projectTeams]);
      useEffect(()=>{ const o={}; Object.entries(vacations).forEach(([k,v])=>o[k]=Array.from(v)); saveJSON({vacations:o}); }, [vacations]);
      useEffect(()=> saveJSON({personProjectOrder}), [personProjectOrder]);
      useEffect(()=> saveJSON({teamOrder}), [teamOrder]);

      // helpers
      const isVacation = (pid,w) => !!vacations[pid]?.has?.(w);
      const peopleInternal = useMemo(()=> people.filter(p=>p.active && !p.external), [people]);

      useEffect(()=>{ setTeamOrder(prev => mergeOrder(prev, peopleInternal.map(p=>p.id))); }, [peopleInternal]);

      const [roleFilter, setRoleFilter] = useState(loadJSON("roleFilter","all"));
      useEffect(()=> saveJSON({roleFilter}), [roleFilter]);

      const filteredTeamIds = useMemo(()=>{
        const order = teamOrder.filter(id => peopleInternal.some(p=>p.id===id));
        return order.filter(id => roleFilter==="all" ? true : (people.find(p=>p.id===id)?.role===roleFilter));
      }, [teamOrder, peopleInternal, people, roleFilter]);

      // create modals (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ –∫–∞–∫ —Ä–∞–Ω—å—à–µ)
      const [newProjectOpen, setNewProjectOpen] = useState(false);
      const [newPersonOpen, setNewPersonOpen] = useState(false);

      if(!authed){
        return (
          <div className="min-h-screen grid place-items-center bg-[#F7F8FA]">
            <div className="bg-white w-[360px] rounded-2xl shadow-lg border border-neutral-200 p-5">
              <div className="text-center mb-4"><div className="text-2xl font-semibold">–í—Ö–æ–¥</div></div>
              <AuthForm onSuccess={(remember)=>{ if(remember){ saveJSON({authed:true, remember:true}); } else { saveJSON({remember:false, authed:false}); } setAuthed(true); }} />
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-[#F7F8FA] text-neutral-900">
          {/* –õ–∏–ø–∫–∞—è –≤–µ—Ä—Ö–Ω—è—è —à–∞–ø–∫–∞ */}
          <header className="sticky top-0 z-50 border-b border-neutral-200 bg-white/90 backdrop-blur" style={{height:'var(--app-header-h)'}}>
            <div className="max-w-screen-2xl mx-auto px-4 h-full flex items-center gap-4">
              <div className="text-lg font-semibold tracking-tight text-green-600">–ü–∞–Ω–∫–≤–µ–± FTE Planner</div>
              <div className="segmented">
                <button className={view==="team" ? "active" : ""} onClick={()=>setView("team")}>–ù–∞–≥—Ä—É–∑–∫–∞</button>
                <button className={view==="employees" ? "active" : ""} onClick={()=>setView("employees")}>–ö–æ–º–∞–Ω–¥–∞</button>
                <button className={view==="project" ? "active" : ""} onClick={()=>setView("project")}>–ü—Ä–æ–µ–∫—Ç—ã</button>
              </div>
              <div className="ml-auto flex items-center gap-2">
                <button className="btn" onClick={()=>setNewProjectOpen(true)}>+ –ü—Ä–æ–µ–∫—Ç</button>
                <button className="btn" onClick={()=>setNewPersonOpen(true)}>+ –°–æ—Ç—Ä—É–¥–Ω–∏–∫</button>
              </div>
            </div>
          </header>

          <main className="max-w-screen-2xl mx-auto p-4">
            {/* --- –ù–∞–≥—Ä—É–∑–∫–∞ --- */}
            {view==="team" && (
              <>
                <div className="sticky top-[var(--app-header-h)] z-40 bg-[#F7F8FA] py-2 mb-2">
                  <div className="flex items-center justify-end gap-2">
                    <label className="text-sm text-neutral-700">–§–∏–ª—å—Ç—Ä —Ä–æ–ª–∏</label>
                    <select className="border border-neutral-300 rounded-xl px-2 py-1 text-sm"
                            value={roleFilter} onChange={e=>setRoleFilter(e.target.value)}>
                      <option value="all">–í—Å–µ</option>
                      {roles.map(r => (<option key={r} value={r}>{r}</option>))}
                    </select>
                    <button className="btn" onClick={()=>goLeft()}>‚Äπ</button>
                    <button className="btn" onClick={()=>goToday()}>–°–µ–≥–æ–¥–Ω—è</button>
                    <button className="btn" onClick={()=>goRight()}>‚Ä∫</button>
                  </div>
                </div>

                {/* –®–∞–ø–∫–∞ –±–∞—Ä–∞ (–ì–æ–¥ ‚Üí –ú–µ—Å—è—Ü—ã ‚Üí –ù–æ–º–µ—Ä–∞ –Ω–µ–¥–µ–ª—å) */}
                <CalendarHeader visible={visible} leftLabel="–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏" />

                {/* –°–µ—Ç–∫–∞ —Å—Ç—Ä–æ–∫: —Å–ª–µ–≤–∞ –ø–ª–∞—à–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞, —Å–ø—Ä–∞–≤–∞ —Å—Ç–æ–ª–±—Ü—ã –Ω–µ–¥–µ–ª—å */}
                <div className="grid" style={{gridTemplateColumns:`var(--left-col-w) repeat(${visible.length}, ${WEEK_COL_PX}px)`}}>
                  {filteredTeamIds.map((pid, rowIdx) => {
                    const person = people.find(p=>p.id===pid);
                    return (
                      <Fragment key={pid}>
                        {/* –ª–µ–≤—ã–π –±–ª–æ–∫-–ø–ª–∞—à–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (—Ä–æ–≤–Ω–æ –∫–∞–∫ –≤ index3) */}
                        <div
                          className="sticky left-0 z-30 bg-[#F7F8FA] border-r border-neutral-200 p-1"
                          draggable
                          onDragStart={()=>{ window.__dragRow=rowIdx; }}
                          onDragOver={e=>e.preventDefault()}
                          onDrop={()=>{
                            const from=window.__dragRow; const to=rowIdx; if(from==null || from===to) return;
                            const arr=[...filteredTeamIds]; const id=arr.splice(from,1)[0]; arr.splice(to,0,id);
                            const inactive = teamOrder.filter(id => !filteredTeamIds.includes(id));
                            setTeamOrder([...arr, ...inactive]); window.__dragRow=null;
                          }}
                        >
                          <button
                            onClick={()=>setSelectedPersonId(person.id)}
                            className="w-full text-left"
                            title="–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞"
                          >
                            <div className="relative bg-white rounded-2xl shadow-sm h-[120px] flex flex-col justify-center pl-5 pr-8 hover:shadow-md hover:bg-blue-50/70 transition">
                              <div className="font-medium truncate">{person.name}</div>
                              <div className="mt-1 text-[11px] text-neutral-600">{String(person.role||"").toUpperCase()}</div>
                            </div>
                          </button>
                        </div>

                        {/* —Å—Ç–æ–ª–±—Ü—ã –Ω–µ–¥–µ–ª—å */}
                        {visible.map(week => {
                          const total = personWeekTotal(assignments, person.id, week);
                          const ratio = scaleRatio(total);
                          const vac = isVacation(person.id, week);
                          return (
                            <div key={`${pid}-${week}`} className="p-1 h-[120px]">
                              <div className={`bg-white rounded-2xl shadow-sm h-full flex items-end justify-center relative ${total>1.0001?"ring-1 ring-red-300":""}`}>
                                <div className="relative w-14 h-[92%] rounded-lg bg-neutral-200 overflow-hidden">
                                  {!vac && (<div className="absolute bottom-0 left-0 right-0" style={{height:`${ratio*100}%`, background:TEAM_BAR_COLOR}} />)}
                                </div>
                                {!vac && (
                                  <div className="absolute inset-0 flex items-center justify-center text-sm font-semibold text-neutral-900">
                                    {fmtFTE1(total)}
                                  </div>
                                )}
                                {vac && (<div className="absolute inset-0 flex items-center justify-center text-2xl" title="–û—Ç–ø—É—Å–∫">üèñ</div>)}
                              </div>
                            </div>
                          );
                        })}
                      </Fragment>
                    );
                  })}
                </div>
              </>
            )}

            {/* --- –ü—Ä–æ–µ–∫—Ç—ã (–∫–∞–∫ —É –≤–∞—Å –æ–∫) --- */}
            {view==="project" && <ProjectsPage
              projects={projects} setProjects={setProjects}
              people={people} projectTeams={projectTeams} setProjectTeams={setProjectTeams}
            />}

            {/* --- –ö–æ–º–∞–Ω–¥–∞ (–∫–∞–∫ —É –≤–∞—Å –æ–∫) --- */}
            {view==="employees" && <EmployeesPage
              people={people} setPeople={setPeople}
              projects={projects} projectTeams={projectTeams} setProjectTeams={setProjectTeams}
            />}
          </main>

          {/* –°—Ç—Ä–∞–Ω–∏—Ü–∞ ¬´–û–¥–∏–Ω —Å–æ—Ç—Ä—É–¥–Ω–∏–∫¬ª (–æ–≤–µ—Ä–ª–µ–π –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω) */}
          {selectedPersonId && (
            <PersonPage
              person={people.find(p=>p.id===selectedPersonId)}
              projects={projects}
              assignments={assignments}
              setAssignments={setAssignments}
              projectTeams={projectTeams}
              vacations={vacations} setVacations={setVacations}
              weeks={visible}
              goLeft={goLeft} goRight={goRight} goToday={goToday}
              onClose={()=>setSelectedPersonId(null)}
            />
          )}

          {/* –î–≤–∞ –ø—Ä–æ—Å—Ç—ã—Ö –º–æ–¥–∞–ª—å–Ω—ã—Ö ¬´–∫–∞–∫ —Ä–∞–Ω—å—à–µ¬ª ‚Äî –∑–∞–≥–ª—É—à–∫–∏ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ */}
          {newProjectOpen && (
            <Modal onClose={()=>setNewProjectOpen(false)} title="–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç">
              <div className="text-sm text-neutral-600">–ó–¥–µ—Å—å —Ñ–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ (–æ—Å—Ç–∞–≤–∏–ª –∫–∞–∫ –±—ã–ª–æ).</div>
            </Modal>
          )}
          {newPersonOpen && (
            <Modal onClose={()=>setNewPersonOpen(false)} title="–ù–æ–≤—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫">
              <div className="text-sm text-neutral-600">–ó–¥–µ—Å—å —Ñ–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (–æ—Å—Ç–∞–≤–∏–ª –∫–∞–∫ –±—ã–ª–æ).</div>
            </Modal>
          )}
        </div>
      );
    }

    /* ---------------- Projects page (–∫–æ—Ä–æ—Ç–∫–æ, –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ª–æ–≥–∏–∫–∏) ---------------- */
    function ProjectsPage({projects, setProjects, people, projectTeams, setProjectTeams}){
      const Minus = ()=>(
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>
      );
      const Eyedrop = ()=>(
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 2l3 3-7.5 7.5"/><path d="M16 5l3 3"/><path d="M9 11l-6 6v3h3l6-6"/></svg>
      );
      const del = (id)=> setProjects(ps=>ps.filter(p=>p.id!==id));
      return (
        <div className="grid" style={{gridTemplateColumns:`300px 1fr`}}>
          {projects.map(p=>(
            <Fragment key={p.id}>
              <div className="sticky left-0 z-30 bg-[#F7F8FA] border-r border-neutral-200 p-1">
                <div className="relative bg-white rounded-2xl border border-neutral-200 shadow-sm p-3 flex items-center gap-3 h-[120px]">
                  <button className="w-8 h-8 rounded-lg grid place-items-center" style={{background:p.color}}><StatusIcon status={p.status}/></button>
                  <div className="font-medium truncate">{p.name}</div>
                  <button className="absolute top-2 right-10 w-7 h-7 rounded-lg grid place-items-center hover:bg-neutral-50" title="–ò–∑–º–µ–Ω–∏—Ç—å —Ü–≤–µ—Ç" onClick={()=>document.getElementById(`c-${p.id}`)?.click()}><Eyedrop/></button>
                  <input id={`c-${p.id}`} type="color" className="hidden" value={p.color} onChange={(e)=>setProjects(ps=>ps.map(x=>x.id===p.id?{...x,color:e.target.value}:x))}/>
                  <button className="absolute top-2 right-2 w-7 h-7 rounded-lg grid place-items-center hover:bg-red-50 text-red-600 border border-red-200" onClick={()=>del(p.id)}><Minus/></button>
                </div>
              </div>
              <div className="border border-neutral-200 p-3">
                <div className="bg-white rounded-2xl border border-neutral-200 shadow-sm p-3">
                  <div className="text-sm text-neutral-600">–ö–æ–º–∞–Ω–¥–∞ –ø—Ä–æ–µ–∫—Ç–∞ ‚Äî –æ—Å—Ç–∞–≤–∏–ª –∫–∞–∫ –±—ã–ª–æ —É –≤–∞—Å –≤ index3.</div>
                </div>
              </div>
            </Fragment>
          ))}
        </div>
      );
    }

    /* ---------------- Employees page (–∫—Ä–∞—Ç–∫–æ) ---------------- */
    function EmployeesPage({people, setPeople, projects, projectTeams, setProjectTeams}){
      const [q, setQ] = useState("");
      const list = people.filter(p=>p.active && p.name.toLowerCase().includes(q.toLowerCase()));
      return (
        <div className="space-y-3">
          <input value={q} onChange={e=>setQ(e.target.value)} placeholder="–ù–∞–π—Ç–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞..."
                 className="w-full border border-neutral-300 rounded-xl px-3 py-2 text-sm"/>
          <div className="grid" style={{gridTemplateColumns:`300px 1fr`}}>
            {list.map(p=>(
              <Fragment key={p.id}>
                <div className="sticky left-0 z-30 bg-[#F7F8FA] border-r border-neutral-200 p-1">
                  <div className="bg-white rounded-2xl border border-neutral-200 shadow-sm p-3 h-[120px] flex flex-col justify-center">
                    <div className="font-medium truncate">{p.name}</div>
                    <div className="text-[11px] text-neutral-600">{String(p.role||"").toUpperCase()}</div>
                  </div>
                </div>
                <div className="border border-neutral-200 p-3">
                  <div className="bg-white rounded-2xl border border-neutral-200 shadow-sm p-3 text-sm text-neutral-600">
                    –†–µ–¥–∞–∫—Ç–æ—Ä –ø—Ä–æ–µ–∫—Ç–æ–≤ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ ‚Äî –∫–∞–∫ –≤ index3 (—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω).
                  </div>
                </div>
              </Fragment>
            ))}
          </div>
        </div>
      );
    }

    /* ---------------- Person page ---------------- */
    function PersonPage({person, projects, assignments, setAssignments, projectTeams, vacations, setVacations, weeks, goLeft, goRight, goToday, onClose}){
      const isVacation = (pid,w) => !!vacations[pid]?.has?.(w);

      // –ø—Ä–æ–µ–∫—Ç—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (–ø–æ—Ä—è–¥–æ–∫ ‚Äî –ø—Ä–æ—Å—Ç–æ–π: –∫–∞–∫ –≤ assignments/team)
      const projIds = Array.from(new Set([
        ...assignments.filter(a=>a.personId===person.id).map(a=>a.projectId),
        ...Object.entries(projectTeams).filter(([_,set])=>set.has(person.id)).map(([id])=>id)
      ]));

      // Œ£ –ø–æ –Ω–µ–¥–µ–ª—è–º –¥–ª—è –±–µ–π–¥–∂–∞ –≤ —à–∞–ø–∫–µ
      const weekBadge = {};
      weeks.forEach(w=>{
        const sum = assignments.filter(a=>a.personId===person.id && a.weekStart===w).reduce((s,a)=>s+a.fte,0);
        weekBadge[w] = `Œ£ ${fmtFTE1(sum)}`;
      });

      const [editKey, setEditKey] = useState(null);
      const [val, setVal] = useState("");
      const begin = (pr,w,cur)=>{ if(isVacation(person.id,w)) return; setEditKey(`${pr}|${w}`); setVal(fmtFTE1(cur||0)); };
      const commit = (pr,w)=>{
        const k=`${pr}|${w}`; if(editKey!==k) return;
        const next=parseFloat((val||"").replace(",","."));
        setEditKey(null);
        if(isNaN(next)||next<0||next>MAX_FTE) return;
        setAssignments(prev=>{
          const rest=prev.filter(a=>!(a.personId===person.id && a.projectId===pr && a.weekStart===w));
          return [...rest, {id:Math.random().toString(36).slice(2), personId:person.id, projectId:pr, weekStart:w, fte:next}];
        });
      };

      return (
        <div className="fixed inset-0 z-50 bg-[#F7F8FA] overflow-auto">
          {/* –ª–∏–ø–∫–∞—è —à–∞–ø–∫–∞ —Å —Ç—Ä–µ–º—è –∫–Ω–æ–ø–∫–∞–º–∏ */}
          <div className="sticky top-0 z-50 border-b border-neutral-200 bg-white/90 backdrop-blur" style={{height:'var(--app-header-h)'}}>
            <div className="max-w-screen-2xl mx-auto px-4 h-full flex items-center gap-4">
              <div className="text-lg font-semibold tracking-tight text-green-600">–ü–∞–Ω–∫–≤–µ–± FTE Planner</div>
              <div className="segmented">
                <button className="active" onClick={()=>{ onClose(); }}>–ù–∞–≥—Ä—É–∑–∫–∞</button>
                <button onClick={()=>{ onClose(); }}>–ö–æ–º–∞–Ω–¥–∞</button>
                <button onClick={()=>{ onClose(); }}>–ü—Ä–æ–µ–∫—Ç—ã</button>
              </div>
              <div className="ml-auto"/>
            </div>
          </div>

          {/* —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ–¥–µ–ª—è–º–∏ */}
          <div className="max-w-screen-2xl mx-auto px-4 sticky top-[var(--app-header-h)] z-40 bg-[#F7F8FA] py-2">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <div className="text-lg font-semibold">{person.name}</div>
                <div className="text-[11px] px-2 py-0.5 rounded-full bg-neutral-100 border border-neutral-200">{String(person.role||"other").toUpperCase()}</div>
                <button className="ml-2 px-2 py-1 rounded-lg border border-amber-300 bg-amber-50 text-amber-800">üèñ –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—É—Å–∫</button>
              </div>
              <div className="flex items-center gap-2">
                <button className="btn" onClick={goLeft}>‚Äπ</button>
                <button className="btn" onClick={goToday}>–°–µ–≥–æ–¥–Ω—è</button>
                <button className="btn" onClick={goRight}>‚Ä∫</button>
                <button className="btn" onClick={onClose}>–ó–∞–∫—Ä—ã—Ç—å</button>
              </div>
            </div>
          </div>

          {/* —à–∞–ø–∫–∞ –±–∞—Ä–∞ (—Å Œ£ –±–µ–π–¥–∂–∞–º–∏) */}
          <div className="max-w-screen-2xl mx-auto px-4">
            <CalendarHeader visible={weeks} leftLabel="–ü—Ä–æ–µ–∫—Ç—ã" weekBadgeByISO={weekBadge}/>
          </div>

          {/* —Å–µ—Ç–∫–∞ –∫–∞–∫ –Ω–∞ ¬´–ù–∞–≥—Ä—É–∑–∫–∞¬ª: —Å–ª–µ–≤–∞ –ø—Ä–æ–µ–∫—Ç, —Å–ø—Ä–∞–≤–∞ —Å—Ç–æ–ª–±—Ü—ã –Ω–µ–¥–µ–ª—å —Å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º */}
          <div className="max-w-screen-2xl mx-auto px-4">
            <div className="grid" style={{gridTemplateColumns:`var(--left-col-w) repeat(${weeks.length}, ${WEEK_COL_PX}px)`}}>
              {projIds.map(prid=>{
                const pr = projects.find(p=>p.id===prid); if(!pr) return null;
                return (
                  <Fragment key={prid}>
                    <div className="sticky left-0 z-30 bg-[#F7F8FA] border-r border-neutral-200 p-1">
                      <div className="bg-white rounded-2xl shadow-sm h-[120px] flex items-center gap-2 pl-5 pr-3">
                        <span className="w-6 h-6 rounded-lg grid place-items-center" style={{background:pr.color}}><StatusIcon status={pr.status}/></span>
                        <div className="font-medium truncate">{pr.name}</div>
                      </div>
                    </div>
                    {weeks.map(week=>{
                      const f = fteFor(assignments, person.id, prid, week);
                      const ratio = scaleRatio(f);
                      const vac = isVacation(person.id, week);
                      const k = `${prid}|${week}`;
                      const editing = (editKey===k);
                      return (
                        <div key={`${prid}-${week}`} className="p-1 h-[120px]">
                          <div className="bg-white rounded-2xl shadow-sm h-full flex items-end justify-center relative">
                            <div className="relative w-14 h-[92%] rounded-lg bg-neutral-200 overflow-hidden">
                              {!vac && (<div className="absolute bottom-0 left-0 right-0" style={{height:`${ratio*100}%`, background:pr.color}} />)}
                            </div>
                            {!vac && (!editing ? (
                              <div className="absolute inset-0 text-sm font-semibold text-neutral-800 grid place-items-center"
                                   title={fmtFTE1(f)} onClick={()=>begin(prid, week, f)}>{fmtFTE1(f)}</div>
                            ) : (
                              <input autoFocus value={val} onChange={e=>setVal(e.target.value)}
                                     className="absolute inset-0 m-auto h-8 w-16 text-center text-sm font-semibold border border-neutral-300 rounded-md bg-white shadow-sm"
                                     onBlur={()=>commit(prid, week)}
                                     onKeyDown={(e)=>{ if(e.key==="Enter") e.currentTarget.blur(); if(e.key==="Escape") setEditKey(null); }}/>
                            ))}
                            {vac && (<div className="absolute inset-0 grid place-items-center text-2xl">üèñ</div>)}
                          </div>
                        </div>
                      );
                    })}
                  </Fragment>
                );
              })}
            </div>
          </div>
        </div>
      );
    }

    /* ---------------- Small Modal ---------------- */
    function Modal({title, children, onClose}){
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center" onClick={onClose}>
          <div className="absolute inset-0 bg-black/40"/>
          <div className="relative bg-white rounded-2xl shadow-xl border border-neutral-200 w-[520px] p-4" onClick={(e)=>e.stopPropagation()}>
            <div className="text-base font-semibold mb-3">{title}</div>
            {children}
            <div className="mt-4 text-right"><button className="btn" onClick={onClose}>–ó–∞–∫—Ä—ã—Ç—å</button></div>
          </div>
        </div>
      );
    }

    /* ---------------- Auth (–∫–∞–∫ –±—ã–ª–æ) ---------------- */
    function AuthForm({onSuccess}){
      const [login, setLogin] = useState(""); const [pass, setPass] = useState(""); const [remember, setRemember] = useState(false);
      const submit = (e)=>{ e.preventDefault(); if(login.trim().toLowerCase()==="–ø–∞–Ω–∫–≤–µ–±" && pass==="123455"){ onSuccess(remember); } else { alert("–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"); } };
      return (
        <form onSubmit={submit} className="space-y-3">
          <div><label className="block text-sm mb-1">–õ–æ–≥–∏–Ω</label><input value={login} onChange={e=>setLogin(e.target.value)} className="w-full border border-neutral-300 rounded-lg px-3 py-2"/></div>
          <div><label className="block text-sm mb-1">–ü–∞—Ä–æ–ª—å</label><input type="password" value={pass} onChange={e=>setPass(e.target.value)} className="w-full border border-neutral-300 rounded-lg px-3 py-2"/></div>
          <label className="flex items-center gap-2 text-sm select-none"><input type="checkbox" checked={remember} onChange={e=>setRemember(e.target.checked)} />–ó–∞–ø–æ–º–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</label>
          <button className="w-full rounded-xl border border-emerald-300 bg-emerald-50 text-emerald-800 py-2">–í–æ–π—Ç–∏</button>
        </form>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
