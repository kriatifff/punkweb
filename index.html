<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ü–∞–Ω–∫–≤–µ–± FTE Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- React & Babel (UMD) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --app-header-h: 56px;
      --left-col-w: 220px;
    }
    .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }
    .no-scrollbar::-webkit-scrollbar{ display:none; }

    .btn{
      border-radius: 0.75rem;
      border: 1px solid rgb(212 212 216);
      background: #fff;
      padding: 0.25rem 0.75rem;
      box-shadow: 0 1px 1px rgba(0,0,0,.05);
      transition: box-shadow .15s ease;
    }
    .btn:hover{ box-shadow: 0 2px 6px rgba(0,0,0,.08); }

    .segmented{
      display:flex; align-items:center; gap:0.75rem;
      background:#f5f5f5;
      border:1px solid #e5e7eb;
      border-radius: 1rem; padding: 0.25rem 0.5rem;
      box-shadow: 0 1px 1px rgba(0,0,0,.04);
    }
    .segmented > button{
      padding: 0.25rem 0.75rem;
      border-radius: 0.75rem;
      margin: 0 2px;
      transition: background .15s ease, box-shadow .15s ease;
    }
    .segmented > button.active{
      background:#fff; box-shadow: 0 1px 1px rgba(0,0,0,.05);
    }
    .segmented > button.idle:hover{
      background: rgba(255,255,255,.7);
    }
  </style>
</head>
<body class="bg-[#F7F8FA] no-scrollbar">
  <div id="root"></div>

  <!-- –í–ê–ñ–ù–û: –≤–∫–ª—é—á–∞–µ–º preset env, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ -->
  <script type="text/babel" data-presets="env,react">
    const {useState, useEffect, useMemo, useRef, Fragment} = React;

    // ---------- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ----------
    const MAX_FTE = 1.2;
    const WEEK_COL_PX = 72;
    const TEAM_BAR_COLOR = "#22c55e";
    const VISIBLE_WEEKS = 16;

    // ==== —á–∞—Å—ã ====
    const HOURS_PER_WEEK = 40;
    const BAR_MAX_HOURS = 40;

    const fteToHours = (fte) => Math.round((Number(fte)||0) * HOURS_PER_WEEK);
    const hoursToFte = (hours) => {
      const h = Math.max(0, Math.round(Number(hours)||0));
      return h / HOURS_PER_WEEK;
    };
    const fmtHours = (h) => String(Math.round(Number(h)||0));
    const fillRatio = (h) => {
      const v = Math.min(Math.max(0, Math.round(Number(h)||0)), BAR_MAX_HOURS);
      return v / BAR_MAX_HOURS;
    };

    // ---------- Persistence ----------
    const LS_KEY = "fteplanner.v1";
    function loadAll(){
      try{ return JSON.parse(localStorage.getItem(LS_KEY)||"{}"); }catch(e){ return {}; }
    }
    function loadJSON(key, fallback){
      const all = loadAll();
      return (all && (key in all)) ? all[key] : fallback;
    }
    function saveJSON(patch){
      try{
        const all = loadAll();
        const merged = Object.assign({}, all, patch);
        localStorage.setItem(LS_KEY, JSON.stringify(merged));
        debouncedSaveAllRemote(merged);
      }catch(e){}
    }
    async function loadAllRemote(){ return null; }
    async function saveAllRemote(_state){}
    let saveTimer=null;
    function debouncedSaveAllRemote(state){
      if(saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(function(){ try{ saveAllRemote(state); }catch(e){} }, 400);
    }

    // ---------- –î–∞—Ç—ã/—Ñ–æ—Ä–º–∞—Ç—ã ----------
    const fmtISO = (date) => date.toISOString().slice(0,10);
    const addDays = (d, n) => { const x=new Date(d); x.setDate(x.getDate()+n); x.setHours(0,0,0,0); return x; };
    const pad2 = (n) => (n<10 ? ("0"+n) : String(n));
    const fmtDM = (d) => pad2(d.getDate())+"."+pad2(d.getMonth()+1);
    const RU_MONTHS = ["—è–Ω–≤","—Ñ–µ–≤","–º–∞—Ä","–∞–ø—Ä","–º–∞–π","–∏—é–Ω","–∏—é–ª","–∞–≤–≥","—Å–µ–Ω","–æ–∫—Ç","–Ω–æ—è","–¥–µ–∫"];
    const ruMonthShort = (m) => (RU_MONTHS[m] ? RU_MONTHS[m] : "");
    const startOfISOWeek = (d) => {
      const day=d.getDay(); const diff=(day===0?-6:1)-day;
      const m=new Date(d); m.setDate(d.getDate()+diff); m.setHours(0,0,0,0); return m;
    };
    const addWeeks = (m, n) => { const d=new Date(m); d.setDate(d.getDate()+n*7); d.setHours(0,0,0,0); return d; };
    const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
    const scaleRatio = (v, max) => { if(typeof max!=="number") max=MAX_FTE; return clamp(v/max, 0, 1); };
    const weekLabelParts = (iso) => { const d=new Date(iso); const w=1+Math.floor((d.getDate()-1)/7); return { top:(w+" –Ω–µ–¥"), bot:ruMonthShort(d.getMonth()) }; };
    const weekRangeLabel = (iso) => { const d=new Date(iso); const end=addDays(d,6); return fmtDM(d)+"‚Äì"+fmtDM(end); };
    const rndId = () => {
      try{
        if(window && window.crypto && typeof window.crypto.randomUUID==="function"){
          return window.crypto.randomUUID();
        }
      }catch(e){}
      return Math.random().toString(36).slice(2)+"_"+Date.now();
    };
    const fmtFTE1 = (n) => (Math.round(n*10)/10).toFixed(1);
    const yearWeekMondays = (year) => {
      let m=startOfISOWeek(new Date(year,0,1));
      const end=new Date(year,11,31); end.setHours(0,0,0,0);
      const list=[]; while(m<=end){ list.push(fmtISO(m)); m=addDays(m,7); }
      return list;
    };

    const isWeekEnded = (weekISO) => {
      const end = addDays(new Date(weekISO), 6);
      const today = new Date(); today.setHours(0,0,0,0);
      return today > end;
    };

    // ---------- –î–∞–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ----------
    const base = startOfISOWeek(new Date());
    const initialWeeks = Array.from({length:24}, function(_,i){ return fmtISO(addWeeks(base, i-4)); });
    const seedPeople = [
      { id:"p1", name:"–°–∞—à–∞", role:"manager", capacityPerWeek:1, active:true, external:false },
      { id:"p2", name:"–ö–∞—Ç—è –ö.", role:"designer", capacityPerWeek:1, active:true, external:false },
    ];
    const seedProjects = [
      { id:"pr1", name:"HR –ü–æ–¥–∫–∞—Å—Ç—ã", status:"active", color:"#3b82f6" },
      { id:"pr2", name:"–ê—Ä–∫—Ç–∏–∫–∞ –ú–µ–¥–∏–∞", status:"active", color:"#f43f5e" },
      { id:"pr3", name:"–ü–∞–¥–µ–ª-—Ç–µ–Ω–Ω–∏—Å", status:"planned", color:"#06b6d4" },
    ];
    const seedAssignments = [
      { id:"a1", personId:"p1", projectId:"pr1", weekStart: initialWeeks[4], fte:0.3 },
      { id:"a2", personId:"p1", projectId:"pr2", weekStart: initialWeeks[4], fte:0.2 },
      { id:"a3", personId:"p2", projectId:"pr2", weekStart: initialWeeks[5], fte:0.4 },
    ];
    const seedRoles = ["designer","dev","manager","pm","other"];

    // ---------- –ê–≥—Ä–µ–≥–∞—Ü–∏–∏ ----------
    const personWeekTotal = (as, pid, w) => as.filter(function(a){return a.personId===pid && a.weekStart===w;}).reduce(function(s,a){return s+a.fte;},0);

    const effectiveFactHours = (a, w) => {
      var has = (a && a.factHours!=null && !isNaN(a.factHours));
      if(has) return Math.max(0, Math.round(Number(a.factHours)||0));
      if(isWeekEnded(w)) return Math.max(0, Math.round(fteToHours(a.fte)));
      return 0;
    };
    const personWeekFactTotal = (as, pid, w) =>
      as.filter(function(a){ return a.personId===pid && a.weekStart===w; })
        .reduce(function(s,a){ return s + effectiveFactHours(a,w); }, 0);

    const fteFor = (as, pid, pr, w) => as.filter(function(a){return a.personId===pid && a.projectId===pr && a.weekStart===w;}).reduce(function(s,a){return s+a.fte;},0);
    const mergeOrder = (existing, nextIds) => {
      const seen={}; const res=[];
      var i;
      for(i=0;i<(existing||[]).length;i++){
        var id = existing[i];
        if(nextIds.indexOf(id)!==-1 && !seen[id]){ res.push(id); seen[id]=true; }
      }
      for(i=0;i<nextIds.length;i++){
        var id2 = nextIds[i];
        if(!seen[id2]){ res.push(id2); seen[id2]=true; }
      }
      return res;
    };

    // ---------- Icons ----------
    function StatusIcon(props){
      const status = props.status;
      const common = { width:16, height:16, viewBox:"0 0 24 24", fill:"white" };
      if(status==="active") return (<svg {...common}><polygon points="8,5 19,12 8,19"/></svg>);
      if(status==="onhold") return (<svg {...common}><rect x="6" y="5" width="4" height="14"/><rect x="14" y="5" width="4" height="14"/></svg>);
      if(status==="done") return (<svg {...common}><rect x="6" y="6" width="12" height="12" rx="2"/></svg>);
      return (<svg {...common}><circle cx="12" cy="12" r="6"/></svg>);
    }
    const MinusIcon = ({className=""}) => (
      <svg className={className} width="16" height="16" viewBox="0 0 24 24" fill="none"
           stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="5" y1="12" x2="19" y2="12"/>
      </svg>
    );
    const PencilIcon = ({className=""}) => (
      <svg className={className} width="14" height="14" viewBox="0 0 24 24" fill="none"
           stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M12 20h9"/>
        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/>
      </svg>
    );
    const TrashIcon = ({className=""}) => (
      <svg className={className} width="14" height="14" viewBox="0 0 24 24" fill="none"
           stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="3 6 5 6 21 6"/>
        <path d="M19 6l-1 14a2 2 0 0 1 2 2H8a2 2 0 0 1-2-2L5 6"/>
        <path d="M10 11v6"/>
        <path d="M14 11v6"/>
        <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/>
      </svg>
    );
    const EyedropperIcon = ({className=""}) => (
      <svg className={className} width="16" height="16" viewBox="0 0 24 24" fill="none"
           stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" aria-hidden="true">
        <path d="M19 2l3 3-7.5 7.5"/>
        <path d="M16 5l3 3"/>
        <path d="M9 11l-6 6v3h3l6-6"/>
      </svg>
    );

    function WeekHeader({iso}){
      const parts = weekLabelParts(iso);
      return (
        <div className="h-[40px] flex items-center justify-center text-neutral-700">
          <span className="block text-center leading-tight" style={{width:WEEK_COL_PX}}>
            <div className="text-xs font-medium">{parts.top}</div>
            <div className="text-[10px]">{parts.bot}</div>
          </span>
        </div>
      );
    }

    // ---------- –û–∫–Ω–æ –Ω–µ–¥–µ–ª—å ----------
    function useWeeksWindow(){
      const [weeks, setWeeks] = useState(loadJSON("weeks", initialWeeks));
      const savedFirstISO = loadJSON("firstWeekISO", weeks[0]);
      const initIdx = Math.max(0, weeks.indexOf(savedFirstISO));
      const [firstIdx, setFirstIdx] = useState(initIdx);

      const ensureRange = (needIdx) => {
        // —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ —Å–ª–µ–≤–∞
        if(needIdx < 0){
          const first = new Date(weeks[0]);
          const addCount = Math.ceil((-needIdx)/8)*8;
          const prepend = [];
          for(var i=0;i<addCount;i++){ prepend.push(fmtISO(addWeeks(first, -(i+1)))); }
          prepend.reverse();
          const next = prepend.concat(weeks);
          setWeeks(next);
          return { weeks: next, firstIdx: needIdx + prepend.length };
        }
        // —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–∞
        if(needIdx + VISIBLE_WEEKS >= weeks.length){
          const last = new Date(weeks[weeks.length-1]);
          const more = [];
          for(var j=0;j<16;j++){ more.push(fmtISO(addWeeks(last, j+1))); }
          const next = weeks.concat(more);
          setWeeks(next);
          return { weeks: next, firstIdx: needIdx };
        }
        return { weeks: weeks, firstIdx: needIdx };
      };

      const goLeft = () => {
        const r = ensureRange(firstIdx-1);
        setFirstIdx(r.firstIdx);
        saveJSON({firstWeekISO: r.weeks[r.firstIdx]});
        saveJSON({weeks: r.weeks});
      };
      const goRight = () => {
        const r = ensureRange(firstIdx+1);
        setFirstIdx(r.firstIdx);
        saveJSON({firstWeekISO: r.weeks[r.firstIdx]});
        saveJSON({weeks: r.weeks});
      };

      // ¬´–°–µ–≥–æ–¥–Ω—è¬ª ‚Äî —Ç–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –ü–ï–†–í–û–ô –∫–æ–ª–æ–Ω–∫–æ–π
      const goToday = () => {
        const todayISO = fmtISO(startOfISOWeek(new Date()));
        var idx = weeks.indexOf(todayISO);
        var next = weeks.slice();
        if(idx<0){
          // –¥–æ–±–∞–≤–∏–º —Ç–µ–∫—É—â—É—é –∏ —Å–ª–µ–¥—É—é—â–∏–µ –Ω–µ–¥–µ–ª–∏ (–º–∏–Ω–∏–º—É–º VISIBLE_WEEKS)
          const needLen = Math.max(VISIBLE_WEEKS, 24);
          const need = [];
          for(var k=0;k<needLen;k++){ need.push(fmtISO(addWeeks(new Date(todayISO), k))); }
          const set = {};
          for(var z=0; z<next.length; z++){ set[next[z]] = true; }
          for(var q=0; q<need.length; q++){ if(!set[need[q]]){ next.push(need[q]); set[need[q]]=true; } }
          next.sort(); // ISO —Å—Ç—Ä–æ–∫–∏ —Å–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
          setWeeks(next);
          saveJSON({weeks: next});
          idx = next.indexOf(todayISO);
        }
        setFirstIdx(idx);
        saveJSON({firstWeekISO: next[idx]});
      };

      const visible = useMemo(function(){ return weeks.slice(firstIdx, firstIdx+VISIBLE_WEEKS); }, [weeks, firstIdx]);

      return {weeks, setWeeks, firstIdx, setFirstIdx, visible, goLeft, goRight, goToday};
    }

    // =================================
    // –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    // =================================
    function App(){
      const [people, setPeople] = useState(loadJSON("people", seedPeople));
      const [projects, setProjects] = useState(loadJSON("projects", seedProjects));
      const [assignments, setAssignments] = useState(loadJSON("assignments", seedAssignments));
      const [roles, setRoles] = useState(loadJSON("roles",[].concat(seedRoles)));
      const [projectTeams, setProjectTeams] = useState(function(){
        const saved = loadJSON("projectTeams", {});
        const map = {};
        for(const k in saved){ if(Object.prototype.hasOwnProperty.call(saved,k)){ map[k]=new Set(saved[k]); } }
        if(Object.keys(map).length===0){
          for(var i=0;i<seedProjects.length;i++){ map[seedProjects[i].id]=new Set(); }
          for(var j=0;j<seedAssignments.length;j++){
            var a=seedAssignments[j]; if(!map[a.projectId]) map[a.projectId]=new Set();
            map[a.projectId].add(a.personId);
          }
        }
        return map;
      });
      const [vacations, setVacations] = useState(function(){
        const saved = loadJSON("vacations", {});
        const map = {}; for(const k in saved){ if(Object.prototype.hasOwnProperty.call(saved,k)){ map[k]=new Set(saved[k]); } }
        return map;
      });
      const [personProjectOrder, setPersonProjectOrder] = useState(loadJSON("personProjectOrder", {}));
      const [teamOrder, setTeamOrder] = useState(function(){ return loadJSON("teamOrder", seedPeople.map(function(p){return p.id;})); });

      const [authed, setAuthed] = useState(loadJSON("authed", false));

      const [view, setView] = useState(loadJSON("view","team"));
      useEffect(function(){ saveJSON({view:view}); }, [view]);

      const [selectedPersonId, setSelectedPersonId] = useState(null);

      const {weeks, setWeeks, visible, goLeft, goRight, goToday} = useWeeksWindow();

      useEffect(function(){
        (async function(){
          try{
            const remote = await loadAllRemote();
            if(remote && typeof remote==="object"){
              localStorage.setItem(LS_KEY, JSON.stringify(remote));
              if(remote.people) setPeople(remote.people);
              if(remote.projects) setProjects(remote.projects);
              if(remote.assignments) setAssignments(remote.assignments);
              if(remote.roles) setRoles(remote.roles);
              if(remote.projectTeams){
                const map={}; for(const k in remote.projectTeams){ if(Object.prototype.hasOwnProperty.call(remote.projectTeams,k)){ map[k]=new Set(remote.projectTeams[k]); } }
                setProjectTeams(map);
              }
              if(remote.vacations){
                const map2={}; for(const k2 in remote.vacations){ if(Object.prototype.hasOwnProperty.call(remote.vacations,k2)){ map2[k2]=new Set(remote.vacations[k2]); } }
                setVacations(map2);
              }
              if(remote.personProjectOrder) setPersonProjectOrder(remote.personProjectOrder);
              if(remote.teamOrder) setTeamOrder(remote.teamOrder);
              if(remote.weeks) setWeeks(remote.weeks);
            }
          }catch(e){}
        })();
      }, []);

      // –ê–≤—Ç–æ–ø–µ—Ä–µ–Ω–æ—Å –ø–ª–∞–Ω–∞ -> —Ñ–∞–∫—Ç –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω–µ–¥–µ–ª–∏ (–µ—Å–ª–∏ —Ñ–∞–∫—Ç –µ—â—ë –Ω–µ –∑–∞–¥–∞–Ω)
      useEffect(function(){
        setAssignments(function(prev){
          var changed=false;
          const next = prev.map(function(a){
            var has = (a && a.factHours!=null && !isNaN(a.factHours));
            if(!has && isWeekEnded(a.weekStart)){
              const v = Math.max(0, Math.round(fteToHours(a.fte)));
              if(a.factHours!==v){ changed=true; var b=Object.assign({}, a); b.factHours=v; return b; }
            }
            return a;
          });
          return changed ? next : prev;
        });
      }, [weeks]);

      useEffect(function(){ saveJSON({people:people}); }, [people]);
      useEffect(function(){ saveJSON({projects:projects}); }, [projects]);
      useEffect(function(){ saveJSON({assignments:assignments}); }, [assignments]);
      useEffect(function(){ saveJSON({roles:roles}); }, [roles]);
      useEffect(function(){
        const obj={}; for(const k in projectTeams){ if(Object.prototype.hasOwnProperty.call(projectTeams,k)){ obj[k]=Array.from(projectTeams[k]); } }
        saveJSON({projectTeams:obj});
      }, [projectTeams]);
      useEffect(function(){
        const obj={}; for(const k in vacations){ if(Object.prototype.hasOwnProperty.call(vacations,k)){ obj[k]=Array.from(vacations[k]); } }
        saveJSON({vacations:obj});
      }, [vacations]);
      useEffect(function(){ saveJSON({personProjectOrder:personProjectOrder}); }, [personProjectOrder]);
      useEffect(function(){ saveJSON({teamOrder:teamOrder}); }, [teamOrder]);

      // helpers
      const isVacation = function(pid,w){
        const set = vacations[pid];
        return !!(set && set.has && set.has(w));
      };
      const dragRow = useRef(null);

      const peopleForTeam = useMemo(function(){ return people.filter(function(p){ return p.active && !p.external; }); }, [people]);
      const peopleActiveAll = useMemo(function(){ return people.filter(function(p){ return p.active; }); }, [people]);

      useEffect(function(){
        setTeamOrder(function(prev){ return mergeOrder(prev, peopleForTeam.map(function(p){return p.id;})); });
      }, [peopleForTeam]);

      const [roleFilter, setRoleFilter] = useState(loadJSON("roleFilter","all"));
      useEffect(function(){ saveJSON({roleFilter:roleFilter}); }, [roleFilter]);

      const activeTeamIds = useMemo(function(){ return teamOrder.filter(function(id){ return peopleForTeam.some(function(p){return p.id===id;}); }); }, [teamOrder, peopleForTeam]);
      const filteredTeamIds = useMemo(function(){
        return activeTeamIds.filter(function(id){
          if(roleFilter==="all") return true;
          const p = people.find(function(x){return x.id===id;});
          return p ? (p.role===roleFilter) : false;
        });
      }, [activeTeamIds, roleFilter, people]);

      function deletePerson(pid){
        if(!confirm("–£–¥–∞–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞?")) return;
        setPeople(function(prev){ return prev.filter(function(p){return p.id!==pid;}); });
        setAssignments(function(prev){ return prev.filter(function(a){return a.personId!==pid;}); });
        setVacations(function(prev){
          const c={};
          for(const k in prev){ if(Object.prototype.hasOwnProperty.call(prev,k)){ if(k!==pid){ c[k]=new Set(prev[k]); } } }
          return c;
        });
        setProjectTeams(function(prev){
          const c={};
          for(const k in prev){ if(Object.prototype.hasOwnProperty.call(prev,k)){ const s=new Set(prev[k]); s.delete(pid); c[k]=s; } }
          return c;
        });
        setTeamOrder(function(prev){ return prev.filter(function(id){return id!==pid;}); });
        if(selectedPersonId===pid) setSelectedPersonId(null);
      }
      function deleteProject(prid){
        if(!confirm("–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç?")) return;
        setProjects(function(prev){ return prev.filter(function(p){return p.id!==prid;}); });
        setAssignments(function(prev){ return prev.filter(function(a){return a.projectId!==prid;}); });
        setProjectTeams(function(prev){
          const c={};
          for(const k in prev){ if(Object.prototype.hasOwnProperty.call(prev,k)){ if(k!==prid){ c[k]=new Set(prev[k]); } } }
          return c;
        });
        setPersonProjectOrder(function(prev){
          const out={};
          for(const pid in prev){
            if(Object.prototype.hasOwnProperty.call(prev,pid)){
              out[pid] = (prev[pid]||[]).filter(function(x){return x!==prid;});
            }
          }
          return out;
        });
      }

      const dragProjectIndex = useRef(null);
      const onProjectDragStart = function(i){ dragProjectIndex.current = i; };
      const onProjectDrop = function(i){
        const from = dragProjectIndex.current;
        dragProjectIndex.current = null;
        if(from==null || from===i) return;
        setProjects(function(prev){
          const arr = prev.slice();
          const moved = arr.splice(from,1)[0];
          arr.splice(i,0,moved);
          return arr;
        });
      };

      // create person
      const [createPersonOpen, setCreatePersonOpen] = useState(false);
      const [newPersonName, setNewPersonName] = useState("");
      const [newPersonRole, setNewPersonRole] = useState("other");
      const [newPersonExternal, setNewPersonExternal] = useState(false);
      function submitNewPerson(){
        const name = (newPersonName||"").trim(); if(!name) return;
        const id = rndId();
        setPeople(function(p){ return p.concat([{ id:id, name:name, role:newPersonRole||"other", capacityPerWeek:1, active:true, external: !!newPersonExternal }]); });
        setCreatePersonOpen(false); setNewPersonName(""); setNewPersonRole("other"); setNewPersonExternal(false);
      }

      // create project
      const [createProjectOpen, setCreateProjectOpen] = useState(false);
      const [newProjectName, setNewProjectName] = useState("");
      const [newProjectColor, setNewProjectColor] = useState("#3b82f6");
      const [newProjectStatus, setNewProjectStatus] = useState("active");
      const [projSearch, setProjSearch] = useState("");
      const [projTeamSel, setProjTeamSel] = useState(function(){ return new Set(); });
      const personSuggestions = useMemo(function(){
        return peopleActiveAll.filter(function(p){
          return p.name.toLowerCase().indexOf(projSearch.toLowerCase())!==-1 && !projTeamSel.has(p.id);
        }).slice(0,6);
      }, [peopleActiveAll, projSearch, projTeamSel]);
      function submitNewProject(){
        const name = (newProjectName||"").trim(); if(!name) return;
        const id = rndId(); const color = newProjectColor || "#64748b"; const status = newProjectStatus;
        setProjects(function(ps){ return ps.concat([{ id:id, name:name, color:color, status:status }]); });
        setProjectTeams(function(pt){
          const copy={};
          for(const k in pt){ if(Object.prototype.hasOwnProperty.call(pt,k)){ copy[k]=new Set(pt[k]); } }
          copy[id]=new Set(projTeamSel);
          return copy;
        });
        setCreateProjectOpen(false); setNewProjectName(""); setProjSearch(""); setProjTeamSel(new Set()); setNewProjectStatus("active"); setView("project");
      }

      if(!authed){
        return (
          <div className="min-h-screen grid place-items-center bg-[#F7F8FA]">
            <div className="bg-white w-[360px] rounded-2xl shadow-lg border border-neutral-200 p-5">
              <div className="text-center mb-4"><div className="text-2xl font-semibold">–í—Ö–æ–¥</div></div>
              <AuthForm onSuccess={function(remember){ if(remember){ saveJSON({authed:true, remember:true}); } else { saveJSON({remember:false, authed:false}); } setAuthed(true); }} />
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-[#F7F8FA] text-neutral-900 font-sans">
          {/* –®–∞–ø–∫–∞ */}
          <header className="sticky top-0 z-50 border-b border-neutral-200 bg-white/90 backdrop-blur" style={{height:'var(--app-header-h)'}}>
            <div className="max-w-screen-2xl mx-auto px-4 h-full flex items-center gap-3">
              <div className="text-lg font-semibold tracking-tight text-green-600">–ü–∞–Ω–∫–≤–µ–± FTE Planner</div>
              <div className="ml-4 segmented">
                <button className={view==="team" ? "active" : "idle" } onClick={function(){setView("team");}}>–ù–∞–≥—Ä—É–∑–∫–∞</button>
                <button className={view==="project" ? "active" : "idle"} onClick={function(){setView("project");}}>–ü—Ä–æ–µ–∫—Ç—ã</button>
                <button className={view==="employees" ? "active" : "idle"} onClick={function(){setView("employees");}}>–ö–æ–º–∞–Ω–¥–∞</button>
              </div>
              <div className="ml-auto flex items-center gap-2">
                <button onClick={function(){setCreateProjectOpen(true);}} className="btn">+ –ü—Ä–æ–µ–∫—Ç</button>
                <button onClick={function(){setCreatePersonOpen(true);}} className="btn">+ –°–æ—Ç—Ä—É–¥–Ω–∏–∫</button>
              </div>
            </div>
          </header>

          <main className="max-w-screen-2xl mx-auto p-4">
            {view==="team" && (
              <WeekNavigator
                onLeft={goLeft}
                onRight={goRight}
                onToday={goToday}
                showRoleFilter={true}
                roleFilter={roleFilter}
                setRoleFilter={setRoleFilter}
                roles={roles}
              />
            )}

            {view==="team" ? (
              // -------- –ù–∞–≥—Ä—É–∑–∫–∞ --------
              <div className="grid" style={{gridTemplateColumns:"var(--left-col-w) repeat("+visible.length+", "+WEEK_COL_PX+"px)"}}>
                <div className="sticky left-0 z-50 bg-[#F7F8FA] backdrop-blur border-r border-neutral-200 p-2 text-sm font-medium" />
                {visible.map(function(w){ return (<div key={w} className="border-b border-neutral-200"><WeekHeader iso={w}/></div>); })}
                {filteredTeamIds.map(function(pid, rowIdx){
                  const person = people.find(function(p){return p.id===pid;});
                  return (
                    <Fragment key={pid}>
                      <div
                        className="sticky left-0 z-50 bg-[#F7F8FA] backdrop-blur border-r border-neutral-200 p-1"
                        draggable
                        onDragStart={function(){ dragRow.current=rowIdx; }}
                        onDragOver={function(e){e.preventDefault();}}
                        onDrop={function(){
                          const from=dragRow.current; const to=rowIdx; if(from==null || from===to) return;
                          const arr=filteredTeamIds.slice(); const id=arr.splice(from,1)[0]; arr.splice(to,0,id);
                          const inactive = teamOrder.filter(function(x){ return filteredTeamIds.indexOf(x)===-1; });
                          setTeamOrder(arr.concat(inactive)); dragRow.current=null;
                        }}
                      >
                        <div
                          role="button"
                          tabIndex={0}
                          onClick={function(){setSelectedPersonId(person.id);}}
                          onKeyDown={function(e){ if(e.key==='Enter'||e.key===' '){ setSelectedPersonId(person.id); } }}
                          className="w-full text-left"
                        >
                          <div className="relative bg-white rounded-2xl shadow-sm h-[120px] flex flex-col justify-center pl-5 pr-8 hover:shadow-md hover:bg-blue-50/70 transition">
                            <div className="font-medium truncate" title="–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞">{person.name}</div>
                            <div className="mt-1 text-[11px] text-neutral-600">{String(person.role||"").toUpperCase()}</div>
                          </div>
                        </div>
                      </div>

                      {visible.map(function(week){
                        const totalFte = personWeekTotal(assignments, person.id, week);
                        const totalHoursPlan = Math.round(totalFte * HOURS_PER_WEEK);
                        const ratio = fillRatio(totalHoursPlan);
                        const vac = isVacation(person.id, week);
                        const over = totalHoursPlan > HOURS_PER_WEEK;

                        const factSum = personWeekFactTotal(assignments, person.id, week);
                        const hasAnyFactOrEnded = (factSum>0 || isWeekEnded(week));

                        return (
                          <div key={week+pid} className="p-1 bg-transparent h-[120px] relative">
                            <div className={"bg-white rounded-2xl shadow-sm h-full flex items-end justify-center relative "+(over ? "ring-2 ring-red-300" : "")}>
                              <div className="relative w-14 h-[92%] rounded-lg bg-neutral-200 overflow-hidden">
                                {!vac && (<div className="absolute bottom-0 left-0 right-0" style={{height:(ratio*100)+"%", background:TEAM_BAR_COLOR}} />)}
                              </div>
                              {!vac && (
                                <div className="absolute inset-0 flex items-center justify-center" title={"–ø–ª–∞–Ω: "+totalHoursPlan+" —á"+(hasAnyFactOrEnded ? (", —Ñ–∞–∫—Ç: "+factSum+" —á") : "")}>
                                  <div className="leading-tight text-center">
                                    <div className="text-sm font-semibold text-neutral-900">{fmtHours(totalHoursPlan)}</div>
                                    <div className="text-[11px] font-normal text-neutral-500 mt-0.5">{hasAnyFactOrEnded ? fmtHours(factSum) : "‚Äî"}</div>
                                  </div>
                                </div>
                              )}
                              {vac && (<div className="absolute inset-0 flex items-center justify-center text-2xl" title="–û—Ç–ø—É—Å–∫">üèñ</div>)}
                            </div>
                          </div>
                        );
                      })}
                    </Fragment>
                  );
                })}
              </div>
            ) : view==="project" ? (
              // -------- –ü—Ä–æ–µ–∫—Ç—ã --------
              <Fragment>
                <RoleManager
                  roles={roles}
                  setRoles={setRoles}
                  setRoleFilter={setRoleFilter}
                  people={people}
                  setPeople={setPeople}
                  stickyTopClass="top-[var(--app-header-h)]"
                />

                <div className="grid" style={{gridTemplateColumns:"300px 1fr"}}>
                  {projects.map(function(project, idx){
                    return (
                      <Fragment key={project.id}>
                        <div
                          className="sticky left-0 z-40 bg-[#F7F8FA] backdrop-blur border-r border-neutral-200 p-1"
                          draggable
                          onDragStart={function(){onProjectDragStart(idx);}}
                          onDragOver={function(e){e.preventDefault();}}
                          onDrop={function(){onProjectDrop(idx);}}
                          title="–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫"
                        >
                          <div className="relative bg-white rounded-2xl border border-neutral-200 shadow-sm p-3 flex items-center gap-3 min-w-0 h-[120px] cursor-grab active:cursor-grabbing select-none">
                            <button
                              className="w-8 h-8 rounded-lg flex items-center justify-center"
                              style={{background:project.color}}
                              title="–°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞"
                              onClick={function(){
                                setProjects(function(prev){
                                  return prev.map(function(p){
                                    if(p.id!==project.id) return p;
                                    var next = (p.status==="active"?"onhold": p.status==="onhold"?"done": p.status==="done"?"planned":"active");
                                    var cp = Object.assign({}, p, {status:next});
                                    return cp;
                                  });
                                });
                              }}
                            >
                              <StatusIcon status={project.status}/>
                            </button>
                            <div className="font-medium truncate" title={project.name}>{project.name}</div>

                            <button
                              className="absolute top-2 right-10 w-7 h-7 rounded-lg grid place-items-center text-neutral-700 hover:bg-neutral-50"
                              title="–ò–∑–º–µ–Ω–∏—Ç—å —Ü–≤–µ—Ç"
                              onClick={function(){ var el=document.getElementById("color-"+project.id); if(el) el.click(); }}
                              type="button"
                            >
                              <EyedropperIcon/>
                            </button>
                            <input
                              id={"color-"+project.id}
                              type="color"
                              className="hidden"
                              value={project.color}
                              onChange={function(e){
                                const val=e.target.value;
                                setProjects(function(prev){ return prev.map(function(p){ return p.id===project.id ? Object.assign({}, p, {color:val}) : p; }); });
                              }}
                            />

                            <button
                              type="button"
                              draggable={false}
                              aria-label="–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç"
                              onMouseDown={function(e){e.preventDefault();}}
                              onClick={function(){ deleteProject(project.id); }}
                              title="–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç"
                              className="absolute top-2 right-2 w-7 h-7 rounded-lg grid place-items-center text-neutral-700 hover:text-red-600 hover:bg-red-50 border border-neutral-300 hover:border-red-200 transition"
                            >
                              <MinusIcon className="text-neutral-700"/>
                            </button>
                          </div>
                        </div>
                        <div className="border border-neutral-200 p-3">
                          <div className="bg-white rounded-2xl border border-neutral-200 shadow-sm p-3">
                            <ProjectTeamSelector
                              project={project}
                              people={peopleActiveAll}
                              projectTeams={projectTeams}
                              setProjectTeams={setProjectTeams}
                            />
                          </div>
                        </div>
                      </Fragment>
                    );
                  })}
                </div>
              </Fragment>
            ) : (
              // -------- –ö–æ–º–∞–Ω–¥–∞ --------
              <EmployeesPage
                people={people}
                setPeople={setPeople}
                projects={projects}
                projectTeams={projectTeams}
                setProjectTeams={setProjectTeams}
                deletePerson={deletePerson}
              />
            )}
          </main>

          {selectedPersonId && (
            <PersonPage
              person={people.find(function(p){return p.id===selectedPersonId;})}
              projects={projects}
              assignments={assignments}
              teamByProject={projectTeams}
              vacations={vacations}
              setVacations={setVacations}
              order={personProjectOrder[selectedPersonId]}
              setOrder={function(o){ setPersonProjectOrder(function(prev){ var c=Object.assign({}, prev); c[selectedPersonId]=o; return c; }); }}
              onClose={function(){ setSelectedPersonId(null); }}
              onSave={setAssignments}
              setPeople={setPeople}
              weeksAll={weeks}
              visibleWeeks={visible}
              goLeft={goLeft}
              goRight={goRight}
              goToday={goToday}
              roles={roles}
              view={view}
              setView={function(v){ setView(v); setSelectedPersonId(null); }}
            />
          )}

          <CreatePersonModal
            open={createPersonOpen}
            onClose={function(){setCreatePersonOpen(false);}}
            name={newPersonName} setName={setNewPersonName}
            role={newPersonRole} setRole={setNewPersonRole}
            external={newPersonExternal} setExternal={setNewPersonExternal}
            onSubmit={submitNewPerson} roles={roles}
          />
          <CreateProjectModal
            open={createProjectOpen}
            onClose={function(){setCreateProjectOpen(false);}}
            name={newProjectName}
            setName={setNewProjectName}
            color={newProjectColor}
            setColor={setNewProjectColor}
            status={newProjectStatus}
            setStatus={setNewProjectStatus}
            search={projSearch}
            setSearch={setProjSearch}
            teamSel={projTeamSel}
            setTeamSel={setProjTeamSel}
            people={peopleActiveAll}
            suggestions={personSuggestions}
            onSubmit={submitNewProject}
          />
        </div>
      );
    }

    // –ù–∞–≤–∏–≥–∞—Ç–æ—Ä –Ω–µ–¥–µ–ª—å
    function WeekNavigator(props){
      const onLeft = props.onLeft;
      const onRight = props.onRight;
      const onToday = props.onToday;
      const showRoleFilter = !!props.showRoleFilter;
      const roleFilter = props.roleFilter;
      const setRoleFilter = props.setRoleFilter || function(){};
      const roles = props.roles || [];
      const stickyTopClass = props.stickyTopClass || 'top-[var(--app-header-h)]';
      const leftNode = (typeof props.leftNode!=="undefined" ? props.leftNode : null);

      return (
        <div className={"sticky "+stickyTopClass+" z-50 bg-[#F7F8FA] py-2 mb-2"}>
          <div className="flex items-center justify-between gap-2">
            <div className="flex items-center gap-2 min-h-[32px]">
              {leftNode}
            </div>
            <div className="flex items-center gap-2">
              {showRoleFilter && (
                <div className="flex items-center gap-2 mr-1">
                  <label className="text-sm text-neutral-700">–§–∏–ª—å—Ç—Ä —Ä–æ–ª–∏</label>
                  <select className="border border-neutral-300 rounded-xl px-2 py-1 text-sm"
                          value={roleFilter} onChange={function(e){ setRoleFilter(e.target.value); }}>
                    <option value="all">–í—Å–µ</option>
                    {roles.map(function(r){ return (<option key={r} value={r}>{r}</option>); })}
                  </select>
                </div>
              )}
              <button onClick={onLeft} className="btn">‚Äπ</button>
              <button onClick={onToday} className="btn">–°–µ–≥–æ–¥–Ω—è</button>
              <button onClick={onRight} className="btn">‚Ä∫</button>
            </div>
          </div>
        </div>
      );
    }

    // ---------- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–¥–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ ----------
    function PersonPage({ person, projects, assignments, teamByProject, vacations, setVacations, order, setOrder, onClose, onSave, setPeople, weeksAll, visibleWeeks, goLeft, goRight, goToday, roles, view, setView }){
      if(!person) return null;

      const isVacation = function(pid,w){
        const set = vacations[pid]; return !!(set && set.has && set.has(w));
      };

      const unionIds = useMemo(function(){
        const ids={};
        assignments.forEach(function(a){ if(a.personId===person.id){ ids[a.projectId]=true; } });
        for(const pr in teamByProject){
          if(Object.prototype.hasOwnProperty.call(teamByProject,pr)){
            const s = teamByProject[pr];
            if(s && s.has && s.has(person.id)){ ids[pr]=true; }
          }
        }
        return Object.keys(ids);
      }, [assignments, person.id, teamByProject]);

      const orderedIds = useMemo(function(){ return mergeOrder(order, unionIds); }, [order, unionIds]);
      useEffect(function(){ setOrder(orderedIds); }, [orderedIds, setOrder]);

      const [editKey, setEditKey] = useState(null);
      const [editVal, setEditVal] = useState("");

      function beginEditPlan(pid, w, curFte){
        if(isVacation(person.id,w)) return;
        const curHours = Math.max(0, Math.round(fteToHours(curFte||0)));
        setEditKey(pid+"|"+w+"|plan");
        setEditVal(String(curHours));
      }
      function beginEditFact(pid, w, curFact){
        if(isVacation(person.id,w)) return;
        const curHours = (curFact==null || isNaN(curFact)) ? "" : String(Math.max(0, Math.round(Number(curFact)||0)));
        setEditKey(pid+"|"+w+"|fact");
        setEditVal(curHours);
      }
      function commitEdit(pid, w, mode){
        const k = pid+"|"+w+"|"+mode; if(editKey!==k) return;
        const normalized = (editVal||"").replace(",", ".");
        const nextHours = parseInt(normalized, 10);
        setEditKey(null);
        if(isNaN(nextHours) || nextHours<0) return;
        onSave(function(prev){
          const rest = prev.filter(function(a){ return !(a.personId===person.id && a.projectId===pid && a.weekStart===w); });
          const old = (function(){
            for(var i=0;i<prev.length;i++){
              var a=prev[i];
              if(a.personId===person.id && a.projectId===pid && a.weekStart===w) return a;
            }
            return null;
          })();
          if(mode==="plan"){
            const nextFte = hoursToFte(nextHours);
            return rest.concat([{ id:rndId(), personId:person.id, projectId:pid, weekStart:w, fte:nextFte, factHours: old ? old.factHours : undefined }]);
          }else{
            return rest.concat([{ id:rndId(), personId:person.id, projectId:pid, weekStart:w, fte: old ? (old.fte||0) : 0, factHours: Math.max(0, nextHours) }]);
          }
        });
      }

      const dragIndex = useRef(null);
      const onDragStart = function(i){ dragIndex.current=i; };
      const onDrop = function(i){
        const from=dragIndex.current; dragIndex.current=null; if(from==null || from===i) return;
        const arr=orderedIds.slice(); const moved=arr.splice(from,1)[0]; arr.splice(i,0,moved); setOrder(arr);
      };

      const [vacOpen, setVacOpen] = useState(false);
      const [personVac, setPersonVac] = useState(function(){ return new Set(vacations[person.id] || []); });
      const [vacTab, setVacTab] = useState("range");
      const [vFrom, setVFrom] = useState("");
      const [vTo, setVTo] = useState("");
      useEffect(function(){ setPersonVac(new Set(vacations[person.id] || [])); }, [person.id, vacations]);
      const saveVac = function(){
        var setToSave = new Set(personVac);
        if(vFrom && vTo){
          const d1=new Date(vFrom), d2=new Date(vTo);
          if(!(isNaN(d1) || isNaN(d2) || d1>d2)){
            let m1=startOfISOWeek(d1); const m2=startOfISOWeek(d2);
            while(m1<=m2){ setToSave.add(fmtISO(m1)); m1=addDays(m1,7); }
          }
        }
        setVacations(function(prev){
          const c={}; for(const k in prev){ if(Object.prototype.hasOwnProperty.call(prev,k)){ c[k]=new Set(prev[k]); } }
          c[person.id]=setToSave; return c;
        });
        onSave(function(prev){ return prev.filter(function(a){ return !(a.personId===person.id && setToSave.has(a.weekStart)); }); });
        setVacOpen(false);
      };
      const clearVacationWeek = function(week){
        setVacations(function(prev){
          const c={}; for(const k in prev){ if(Object.prototype.hasOwnProperty.call(prev,k)){ c[k]=new Set(prev[k]); } }
          const s = new Set(c[person.id]||[]); s.delete(week); c[person.id]=s; return c;
        });
      };

      const visible = visibleWeeks;

      const weekTotalsPlan = useMemo(function(){
        return visible.map(function(w){
          if(isVacation(person.id,w)) return 0;
          const sumFte = assignments.filter(function(a){return a.personId===person.id && a.weekStart===w;}).reduce(function(s,a){return s+a.fte;},0);
          return Math.max(0, Math.round(fteToHours(sumFte)));
        });
      }, [assignments, person.id, vacations, visible]);
      const weekTotalsFact = useMemo(function(){
        return visible.map(function(w){
          if(isVacation(person.id,w)) return 0;
          return personWeekFactTotal(assignments, person.id, w);
        });
      }, [assignments, person.id, vacations, visible]);

      return (
        <div className="fixed inset-0 z-50 bg-[#F7F8FA] overflow-auto no-scrollbar">
          {/* –®–∞–ø–∫–∞ */}
          <div className="sticky top-0 z-50 border-b border-neutral-200 bg-white/90 backdrop-blur" style={{height:'var(--app-header-h)'}}>
            <div className="max-w-screen-2xl mx-auto px-4 h-full flex items-center gap-3">
              <div className="text-lg font-semibold tracking-tight text-green-600">–ü–∞–Ω–∫–≤–µ–± FTE Planner</div>
              <div className="ml-4 segmented">
                <button className={view==="team" ? "active" : "idle"} onClick={function(){ setView("team"); onClose(); }}>–ù–∞–≥—Ä—É–∑–∫–∞</button>
                <button className={view==="project" ? "active" : "idle"} onClick={function(){ setView("project"); onClose(); }}>–ü—Ä–æ–µ–∫—Ç—ã</button>
                <button className={view==="employees" ? "active" : "idle"} onClick={function(){ setView("employees"); onClose(); }}>–ö–æ–º–∞–Ω–¥–∞</button>
              </div>
              <div className="ml-auto" />
            </div>
          </div>

          <div className="max-w-screen-2xl mx-auto px-4">
            <WeekNavigator
              onLeft={goLeft}
              onRight={goRight}
              onToday={goToday}
              showRoleFilter={false}
              stickyTopClass="top-[var(--app-header-h)]"
              leftNode={
                <Fragment>
                  <EditableName person={person} setPeople={setPeople}/>
                  <EditableRole person={person} setPeople={setPeople} roles={roles}/>
                  <button
                    onClick={function(){setVacOpen(true);}}
                    className="inline-flex items-center gap-1 text-sm px-2 py-1 rounded-lg border border-amber-300 bg-amber-50 text-amber-800"
                  >üèñ –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—É—Å–∫</button>
                </Fragment>
              }
            />
          </div>

          {/* –°–µ—Ç–∫–∞ –Ω–µ–¥–µ–ª—å / —Å—É–º–º */}
          <div className="max-w-screen-2xl mx-auto px-4">
            <div className="grid" style={{gridTemplateColumns:"var(--left-col-w) repeat("+visible.length+", "+WEEK_COL_PX+"px)"}}>
              <div className="sticky left-0 z-50 bg-[#F7F8FA] border-r border-neutral-200" />
              {visible.map(function(w){ return (<div key={w}><WeekHeader iso={w}/></div>); })}
            </div>

            <div className="grid mb-1" style={{gridTemplateColumns:"var(--left-col-w) repeat("+visible.length+", "+WEEK_COL_PX+"px)"}}>
              <div className="sticky left-0 z-50 bg-[#F7F8FA] border-r border-neutral-200" />
              {visible.map(function(w,i){
                const over = weekTotalsPlan[i]>HOURS_PER_WEEK;
                return (
                  <div key={w} className="h-8 flex items-center justify-center">
                    <div className={"px-2 py-0.5 rounded-lg border "+(over?"border-red-300 bg-red-50 text-red-800":"border-neutral-300 bg-white text-neutral-900")+" text-[12px] font-medium shadow-sm text-center leading-tight"} title={"–ø–ª–∞–Ω: "+weekTotalsPlan[i]+" —á, —Ñ–∞–∫—Ç: "+weekTotalsFact[i]+" —á"}>
                      <div className="font-semibold">{fmtHours(weekTotalsPlan[i])}</div>
                      <div className="text-[10px] font-normal text-neutral-500">{fmtHours(weekTotalsFact[i])}</div>
                    </div>
                  </div>
                );
              })}
            </div>

            <div className="grid pb-4" style={{gridTemplateColumns:"var(--left-col-w) repeat("+visible.length+", "+WEEK_COL_PX+"px)"}}>
              {orderedIds.map(function(pid, idx){
                const pr = projects.find(function(p){return p.id===pid;}); if(!pr) return null;
                return (
                  <Fragment key={pid}>
                    <div className="sticky left-0 z-50 bg-[#F7F8FA] border-r border-neutral-200 p-1" draggable onDragStart={function(){onDragStart(idx);}} onDragOver={function(e){e.preventDefault();}} onDrop={function(){onDrop(idx);}}>
                      <div className="bg-white rounded-2xl shadow-sm h-[120px] flex items-center gap-2 pl-5 pr-3 cursor-grab active:cursor-grabbing select-none">
                        <span className="text-neutral-400">‚ãÆ‚ãÆ</span>
                        <button className="w-6 h-6 rounded-lg flex items-center justify-center" style={{background:pr.color}} title="–°—Ç–∞—Ç—É—Å"><StatusIcon status={pr.status}/></button>
                        <div className="font-medium truncate" title={pr.name}>{pr.name}</div>
                      </div>
                    </div>
                    {visible.map(function(week){
                      const fte = fteFor(assignments, person.id, pid, week);
                      const hoursPlan = Math.max(0, Math.round(fteToHours(fte)));
                      const ratio = fillRatio(hoursPlan);
                      const vac = isVacation(person.id, week);
                      const over = hoursPlan > HOURS_PER_WEEK;

                      var curAssign = null;
                      for(var u=0;u<assignments.length;u++){
                        var a=assignments[u];
                        if(a.personId===person.id && a.projectId===pid && a.weekStart===week){ curAssign=a; break; }
                      }
                      const factRaw = curAssign ? curAssign.factHours : undefined;
                      const factEffective = (factRaw==null || isNaN(factRaw)) ? (isWeekEnded(week) ? Math.max(0, Math.round(fteToHours(fte))) : null) : Math.max(0, Math.round(Number(factRaw)||0));

                      const editingPlan = (editKey===(pid+"|"+week+"|plan"));
                      const editingFact = (editKey===(pid+"|"+week+"|fact"));

                      return (
                        <div key={week+pid} className="p-1 bg-transparent h-[120px] relative">
                          <div className={"bg-white rounded-2xl shadow-sm h-full flex items-end justify-center relative "+(over ? "ring-2 ring-red-300" : "")}>
                            <div className="relative w-14 h-[92%] rounded-lg bg-neutral-200 overflow-hidden">
                              {!vac && (<div className="absolute bottom-0 left-0 right-0" style={{height:(ratio*100)+"%", background:pr.color}} title={pr.name}/>)}
                            </div>
                            {!vac && (
                              <div className="absolute inset-0 flex items-center justify-center">
                                <div className="leading-tight text-center">
                                  {!editingPlan ? (
                                    <div className="text-sm font-semibold text-neutral-800 cursor-text" title={"–ø–ª–∞–Ω: "+hoursPlan+" —á"} onClick={function(){beginEditPlan(pid, week, fte);}}>{fmtHours(hoursPlan)}</div>
                                  ) : (
                                    <input
                                      autoFocus
                                      inputMode="numeric"
                                      className="h-8 w-16 text-center text-sm font-semibold border border-neutral-300 rounded-md bg-white shadow-sm"
                                      value={editVal}
                                      onChange={function(e){setEditVal(e.target.value);}}
                                      onBlur={function(){commitEdit(pid, week, "plan");}}
                                      onKeyDown={function(e){ if(e.key==="Enter") e.currentTarget.blur(); if(e.key==="Escape") setEditKey(null); }}
                                    />
                                  )}
                                  {!editingFact ? (
                                    <div
                                      className="text-[11px] font-normal text-neutral-500 mt-0.5 cursor-text"
                                      title={factEffective!=null ? ("—Ñ–∞–∫—Ç: "+factEffective+" —á") : "—Ñ–∞–∫—Ç –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω"}
                                      onClick={function(){beginEditFact(pid, week, factRaw);}}
                                    >
                                      {factEffective!=null ? fmtHours(factEffective) : "‚Äî"}
                                    </div>
                                  ) : (
                                    <input
                                      autoFocus
                                      inputMode="numeric"
                                      className="mt-0.5 h-7 w-16 text-center text-[11px] font-normal border border-neutral-300 rounded-md bg-white shadow-sm"
                                      value={editVal}
                                      onChange={function(e){setEditVal(e.target.value);}}
                                      onBlur={function(){commitEdit(pid, week, "fact");}}
                                      onKeyDown={function(e){ if(e.key==="Enter") e.currentTarget.blur(); if(e.key==="Escape") setEditKey(null); }}
                                    />
                                  )}
                                </div>
                              </div>
                            )}
                            {vac && (<button className="absolute inset-0 flex items-center justify-center text-2xl" title="–°–Ω—è—Ç—å –æ—Ç–ø—É—Å–∫" onClick={function(){clearVacationWeek(week);}}>üèñ</button>)}
                          </div>
                        </div>
                      );
                    })}
                  </Fragment>
                );
              })}
            </div>
          </div>

          {/* –ú–æ–¥–∞–ª –æ—Ç–ø—É—Å–∫–æ–≤ */}
          {vacOpen && (
            <div className="fixed inset-0 z-50 flex items-center justify-center" onClick={function(){setVacOpen(false);}}>
              <div className="absolute inset-0 bg-black/40"/>
              <div className="relative bg-white rounded-2xl shadow-xl border border-neutral-200 w-[720px] max-h-[80vh] overflow-auto p-4" onClick={function(e){e.stopPropagation();}}>
                <div className="text-base font-semibold mb-3">–û—Ç–ø—É—Å–∫ ‚Äî {person.name}</div>
                <div className="mb-3 inline-flex items-center gap-1 rounded-xl border border-neutral-200 p-1">
                  <button className={"px-3 py-1 rounded-lg text-sm "+(vacTab==="range" ? "bg-neutral-100 shadow":"")} onClick={function(){setVacTab("range");}}>–î–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç</button>
                  <button className={"px-3 py-1 rounded-lg text-sm "+(vacTab==="weeks" ? "bg-neutral-100 shadow":"")} onClick={function(){setVacTab("weeks");}}>–ü–æ –Ω–µ–¥–µ–ª—è–º</button>
                </div>
                {vacTab==="range" && (
                  <div className="space-y-3">
                    <div className="flex items-center gap-2">
                      <label className="text-sm text-neutral-700">–°</label>
                      <input type="date" value={vFrom} onChange={function(e){setVFrom(e.target.value);}} className="border border-neutral-300 rounded-lg px-2 py-1"/>
                      <label className="text-sm text-neutral-700">–ø–æ</label>
                      <input type="date" value={vTo} onChange={function(e){setVTo(e.target.value);}} className="border border-neutral-300 rounded-lg px-2 py-1"/>
                    </div>
                    {(vFrom && vTo) && (<div className="text-xs text-neutral-600">–ë—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–µ–¥–µ–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.</div>)}
                  </div>
                )}
                {vacTab==="weeks" && (
                  <div className="space-y-3">
                    <div className="text-sm text-neutral-600">–û—Ç–º–µ—Ç—å—Ç–µ –Ω–µ–¥–µ–ª–∏ (–¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç):</div>
                    <div className="grid grid-cols-3 gap-2">
                      {yearWeekMondays(new Date().getFullYear()).map(function(m){
                        const checked = personVac.has(m);
                        return (
                          <label key={m} className="flex items-center gap-2 p-2 border border-neutral-200 rounded-xl hover:bg-amber-50">
                            <input type="checkbox" checked={checked} onChange={function(){
                              setPersonVac(function(prev){ const s=new Set(prev); if(s.has(m)) s.delete(m); else s.add(m); return s; });
                            }} />
                            <span className="text-sm">{weekRangeLabel(m)}</span>
                            {checked && (<button type="button" className="ml-auto text-amber-700" title="–£–±—Ä–∞—Ç—å" onClick={function(){ setPersonVac(function(prev){ const s=new Set(prev); s.delete(m); return s; }); }}>‚àí</button>)}
                          </label>
                        );
                      })}
                    </div>
                  </div>
                )}
                {Array.from(personVac).length>0 && (
                  <div className="mt-3">
                    <div className="text-sm mb-1">–í—ã–±—Ä–∞–Ω–æ –Ω–µ–¥–µ–ª—å:</div>
                    <div className="flex flex-wrap gap-2">
                      {Array.from(personVac).map(function(w){
                        return (
                          <span key={w} className="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs bg-blue-50 text-blue-800 border border-blue-200">
                            {weekRangeLabel(w)}
                            <button type="button" className="ml-1" title="–£–¥–∞–ª–∏—Ç—å" onClick={function(){ setPersonVac(function(prev){ const s=new Set(prev); s.delete(w); return s; }); }}>√ó</button>
                          </span>
                        );
                      })}
                    </div>
                  </div>
                )}
                <div className="mt-4 flex justify-end gap-2">
                  <button type="button" className="btn" onClick={function(){setVacOpen(false);}}>–û—Ç–º–µ–Ω–∞</button>
                  <button type="button" className="rounded-xl border border-amber-300 bg-amber-50 text-amber-800 px-3 py-1" onClick={saveVac}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ---------- –ò–Ω–ª–∞–π–Ω–æ–≤–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω–∏ (–∫–∞—Ä—Ç–æ—á–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞) ----------
    function InlineNameEditor({person, setPeople}){
      const [editing, setEditing] = useState(false);
      const [val, setVal] = useState(person.name);
      useEffect(function(){ setVal(person.name); }, [person.id, person.name]);
      const commit = function(){
        const name=(val||"").trim(); setEditing(false);
        if(!name || name===person.name) return;
        setPeople(function(prev){ return prev.map(function(p){ return p.id===person.id ? Object.assign({}, p, {name:name}) : p; }); });
      };
      return editing ? (
        <input
          autoFocus
          value={val}
          onChange={function(e){setVal(e.target.value);}}
          onBlur={commit}
          onKeyDown={function(e){ if(e.key==="Enter") e.currentTarget.blur(); if(e.key==="Escape"){ setEditing(false); setVal(person.name);} }}
          className="px-2 py-1 text-sm border border-neutral-300 rounded-lg w-[70%]"
        />
      ) : (
        <button className="font-medium truncate text-left hover:underline" onClick={function(){setEditing(true);}} title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–º—è">
          {person.name}
        </button>
      );
    }

    function EditableName({person, setPeople}){
      const [editing, setEditing] = useState(false);
      const [val, setVal] = useState(person.name);
      useEffect(function(){ setVal(person.name); }, [person.id, person.name]);
      const commit = function(){
        const name=(val||"").trim(); setEditing(false);
        if(!name || name===person.name) return;
        setPeople(function(prev){ return prev.map(function(p){ return p.id===person.id ? Object.assign({}, p, {name:name}) : p; }); });
      };
      return editing ? (
        <input autoFocus value={val} onChange={function(e){setVal(e.target.value);}} onBlur={commit}
               onKeyDown={function(e){ if(e.key==="Enter") e.currentTarget.blur(); if(e.key==="Escape"){ setEditing(false); setVal(person.name);} }}
               className="text-lg font-semibold leading-tight border border-neutral-300 rounded-md px-2 py-0.5"/>
      ) : (
        <button className="text-lg font-semibold leading-tight hover:underline" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–º—è" onClick={function(){setEditing(true);}}>{person.name}</button>
      );
    }
    function EditableRole({person, setPeople, roles}){
      const [editing, setEditing] = useState(false);
      const [val, setVal] = useState(person.role || "other");
      useEffect(function(){ setVal(person.role || "other"); }, [person.id, person.role]);
      const commit = function(){ const role = val || "other"; setEditing(false); if(role===person.role) return; setPeople(function(prev){ return prev.map(function(p){ return p.id===person.id ? Object.assign({}, p, {role:role}) : p; }); }); };
      return editing ? (
        <select autoFocus value={val} onChange={function(e){setVal(e.target.value);}} onBlur={commit} className="text-[11px] px-2 py-0.5 rounded-full bg-neutral-100 border border-neutral-200">
          {roles.map(function(r){ return (<option key={r} value={r}>{r.toUpperCase()}</option>); })}
        </select>
      ) : (
        <button className="inline-flex items-center gap-1 text-[11px] px-2 py-0.5 rounded-full bg-neutral-100 border border-neutral-200 text-neutral-700 hover:bg-neutral-200" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–æ–ª–∂–Ω–æ—Å—Ç—å" onClick={function(){setEditing(true);}}>
          <PencilIcon className="opacity-70"/> {(person.role||"OTHER").toUpperCase()}
        </button>
      );
    }

    // ---------- –ü—Ä–æ–µ–∫—Ç—ã ‚Üí –∫–æ–º–∞–Ω–¥–∞ ----------
    function ProjectTeamSelector({project, people, projectTeams, setProjectTeams}){
      const [search, setSearch] = useState("");
      const list = useMemo(function(){
        const teamSet = projectTeams[project.id];
        return people.filter(function(p){
          const inTeam = !!(teamSet && teamSet.has && teamSet.has(p.id));
          return !inTeam && p.name.toLowerCase().indexOf(search.toLowerCase())!==-1;
        }).slice(0,8);
      }, [people, project.id, projectTeams, search]);

      const addToTeam = function(pid){
        setProjectTeams(function(prev){
          const copy={}; for(const k in prev){ if(Object.prototype.hasOwnProperty.call(prev,k)){ copy[k]=new Set(prev[k]); } }
          if(!copy[project.id]) copy[project.id]=new Set();
          copy[project.id].add(pid);
          return copy;
        });
      };
      const removeFromTeam = function(pid){
        setProjectTeams(function(prev){
          const copy={}; for(const k in prev){ if(Object.prototype.hasOwnProperty.call(prev,k)){ copy[k]=new Set(prev[k]); } }
          if(copy[project.id]) copy[project.id].delete(pid);
          return copy;
        });
      };

      const currentTeam = Array.from(projectTeams[project.id] ? projectTeams[project.id] : new Set());

      return (
        <div>
          <div className="flex items-center gap-2">
            <input
              value={search}
              onChange={function(e){setSearch(e.target.value);}}
              placeholder="–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞..."
              className="w-full max-w-sm border border-neutral-300 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-200"
            />
          </div>
          {search && (
            <div className="mt-2 border border-neutral-200 rounded-xl overflow-hidden">
              {list.length>0 ? (
                list.map(function(sug){
                  return (
                    <button key={sug.id} className="w-full text-left px-3 py-2 hover:bg-blue-50" onClick={function(){ addToTeam(sug.id); setSearch(""); }}>
                      {sug.name} <span className="text-[10px] text-neutral-500">{String(sug.role).toUpperCase()}</span> {sug.external ? (<span className="ml-1 text-[10px] text-amber-700">–≤–Ω–µ—à–Ω.</span>) : null}
                    </button>
                  );
                })
              ) : (
                <div className="px-3 py-2 text-xs text-neutral-500">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</div>
              )}
            </div>
          )}

          <div className="mt-3 flex flex-wrap gap-2">
            {currentTeam.map(function(pid){
              const p = people.find(function(x){return x.id===pid;}); if(!p) return null;
              return (
                <span key={pid} className="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs bg-blue-50 text-blue-800 border border-blue-200">
                  {p.name}{p.external ? (<span className="ml-1 text-amber-700">(–≤–Ω–µ—à–Ω.)</span>) : null}
                  <button className="ml-1 text-blue-700/70 hover:text-blue-900" onClick={function(){removeFromTeam(pid);}}>√ó</button>
                </span>
              );
            })}
          </div>
        </div>
      );
    }

    // ---------- –ö–æ–º–∞–Ω–¥–∞ (—Å–ø–∏—Å–æ–∫) ----------
    function EmployeesPage({people, setPeople, projects, projectTeams, setProjectTeams, deletePerson}){
      const [search, setSearch] = useState("");
      const list = useMemo(function(){ return people.filter(function(p){ return p.active && p.name.toLowerCase().indexOf(search.toLowerCase())!==-1; }); }, [people, search]);

      return (
        <div className="space-y-3">
          <input
            value={search}
            onChange={function(e){setSearch(e.target.value);}}
            placeholder="–ù–∞–π—Ç–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞..."
            className="w-full border border-neutral-300 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-200"
          />

          <div className="grid" style={{gridTemplateColumns:"300px 1fr"}}>
            {list.map(function(p){
              return (
                <Fragment key={p.id}>
                  <div className="sticky left-0 z-40 bg-[#F7F8FA] backdrop-blur border-r border-neutral-200 p-1">
                    <div className="relative bg-white rounded-2xl border border-neutral-200 shadow-sm p-3 min-w-0 h-[120px] flex flex-col justify-center">
                      <div className="flex items-center gap-2">
                        <InlineNameEditor person={p} setPeople={setPeople}/>
                        <button
                          className="text-neutral-500 hover:text-red-600 ml-auto"
                          title="–£–¥–∞–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞"
                          onClick={function(){deletePerson(p.id);}}
                        ><TrashIcon/></button>
                      </div>
                      <div className="mt-1 flex items-center gap-2">
                        <select
                          value={p.role||"other"}
                          onChange={function(e){ setPeople(function(prev){ return prev.map(function(x){ return x.id===p.id ? Object.assign({}, x, {role:e.target.value}) : x; }); }); }}
                          className="text-[12px] px-2 py-1 rounded-full bg-neutral-100 border border-neutral-200"
                        >
                          {["designer","dev","manager","pm","other"].map(function(r){ return (<option key={r} value={r}>{r.toUpperCase()}</option>); })}
                        </select>
                        <label className="text-xs flex items-center gap-1 ml-2">
                          <input type="checkbox" checked={!!p.external} onChange={function(e){ setPeople(function(prev){ return prev.map(function(x){ return x.id===p.id ? Object.assign({}, x, {external:e.target.checked}) : x; }); }); }}/>
                          –í–Ω–µ—à–Ω–∏–π
                        </label>
                      </div>
                      <div className="mt-1 text-[11px] text-neutral-500">ID: {p.id.slice(0,6)}‚Ä¶</div>
                    </div>
                  </div>

                  <div className="border border-neutral-200 p-3">
                    <div className="bg-white rounded-2xl border border-neutral-200 shadow-sm p-3">
                      <PersonProjectsEditor person={p} projects={projects} projectTeams={projectTeams} setProjectTeams={setProjectTeams}/>
                    </div>
                  </div>
                </Fragment>
              );
            })}
          </div>
        </div>
      );
    }

    function PersonProjectsEditor({person, projects, projectTeams, setProjectTeams}){
      const [search, setSearch] = useState("");
      const memberOf = useMemo(function(){
        const ids = [];
        for(var i=0;i<projects.length;i++){
          var pr=projects[i];
          const set = projectTeams[pr.id];
          if(set && set.has && set.has(person.id)) ids.push(pr.id);
        }
        return new Set(ids);
      }, [projects, projectTeams, person.id]);

      const pool = useMemo(function(){
        return projects.filter(function(pr){
          return !memberOf.has(pr.id) && pr.name.toLowerCase().indexOf(search.toLowerCase())!==-1;
        }).slice(0,8);
      }, [projects, memberOf, search]);

      const add = function(prid){
        setProjectTeams(function(prev){
          const copy={}; for(const k in prev){ if(Object.prototype.hasOwnProperty.call(prev,k)){ copy[k]=new Set(prev[k]); } }
          if(!copy[prid]) copy[prid]=new Set();
          copy[prid].add(person.id);
          return copy;
        });
      };
      const remove = function(prid){
        setProjectTeams(function(prev){
          const copy={}; for(const k in prev){ if(Object.prototype.hasOwnProperty.call(prev,k)){ copy[k]=new Set(prev[k]); } }
          if(copy[prid]) copy[prid].delete(person.id);
          return copy;
        });
      };

      const current = Array.from(memberOf);

      return (
        <div>
          <div className="flex items-center gap-2">
            <input
              value={search}
              onChange={function(e){setSearch(e.target.value);}}
              placeholder="–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç..."
              className="w-full max-w-sm border border-neutral-300 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-200"
            />
          </div>
          {search && (
            <div className="mt-2 border border-neutral-200 rounded-xl overflow-hidden">
              {pool.length>0 ? (
                pool.map(function(pr){
                  return (
                    <button key={pr.id} className="w-full text-left px-3 py-2 hover:bg-blue-50" onClick={function(){ add(pr.id); setSearch(""); }}>
                      <span className="inline-flex items-center gap-2">
                        <span className="w-3 h-3 rounded" style={{background:pr.color}}></span>
                        {pr.name}
                      </span>
                    </button>
                  );
                })
              ) : (
                <div className="px-3 py-2 text-xs text-neutral-500">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</div>
              )}
            </div>
          )}

          <div className="mt-3 flex flex-wrap gap-2">
            {current.map(function(prid){
              const pr = projects.find(function(p){return p.id===prid;}); if(!pr) return null;
              return (
                <span key={prid} className="inline-flex items-center gap-2 px-2 py-1 rounded-full text-xs bg-blue-50 text-blue-800 border border-blue-200">
                  <span className="w-3 h-3 rounded" style={{background:pr.color}}></span>
                  {pr.name}
                  <button className="ml-1 text-blue-700/70 hover:text-blue-900" onClick={function(){remove(prid);}}>√ó</button>
                </span>
              );
            })}
          </div>
        </div>
      );
    }

    // ---------- –ú–µ–Ω–µ–¥–∂–µ—Ä —Ä–æ–ª–µ–π ----------
    function RoleManager({roles, setRoles, setRoleFilter, people, setPeople, stickyTopClass}){
      stickyTopClass = stickyTopClass || 'top-[calc(var(--app-header-h)+48px)]';
      const [adding, setAdding] = useState("");
      const [editing, setEditing] = useState(null);
      const [val, setVal] = useState("");

      const add = function(){ const x=(adding||"").trim(); if(!x || roles.indexOf(x)!==-1) return; setRoles(roles.concat([x])); setAdding(""); };
      const startEdit = function(r){ setEditing(r); setVal(r); };
      const commit = function(){
        if(!editing) return;
        const x=(val||"").trim(); setEditing(null);
        if(!x) return;
        setRoles(roles.map(function(r){ return r===editing ? x : r; })); setRoleFilter(x);
      };
      const remove = function(r){
        if(!confirm("–£–¥–∞–ª–∏—Ç—å —Ä–æ–ª—å ¬´"+r+"¬ª? –õ—é–¥—è–º —Å —ç—Ç–æ–π —Ä–æ–ª—å—é –±—É–¥–µ—Ç –ø—Ä–æ—Å—Ç–∞–≤–ª–µ–Ω–æ OTHER.")) return;
        setRoles(roles.filter(function(x){return x!==r;}));
        setPeople(function(prev){ return prev.map(function(p){ return p.role===r ? Object.assign({}, p, {role:"other"}) : p; }); });
        setRoleFilter("all");
      };

      return (
        <div className={"bg-white rounded-2xl border border-neutral-200 shadow-sm p-3 sticky "+stickyTopClass+" z-50"}>
          <div className="text-sm font-medium">–†–æ–ª–∏</div>
          <div className="mt-2 flex flex-wrap gap-2">
            {roles.map(function(r){
              return (
                <span key={r} className="inline-flex items-center gap-2 px-2 py-1 rounded-full border border-neutral-200 bg-neutral-50 text-xs">
                  {editing===r ? (
                    <input autoFocus value={val} onChange={function(e){setVal(e.target.value);}} onBlur={commit} onKeyDown={function(e){ if(e.key==='Enter') e.currentTarget.blur(); if(e.key==='Escape') setEditing(null); }} className="px-1 py-0.5 border border-neutral-300 rounded"/>
                  ) : (
                    <Fragment>
                      <button className="hover:underline" onClick={function(){setRoleFilter(r);}}>{r}</button>
                      <button className="text-neutral-500 hover:text-neutral-800" title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å —Ä–æ–ª—å" onClick={function(){startEdit(r);}}>
                        <PencilIcon/>
                      </button>
                      <button className="text-neutral-500 hover:text-red-600" title="–£–¥–∞–ª–∏—Ç—å —Ä–æ–ª—å" onClick={function(){remove(r);}}>
                        <TrashIcon/>
                      </button>
                    </Fragment>
                  )}
                </span>
              );
            })}
            <span className="inline-flex items-center gap-1">
              <input value={adding} onChange={function(e){setAdding(e.target.value);}} placeholder="–î–æ–±–∞–≤–∏—Ç—å —Ä–æ–ª—å" className="px-2 py-1 text-sm border border-neutral-300 rounded-lg"/>
              <button className="btn" onClick={add}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </span>
          </div>
        </div>
      );
    }

    // ---------- –ú–æ–¥–∞–ª–∫–∏ ----------
    function CreatePersonModal({open, onClose, name, setName, role, setRole, external, setExternal, onSubmit, roles}){
      if(!open) return null;
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center" onClick={onClose}>
          <div className="absolute inset-0 bg-black/40"/>
          <div className="relative bg-white rounded-2xl shadow-xl border border-neutral-200 w-[460px] p-4" onClick={function(e){e.stopPropagation();}}>
            <div className="text-base font-semibold mb-3">–ù–æ–≤—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫</div>
            <div className="space-y-3">
              <div>
                <label className="block text-sm mb-1">–ò–º—è</label>
                <input value={name} onChange={function(e){setName(e.target.value);}} className="w-full border border-neutral-300 rounded-lg px-3 py-2"/>
              </div>
              <div>
                <label className="block text-sm mb-1">–†–æ–ª—å</label>
                <select value={role} onChange={function(e){setRole(e.target.value);}} className="w-full border border-neutral-300 rounded-lg px-3 py-2">
                  {roles.map(function(r){ return (<option key={r} value={r}>{r}</option>); })}
                </select>
              </div>
              <label className="flex items-center gap-2 text-sm">
                <input type="checkbox" checked={!!external} onChange={function(e){setExternal(e.target.checked);}} />
                –í–Ω–µ—à–Ω–∏–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ (–Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤–æ ¬´–ù–∞–≥—Ä—É–∑–∫–∞¬ª)
              </label>
            </div>
            <div className="mt-4 flex justify-end gap-2">
              <button className="btn" onClick={onClose}>–û—Ç–º–µ–Ω–∞</button>
              <button className="rounded-xl border border-green-300 bg-green-50 text-green-800 px-3 py-1" onClick={onSubmit}>–°–æ–∑–¥–∞—Ç—å</button>
            </div>
          </div>
        </div>
      );
    }

    function CreateProjectModal({open, onClose, name, setName, color, setColor, status, setStatus, search, setSearch, teamSel, setTeamSel, people, suggestions, onSubmit}){
      if(!open) return null;
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center" onClick={onClose}>
          <div className="absolute inset-0 bg-black/40"/>
          <div className="relative bg-white rounded-2xl shadow-xl border border-neutral-200 w-[560px] max-h-[80vh] overflow-auto p-4" onClick={function(e){e.stopPropagation();}}>
            <div className="text-base font-semibold mb-3">–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</div>
            <div className="grid grid-cols-2 gap-3">
              <div>
                <label className="block text-sm mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input value={name} onChange={function(e){setName(e.target.value);}} className="w-full border border-neutral-300 rounded-lg px-3 py-2"/>
              </div>
              <div>
                <label className="block text-sm mb-1">–°—Ç–∞—Ç—É—Å</label>
                <select value={status} onChange={function(e){setStatus(e.target.value);}} className="w-full border border-neutral-300 rounded-lg px-3 py-2">
                  <option value="active">active</option>
                  <option value="onhold">onhold</option>
                  <option value="done">done</option>
                  <option value="planned">planned</option>
                </select>
              </div>
              <div>
                <label className="block text-sm mb-1">–¶–≤–µ—Ç</label>
                <input type="color" value={color} onChange={function(e){setColor(e.target.value);}} className="w-16 h-10 p-0 border border-neutral-300 rounded-lg"/>
              </div>
            </div>

            <div className="mt-4">
              <div className="text-sm font-medium mb-2">–ö–æ–º–∞–Ω–¥–∞</div>
              <div className="flex items-center gap-2 mb-2">
                <input value={search} onChange={function(e){setSearch(e.target.value);}} placeholder="–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞..." className="w-full border border-neutral-300 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-200"/>
              </div>
              {search && (
                <div className="mb-2 border border-neutral-200 rounded-xl overflow-hidden">
                  {suggestions.length>0 ? suggestions.map(function(s){
                    return (
                      <button key={s.id} className="w-full text-left px-3 py-2 hover:bg-blue-50" onClick={function(){
                        const c=new Set(teamSel); c.add(s.id); setTeamSel(c); setSearch("");
                      }}>
                        {s.name} <span className="text-[10px] text-neutral-500">{String(s.role).toUpperCase()}</span> {s.external ? (<span className="ml-1 text-[10px] text-amber-700">–≤–Ω–µ—à–Ω.</span>) : null}
                      </button>
                    );
                  }) : (
                    <div className="px-3 py-2 text-xs text-neutral-500">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</div>
                  )}
                </div>
              )}
              <div className="flex flex-wrap gap-2">
                {Array.from(teamSel).map(function(pid){
                  const p = people.find(function(x){return x.id===pid;}); if(!p) return null;
                  return (
                    <span key={pid} className="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs bg-blue-50 text-blue-800 border border-blue-200">
                      {p.name}{p.external ? (<span className="ml-1 text-amber-700">(–≤–Ω–µ—à–Ω.)</span>) : null}
                      <button className="ml-1 text-blue-700/70 hover:text-blue-900" onClick={function(){ const c=new Set(teamSel); c.delete(pid); setTeamSel(c); }}>√ó</button>
                    </span>
                  );
                })}
              </div>
            </div>

            <div className="mt-4 flex justify-end gap-2">
              <button className="btn" onClick={onClose}>–û—Ç–º–µ–Ω–∞</button>
              <button className="rounded-xl border border-green-300 bg-green-50 text-green-800 px-3 py-1" onClick={onSubmit}>–°–æ–∑–¥–∞—Ç—å</button>
            </div>
          </div>
        </div>
      );
    }

    // ---------- Auth ----------
    function AuthForm({onSuccess}){
      const [login, setLogin] = useState("");
      const [pass, setPass] = useState("");
      const [remember, setRemember] = useState(false);
      const submit = function(e){
        e.preventDefault();
        if((login||"").trim().toLowerCase()==="–ø–∞–Ω–∫–≤–µ–±" && pass==="123455"){ onSuccess(remember); } else { alert("–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"); }
      };
      return (
        <form onSubmit={submit} className="space-y-3">
          <div>
            <label className="block text-sm mb-1">–õ–æ–≥–∏–Ω</label>
            <input value={login} onChange={function(e){setLogin(e.target.value);}} className="w-full border border-neutral-300 rounded-lg px-3 py-2"/>
          </div>
          <div>
            <label className="block text-sm mb-1">–ü–∞—Ä–æ–ª—å</label>
            <input type="password" value={pass} onChange={function(e){setPass(e.target.value);}} className="w-full border border-neutral-300 rounded-lg px-3 py-2"/>
          </div>
          <label className="flex items-center gap-2 text-sm select-none">
            <input type="checkbox" checked={!!remember} onChange={function(e){setRemember(e.target.checked);}} />
            –ó–∞–ø–æ–º–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
          </label>
          <button className="w-full rounded-xl border border-green-300 bg-green-50 text-green-800 py-2">–í–æ–π—Ç–∏</button>
        </form>
      );
    }

    // sanity
    if(typeof window!=="undefined"){
      try{
        console.assert(fmtFTE1(1.16)==="1.2","fmtFTE1 rounds to 1 decimal");
        console.assert(scaleRatio(1.2)===1,"scaleRatio clamps to 1");
      }catch(e){}
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
