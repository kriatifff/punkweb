<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Панквеб FTE Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- React & Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --app-header-h: 56px;
      --left-col-w: 220px;
      --emerald-50:#ecfdf5; --emerald-100:#d1fae5; --emerald-200:#a7f3d0; --emerald-600:#059669; --emerald-700:#047857; --emerald-900:#064e3b;
    }
    .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }
    .no-scrollbar::-webkit-scrollbar{ display:none; }
    .btn{
      @apply rounded-xl border border-neutral-300 bg-white px-3 py-1 shadow-sm hover:shadow transition;
    }
    .nav-group{ @apply flex items-center gap-2; }
    .navbtn{
      @apply rounded-xl border px-3 py-1 transition shadow-sm;
      border-color: rgb(212 212 216); /* neutral-300 */
      background: white;
    }
    .navbtn:hover{ box-shadow: 0 1px 2px rgba(0,0,0,.06); background: rgb(250 250 250); }
    .navbtn.active{
      border-color: rgba(5,150,105,.35); /* emerald-600/35 */
      background: var(--emerald-50);
      color: var(--emerald-700);
      box-shadow: 0 2px 6px rgba(4,120,87,.12);
    }
    /* мини-скролл для внутренних списков по желанию */
    .hide-scrollbar::-webkit-scrollbar{ width:8px; height:8px; }
    .hide-scrollbar::-webkit-scrollbar-thumb{ background:rgba(0,0,0,0.15); border-radius:8px; }
    .hide-scrollbar{ scrollbar-width:thin; }
  </style>
</head>
<body class="bg-[#F7F8FA] no-scrollbar">
  <div id="root"></div>

  <script type="text/babel">
    const {useState, useEffect, useMemo, useRef, Fragment} = React;

    // ---------- Config ----------
    const MAX_FTE = 1.2;
    const WEEK_COL_PX = 72;
    const TEAM_BAR_COLOR = "#22c55e";
    const VISIBLE_WEEKS = 16;

    // ---------- Persistence ----------
    const LS_KEY = "fteplanner.v1";
    function loadAll(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||"{}"); }catch{ return {}; } }
    function loadJSON(key, fallback){ const all = loadAll(); return (key in all) ? all[key] : fallback; }
    function saveJSON(patch){
      try{
        const all = loadAll();
        const merged = {...all, ...patch};
        localStorage.setItem(LS_KEY, JSON.stringify(merged));
      }catch{}
    }

    // ---------- Date helpers ----------
    const fmtISO = (date) => date.toISOString().slice(0,10);
    const addDays = (d, n) => { const x=new Date(d); x.setDate(x.getDate()+n); x.setHours(0,0,0,0); return x; };
    const startOfISOWeek = (d) => { const day=d.getDay(); const diff=(day===0?-6:1)-day; const m=new Date(d); m.setDate(d.getDate()+diff); m.setHours(0,0,0,0); return m; };
    const addWeeks = (m, n) => { const d=new Date(m); d.setDate(d.getDate()+n*7); d.setHours(0,0,0,0); return d; };
    const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
    const scaleRatio = (v, max=MAX_FTE) => clamp(v/max, 0, 1);
    const pad2 = (n) => (n<10?`0${n}`:String(n));
    const fmtDM = (d) => `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}`;
    const RU_MONTHS_FULL = ["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"];
    const yearOfISO = (iso)=> new Date(iso).getFullYear();
    const monthIdxOfISO = (iso)=> new Date(iso).getMonth();
    const weekRangeLabel = (iso) => { const d=new Date(iso); const end=addDays(d,6); return `${fmtDM(d)}–${fmtDM(end)}`; };
    const rndId = () => (globalThis.crypto && crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2));
    const fmtFTE1 = (n) => (Math.round(n*10)/10).toFixed(1);
    const yearWeekMondays = (year) => { let m=startOfISOWeek(new Date(year,0,1)); const end=new Date(year,11,31); end.setHours(0,0,0,0); const list=[]; while(m<=end){ list.push(fmtISO(m)); m=addDays(m,7);} return list; };

    // ---------- Seeds ----------
    const base = startOfISOWeek(new Date());
    const initialWeeks = Array.from({length:24}, (_,i)=> fmtISO(addWeeks(base, i-4)));
    const seedPeople = [
      { id:"p1", name:"Саша", role:"manager", capacityPerWeek:1, active:true, external:false },
      { id:"p2", name:"Катя К.", role:"designer", capacityPerWeek:1, active:true, external:false },
    ];
    const seedProjects = [
      { id:"pr1", name:"HR Подкасты", status:"active", color:"#3b82f6" },
      { id:"pr2", name:"Арктика Медиа", status:"active", color:"#f43f5e" },
      { id:"pr3", name:"Падел-теннис", status:"planned", color:"#06b6d4" },
    ];
    const seedAssignments = [
      { id:"a1", personId:"p1", projectId:"pr1", weekStart: initialWeeks[4], fte:0.3 },
      { id:"a2", personId:"p1", projectId:"pr2", weekStart: initialWeeks[4], fte:0.2 },
      { id:"a3", personId:"p2", projectId:"pr2", weekStart: initialWeeks[5], fte:0.4 },
    ];
    const seedRoles = ["designer","dev","manager","pm","other"];

    // ---------- Aggregations ----------
    const personWeekTotal = (as, pid, w) => as.filter(a=>a.personId===pid && a.weekStart===w).reduce((s,a)=>s+a.fte,0);
    const fteFor = (as, pid, pr, w) => as.filter(a=>a.personId===pid && a.projectId===pr && a.weekStart===w).reduce((s,a)=>s+a.fte,0);
    const mergeOrder = (existing, nextIds) => {
      const seen=new Set(); const res=[];
      for(const id of (existing||[])) if(nextIds.includes(id) && !seen.has(id)){ res.push(id); seen.add(id); }
      for(const id of nextIds) if(!seen.has(id)){ res.push(id); seen.add(id); }
      return res;
    };

    // ---------- Icons ----------
    function StatusIcon({status}){
      const common = { width:16, height:16, viewBox:"0 0 24 24", fill:"white" };
      if(status==="active") return (<svg {...common}><polygon points="8,5 19,12 8,19"/></svg>);
      if(status==="onhold") return (<svg {...common}><rect x="6" y="5" width="4" height="14"/><rect x="14" y="5" width="4" height="14"/></svg>);
      if(status==="done") return (<svg {...common}><rect x="6" y="6" width="12" height="12" rx="2"/></svg>);
      return (<svg {...common}><circle cx="12" cy="12" r="6"/></svg>);
    }
    const MinusIcon = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
           stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="5" y1="12" x2="19" y2="12"/>
      </svg>
    );
    const PencilIcon = () => (
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
           stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M12 20h9"/>
        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/>
      </svg>
    );
    const TrashIcon = () => (
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
           stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="3 6 5 6 21 6"/>
        <path d="M19 6l-1 14a2 2 0 0 1 2 2H8a2 2 0 0 1-2-2L5 6"/>
        <path d="M10 11v6"/>
        <path d="M14 11v6"/>
        <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/>
      </svg>
    );
    const EyedropperIcon = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
           stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" aria-hidden="true">
        <path d="M19 2l3 3-7.5 7.5"/>
        <path d="M16 5l3 3"/>
        <path d="M9 11l-6 6v3h3l6-6"/>
      </svg>
    );

    // ---------- Week navigator ----------
    function useWeeksWindow(){
      const [weeks, setWeeks] = useState(loadJSON("weeks", initialWeeks));
      const savedFirstISO = loadJSON("firstWeekISO", weeks[0]);
      const initIdx = Math.max(0, weeks.indexOf(savedFirstISO));
      const [firstIdx, setFirstIdx] = useState(initIdx);

      const ensureRange = (needIdx) => {
        if(needIdx < 0){
          const first = new Date(weeks[0]);
          const prepend = Array.from({length: Math.ceil((-needIdx)/8)*8 }, (_,i)=> fmtISO(addWeeks(first, -(i+1)))).reverse();
          const next = [...prepend, ...weeks];
          setWeeks(next);
          return { weeks: next, firstIdx: needIdx + prepend.length };
        }
        if(needIdx + VISIBLE_WEEKS >= weeks.length){
          const last = new Date(weeks[weeks.length-1]);
          const more = Array.from({length:16}, (_,i)=> fmtISO(addWeeks(last, i+1)));
          const next = [...weeks, ...more];
          setWeeks(next);
          return { weeks: next, firstIdx: needIdx };
        }
        return { weeks, firstIdx: needIdx };
      };

      const goLeft = () => {
        const {weeks: w2, firstIdx: f2} = ensureRange(firstIdx-1);
        setFirstIdx(f2); saveJSON({firstWeekISO: w2[f2]}); saveJSON({weeks: w2});
      };
      const goRight = () => {
        const {weeks: w2, firstIdx: f2} = ensureRange(firstIdx+1);
        setFirstIdx(f2); saveJSON({firstWeekISO: w2[f2]}); saveJSON({weeks: w2});
      };
      const goToday = () => {
        const todayISO = fmtISO(startOfISOWeek(new Date()));
        let idx = weeks.indexOf(todayISO);
        if(idx<0){
          let m = startOfISOWeek(new Date(todayISO));
          const end = addWeeks(m, 200);
          const set = new Set(weeks);
          const add = [];
          while(m<=end){ const iso=fmtISO(m); if(!set.has(iso)) add.push(iso); m = addDays(m,7); }
          const next = [...weeks, ...add].sort();
          setWeeks(next);
          idx = next.indexOf(todayISO);
          saveJSON({weeks: next});
        }
        const {weeks: w2, firstIdx: f2} = ensureRange(idx);
        setFirstIdx(f2); saveJSON({firstWeekISO: w2[f2]});
      };

      const visible = useMemo(()=> weeks.slice(firstIdx, firstIdx+VISIBLE_WEEKS), [weeks, firstIdx]);

      return {weeks, setWeeks, firstIdx, setFirstIdx, visible, goLeft, goRight, goToday};
    }

    // ---------- Timeline header (Год → Месяц → Неделя) ----------
    function TimelineHeader({visible, labelLeft="Сотрудники"}){
      // сгруппируем видимые недели по (год, месяц)
      const monthGroups = [];
      let curKey=null, curCount=0, curYear=null, curMonth=null;
      visible.forEach((iso, idx) => {
        const y = yearOfISO(iso);
        const m = monthIdxOfISO(iso);
        const key = `${y}-${m}`;
        if(key!==curKey){
          if(curKey!==null) monthGroups.push({key:curKey, year:curYear, month:curMonth, count:curCount});
          curKey = key; curCount=1; curYear=y; curMonth=m;
        }else curCount++;
        if(idx===visible.length-1) monthGroups.push({key:curKey, year:curYear, month:curMonth, count:curCount});
      });

      // для недель — 1..N внутри каждого месяца
      const weekIndexInMonth = [];
      monthGroups.forEach(g => { for(let i=1;i<=g.count;i++) weekIndexInMonth.push(i); });

      const firstYear = monthGroups[0]?.year ?? new Date().getFullYear();
      const lastYear = monthGroups[monthGroups.length-1]?.year ?? firstYear;
      const yearTitle = (firstYear===lastYear) ? `${firstYear} г.` : `${firstYear}–${lastYear} гг.`;

      return (
        <div className="grid mb-1" style={{gridTemplateColumns:`var(--left-col-w) repeat(${visible.length}, ${WEEK_COL_PX}px)`}}>
          {/* Левый блок — общая плашка раздела (тянется на три ряда) */}
          <div className="sticky left-0 z-50 bg-[#F7F8FA] border-r border-neutral-200 p-1" style={{gridRow:"span 3 / span 3"}}>
            <div className="h-full rounded-2xl bg-white border border-neutral-200 shadow-sm flex items-center justify-center text-sm text-neutral-700">
              {labelLeft}
            </div>
          </div>

          {/* Ряд 1 — год */}
          <div className="col-span-full" style={{gridColumn:`2 / -1`}}>
            <div className="mx-1 rounded-xl px-3 py-1 text-center text-white text-sm font-medium"
                 style={{background:"var(--emerald-900)"}}>
              {yearTitle}
            </div>
          </div>

          {/* Ряд 2 — месяцы */}
          {monthGroups.map(g => (
            <div key={g.key} style={{gridColumn:`span ${g.count}`}}>
              <div className="mx-1 rounded-xl px-3 py-2 text-center text-sm font-medium"
                   style={{background:"var(--emerald-100)", color:"var(--emerald-700)"}}>
                {RU_MONTHS_FULL[g.month]}
              </div>
            </div>
          ))}

          {/* Ряд 3 — недели */}
          {visible.map((w, i) => (
            <div key={w}>
              <div className="mx-1 rounded-md px-2 py-1 text-center text-[12px] text-neutral-700 bg-white border border-neutral-200 shadow-sm">
                Неделя {weekIndexInMonth[i]}
              </div>
            </div>
          ))}
        </div>
      );
    }

    // =================================
    // App
    // =================================
    function App(){
      const [people, setPeople] = useState(loadJSON("people", seedPeople));
      const [projects, setProjects] = useState(loadJSON("projects", seedProjects));
      const [assignments, setAssignments] = useState(loadJSON("assignments", seedAssignments));
      const [roles, setRoles] = useState(loadJSON("roles",[...seedRoles]));
      const [projectTeams, setProjectTeams] = useState(()=>{
        const saved = loadJSON("projectTeams", {});
        const map = {};
        Object.keys(saved).forEach(k => (map[k]=new Set(saved[k])));
        if(Object.keys(map).length===0){
          for(const p of seedProjects) map[p.id]=new Set();
          for(const a of seedAssignments) (map[a.projectId] = map[a.projectId] || new Set()).add(a.personId);
        }
        return map;
      });
      const [vacations, setVacations] = useState(()=>{
        const saved = loadJSON("vacations", {});
        const map = {}; Object.keys(saved).forEach(k => (map[k] = new Set(saved[k])));
        return map;
      });
      const [personProjectOrder, setPersonProjectOrder] = useState(loadJSON("personProjectOrder", {}));
      const [teamOrder, setTeamOrder] = useState(()=> loadJSON("teamOrder", seedPeople.map(p=>p.id)));

      const [authed, setAuthed] = useState(loadJSON("authed", false));
      const [view, setView] = useState(loadJSON("view","team")); // 'team' | 'project' | 'employees'
      useEffect(()=> saveJSON({view}), [view]);

      const [selectedPersonId, setSelectedPersonId] = useState(null);

      const {weeks, setWeeks, visible, goLeft, goRight, goToday} = useWeeksWindow();

      // save effects
      useEffect(()=> saveJSON({people}), [people]);
      useEffect(()=> saveJSON({projects}), [projects]);
      useEffect(()=> saveJSON({assignments}), [assignments]);
      useEffect(()=> saveJSON({roles}), [roles]);
      useEffect(()=>{ const obj={}; Object.entries(projectTeams).forEach(([k,v])=> obj[k]=Array.from(v)); saveJSON({projectTeams:obj}); }, [projectTeams]);
      useEffect(()=>{ const obj={}; Object.entries(vacations).forEach(([k,v])=> obj[k]=Array.from(v)); saveJSON({vacations:obj}); }, [vacations]);
      useEffect(()=> saveJSON({personProjectOrder}), [personProjectOrder]);
      useEffect(()=> saveJSON({teamOrder}), [teamOrder]);

      // helpers
      const isVacation = (pid,w) => !!vacations[pid]?.has?.(w);
      const dragRow = useRef(null);

      const peopleForTeam = useMemo(()=> people.filter(p=>p.active && !p.external), [people]);
      const peopleActiveAll = useMemo(()=> people.filter(p=>p.active), [people]);

      useEffect(()=>{
        setTeamOrder(prev => mergeOrder(prev, peopleForTeam.map(p=>p.id)));
      }, [peopleForTeam]);

      const [roleFilter, setRoleFilter] = useState(loadJSON("roleFilter","all"));
      useEffect(()=> saveJSON({roleFilter}), [roleFilter]);

      const activeTeamIds = useMemo(()=> teamOrder.filter(id => peopleForTeam.some(p=>p.id===id)), [teamOrder, peopleForTeam]);
      const filteredTeamIds = useMemo(()=> activeTeamIds.filter(id => roleFilter==="all" ? true : (people.find(p=>p.id===id)?.role===roleFilter)), [activeTeamIds, roleFilter, people]);

      function deletePerson(pid){
        if(!confirm("Удалить сотрудника?")) return;
        setPeople(prev => prev.filter(p=>p.id!==pid));
        setAssignments(prev => prev.filter(a=>a.personId!==pid));
        setVacations(prev => { const c={}; Object.entries(prev).forEach(([k,v])=>{ if(k!==pid) c[k]=new Set(v); }); return c; });
        setProjectTeams(prev => { const c={}; Object.entries(prev).forEach(([k,v])=>{ const s=new Set(v); s.delete(pid); c[k]=s; }); return c; });
        setTeamOrder(prev => prev.filter(id=>id!==pid));
        if(selectedPersonId===pid) setSelectedPersonId(null);
      }
      function deleteProject(prid){
        if(!confirm("Удалить проект?")) return;
        setProjects(prev => prev.filter(p=>p.id!==prid));
        setAssignments(prev => prev.filter(a=>a.projectId!==prid));
        setProjectTeams(prev => { const c={}; Object.entries(prev).forEach(([k,v])=>{ if(k!==prid) c[k]=new Set(v); }); return c; });
        setPersonProjectOrder(prev => { const out={}; Object.entries(prev).forEach(([pid, arr]) => { out[pid]=(arr||[]).filter(x=>x!==prid); }); return out; });
      }

      const dragProjectIndex = useRef(null);
      const onProjectDragStart = (i) => { dragProjectIndex.current = i; };
      const onProjectDrop = (i) => {
        const from = dragProjectIndex.current;
        dragProjectIndex.current = null;
        if(from==null || from===i) return;
        setProjects(prev => {
          const arr = [...prev];
          const [moved] = arr.splice(from,1);
          arr.splice(i,0,moved);
          return arr;
        });
      };

      // create person
      const [createPersonOpen, setCreatePersonOpen] = useState(false);
      const [newPersonName, setNewPersonName] = useState("");
      const [newPersonRole, setNewPersonRole] = useState("other");
      const [newPersonExternal, setNewPersonExternal] = useState(false);
      function submitNewPerson(){
        const name = newPersonName.trim(); if(!name) return;
        const id = rndId();
        setPeople(p => [...p, { id, name, role:newPersonRole||"other", capacityPerWeek:1, active:true, external: !!newPersonExternal }]);
        setCreatePersonOpen(false); setNewPersonName(""); setNewPersonRole("other"); setNewPersonExternal(false);
      }

      // create project
      const [createProjectOpen, setCreateProjectOpen] = useState(false);
      const [newProjectName, setNewProjectName] = useState("");
      const [newProjectColor, setNewProjectColor] = useState("#3b82f6");
      const [newProjectStatus, setNewProjectStatus] = useState("active");
      const [projSearch, setProjSearch] = useState("");
      const [projTeamSel, setProjTeamSel] = useState(()=> new Set());
      const personSuggestions = useMemo(()=> peopleActiveAll.filter(p => p.name.toLowerCase().includes(projSearch.toLowerCase()) && !projTeamSel.has(p.id)).slice(0,6), [peopleActiveAll, projSearch, projTeamSel]);
      function submitNewProject(){
        const name = newProjectName.trim(); if(!name) return;
        const id = rndId(); const color = newProjectColor || "#64748b"; const status = newProjectStatus;
        setProjects(ps => [...ps, { id, name, color, status }]);
        setProjectTeams(pt => { const copy={}; Object.entries(pt).forEach(([k,v])=>copy[k]=new Set(v)); copy[id]=new Set(projTeamSel); return copy; });
        setCreateProjectOpen(false); setNewProjectName(""); setProjSearch(""); setProjTeamSel(new Set()); setNewProjectStatus("active"); setView("project");
      }

      if(!authed){
        return (
          <div className="min-h-screen grid place-items-center bg-[#F7F8FA]">
            <div className="bg-white w-[360px] rounded-2xl shadow-lg border border-neutral-200 p-5">
              <div className="text-center mb-4"><div className="text-2xl font-semibold">Вход</div></div>
              <AuthForm onSuccess={(remember)=>{ if(remember){ saveJSON({authed:true, remember:true}); } else { saveJSON({remember:false, authed:false}); } setAuthed(true); }} />
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-[#F7F8FA] text-neutral-900 font-sans">
          {/* Глобальная шапка */}
          <header className="sticky top-0 z-50 border-b border-neutral-200 bg-white/90 backdrop-blur" style={{height:'var(--app-header-h)'}}>
            <div className="max-w-screen-2xl mx-auto px-4 h-full flex items-center gap-3">
              <div className="text-lg font-semibold tracking-tight text-green-600">Панквеб FTE Planner</div>
              <div className="ml-4 nav-group">
                <button className={`navbtn ${view==="team"?"active":""}`} onClick={()=>setView("team")}>Нагрузка</button>
                <button className={`navbtn ${view==="project"?"active":""}`} onClick={()=>setView("project")}>Проекты</button>
                <button className={`navbtn ${view==="employees"?"active":""}`} onClick={()=>setView("employees")}>Команда</button>
              </div>
              <div className="ml-auto flex items-center gap-2">
                <button onClick={()=>setCreateProjectOpen(true)} className="btn">+ Проект</button>
                <button onClick={()=>setCreatePersonOpen(true)} className="btn">+ Сотрудник</button>
              </div>
            </div>
          </header>

          <main className="max-w-screen-2xl mx-auto p-4">
            {/* Навигатор недель нужен только во «Нагрузка» */}
            {view==="team" && (
              <div className="sticky top-[var(--app-header-h)] z-50 bg-[#F7F8FA] py-2 mb-2">
                <div className="flex items-center justify-end gap-2">
                  <div className="flex items-center gap-2">
                    <label className="text-sm text-neutral-700">Фильтр роли</label>
                    <select className="border border-neutral-300 rounded-xl px-2 py-1 text-sm"
                            value={roleFilter} onChange={e=>setRoleFilter(e.target.value)}>
                      <option value="all">Все</option>
                      {roles.map(r => (<option key={r} value={r}>{r}</option>))}
                    </select>
                    <button onClick={goLeft} className="btn">‹</button>
                    <button onClick={goToday} className="btn">Сегодня</button>
                    <button onClick={goRight} className="btn">›</button>
                  </div>
                </div>
              </div>
            )}

            {view==="team" ? (
              // -------- Нагрузка --------
              <>
                <TimelineHeader visible={visible} labelLeft="Сотрудники"/>
                <div className="grid" style={{gridTemplateColumns:`var(--left-col-w) repeat(${visible.length}, ${WEEK_COL_PX}px)`}}>
                  <div className="sticky left-0 z-50 bg-[#F7F8FA] backdrop-blur border-r border-neutral-200 p-2 text-sm font-medium" />
                  {filteredTeamIds.map((pid, rowIdx) => {
                    const person = people.find(p=>p.id===pid);
                    return (
                      <Fragment key={pid}>
                        <div
                          className="sticky left-0 z-50 bg-[#F7F8FA] backdrop-blur border-r border-neutral-200 p-1"
                          draggable
                          onDragStart={()=>{ dragRow.current=rowIdx; }}
                          onDragOver={e=>e.preventDefault()}
                          onDrop={()=>{
                            const from=dragRow.current; const to=rowIdx; if(from==null || from===to) return;
                            const arr=[...filteredTeamIds]; const id=arr.splice(from,1)[0]; arr.splice(to,0,id);
                            const inactive = teamOrder.filter(id => !filteredTeamIds.includes(id));
                            setTeamOrder([...arr, ...inactive]); dragRow.current=null;
                          }}
                        >
                          <div
                            role="button"
                            tabIndex={0}
                            onClick={()=>setSelectedPersonId(person.id)}
                            onKeyDown={e=>{ if(e.key==='Enter'||e.key===' ') setSelectedPersonId(person.id) }}
                            className="w-full text-left"
                          >
                            <div className="relative bg-white rounded-2xl shadow-sm h-[120px] flex flex-col justify-center pl-5 pr-8 hover:shadow-md hover:bg-blue-50/70 transition">
                              <div className="font-medium truncate" title="Открыть карточку сотрудника">{person.name}</div>
                              <div className="mt-1 text-[11px] text-neutral-600">{String(person.role||"").toUpperCase()}</div>
                            </div>
                          </div>
                        </div>

                        {visible.map(week => {
                          const total = personWeekTotal(assignments, person.id, week);
                          const ratio = scaleRatio(total);
                          const vac = isVacation(person.id, week);
                          return (
                            <div key={week+pid} className="p-1 bg-transparent h-[120px] relative">
                              <div className={`bg-white rounded-2xl shadow-sm h-full flex items-end justify-center relative ${total>1.0001?"ring-1 ring-red-300":""}`}>
                                <div className="relative w-14 h-[92%] rounded-lg bg-neutral-200 overflow-hidden">
                                  {!vac && (<div className="absolute bottom-0 left-0 right-0" style={{height:`${ratio*100}%`, background:TEAM_BAR_COLOR}} />)}
                                </div>
                                {!vac && (
                                  <div className="absolute inset-0 flex items-center justify-center text-sm font-semibold text-neutral-900" title={fmtFTE1(total)}>
                                    {fmtFTE1(total)}
                                  </div>
                                )}
                                {vac && (<div className="absolute inset-0 flex items-center justify-center text-2xl" title="Отпуск">🏖</div>)}
                              </div>
                            </div>
                          );
                        })}
                      </Fragment>
                    );
                  })}
                </div>
              </>
            ) : view==="project" ? (
              // -------- Проекты --------
              <>
                <div className="bg-white rounded-2xl border border-neutral-200 shadow-sm p-3 sticky top-[var(--app-header-h)] z-50 mb-2">
                  <div className="text-sm font-medium">Роли</div>
                  <div className="mt-2 flex flex-wrap gap-2">
                    {roles.map(r => (
                      <span key={r} className="inline-flex items-center gap-2 px-2 py-1 rounded-full border border-neutral-200 bg-neutral-50 text-xs">
                        {r}
                      </span>
                    ))}
                  </div>
                </div>

                <div className="grid" style={{gridTemplateColumns:`300px 1fr`}}>
                  {projects.map((project, idx) => (
                    <Fragment key={project.id}>
                      <div
                        className="sticky left-0 z-40 bg-[#F7F8FA] backdrop-blur border-r border-neutral-200 p-1"
                        draggable
                        onDragStart={()=>onProjectDragStart(idx)}
                        onDragOver={e=>e.preventDefault()}
                        onDrop={()=>onProjectDrop(idx)}
                        title="Перетащите, чтобы изменить порядок"
                      >
                        <div className="relative bg-white rounded-2xl border border-neutral-200 shadow-sm p-3 flex items-center gap-3 min-w-0 h-[120px] cursor-grab active:cursor-grabbing select-none">
                          <button
                            className="w-8 h-8 rounded-lg flex items-center justify-center"
                            style={{background:project.color}}
                            title="Статус проекта"
                            onClick={()=> setProjects(prev => prev.map(p => p.id===project.id ? {...p, status:(p.status==="active"?"onhold": p.status==="onhold"?"done": p.status==="done"?"planned":"active")} : p))}
                          >
                            <StatusIcon status={project.status}/>
                          </button>
                          <div className="font-medium truncate" title={project.name}>{project.name}</div>

                          {/* Пипетка */}
                          <button
                            className="absolute top-2 right-10 w-7 h-7 rounded-lg grid place-items-center text-neutral-700 hover:bg-neutral-50"
                            title="Изменить цвет"
                            onClick={()=> document.getElementById(`color-${project.id}`)?.click()}
                            type="button"
                          >
                            <EyedropperIcon/>
                          </button>
                          <input
                            id={`color-${project.id}`}
                            type="color"
                            className="hidden"
                            value={project.color}
                            onChange={(e)=> setProjects(prev => prev.map(p => p.id===project.id ? {...p, color:e.target.value} : p))}
                          />

                          {/* Удаление */}
                          <button
                            type="button"
                            draggable={false}
                            aria-label="Удалить проект"
                            onMouseDown={(e)=>e.preventDefault()}
                            onClick={()=> deleteProject(project.id)}
                            title="Удалить проект"
                            className="absolute top-2 right-2 w-7 h-7 rounded-lg grid place-items-center text-neutral-700 hover:text-red-600 hover:bg-red-50 border border-neutral-300 hover:border-red-200 transition"
                          >
                            <MinusIcon/>
                          </button>
                        </div>
                      </div>
                      <div className="border border-neutral-200 p-3">
                        <div className="bg-white rounded-2xl border border-neutral-200 shadow-sm p-3">
                          <ProjectTeamSelector
                            project={project}
                            people={peopleActiveAll}
                            projectTeams={projectTeams}
                            setProjectTeams={setProjectTeams}
                          />
                        </div>
                      </div>
                    </Fragment>
                  ))}
                </div>
              </>
            ) : (
              // -------- Команда (все сотрудники) --------
              <EmployeesPage
                people={people}
                setPeople={setPeople}
                projects={projects}
                projectTeams={projectTeams}
                setProjectTeams={setProjectTeams}
                deletePerson={deletePerson}
              />
            )}
          </main>

          {selectedPersonId && (
            <PersonPage
              person={people.find(p=>p.id===selectedPersonId)}
              projects={projects}
              assignments={assignments}
              teamByProject={projectTeams}
              vacations={vacations}
              setVacations={setVacations}
              order={personProjectOrder[selectedPersonId]}
              setOrder={o=> setPersonProjectOrder(prev => ({...prev, [selectedPersonId]: o}))}
              onClose={()=> setSelectedPersonId(null)}
              onSave={setAssignments}
              setPeople={setPeople}
              weeksAll={weeks}
              visibleWeeks={visible}
              goLeft={goLeft}
              goRight={goRight}
              goToday={goToday}
              roles={roles}
              view={view}
              setView={(v)=>{ setView(v); setSelectedPersonId(null); }}
            />
          )}

          <CreatePersonModal
            open={createPersonOpen}
            onClose={()=>setCreatePersonOpen(false)}
            name={newPersonName} setName={setNewPersonName}
            role={newPersonRole} setRole={setNewPersonRole}
            external={newPersonExternal} setExternal={setNewPersonExternal}
            onSubmit={submitNewPerson} roles={roles}
          />
          <CreateProjectModal
            open={createProjectOpen}
            onClose={()=>setCreateProjectOpen(false)}
            name={newProjectName}
            setName={setNewProjectName}
            color={newProjectColor}
            setColor={setNewProjectColor}
            status={newProjectStatus}
            setStatus={setNewProjectStatus}
            search={projSearch}
            setSearch={setProjSearch}
            teamSel={projTeamSel}
            setTeamSel={setProjTeamSel}
            people={peopleActiveAll}
            suggestions={personSuggestions}
            onSubmit={submitNewProject}
          />
        </div>
      );
    }

    // ---------- FULL-PAGE «Один сотрудник» ----------
    function PersonPage({ person, projects, assignments, teamByProject, vacations, setVacations, order, setOrder, onClose, onSave, setPeople, visibleWeeks, goLeft, goRight, goToday, roles, view, setView }){
      if(!person) return null;
      const isVacation = (pid,w) => !!vacations[pid]?.has?.(w);

      const unionIds = useMemo(()=>{
        const ids=new Set();
        assignments.forEach(a=>{ if(a.personId===person.id) ids.add(a.projectId); });
        Object.entries(teamByProject).forEach(([pr,set])=>{ if(set.has(person.id)) ids.add(pr); });
        return Array.from(ids);
      }, [assignments, person.id, teamByProject]);
      const orderedIds = useMemo(()=> mergeOrder(order, unionIds), [order, unionIds]);
      useEffect(()=>{ setOrder(orderedIds); }, [orderedIds, setOrder]);

      const [editKey, setEditKey] = useState(null);
      const [editVal, setEditVal] = useState("");
      function beginEdit(pid, w, cur){ if(isVacation(person.id,w)) return; setEditKey(`${pid}|${w}`); setEditVal(fmtFTE1(cur||0)); }
      function commitEdit(pid, w){
        const k = `${pid}|${w}`; if(editKey!==k) return;
        const next = parseFloat((editVal||"").replace(",", "."));
        setEditKey(null);
        if(isNaN(next) || next<0 || next>MAX_FTE) return;
        onSave(prev => { const rest = prev.filter(a => !(a.personId===person.id && a.projectId===pid && a.weekStart===w)); return [...rest, { id:rndId(), personId:person.id, projectId:pid, weekStart:w, fte:next }]; });
      }

      const dragIndex = useRef(null);
      const onDragStart = (i)=>{ dragIndex.current=i; };
      const onDrop = (i)=>{ const from=dragIndex.current; dragIndex.current=null; if(from==null || from===i) return; const arr=[...orderedIds]; const [moved]=arr.splice(from,1); arr.splice(i,0,moved); setOrder(arr); };

      const [vacOpen, setVacOpen] = useState(false);
      const [personVac, setPersonVac] = useState(()=> new Set(vacations[person.id] || []));
      const [vacTab, setVacTab] = useState("range");
      const [vFrom, setVFrom] = useState("");
      const [vTo, setVTo] = useState("");
      useEffect(()=>{ setPersonVac(new Set(vacations[person.id] || [])); }, [person.id, vacations]);
      const saveVac = () => {
        let setToSave = new Set(personVac);
        if(vFrom && vTo){
          const d1=new Date(vFrom), d2=new Date(vTo);
          if(!(isNaN(d1) || isNaN(d2) || d1>d2)){
            let m1=startOfISOWeek(d1); const m2=startOfISOWeek(d2);
            while(m1<=m2){ setToSave.add(fmtISO(m1)); m1=addDays(m1,7); }
          }
        }
        setVacations(prev => { const c={}; Object.entries(prev).forEach(([k,v])=> (c[k]=new Set(v))); c[person.id]=setToSave; return c; });
        onSave(prev => prev.filter(a => !(a.personId===person.id && setToSave.has(a.weekStart))));
        setVacOpen(false);
      };
      const clearVacationWeek = (week) => setVacations(prev => { const c={}; Object.entries(prev).forEach(([k,v])=> (c[k]=new Set(v))); const s=new Set(c[person.id]||[]); s.delete(week); c[person.id]=s; return c; });

      const visible = visibleWeeks;
      const weekTotals = useMemo(()=> visible.map(w => (isVacation(person.id,w) ? 0 : assignments.filter(a=>a.personId===person.id && a.weekStart===w).reduce((s,a)=>s+a.fte,0))), [assignments, person.id, vacations, visible]);

      return (
        <div className="fixed inset-0 z-50 bg-[#F7F8FA] overflow-auto no-scrollbar">
          {/* Шапка-навигатор */}
          <div className="sticky top-0 z-50 border-b border-neutral-200 bg-white/90 backdrop-blur" style={{height:'var(--app-header-h)'}}>
            <div className="max-w-screen-2xl mx-auto px-4 h-full flex items-center gap-3">
              <div className="text-lg font-semibold tracking-tight text-green-600">Панквеб FTE Planner</div>
              <div className="ml-4 nav-group">
                <button className={`navbtn ${view==="team"?"active":""}`} onClick={()=>{ setView("team"); onClose(); }}>Нагрузка</button>
                <button className={`navbtn ${view==="project"?"active":""}`} onClick={()=>{ setView("project"); onClose(); }}>Проекты</button>
                <button className={`navbtn ${view==="employees"?"active":""}`} onClick={()=>{ setView("employees"); onClose(); }}>Команда</button>
              </div>
              <div className="ml-auto" />
            </div>
          </div>

          {/* Timeline */}
          <div className="max-w-screen-2xl mx-auto px-4">
            <div className="sticky top-[var(--app-header-h)] z-50 bg-[#F7F8FA] py-2">
              <div className="flex items-center justify-end gap-2">
                <button onClick={goLeft} className="btn">‹</button>
                <button onClick={goToday} className="btn">Сегодня</button>
                <button onClick={goRight} className="btn">›</button>
              </div>
            </div>

            <TimelineHeader visible={visible} labelLeft="Проекты"/>

            <div className="grid mb-1" style={{gridTemplateColumns:`var(--left-col-w) repeat(${visible.length}, ${WEEK_COL_PX}px)`}}>
              <div className="sticky left-0 z-50 bg-[#F7F8FA] border-r border-neutral-200 p-1" />
              {visible.map((w,i)=>(
                <div key={w} className="h-6 flex items-center justify-center">
                  <span className="px-2 py-0.5 rounded-lg border border-neutral-300 bg-white text-[12px] font-medium shadow-sm">{fmtFTE1(weekTotals[i])}</span>
                </div>
              ))}
            </div>

            <div className="grid pb-4" style={{gridTemplateColumns:`var(--left-col-w) repeat(${visible.length}, ${WEEK_COL_PX}px)`}}>
              {orderedIds.map((pid, idx) => {
                const pr = projects.find(p=>p.id===pid); if(!pr) return null;
                return (
                  <Fragment key={pid}>
                    <div className="sticky left-0 z-50 bg-[#F7F8FA] border-r border-neutral-200 p-1" draggable onDragStart={()=>onDragStart(idx)} onDragOver={(e)=>e.preventDefault()} onDrop={()=>onDrop(idx)}>
                      <div className="bg-white rounded-2xl shadow-sm h-[120px] flex items-center gap-2 pl-5 pr-3 cursor-grab active:cursor-grabbing select-none">
                        <span className="text-neutral-400">⋮⋮</span>
                        <button className="w-6 h-6 rounded-lg flex items-center justify-center" style={{background:pr.color}} title="Статус"><StatusIcon status={pr.status}/></button>
                        <div className="font-medium truncate" title={pr.name}>{pr.name}</div>
                      </div>
                    </div>
                    {visible.map(week => {
                      const fte = fteFor(assignments, person.id, pid, week);
                      const ratio = scaleRatio(fte);
                      const k = `${pid}|${week}`;
                      const editing = editKey===k;
                      const vac = isVacation(person.id, week);
                      return (
                        <div key={week+pid} className="p-1 bg-transparent h-[120px] relative">
                          <div className="bg-white rounded-2xl shadow-sm h-full flex items-end justify-center relative">
                            <div className="relative w-14 h-[92%] rounded-lg bg-neutral-200 overflow-hidden">
                              {!vac && (<div className="absolute bottom-0 left-0 right-0" style={{height:`${ratio*100}%`, background:pr.color}} />)}
                            </div>
                            {!vac && (!editing ? (
                              <div className="absolute inset-0 text-sm font-semibold text-neutral-800 flex items-center justify-center" title={fmtFTE1(fte)} onClick={()=>beginEdit(pid, week, fte)}>{fmtFTE1(fte)}</div>
                            ) : (
                              <input
                                autoFocus
                                inputMode="decimal"
                                className="absolute inset-0 m-auto h-8 w-16 text-center text-sm font-semibold border border-neutral-300 rounded-md bg-white shadow-sm"
                                value={editVal}
                                onChange={e=>setEditVal(e.target.value)}
                                onBlur={()=>commitEdit(pid, week)}
                                onKeyDown={(e)=>{ if(e.key==="Enter") e.currentTarget.blur(); if(e.key==="Escape") setEditKey(null); }}
                              />
                            ))}
                            {vac && (<button className="absolute inset-0 flex items-center justify-center text-2xl" title="Снять отпуск" onClick={()=>clearVacationWeek(week)}>🏖</button>)}
                          </div>
                        </div>
                      );
                    })}
                  </Fragment>
                );
              })}
            </div>
          </div>

          {/* Модал отпусков */}
          {vacOpen && (
            <div className="fixed inset-0 z-50 flex items-center justify-center" onClick={()=>setVacOpen(false)}>
              <div className="absolute inset-0 bg-black/40"/>
              <div className="relative bg-white rounded-2xl shadow-xl border border-neutral-200 w-[720px] max-h-[80vh] overflow-auto p-4" onClick={(e)=>e.stopPropagation()}>
                <div className="text-base font-semibold mb-3">Отпуск — {person.name}</div>
                <div className="mb-3 inline-flex items-center gap-1 rounded-xl border border-neutral-200 p-1">
                  <button className={`px-3 py-1 rounded-lg text-sm ${vacTab==="range" ? "bg-neutral-100 shadow":""}`} onClick={()=>setVacTab("range")}>Диапазон дат</button>
                  <button className={`px-3 py-1 rounded-lg text-sm ${vacTab==="weeks" ? "bg-neutral-100 shadow":""}`} onClick={()=>setVacTab("weeks")}>По неделям</button>
                </div>
                {vacTab==="range" && (
                  <div className="space-y-3">
                    <div className="flex items-center gap-2">
                      <label className="text-sm text-neutral-700">С</label>
                      <input type="date" value={vFrom} onChange={e=>setVFrom(e.target.value)} className="border border-neutral-300 rounded-lg px-2 py-1"/>
                      <label className="text-sm text-neutral-700">по</label>
                      <input type="date" value={vTo} onChange={e=>setVTo(e.target.value)} className="border border-neutral-300 rounded-lg px-2 py-1"/>
                    </div>
                    {(vFrom && vTo) && (<div className="text-xs text-neutral-600">Будут добавлены недели диапазона после сохранения.</div>)}
                  </div>
                )}
                {vacTab==="weeks" && (
                  <div className="space-y-3">
                    <div className="text-sm text-neutral-600">Отметьте недели (диапазон дат):</div>
                    <div className="grid grid-cols-3 gap-2">
                      {yearWeekMondays(new Date().getFullYear()).map(m => (
                        <label key={m} className="flex items-center gap-2 p-2 border border-neutral-200 rounded-xl hover:bg-emerald-50">
                          <input type="checkbox" checked={personVac.has(m)} onChange={()=> setPersonVac(prev=>{ const s=new Set(prev); if(s.has(m)) s.delete(m); else s.add(m); return s; }) } />
                          <span className="text-sm">{weekRangeLabel(m)}</span>
                          {personVac.has(m) && (<button className="ml-auto text-emerald-700" title="Убрать" onClick={()=> setPersonVac(prev=>{ const s=new Set(prev); s.delete(m); return s; })}>−</button>)}
                        </label>
                      ))}
                    </div>
                  </div>
                )}
                {Array.from(personVac).length>0 && (
                  <div className="mt-3">
                    <div className="text-sm mb-1">Выбрано недель:</div>
                    <div className="flex flex-wrap gap-2">
                      {Array.from(personVac).map(w => (
                        <span key={w} className="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs bg-blue-50 text-blue-800 border border-blue-200">
                          {weekRangeLabel(w)}
                          <button className="ml-1" title="Удалить" onClick={()=> setPersonVac(prev=>{ const s=new Set(prev); s.delete(w); return s; }) }>×</button>
                        </span>
                      ))}
                    </div>
                  </div>
                )}
                <div className="mt-4 flex justify-end gap-2">
                  <button className="btn" onClick={()=>setVacOpen(false)}>Отмена</button>
                  <button className="rounded-xl border border-amber-300 bg-amber-50 text-amber-800 px-3 py-1" onClick={saveVac}>Сохранить</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ---------- ProjectTeamSelector ----------
    function ProjectTeamSelector({project, people, projectTeams, setProjectTeams}){
      const [search, setSearch] = useState("");
      const list = useMemo(()=> people.filter(p => !projectTeams[project.id]?.has(p.id) && p.name.toLowerCase().includes(search.toLowerCase())).slice(0,8), [people, project.id, projectTeams, search]);

      const addToTeam = (pid) => {
        setProjectTeams(prev => {
          const copy={}; Object.entries(prev).forEach(([k,v])=> (copy[k]=new Set(v)));
          (copy[project.id]=copy[project.id]||new Set()).add(pid);
          return copy;
        });
      };
      const removeFromTeam = (pid) => {
        setProjectTeams(prev => {
          const copy={}; Object.entries(prev).forEach(([k,v])=> (copy[k]=new Set(v)));
          copy[project.id]?.delete(pid);
          return copy;
        });
      };

      return (
        <div>
          <div className="flex items-center gap-2">
            <input
              value={search}
              onChange={e=>setSearch(e.target.value)}
              placeholder="Добавить сотрудника..."
              className="w-full max-w-sm border border-neutral-300 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-200"
            />
          </div>
          {search && (
            <div className="mt-2 border border-neutral-200 rounded-xl overflow-hidden">
              {list.length>0 ? (
                list.map(sug => (
                  <button key={sug.id} className="w-full text-left px-3 py-2 hover:bg-blue-50" onClick={()=>{ addToTeam(sug.id); setSearch(""); }}>
                    {sug.name} <span className="text-[10px] text-neutral-500">{String(sug.role).toUpperCase()}</span> {sug.external && <span className="ml-1 text-[10px] text-emerald-700">внешн.</span>}
                  </button>
                ))
              ) : (
                <div className="px-3 py-2 text-xs text-neutral-500">Не найдено</div>
              )}
            </div>
          )}

          <div className="mt-3 flex flex-wrap gap-2">
            {Array.from(projectTeams[project.id] || new Set()).map(pid => {
              const p = people.find(x=>x.id===pid); if(!p) return null;
              return (
                <span key={pid} className="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs bg-blue-50 text-blue-800 border border-blue-200">
                  {p.name}{p.external && <span className="ml-1 text-emerald-700">(внешн.)</span>}
                  <button className="ml-1 text-blue-700/70 hover:text-blue-900" onClick={()=>removeFromTeam(pid)}>×</button>
                </span>
              );
            })}
          </div>
        </div>
      );
    }

    // ---------- EmployeesPage ----------
    function EmployeesPage({people, setPeople, projects, projectTeams, setProjectTeams, deletePerson}){
      const [search, setSearch] = useState("");
      const list = useMemo(()=> people.filter(p => p.active && p.name.toLowerCase().includes(search.toLowerCase())), [people, search]);

      return (
        <div className="space-y-3">
          <input
            value={search}
            onChange={e=>setSearch(e.target.value)}
            placeholder="Найти сотрудника..."
            className="w-full border border-neutral-300 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-200"
          />

          <div className="grid" style={{gridTemplateColumns:`300px 1fr`}}>
            {list.map(p => (
              <Fragment key={p.id}>
                <div className="sticky left-0 z-40 bg-[#F7F8FA] backdrop-blur border-r border-neutral-200 p-1">
                  <div className="relative bg-white rounded-2xl border border-neutral-200 shadow-sm p-3 min-w-0 h-[120px] flex flex-col justify-center">
                    <div className="flex items-center gap-2">
                      <span className="font-medium truncate">{p.name}</span>
                      <button className="text-neutral-500 hover:text-red-600 ml-auto" title="Удалить сотрудника" onClick={()=>deletePerson(p.id)}><TrashIcon/></button>
                    </div>
                    <div className="mt-1 flex items-center gap-2">
                      <select
                        value={p.role||"other"}
                        onChange={e=> setPeople(prev => prev.map(x => x.id===p.id ? {...x, role:e.target.value} : x))}
                        className="text-[12px] px-2 py-1 rounded-full bg-neutral-100 border border-neutral-200"
                      >
                        {["designer","dev","manager","pm","other"].map(r => (<option key={r} value={r}>{r.toUpperCase()}</option>))}
                      </select>
                      <label className="text-xs flex items-center gap-1 ml-2">
                        <input type="checkbox" checked={!!p.external} onChange={e=> setPeople(prev => prev.map(x => x.id===p.id ? {...x, external:e.target.checked} : x))}/>
                        Внешний
                      </label>
                    </div>
                    <div className="mt-1 text-[11px] text-neutral-500">ID: {p.id.slice(0,6)}…</div>
                  </div>
                </div>

                <div className="border border-neutral-200 p-3">
                  <div className="bg-white rounded-2xl border border-neutral-200 shadow-sm p-3">
                    <PersonProjectsEditor person={p} projects={projects} projectTeams={projectTeams} setProjectTeams={setProjectTeams}/>
                  </div>
                </div>
              </Fragment>
            ))}
          </div>
        </div>
      );
    }

    // ---------- Inline editable ----------
    function EditableName({person, setPeople}){
      const [editing, setEditing] = useState(false);
      const [val, setVal] = useState(person.name);
      useEffect(()=> setVal(person.name), [person.id, person.name]);
      const commit = () => { const name=(val||"").trim(); setEditing(false); if(!name || name===person.name) return; setPeople(prev => prev.map(p => p.id===person.id ? {...p, name} : p)); };
      return editing ? (
        <input autoFocus value={val} onChange={e=>setVal(e.target.value)} onBlur={commit}
               onKeyDown={e=>{ if(e.key==="Enter") e.currentTarget.blur(); if(e.key==="Escape"){ setEditing(false); setVal(person.name);} }}
               className="text-lg font-semibold leading-tight border border-neutral-300 rounded-md px-2 py-0.5"/>
      ) : (
        <button className="text-lg font-semibold leading-tight hover:underline" title="Редактировать имя" onClick={()=>setEditing(true)}>{person.name}</button>
      );
    }
    function EditableRole({person, setPeople, roles}){
      const [editing, setEditing] = useState(false);
      const [val, setVal] = useState(person.role || "other");
      useEffect(()=> setVal(person.role || "other"), [person.id, person.role]);
      const commit = ()=>{ const role = val || "other"; setEditing(false); if(role===person.role) return; setPeople(prev => prev.map(p => p.id===person.id ? {...p, role} : p)); };
      return editing ? (
        <select autoFocus value={val} onChange={e=>setVal(e.target.value)} onBlur={commit} className="text-[11px] px-2 py-0.5 rounded-full bg-neutral-100 border border-neutral-200">
          {roles.map(r => (<option key={r} value={r}>{r.toUpperCase()}</option>))}
        </select>
      ) : (
        <button className="inline-flex items-center gap-1 text-[11px] px-2 py-0.5 rounded-full bg-neutral-100 border border-neutral-200 text-neutral-700 hover:bg-neutral-200" title="Редактировать должность" onClick={()=>setEditing(true)}>
          <PencilIcon/> {(person.role||"OTHER").toUpperCase()}
        </button>
      );
    }

    // ---------- Create modals ----------
    function CreatePersonModal({open, onClose, name, setName, role, setRole, external, setExternal, onSubmit, roles}){
      if(!open) return null;
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center" onClick={onClose}>
          <div className="absolute inset-0 bg-black/40"/>
          <div className="relative bg-white rounded-2xl shadow-xl border border-neutral-200 w-[460px] p-4" onClick={(e)=>e.stopPropagation()}>
            <div className="text-base font-semibold mb-3">Новый сотрудник</div>
            <div className="space-y-3">
              <div>
                <label className="block text-sm mb-1">Имя</label>
                <input value={name} onChange={e=>setName(e.target.value)} className="w-full border border-neutral-300 rounded-lg px-3 py-2"/>
              </div>
              <div>
                <label className="block text-sm mb-1">Роль</label>
                <select value={role} onChange={e=>setRole(e.target.value)} className="w-full border border-neutral-300 rounded-lg px-3 py-2">
                  {roles.map(r => (<option key={r} value={r}>{r}</option>))}
                </select>
              </div>
              <label className="flex items-center gap-2 text-sm">
                <input type="checkbox" checked={!!external} onChange={e=>setExternal(e.target.checked)} />
                Внешний сотрудник (не показывать во «Нагрузка»)
              </label>
            </div>
            <div className="mt-4 flex justify-end gap-2">
              <button className="btn" onClick={onClose}>Отмена</button>
              <button className="rounded-xl border border-emerald-300 bg-emerald-50 text-emerald-800 px-3 py-1" onClick={onSubmit}>Создать</button>
            </div>
          </div>
        </div>
      );
    }
    function CreateProjectModal({open, onClose, name, setName, color, setColor, status, setStatus, search, setSearch, teamSel, setTeamSel, people, suggestions, onSubmit}){
      if(!open) return null;
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center" onClick={onClose}>
          <div className="absolute inset-0 bg-black/40"/>
          <div className="relative bg-white rounded-2xl shadow-xl border border-neutral-200 w/[560px] max-h-[80vh] overflow-auto p-4" onClick={(e)=>e.stopPropagation()}>
            <div className="text-base font-semibold mb-3">Новый проект</div>
            <div className="grid grid-cols-2 gap-3">
              <div>
                <label className="block text-sm mb-1">Название</label>
                <input value={name} onChange={e=>setName(e.target.value)} className="w-full border border-neutral-300 rounded-lg px-3 py-2"/>
              </div>
              <div>
                <label className="block text-sm mb-1">Статус</label>
                <select value={status} onChange={e=>setStatus(e.target.value)} className="w-full border border-neutral-300 rounded-lg px-3 py-2">
                  <option value="active">active</option>
                  <option value="onhold">onhold</option>
                  <option value="done">done</option>
                  <option value="planned">planned</option>
                </select>
              </div>
              <div>
                <label className="block text-sm mb-1">Цвет</label>
                <input type="color" value={color} onChange={e=>setColor(e.target.value)} className="w-16 h-10 p-0 border border-neutral-300 rounded-lg"/>
              </div>
            </div>

            <div className="mt-4">
              <div className="text-sm font-medium mb-2">Команда</div>
              <div className="flex items-center gap-2 mb-2">
                <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="Добавить сотрудника..." className="w-full border border-neutral-300 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-200"/>
              </div>
              {search && (
                <div className="mb-2 border border-neutral-200 rounded-xl overflow-hidden">
                  {suggestions.length>0 ? suggestions.map(s => (
                    <button key={s.id} className="w-full text-left px-3 py-2 hover:bg-blue-50" onClick={()=>{ const c=new Set(teamSel); c.add(s.id); setTeamSel(c); setSearch(""); }}>
                      {s.name} <span className="text-[10px] text-neutral-500">{String(s.role).toUpperCase()}</span> {s.external && <span className="ml-1 text-[10px] text-emerald-700">внешн.</span>}
                    </button>
                  )) : (
                    <div className="px-3 py-2 text-xs text-neutral-500">Не найдено</div>
                  )}
                </div>
              )}
              <div className="flex flex-wrap gap-2">
                {Array.from(teamSel).map(pid => { const p = people.find(x=>x.id===pid); if(!p) return null; return (
                  <span key={pid} className="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs bg-blue-50 text-blue-800 border border-blue-200">
                    {p.name}{p.external && <span className="ml-1 text-emerald-700">(внешн.)</span>}
                    <button className="ml-1 text-blue-700/70 hover:text-blue-900" onClick={()=>{ const c=new Set(teamSel); c.delete(pid); setTeamSel(c); }}>×</button>
                  </span>
                );})}
              </div>
            </div>

            <div className="mt-4 flex justify-end gap-2">
              <button className="btn" onClick={onClose}>Отмена</button>
              <button className="rounded-xl border border-emerald-300 bg-emerald-50 text-emerald-800 px-3 py-1" onClick={onSubmit}>Создать</button>
            </div>
          </div>
        </div>
      );
    }

    // ---------- Auth ----------
    function AuthForm({onSuccess}){
      const [login, setLogin] = useState("");
      const [pass, setPass] = useState("");
      const [remember, setRemember] = useState(false);
      const submit = (e)=>{ e.preventDefault(); if(login.trim().toLowerCase()==="панквеб" && pass==="123455"){ onSuccess(remember); } else { alert("Неверные данные"); } };
      return (
        <form onSubmit={submit} className="space-y-3">
          <div>
            <label className="block text-sm mb-1">Логин</label>
            <input value={login} onChange={e=>setLogin(e.target.value)} className="w-full border border-neutral-300 rounded-lg px-3 py-2"/>
          </div>
          <div>
            <label className="block text-sm mb-1">Пароль</label>
            <input type="password" value={pass} onChange={e=>setPass(e.target.value)} className="w-full border border-neutral-300 rounded-lg px-3 py-2"/>
          </div>
          <label className="flex items-center gap-2 text-sm select-none">
            <input type="checkbox" checked={remember} onChange={e=>setRemember(e.target.checked)} />
            Запомнить данные
          </label>
          <button className="w-full rounded-xl border border-emerald-300 bg-emerald-50 text-emerald-800 py-2">Войти</button>
        </form>
      );
    }

    // boot
    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
