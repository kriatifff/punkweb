<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Панквеб FTE Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- React & Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --app-header-h: 56px;
      --sheet-header-h: 44px;
      --left-col-w: 220px;
    }
    .hide-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
    .hide-scrollbar::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 8px; }
    .hide-scrollbar { scrollbar-width: thin; }
  </style>
</head>
<body class="bg-[#F7F8FA]">
  <div id="root"></div>

  <script type="text/babel">
    const {useState, useEffect, useMemo, useRef, Fragment} = React;

    // ---------- Config ----------
    const MAX_FTE = 1.2;
    const WEEK_COL_PX = 72;
    const TEAM_BAR_COLOR = "#22c55e";
    const VISIBLE_WEEKS = 16; // сколько колонок показываем одновременно

    // ---------- Persistence (local) ----------
    const LS_KEY = "fteplanner.v1";
    function loadJSON(key, fallback){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return fallback;
        const all = JSON.parse(raw);
        return (key in all) ? all[key] : fallback;
      }catch{ return fallback; }
    }
    function saveJSON(patch){
      try{
        const all = JSON.parse(localStorage.getItem(LS_KEY) || "{}");
        const merged = {...all, ...patch};
        localStorage.setItem(LS_KEY, JSON.stringify(merged));
        // Хук для удалённого сохранения (если включите бекенд)
        debouncedSaveAllRemote(merged);
      }catch{}
    }

    // ---------- OPTIONAL: remote sync (заглушка) ----------
    async function loadAllRemote(){
      return null; // вернуть null если ничего нет
    }
    async function saveAllRemote(_state){
    }

    // ---------- Date/format helpers ----------
    const fmtISO = (date) => date.toISOString().slice(0,10);
    const addDays = (d, n) => { const x=new Date(d); x.setDate(x.getDate()+n); x.setHours(0,0,0,0); return x; };
    const pad2 = (n) => (n<10 ? `0${n}` : String(n));
    const fmtDM = (d) => `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}`;
    const RU_MONTHS = ["янв","фев","мар","апр","май","июн","июл","авг","сен","окт","ноя","дек"];
    const ruMonthShort = (m) => RU_MONTHS[m] ?? "";
    const startOfISOWeek = (d) => { const day=d.getDay(); const diff=(day===0?-6:1)-day; const m=new Date(d); m.setDate(d.getDate()+diff); m.setHours(0,0,0,0); return m; };
    const addWeeks = (m, n) => { const d=new Date(m); d.setDate(d.getDate()+n*7); d.setHours(0,0,0,0); return d; };
    const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
    const scaleRatio = (v, max=MAX_FTE) => clamp(v/max, 0, 1);
    const weekLabelParts = (iso) => { const d=new Date(iso); const w=1+Math.floor((d.getDate()-1)/7); return { top:`${w} нед`, bot:ruMonthShort(d.getMonth()) }; };
    const weekRangeLabel = (iso) => { const d=new Date(iso); const end=addDays(d,6); return `${fmtDM(d)}–${fmtDM(end)}`; };
    const rndId = () => (globalThis.crypto && crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2));
    const fmtFTE1 = (n) => (Math.round(n*10)/10).toFixed(1);
    const yearWeekMondays = (year) => { let m=startOfISOWeek(new Date(year,0,1)); const end=new Date(year,11,31); end.setHours(0,0,0,0); const list=[]; while(m<=end){ list.push(fmtISO(m)); m=addDays(m,7);} return list; };

    // ---------- Seed data ----------
    const base = startOfISOWeek(new Date());
    const initialWeeks = Array.from({length:24}, (_,i)=> fmtISO(addWeeks(base, i-4)));
    const seedPeople = [
      { id:"p1", name:"Саша", role:"manager", capacityPerWeek:1, active:true },
      { id:"p2", name:"Катя К.", role:"designer", capacityPerWeek:1, active:true },
    ];
    const seedProjects = [
      { id:"pr1", name:"HR Подкасты", status:"active", color:"#3b82f6" },
      { id:"pr2", name:"Арктика Медиа", status:"active", color:"#f43f5e" },
      { id:"pr3", name:"Падел-теннис", status:"planned", color:"#06b6d4" },
    ];
    const seedAssignments = [
      { id:"a1", personId:"p1", projectId:"pr1", weekStart: initialWeeks[4], fte:0.3 },
      { id:"a2", personId:"p1", projectId:"pr2", weekStart: initialWeeks[4], fte:0.2 },
      { id:"a3", personId:"p2", projectId:"pr2", weekStart: initialWeeks[5], fte:0.4 },
    ];
    const seedRoles = ["designer","dev","manager","pm","other"];

    // ---------- Aggregations ----------
    const personWeekTotal = (as, pid, w) => as.filter(a=>a.personId===pid && a.weekStart===w).reduce((s,a)=>s+a.fte,0);
    const fteFor = (as, pid, pr, w) => as.filter(a=>a.personId===pid && a.projectId===pr && a.weekStart===w).reduce((s,a)=>s+a.fte,0);
    const mergeOrder = (existing, nextIds) => {
      const seen=new Set(); const res=[];
      for(const id of (existing||[])) if(nextIds.includes(id) && !seen.has(id)){ res.push(id); seen.add(id); }
      for(const id of nextIds) if(!seen.has(id)){ res.push(id); seen.add(id); }
      return res;
    };

    // ---------- UI atoms ----------
    function StatusIcon({status}){
      const common = { width:16, height:16, viewBox:"0 0 24 24", fill:"white" };
      if(status==="active") return (<svg {...common}><polygon points="8,5 19,12 8,19"/></svg>);
      if(status==="onhold") return (<svg {...common}><rect x="6" y="5" width="4" height="14"/><rect x="14" y="5" width="4" height="14"/></svg>);
      if(status==="done") return (<svg {...common}><rect x="6" y="6" width="12" height="12" rx="2"/></svg>);
      return (<svg {...common}><circle cx="12" cy="12" r="6"/></svg>);
    }
    function MinusIcon({className=""}){
      return (
        <svg className={className} width="16" height="16" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
      );
    }
    function PencilIcon({className=""}){
      return (
        <svg className={className} width="14" height="14" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M12 20h9"/>
          <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/>
        </svg>
      );
    }
    function TrashIcon({className=""}){
      return (
        <svg className={className} width="14" height="14" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <polyline points="3 6 5 6 21 6"/>
          <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
          <path d="M10 11v6"/>
          <path d="M14 11v6"/>
          <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/>
        </svg>
      );
    }
    function WeekHeader({iso}){
      const {top, bot} = weekLabelParts(iso);
      return (
        <div className="h-[40px] flex items-center justify-center text-neutral-700">
          <span className="block text-center leading-tight" style={{width:WEEK_COL_PX}}>
            <div className="text-xs font-medium">{top}</div>
            <div className="text-[10px]">{bot}</div>
          </span>
        </div>
      );
    }

    // =================================
    // App
    // =================================
    function App(){
      const [people, setPeople] = useState(loadJSON("people", seedPeople));
      const [projects, setProjects] = useState(loadJSON("projects", seedProjects));
      const [assignments, setAssignments] = useState(loadJSON("assignments", seedAssignments));
      const [roles, setRoles] = useState(loadJSON("roles", [...seedRoles]));
      const [projectTeams, setProjectTeams] = useState(()=>{
        const saved = loadJSON("projectTeams", {});
        const map = {};
        Object.keys(saved).forEach(k => (map[k]=new Set(saved[k])));
        return map;
      });

      const [view, setView] = useState("team"); // "team" | "project"
      const [selectedPersonId, setSelectedPersonId] = useState(null);

      const {weeks, setWeeks, visible, goLeft, goRight, goToday} = useWeeksWindow();

      const dragRow = useRef(null);

      // ----- Persistence -----
      useEffect(()=> saveJSON({people}), [people]);
      useEffect(()=> saveJSON({projects}), [projects]);
      useEffect(()=> saveJSON({assignments}), [assignments]);
      useEffect(()=> saveJSON({roles}), [roles]);

      const handleProjectDrop = (from, to) => {
        const arr = [...projects];
        const [moved] = arr.splice(from, 1);
        arr.splice(to, 0, moved);
        setProjects(arr);
      };

      return (
        <div className="min-h-screen bg-[#F7F8FA] text-neutral-900 font-sans">
          {/* Логотип */}
          <header className="sticky top-0 z-20 bg-white border-b border-neutral-200">
            <div className="max-w-screen-2xl mx-auto px-4 py-3 flex items-center gap-3">
              <div className="text-lg font-semibold tracking-tight text-green-600">Панквеб FTE Planner</div>
              <div className="ml-4 flex items-center gap-1 bg-neutral-100 border border-neutral-200 rounded-2xl p-1 shadow-sm">
                <button className={`px-3 py-1 rounded-xl transition ${view==="team" ? "bg-white shadow-sm" : "hover:bg-white/70"}`} onClick={()=>setView("team")}>Команда</button>
                <button className={`px-3 py-1 rounded-xl transition ${view==="project" ? "bg-white shadow-sm" : "hover:bg-white/70"}`} onClick={()=>setView("project")}>Проекты</button>
              </div>
              <div className="ml-auto flex items-center gap-2">
                <button onClick={()=>setCreateProjectOpen(true)} className="rounded-xl border border-neutral-300 px-3 py-1 bg-white shadow-sm hover:shadow transition">+ Проект</button>
                <button onClick={()=>setCreatePersonOpen(true)} className="rounded-xl border border-neutral-300 px-3 py-1 bg-white shadow-sm hover:shadow transition">+ Сотрудник</button>
              </div>
            </div>
          </header>

          <main className="max-w-screen-2xl mx-auto p-4">
            {view==="team" ? (
              <>
                <div className="mb-3 flex items-center gap-3">
                  <label className="text-sm text-neutral-700">Фильтр роли</label>
                  <select className="border border-neutral-300 rounded-xl px-2 py-1 text-sm" value={roleFilter} onChange={e=>setRoleFilter(e.target.value)}>
                    <option value="all">Все</option>
                    {roles.map(r => (<option key={r} value={r}>{r}</option>))}
                  </select>
                </div>

                {/* Сетка: закреплены столбцы слева */}
                <div className="grid" style={{gridTemplateColumns:`var(--left-col-w) repeat(${visible.length}, ${WEEK_COL_PX}px)`}}>
                  <div className="sticky left-0 z-50 bg-[#F7F8FA] backdrop-blur border-r border-neutral-200 p-2 text-sm font-medium" />
                  {visible.map(w => (<div key={w} className="border-b border-neutral-200"><WeekHeader iso={w} /></div>))}
                  {filteredTeamIds.map((pid, rowIdx) => {
                    const person = people.find(p=>p.id===pid)!;
                    return (
                      <Fragment key={pid}>
                        <div
                          className="sticky left-0 z-50 bg-[#F7F8FA] backdrop-blur border-r border-neutral-200 p-1"
                          draggable
                          onDragStart={() => { dragRow.current = rowIdx; }}
                          onDragOver={e => e.preventDefault()}
                          onDrop={() => {
                            const from = dragRow.current; const to = rowIdx; if (from == null || from === to) return;
                            const arr = [...filteredTeamIds]; const id = arr.splice(from, 1)[0]; arr.splice(to, 0, id);
                            setTeamOrder([...arr]); dragRow.current = null;
                          }}
                        >
                          <div
                            role="button"
                            tabIndex={0}
                            onClick={() => setSelectedPersonId(person.id)}
                            onKeyDown={(e)=>{ if(e.key==='Enter'||e.key===' ') setSelectedPersonId(person.id) }}
                            className="w-full text-left"
                          >
                            <div className="relative bg-white rounded-2xl shadow-sm h-[120px] flex flex-col justify-center pl-5 pr-8 hover:shadow-md hover:bg-blue-50/70 transition">
                              <div className="font-medium truncate" title="Открыть карточку сотрудника">{person.name}</div>
                              <div className="mt-1 text-[11px] text-neutral-600">{String(person.role||"").toUpperCase()}</div>
                              <button
                                type="button"
                                draggable={false}
                                aria-label="Удалить сотрудника"
                                onMouseDown={(e)=>e.preventDefault()}
                                onClick={(e)=>{ e.stopPropagation(); deletePerson(person.id); }}
                                title="Удалить"
                                className="absolute top-2 right-2 w-7 h-7 rounded-lg grid place-items-center text-neutral-700 hover:text-red-600 hover:bg-red-50 border border-neutral-300 hover:border-red-200 transition"
                              >
                                <MinusIcon className="text-neutral-700"/>
                              </button>
                            </div>
                          </div>
                        </div>

                        {visible.map(week => {
                          const total = personWeekTotal(assignments, person.id, week);
                          const ratio = scaleRatio(total);
                          const vac = isVacation(person.id, week);
                          return (
                            <div key={week+pid} className="p-1 bg-transparent h-[120px] relative">
                              <div className={`bg-white rounded-2xl shadow-sm h-full flex items-end justify-center relative ${total>1.0001?"ring-1 ring-red-300":""}`}>
                                <div className="relative w-14 h-[92%] rounded-lg bg-neutral-200 overflow-hidden">
                                  {!vac && (<div className="absolute bottom-0 left-0 right-0" style={{height:`${ratio*100}%`, background:TEAM_BAR_COLOR}} />)}
                                </div>
                                {!vac && (
                                  <div className="absolute inset-0 flex items-center justify-center text-sm font-semibold text-neutral-900" title={fmtFTE1(total)}>
                                    {fmtFTE1(total)}
                                  </div>
                                )}
                                {vac && (<div className="absolute inset-0 flex items-center justify-center text-2xl" title="Отпуск">🏖</div>)}
                              </div>
                            </div>
                          );
                        })}
                      </Fragment>
                    );
                  })}
                </div>
              </>
            ) : (
              <div className="space-y-4">
                <RoleManager roles={roles} setRoles={setRoles} setRoleFilter={setRoleFilter} people={people} setPeople={setPeople}/>
                <div className="grid" style={{gridTemplateColumns:`300px 1fr`}}>
                  {projects.map((project, idx) => (
                    <Fragment key={project.id}>
                      <div className="sticky left-0 z-40 bg-[#F7F8FA] backdrop-blur border-r border-neutral-200 p-1"
                        draggable
                        onDragStart={() => onProjectDragStart(idx)}
                        onDragOver={(e) => e.preventDefault()}
                        onDrop={() => onProjectDrop(idx)}
                        title="Перетащите, чтобы изменить порядок">
                        <div className="relative bg-white rounded-2xl border border-neutral-200 shadow-sm p-3 flex items-center gap-3 min-w-0 h-[120px] cursor-grab active:cursor-grabbing select-none">
                          <button
                            className="w-8 h-8 rounded-lg flex items-center justify-center"
                            style={{background:project.color}}
                            title="Статус проекта"
                            onClick={() => setProjects(prev => prev.map(p => p.id === project.id ? {...p, status: (p.status === "active" ? "onhold" : p.status === "onhold" ? "done" : p.status === "done" ? "planned" : "active")} : p))}
                          >
                            <StatusIcon status={project.status} />
                          </button>
                          <div className="font-medium truncate" title={project.name}>{project.name}</div>
                          <button
                            type="button"
                            draggable={false}
                            aria-label="Удалить проект"
                            onMouseDown={(e)=>e.preventDefault()}
                            onClick={() => deleteProject(project.id)}
                            title="Удалить проект"
                            className="absolute top-2 right-2 w-7 h-7 rounded-lg grid place-items-center text-neutral-700 hover:text-red-600 hover:bg-red-50 border border-neutral-300 hover:border-red-200 transition"
                          >
                            <MinusIcon className="text-neutral-700" />
                          </button>
                        </div>
                      </div>
                      <div className="border border-neutral-200 p-3">
                        <div className="bg-white rounded-2xl border border-neutral-200 shadow-sm p-3">
                          <ProjectTeamSelector project={project} people={activePeople} projectTeams={projectTeams} setProjectTeams={setProjectTeams} />
                        </div>
                      </div>
                    </Fragment>
                  ))}
                </div>
              </div>
            )}
          </main>
        </div>
      );
    }

    // =================================
    // PersonSheet
    // =================================
    function PersonSheet({ person, projects, assignments, teamByProject, vacations, setVacations, order, setOrder, onBack, onClose, onSave, setPeople, weeks, visible, goLeft, goRight, goToday, roles }) {
      if (!person) return null;
      const isVacation = (pid, w) => !!vacations[pid]?.has?.(w);

      const unionIds = useMemo(() => {
        const ids = new Set();
        assignments.forEach(a => { if (a.personId === person.id) ids.add(a.projectId); });
        Object.entries(teamByProject).forEach(([pr, set]) => { if (set.has(person.id)) ids.add(pr); });
        return Array.from(ids);
      }, [assignments, person.id, teamByProject]);

      const orderedIds = useMemo(() => mergeOrder(order, unionIds), [order, unionIds]);
      useEffect(() => { setOrder(orderedIds); }, [orderedIds, setOrder]);

      const [editKey, setEditKey] = useState(null);
      const [editVal, setEditVal] = useState("");
      function beginEdit(pid, w, cur) { if (isVacation(person.id, w)) return; setEditKey(`${pid}|${w}`); setEditVal(fmtFTE1(cur || 0)); }
      function commitEdit(pid, w) {
        const k = `${pid}|${w}`; if (editKey !== k) return;
        const next = parseFloat(editVal.replace(",", "."));
        setEditKey(null);
        if (isNaN(next) || next < 0 || next > MAX_FTE) return;
        onSave(prev => { const rest = prev.filter(a => !(a.personId === person.id && a.projectId === pid && a.weekStart === w)); return [...rest, { id: rndId(), personId: person.id, projectId: pid, weekStart: w, fte: next }]; });
      }

      const dragIndex = useRef(null);
      const onDragStart = (i) => { dragIndex.current = i; };
      const onDragOver = (e) => e.preventDefault();
      const onDrop = (i) => { const from = dragIndex.current; dragIndex.current = null; if (from == null || from === i) return; const arr = [...orderedIds]; const [moved] = arr.splice(from, 1); arr.splice(i, 0, moved); setOrder(arr); };

      const [vacOpen, setVacOpen] = useState(false);
      const [personVac, setPersonVac] = useState(() => new Set(vacations[person.id] || []));
      const [vacTab, setVacTab] = useState("range");
      const [vFrom, setVFrom] = useState("");
      const [vTo, setVTo] = useState("");
      useEffect(() => { setPersonVac(new Set(vacations[person.id] || [])); }, [person.id, vacations]);

      const toggleVac = (week) => setPersonVac(prev => { const s = new Set(prev); if (s.has(week)) s.delete(week); else s.add(week); return s; });
      const saveVac = () => {
        let setToSave = new Set(personVac);
        if (vFrom && vTo) {
          const d1 = new Date(vFrom), d2 = new Date(vTo);
          if (!(isNaN(d1) || isNaN(d2) || d1 > d2)) {
            let m1 = startOfISOWeek(d1); const m2 = startOfISOWeek(d2);
            while (m1 <= m2) { setToSave.add(fmtISO(m1)); m1 = addDays(m1, 7); }
          }
        }
        setVacations((prev) => { const c = {}; Object.entries(prev).forEach(([k, v]) => (c[k] = new Set(v))); c[person.id] = setToSave; return c; });
        onSave((prev) => prev.filter((a) => !(a.personId === person.id && setToSave.has(a.weekStart))));
        setVacOpen(false);
      };

      return (
        <div className="fixed inset-0 bg-white flex items-stretch justify-center z-50">
          <div className="w-[1040px] h-full bg-white border-l border-neutral-200 overflow-hidden" onClick={(e) => e.stopPropagation()}>
            <div className="sticky top-0 z-50 bg-white border-b border-neutral-200" style={{ height: "var(--sheet-header-h)" }}>
              <div className="px-4 h-full flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <button onClick={onBack} className="text-sm px-2 py-1 rounded-lg border border-neutral-300 bg-white hover:shadow">← Назад</button>
                  <EditableName person={person} setPeople={setPeople} />
                  <EditableRole person={person} setPeople={setPeople} roles={roles} />
                  <button onClick={() => setVacOpen(true)} className="ml-2 inline-flex items-center gap-1 text-sm px-2 py-1 rounded-lg border border-amber-300 bg-amber-50 text-amber-800" title="Добавить отпуск">🏖 Добавить отпуск</button>
                </div>
                <button onClick={onClose} className="ml-2 text-neutral-500 hover:text-neutral-800">✕</button>
              </div>
            </div>

            {/* Хедеры недель */}
            <div className="grid px-4" style={{ gridTemplateColumns: `var(--left-col-w) repeat(${visible.length}, ${WEEK_COL_PX}px)` }}>
              <div className="sticky left-0 z-50 bg-white border-r border-neutral-200" />
              {visible.map((w) => (<div key={w}><WeekHeader iso={w} /></div>))}
            </div>

            {/* Итоговые бейджи */}
            <div className="grid px-4 mb-1" style={{ gridTemplateColumns: `var(--left-col-w) repeat(${visible.length}, ${WEEK_COL_PX}px)` }}>
              <div className="sticky left-0 z-50 bg-white border-r border-neutral-200" />
              {visible.map((w, i) => (
                <div key={w} className="h-6 flex items-center justify-center">
                  <span className="px-2 py-0.5 rounded-lg border border-neutral-300 bg-white text-[12px] font-medium shadow-sm">{fmtFTE1(weekTotals[i])}</span>
                </div>
              ))}
            </div>

            {/* Строки проектов */}
            <div className="grid px-4 pb-4" style={{ gridTemplateColumns: `var(--left-col-w) repeat(${visible.length}, ${WEEK_COL_PX}px)` }}>
              {useMemo(() => order ? order : [], [order]).map((pid, idx) => {
                const pr = projects.find((p) => p.id === pid);
                if (!pr) return null;
                return (
                  <Fragment key={pid}>
                    <div className="sticky left-0 z-50 bg-white border-r border-neutral-200 p-1" draggable onDragStart={() => onDragStart(idx)} onDragOver={(e) => e.preventDefault()} onDrop={() => onDrop(idx)}>
                      <div className="bg-white rounded-2xl shadow-sm h-[120px] flex items-center gap-2 pl-5 pr-3 cursor-grab active:cursor-grabbing select-none">
                        <span className="text-neutral-400">⋮⋮</span>
                        <button className="w-6 h-6 rounded-lg flex items-center justify-center" style={{ background: pr.color }} title="Статус"><StatusIcon status={pr.status} /></button>
                        <div className="font-medium truncate" title={pr.name}>{pr.name}</div>
                      </div>
                    </div>
                    {visible.map((week) => {
                      const fte = fteFor(assignments, person.id, pid, week);
                      const ratio = scaleRatio(fte);
                      const k = `${pid}|${week}`;
                      const editing = editKey === k;
                      const vac = isVacation(person.id, week);
                      return (
                        <div key={week + pid} className="p-1 bg-transparent h-[120px] relative">
                          <div className="bg-white rounded-2xl shadow-sm h-full flex items-end justify-center relative">
                            <div className="relative w-14 h-[92%] rounded-lg bg-neutral-200 overflow-hidden">
                              {!vac && (<div className="absolute bottom-0 left-0 right-0" style={{ height: `${ratio * 100}%`, background: pr.color }} title={`${pr.name}`} />)}
                            </div>
                            {!vac && (!editing ? (
                              <div className="absolute inset-0 text-sm font-semibold text-neutral-800 flex items-center justify-center" title={fmtFTE1(fte)} onClick={() => beginEdit(pid, week, fte)}>{fmtFTE1(fte)}</div>
                            ) : (
                              <input
                                autoFocus
                                inputMode="decimal"
                                className="absolute inset-0 m-auto h-8 w-16 text-center text-sm font-semibold border border-neutral-300 rounded-md bg-white shadow-sm"
                                value={editVal}
                                onChange={(e) => setEditVal(e.target.value)}
                                onBlur={() => commitEdit(pid, week)}
                                onKeyDown={(e) => { if (e.key === "Enter") e.currentTarget.blur(); if (e.key === "Escape") setEditKey(null); }}
                              />
                            ))}
                            {vac && (<button className="absolute inset-0 flex items-center justify-center text-2xl" title="Снять отпуск" onClick={() => clearVacationWeek(week)}>🏖</button>)}
                          </div>
                        </div>
                      );
                    })}
                  </Fragment>
                );
              })}
            </div>

            {/* Модал отпусков */}
            {vacOpen && (
              <div className="fixed inset-0 z-50 flex items-center justify-center" onClick={() => setVacOpen(false)}>
                <div className="absolute inset-0 bg-black/40" />
                <div className="relative bg-white rounded-2xl shadow-xl border border-neutral-200 w-[720px] max-h-[80vh] overflow-auto p-4" onClick={(e) => e.stopPropagation()}>
                  <div className="text-base font-semibold mb-3">Отпуск — {person.name}</div>
                  <div className="mb-3 inline-flex items-center gap-1 rounded-xl border border-neutral-200 p-1">
                    <button className={`px-3 py-1 rounded-lg text-sm ${vacTab === "range" ? "bg-neutral-100 shadow" : ""}`} onClick={() => setVacTab("range")}>Диапазон дат</button>
                    <button className={`px-3 py-1 rounded-lg text-sm ${vacTab === "weeks" ? "bg-neutral-100 shadow" : ""}`} onClick={() => setVacTab("weeks")}>По неделям</button>
                  </div>
                  {vacTab === "range" && (
                    <div className="space-y-3">
                      <div className="flex items-center gap-2">
                        <label className="text-sm text-neutral-700">С</label>
                        <input type="date" value={vFrom} onChange={(e) => setVFrom(e.target.value)} className="border border-neutral-300 rounded-lg px-2 py-1" />
                        <label className="text-sm text-neutral-700">по</label>
                        <input type="date" value={vTo} onChange={(e) => setVTo(e.target.value)} className="border border-neutral-300 rounded-lg px-2 py-1" />
                      </div>
                      {(vFrom && vTo) && (<div className="text-xs text-neutral-600">Будут добавлены недели диапазона после сохранения.</div>)}
                    </div>
                  )}
                  {vacTab === "weeks" && (
                    <div className="space-y-3">
                      <div className="text-sm text-neutral-600">Отметьте недели (диапазон дат):</div>
                      <div className="grid grid-cols-3 gap-2">
                        {yearWeekMondays(new Date().getFullYear()).map((m) => (
                          <label key={m} className="flex items-center gap-2 p-2 border border-neutral-200 rounded-xl hover:bg-amber-50">
                            <input type="checkbox" checked={personVac.has(m)} onChange={() => setPersonVac((prev) => { const s = new Set(prev); if (s.has(m)) s.delete(m); else s.add(m); return s; })} />
                            <span className="text-sm">{weekRangeLabel(m)}</span>
                            {personVac.has(m) && (<button className="ml-auto text-amber-700" title="Убрать" onClick={() => setPersonVac((prev) => { const s = new Set(prev); s.delete(m); return s; })}>−</button>)}
                          </label>
                        ))}
                      </div>
                    </div>
                  )}
                  {Array.from(personVac).length > 0 && (
                    <div className="mt-3">
                      <div className="text-sm mb-1">Выбрано недель:</div>
                      <div className="flex flex-wrap gap-2">
                        {Array.from(personVac).map((w) => (
                          <span key={w} className="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs bg-blue-50 text-blue-800 border border-blue-200">
                            {weekRangeLabel(w)}
                            <button className="ml-1" title="Удалить" onClick={() => setPersonVac((prev) => { const s = new Set(prev); s.delete(w); return s; })}>×</button>
                          </span>
                        ))}
                      </div>
                    </div>
                  )}
                  <div className="mt-4 flex justify-end gap-2">
                    <button className="px-3 py-1 rounded-lg border border-neutral-300 bg-white" onClick={() => setVacOpen(false)}>Отмена</button>
                    <button className="px-3 py-1 rounded-lg border border-amber-300 bg-amber-50 text-amber-800" onClick={saveVac}>Сохранить</button>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    // Dev sanity checks
    if (typeof window !== "undefined") {
      try {
        console.assert(fmtFTE1(1.16) === "1.2", "fmtFTE1 rounds to 1 decimal");
        console.assert(scaleRatio(1.2) === 1, "scaleRatio clamps to 1");
        const parts = weekLabelParts(initialWeeks[0]);
        console.assert(!!parts.top && !!parts.bot, "weekLabelParts returns two lines");
      } catch {}
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>

