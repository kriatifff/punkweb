<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ü–∞–Ω–∫–≤–µ–± FTE Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --app-header-h: 56px;
      --left-col-w: 280px;
      --row-h: 120px;
      --week-col: 120px;
      --green: #16a34a; /* –∑–µ–ª—ë–Ω—ã–π –æ—Å–Ω–æ–≤–Ω–æ–π */
      --green-600: #16a34a;
      --green-50: #ecfdf5;
    }
    .btn{ padding:8px 12px; border-radius:12px; font-size:14px; font-weight:500; border:1px solid var(--green-600); color:#065f46; background:#fff; transition:.15s; }
    .btn:hover{ background:var(--green-50); }
    .segmented{ display:flex; gap:8px; padding:6px; background:#f3f4f6; border:1px solid #e5e7eb; border-radius:16px; box-shadow:0 1px 1px rgba(0,0,0,.03); }
    .segmented button{ padding:8px 12px; border-radius:12px; font-size:14px; font-weight:600; transition:.15s; }
    .segmented .active{ background:var(--green-600); color:#fff; }
    .segmented .idle{ background:#fff; border:1px solid #d1d5db; color:#111827; }
    .segmented .idle:hover{ background:var(--green-50); }
    .tag{ padding:2px 8px; border-radius:8px; font-size:12px; border:1px solid #e5e7eb; background:#fafafa; color:#374151; }
  </style>
</head>
<body class="bg-[#F7F8FA] text-neutral-900">
  <div id="root"></div>

  <!-- React/Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const {useState, useMemo, useEffect, Fragment} = React;

    /* ======================= HELPERS ======================= */
    const WEEK_COL_PX = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--week-col')) || 120;

    const loadJSON = (k, def) => {
      try{ const v=localStorage.getItem(k); if(v) return JSON.parse(v); }catch{}
      return def;
    };
    const saveJSON = (k,v) => { try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} };

    const addDays = (d, n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); x.setHours(0,0,0,0); return x; };
    const startOfISOWeek = (d)=>{ const x=new Date(d); const day=x.getDay(); const diff=(day===0? -6 : 1-day); x.setDate(x.getDate()+diff); x.setHours(0,0,0,0); return x; };
    const addWeeksISO = (iso, n)=> addDays(new Date(iso), n*7).toISOString();
    const weeksRange = (anchorISO, count=12)=>{ const a=startOfISOWeek(new Date(anchorISO)); const arr=[]; for(let i=0;i<count;i++){ const d=new Date(a); d.setDate(a.getDate()+i*7); arr.push(d.toISOString()); } return arr; };

    const pad2=(n)=> (n<10?`0${n}`:String(n));
    const RU_MONTHS_FULL = ["–Ø–Ω–≤–∞—Ä—å","–§–µ–≤—Ä–∞–ª—å","–ú–∞—Ä—Ç","–ê–ø—Ä–µ–ª—å","–ú–∞–π","–ò—é–Ω—å","–ò—é–ª—å","–ê–≤–≥—É—Å—Ç","–°–µ–Ω—Ç—è–±—Ä—å","–û–∫—Ç—è–±—Ä—å","–ù–æ—è–±—Ä—å","–î–µ–∫–∞–±—Ä—å"];
    const RU_MONTHS_SHORT = ["—è–Ω–≤","—Ñ–µ–≤","–º–∞—Ä","–∞–ø—Ä","–º–∞–π","–∏—é–Ω","–∏—é–ª","–∞–≤–≥","—Å–µ–Ω","–æ–∫—Ç","–Ω–æ—è","–¥–µ–∫"];

    const clamp = (v,min,max)=> Math.max(min, Math.min(max,v));
    const fmtFTE1 = (f)=> (Math.round((f||0)*10)/10).toFixed(1);

    // –Ω–µ–¥–µ–ª—è-–≤-–º–µ—Å—è—Ü–µ: ¬´—Ñ–∏–∫—Å –∫–æ–Ω—Ü–∞ –º–µ—Å—è—Ü–∞¬ª (–ø–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–µ–¥–µ–ª–∏ –æ–∫—Ç—è–±—Ä—è ‚Äî 3,4)
    function weekIndexInMonth(weekISO){
      const w = startOfISOWeek(new Date(weekISO));
      const ym = new Date(w.getFullYear(), w.getMonth(), 1);
      // –ø–µ—Ä–≤—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –º–µ—Å—è—Ü–∞
      const firstMonday = startOfISOWeek(new Date(ym));
      // –µ—Å–ª–∏ –ø–µ—Ä–≤–∞—è ISO-–Ω–µ–¥–µ–ª—è –º–µ—Å—è—Ü–∞ –Ω–∞—á–∞–ª–∞—Å—å –µ—â—ë –≤ –ø—Ä–æ—à–ª–æ–º –º–µ—Å—è—Ü–µ –∏ —É—Ö–æ–¥–∏—Ç –¥–∞–ª–µ–∫–æ –≤–ª–µ–≤–æ,
      // –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º: –µ—Å–ª–∏ firstMonday.getMonth() !== ym.getMonth(), —Å–º–µ—â–∞–µ–º –Ω–∞ +7
      let first = new Date(firstMonday);
      if(first.getMonth() !== ym.getMonth()){
        const next = addDays(first, 7);
        if(next.getMonth() === ym.getMonth()) first = next;
      }
      const diffDays = Math.floor((w - first)/ (1000*60*60*24));
      const idx = Math.floor(diffDays/7) + 1;
      return idx < 1 ? 1 : idx;
    }

    /* ======================= SEED (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ) ======================= */
    const seedPeople = loadJSON("__seeded__") ? [] : [
      {id:"p1", name:"–°–∞—à–∞ –ö.", role:"manager"},
      {id:"p2", name:"–ê–Ω—è –ü.", role:"frontend"},
      {id:"p3", name:"–ò–≥–æ—Ä—å –°.", role:"backend"},
      {id:"p4", name:"–õ–µ–Ω–∞ –ú.", role:"qa"},
    ];
    const seedProjects = loadJSON("__seeded__") ? [] : [
      {id:"pr1", name:"–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥-—Å–∞–π—Ç", color:"#7dd3fc", status:"active"},
      {id:"pr2", name:"–õ–ö –ü–∞—Ä—Ç–Ω—ë—Ä–∞", color:"#93c5fd", status:"active"},
      {id:"pr3", name:"–ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ", color:"#a5b4fc", status:"paused"},
    ];
    const seedTeams = loadJSON("__seeded__") ? {} : {
      pr1:new Set(["p1","p2","p4"]),
      pr2:new Set(["p1","p3"]),
      pr3:new Set(["p2","p3"]),
    };
    const seedAssignments = loadJSON("__seeded__") ? new Map() : new Map();
    const seedVacations = loadJSON("__seeded__") ? new Set() : new Set();

    const anchor = startOfISOWeek(new Date());
    const initialWeeks = weeksRange(anchor.toISOString(), 12);
    if(!loadJSON("__seeded__")){
      for(const w of initialWeeks){
        seedAssignments.set(`p2|pr1|${w}`, 0.6);
        seedAssignments.set(`p4|pr1|${w}`, 0.4);
        seedAssignments.set(`p3|pr2|${w}`, 0.7);
        seedAssignments.set(`p2|pr3|${w}`, 0.3);
      }
      saveJSON("__seeded__", true);
    }

    // assignments helpers
    const fteFor = (assignments, personId, projectId, weekISO) => assignments.get(`${personId}|${projectId}|${weekISO}`) || 0;
    const setFteFor = (assignments, personId, projectId, weekISO, val) => {
      const next = new Map(assignments);
      const k=`${personId}|${projectId}|${weekISO}`;
      if(val && +val>0) next.set(k,+val); else next.delete(k);
      return next;
    };
    const totalFTEForPersonWeek = (assignments, personId, weekISO, projects) =>
      projects.reduce((s,pr)=> s + (assignments.get(`${personId}|${pr.id}|${weekISO}`)||0), 0);

    /* ======================= GLOBAL HEADER ======================= */
    function AppHeader({ tab, setTab, onAddProject, onAddPerson }){
      const NavBtn = ({active, onClick, children}) => (
        <button onClick={onClick}
          className={"rounded-xl px-3 py-1.5 text-sm font-semibold " + (active? "bg-[var(--green)] text-white" : "idle")}
          style={!active? {border:"1px solid #d1d5db", background:"#fff", color:"#111827"}:{}}
        >
          {children}
        </button>
      );

      return (
        <header className="sticky top-0 z-50 bg-white/90 backdrop-blur border-b border-neutral-200">
          <div className="max-w-screen-2xl mx-auto px-4 h-[var(--app-header-h)] flex items-center justify-between gap-4">
            <div className="flex items-center gap-3">
              <div className="font-semibold tracking-wide mr-2 text-[var(--green)]">–ü–∞–Ω–∫–≤–µ–± FTE Planner</div>
              <div className="segmented">
                <NavBtn active={tab==='load'} onClick={()=>setTab('load')}>–ù–∞–≥—Ä—É–∑–∫–∞</NavBtn>
                <NavBtn active={tab==='team'} onClick={()=>setTab('team')}>–ö–æ–º–∞–Ω–¥–∞</NavBtn>
                <NavBtn active={tab==='projects'} onClick={()=>setTab('projects')}>–ü—Ä–æ–µ–∫—Ç—ã</NavBtn>
              </div>
            </div>
            <div className="flex items-center gap-2">
              <button className="btn" onClick={onAddProject}>+ –ü—Ä–æ–µ–∫—Ç</button>
              <button className="btn" onClick={onAddPerson}>+ –°–æ—Ç—Ä—É–¥–Ω–∏–∫</button>
            </div>
          </div>
        </header>
      );
    }

    /* ======================= CALENDAR HEADER ======================= */
    function CalendarHeader({visibleWeeks, leftLabel="–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏", stickyTopClass="top-[var(--app-header-h)]", badgeByISO=null}){
      // –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –≥–æ–¥–∞–º
      const years=[]; let cy=null, cnt=0;
      visibleWeeks.forEach((iso,i)=>{
        const y=new Date(iso).getFullYear();
        if(cy===null){ cy=y; cnt=1; }
        else if(y===cy){ cnt++; }
        else { years.push({year:cy,count:cnt}); cy=y; cnt=1; }
        if(i===visibleWeeks.length-1) years.push({year:cy,count:cnt});
      });
      // –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º
      const months=[]; let key=null, mcnt=0, y0=null, m0=null;
      visibleWeeks.forEach((iso,i)=>{
        const d=new Date(iso), y=d.getFullYear(), m=d.getMonth(); const k=`${y}-${m}`;
        if(k!==key){ if(key!==null) months.push({key,year:y0,month:m0,count:mcnt}); key=k; mcnt=1; y0=y; m0=m; }
        else mcnt++;
        if(i===visibleWeeks.length-1) months.push({key,year:y0,month:m0,count:mcnt});
      });

      const gridCols = `var(--left-col-w) repeat(${visibleWeeks.length}, ${WEEK_COL_PX}px)`;

      return (
        <div className={`sticky ${stickyTopClass} z-40`}>
          <div className="grid" style={{gridTemplateColumns:gridCols, rowGap:'6px'}}>
            {/* –ª–µ–≤—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ */}
            <div className="sticky left-0 z-50 bg-[#F7F8FA] border-r border-neutral-200 p-1" style={{gridRow:"span 3 / span 3"}}>
              <div className="h-full rounded-2xl bg-white border border-neutral-200 shadow-sm flex items-center pl-5 text-sm text-neutral-700">
                {leftLabel}
              </div>
            </div>

            {/* —Ä—è–¥ 1: –≥–æ–¥—ã */}
            {years.map(g=>(
              <div key={`y-${g.year}`} style={{gridColumn:`span ${g.count}`}}>
                <div className="mx-1 rounded-xl px-3 py-1 text-center text-white text-sm font-medium bg-neutral-900">{g.year} –≥.</div>
              </div>
            ))}

            {/* —Ä—è–¥ 2: –º–µ—Å—è—Ü—ã */}
            {months.map(g=>(
              <div key={g.key} style={{gridColumn:`span ${g.count}`}}>
                <div className="mx-1 rounded-xl px-3 py-1.5 text-center text-[13px] font-medium bg-neutral-100 text-neutral-800 border border-neutral-200">
                  {RU_MONTHS_FULL[g.month]}
                </div>
              </div>
            ))}

            {/* —Ä—è–¥ 3: –Ω–µ–¥–µ–ª–∏ ‚Äî —É–∑–∫–∏–µ –ø–ª–∞—à–∫–∏ ¬´–ù–µ–¥. N¬ª + –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –±–µ–π–¥–∂ Œ£ */}
            {visibleWeeks.map((iso)=>(
              <div key={`w-${iso}`} className="relative">
                <div className="mx-1 rounded-md px-2 py-1 text-center text-[12px] text-neutral-800 bg-white border border-neutral-200 shadow-sm select-none">
                  –ù–µ–¥. {weekIndexInMonth(iso)}
                </div>
                {badgeByISO && badgeByISO[iso]!=null && (
                  <div className="absolute -right-1 -top-2 translate-x-1/2">
                    <span className="px-2 py-0.5 rounded-full text-[11px] font-bold border border-neutral-300 bg-neutral-50 text-neutral-800 shadow-sm">
                      {badgeByISO[iso]}
                    </span>
                  </div>
                )}
              </div>
            ))}
          </div>
        </div>
      );
    }

    /* ======================= WEEK NAVIGATOR ======================= */
    function WeekNavigator({ onLeft, onRight, onToday, showToday=false, leftNode=null, stickyTopClass="top-[var(--app-header-h)]"}){
      return (
        <div className={`sticky ${stickyTopClass} z-30 bg-white/80 backdrop-blur border-b border-neutral-200`}>
          <div className="max-w-screen-2xl mx-auto px-4 h-[44px] flex items-center justify-between">
            <div className="flex items-center gap-2">{leftNode}</div>
            <div className="flex items-center gap-2">
              <button className="btn" onClick={onLeft} title="–ü—Ä–µ–¥—ã–¥—É—â–∏–µ –Ω–µ–¥–µ–ª–∏">‚Äπ</button>
              {showToday && <button className="btn" onClick={onToday}>–°–µ–≥–æ–¥–Ω—è</button>}
              <button className="btn" onClick={onRight} title="–°–ª–µ–¥—É—é—â–∏–µ –Ω–µ–¥–µ–ª–∏">‚Ä∫</button>
            </div>
          </div>
        </div>
      );
    }

    /* ======================= LOAD (–ù–ê–ì–†–£–ó–ö–ê) ======================= */
    function LoadPage({people, projects, assignments, vacations, setAssignments, visible, setVisible, openPerson}){
      const goLeft = ()=> setVisible(prev => prev.map(w => addWeeksISO(w,-1)));
      const goRight= ()=> setVisible(prev => prev.map(w => addWeeksISO(w, 1)));
      const goToday= ()=> setVisible(weeksRange(startOfISOWeek(new Date()).toISOString(), visible.length));

      const gridCols = `var(--left-col-w) repeat(${visible.length}, ${WEEK_COL_PX}px)`;

      return (
        <div className="pb-24">
          <WeekNavigator onLeft={goLeft} onRight={goRight} onToday={goToday} showToday={false} />
          <div className="max-w-screen-2xl mx-auto px-4">
            <CalendarHeader visibleWeeks={visible} leftLabel="–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏" />
            <div className="grid" style={{gridTemplateColumns:gridCols}}>
              {/* –õ–µ–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü ‚Äî –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ –ø–ª–∞—à–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ */}
              {people.map(person=>(
                <Fragment key={person.id}>
                  <div className="sticky left-0 z-20 bg-[#F7F8FA] border-r border-neutral-200 p-1" onClick={()=>openPerson(person.id)} role="button">
                    <div className="bg-white rounded-2xl shadow-sm h-[var(--row-h)] flex items-center justify-between pl-5 pr-3">
                      <div className="min-w-0">
                        <div className="font-medium truncate">{person.name}</div>
                        <div className="text-[11px] text-neutral-600">{String(person.role||"").toUpperCase()}</div>
                      </div>
                      <span className="tag">–û—Ç–∫—Ä—ã—Ç—å</span>
                    </div>
                  </div>
                  {/* –ë–∞—Ä—ã –ø–æ –Ω–µ–¥–µ–ª—è–º ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∏–ª—å INDEX3: —É–∑–∫–∏–µ —Å—Ç–æ–ª–±–∏–∫–∏/–∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É */}
                  {visible.map(week=>{
                    const sum = totalFTEForPersonWeek(assignments, person.id, week, projects);
                    const vac = vacations.has(`${person.id}|${week}`);
                    return (
                      <div key={person.id+week} className="p-1">
                        <div className="bg-white rounded-2xl shadow-sm h-[var(--row-h)] flex items-end justify-center relative">
                          {vac ? (
                            <div className="absolute inset-0 flex items-center justify-center text-2xl">üèñ</div>
                          ) : (
                            <div className="absolute inset-0 flex items-center justify-center text-sm font-semibold text-neutral-800">{fmtFTE1(sum)}</div>
                          )}
                        </div>
                      </div>
                    );
                  })}
                </Fragment>
              ))}
            </div>
          </div>
        </div>
      );
    }

    /* ======================= TEAM (–ö–û–ú–ê–ù–î–ê) ======================= */
    function TeamPage({people, setPeople}){
      const removePerson = (id)=>{ if(!confirm("–£–¥–∞–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞?")) return; setPeople(prev=>prev.filter(p=>p.id!==id)); };
      const editPerson = (id)=>{
        const name = prompt("–ò–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞", people.find(p=>p.id===id)?.name || ""); if(name===null) return;
        const role = prompt("–†–æ–ª—å", people.find(p=>p.id===id)?.role || ""); if(role===null) return;
        setPeople(prev => prev.map(p => p.id===id ? {...p, name, role} : p));
      };
      return (
        <div className="max-w-screen-2xl mx-auto px-4 py-6">
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
            {people.map(p=>(
              <div key={p.id} className="bg-white rounded-2xl border border-neutral-200 shadow-sm p-4">
                <div className="flex items-center justify-between">
                  <div>
                    <div className="font-medium">{p.name}</div>
                    <div className="text-sm text-neutral-500">{(p.role||"other").toUpperCase()}</div>
                  </div>
                  <div className="flex items-center gap-2">
                    <button className="btn" onClick={()=>editPerson(p.id)}>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button className="btn" onClick={()=>removePerson(p.id)}>–£–¥–∞–ª–∏—Ç—å</button>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    /* ======================= PROJECTS (–ü–†–û–ï–ö–¢–´) ======================= */
    function ProjectsPage({projects, setProjects, people, teams, setTeams}){
      const removeProject = (id)=>{ if(!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç?")) return;
        setProjects(prev=>prev.filter(p=>p.id!==id)); const t={...teams}; delete t[id]; setTeams(t);
      };
      const toggleMember = (prid, pid)=>{
        const cur = teams[prid] || new Set();
        const next = {...teams, [prid]:new Set(cur)};
        if(next[prid].has(pid)) next[prid].delete(pid); else next[prid].add(pid);
        setTeams(next);
      };
      return (
        <div className="max-w-screen-2xl mx-auto px-4 py-6 grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
          {projects.map(pr=>(
            <div key={pr.id} className="bg-white rounded-2xl border border-neutral-200 shadow-sm p-4">
              <div className="flex items-center justify-between">
                <div className="font-medium">{pr.name}</div>
                <button className="btn" onClick={()=>removeProject(pr.id)}>–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
              </div>
              <div className="mt-2 text-sm text-neutral-600">–°—Ç–∞—Ç—É—Å: <span className="tag">{pr.status}</span></div>
              <div className="mt-3">
                <div className="text-sm text-neutral-600 mb-2">–£—á–∞—Å—Ç–Ω–∏–∫–∏:</div>
                <div className="flex flex-wrap gap-2">
                  {people.map(p=>{
                    const on = (teams[pr.id]||new Set()).has(p.id);
                    return (
                      <button key={p.id} className={"tag "+(on?"bg-green-50 border-green-600":"")} onClick={()=>toggleMember(pr.id,p.id)}>
                        {on?"‚úì ":""}{p.name}
                      </button>
                    );
                  })}
                </div>
              </div>
            </div>
          ))}
        </div>
      );
    }

    /* ======================= PERSON (–°–¢–†–ê–ù–ò–¶–ê –°–û–¢–†–£–î–ù–ò–ö–ê) ======================= */
    function PersonPage({ personId, back, people, projects, assignments, setAssignments, vacations, setVacations, visible, setVisible }){
      const person = people.find(p=>p.id===personId);
      const [order, setOrder] = useState(projects.map(p=>p.id));
      const [dragIdx, setDragIdx] = useState(null);

      useEffect(()=>{ setOrder(projects.map(p=>p.id)); }, [projects]);

      const goLeft = ()=> setVisible(prev => prev.map(w => addWeeksISO(w,-1)));
      const goRight= ()=> setVisible(prev => prev.map(w => addWeeksISO(w, 1)));
      const goToday= ()=> setVisible(weeksRange(startOfISOWeek(new Date()).toISOString(), visible.length));

      const gridCols = `var(--left-col-w) repeat(${visible.length}, ${WEEK_COL_PX}px)`;

      // Œ£ FTE –±–µ–π–¥–∂–∏
      const totals = visible.map(w => totalFTEForPersonWeek(assignments, person.id, w, projects));
      const badgeByISO = {}; visible.forEach((w,i)=>badgeByISO[w]=`Œ£ ${fmtFTE1(totals[i])}`);

      const onDragStart = (i)=> setDragIdx(i);
      const onDrop = (i)=>{
        if(dragIdx==null || dragIdx===i) return;
        const next=[...order]; const [m]=next.splice(dragIdx,1); next.splice(i,0,m); setOrder(next); setDragIdx(null);
      };

      const editFTE = (pid, weekISO)=>{
        const cur = fteFor(assignments, person.id, pid, weekISO);
        const val = prompt("FTE (0..1)", String(cur)); if(val===null) return;
        const f = clamp(parseFloat(val)||0,0,1);
        setAssignments(prev => setFteFor(prev, person.id, pid, weekISO, f));
      };

      const toggleVacation = (weekISO)=>{
        const key=`${person.id}|${weekISO}`;
        const next = new Set(vacations);
        if(next.has(key)) next.delete(key); else next.add(key);
        setVacations(next);
      };

      return (
        <div className="pb-24">
          <WeekNavigator onLeft={goLeft} onRight={goRight} onToday={goToday} showToday={false}
            leftNode={<div className="flex items-center gap-2"><button className="btn" onClick={back}>‚Üê –ù–∞–∑–∞–¥</button><div className="text-sm text-neutral-600">{person?.name}</div></div>} />
          <div className="max-w-screen-2xl mx-auto px-4">
            <CalendarHeader visibleWeeks={visible} leftLabel="–ü—Ä–æ–µ–∫—Ç—ã" badgeByISO={badgeByISO} />
            <div className="grid pb-4" style={{gridTemplateColumns:gridCols}}>
              {order.map((pid, idx)=>{
                const pr = projects.find(p=>p.id===pid); if(!pr) return null;
                return (
                  <Fragment key={pid}>
                    <div className="sticky left-0 z-20 bg-[#F7F8FA] border-r border-neutral-200 p-1" draggable
                         onDragStart={()=>onDragStart(idx)} onDragOver={(e)=>e.preventDefault()} onDrop={()=>onDrop(idx)}>
                      <div className="bg-white rounded-2xl shadow-sm h-[var(--row-h)] flex items-center gap-2 pl-5 pr-3 cursor-grab active:cursor-grabbing select-none">
                        <span className="text-neutral-400">‚ãÆ‚ãÆ</span>
                        <div className="w-6 h-6 rounded-lg" style={{background:pr.color}}></div>
                        <div className="font-medium truncate" title={pr.name}>{pr.name}</div>
                      </div>
                    </div>
                    {visible.map(week=>{
                      const fte = fteFor(assignments, person.id, pid, week);
                      const vac = vacations.has(`${person.id}|${week}`);
                      const ratio = clamp((fte||0)/1,0,1);
                      return (
                        <div key={pid+week} className="p-1">
                          <div className="bg-white rounded-2xl shadow-sm h-[var(--row-h)] flex items-end justify-center relative">
                            <div className="relative w-10 h-[92%] rounded-lg bg-neutral-200 overflow-hidden">
                              {!vac && <div className="absolute bottom-0 left-0 right-0" style={{height:`${ratio*100}%`, background:pr.color}}/>}
                            </div>
                            {!vac ? (
                              <button className="absolute inset-0 flex items-center justify-center text-sm font-semibold" onClick={()=>editFTE(pid, week)}>{fmtFTE1(fte)}</button>
                            ) : (
                              <button className="absolute inset-0 flex items-center justify-center text-2xl" onClick={()=>toggleVacation(week)}>üèñ</button>
                            )}
                          </div>
                          {/* –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è –ø–æ–¥–ø–∏—Å—å Œ£ –ø–æ–¥ –Ω–µ–¥–µ–ª–µ–π –Ω–∞ —É–∑–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */}
                          <div className="mt-1 text-center text-[11px] text-neutral-600 sm:hidden">{badgeByISO[week]}</div>
                        </div>
                      );
                    })}
                  </Fragment>
                );
              })}
            </div>
          </div>
        </div>
      );
    }

    /* ======================= APP ======================= */
    function App(){
      const [tab, setTab] = useState("load"); // load | team | projects | person
      const [people, setPeople] = useState(loadJSON("people", seedPeople));
      const [projects, setProjects] = useState(loadJSON("projects", seedProjects));
      const [teams, setTeams] = useState(()=>{ const raw=loadJSON("teams", null); if(raw){ const out={}; for(const k of Object.keys(raw)) out[k]=new Set(raw[k]); return out; } return seedTeams; });
      const [assignments, setAssignments] = useState(()=>{ const raw=loadJSON("assignments", null); if(raw){ return new Map(raw); } return seedAssignments; });
      const [vacations, setVacations] = useState(()=>{ const raw=loadJSON("vacations", null); if(raw){ return new Set(raw); } return seedVacations; });
      const [visible, setVisible] = useState(loadJSON("weeks", initialWeeks));
      const [personId, setPersonId] = useState(null);

      useEffect(()=>saveJSON("people", people), [people]);
      useEffect(()=>saveJSON("projects", projects), [projects]);
      useEffect(()=>{ const obj={}; for(const k of Object.keys(teams)) obj[k]=[...teams[k]]; saveJSON("teams", obj); }, [teams]);
      useEffect(()=>saveJSON("assignments", [...assignments.entries()]), [assignments]);
      useEffect(()=>saveJSON("vacations", [...vacations.values()]), [vacations]);
      useEffect(()=>saveJSON("weeks", visible), [visible]);

      const openPerson = (id)=>{ setPersonId(id); setTab("person"); };

      const onAddProject = ()=>{
        const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞"); if(!name) return;
        const id = "pr" + Math.random().toString(36).slice(2,7);
        setProjects(prev=>[...prev, {id, name, color:"#86efac", status:"active"}]);
        setTeams(prev=>({...prev, [id]:new Set()}));
      };
      const onAddPerson = ()=>{
        const name = prompt("–ò–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞"); if(!name) return;
        const role = prompt("–†–æ–ª—å (frontend/backend/manager/qa)","frontend") || "other";
        const id = "p" + Math.random().toString(36).slice(2,7);
        setPeople(prev=>[...prev, {id, name, role}]);
      };

      let page=null;
      if(tab==="load"){
        page = <LoadPage people={people} projects={projects} assignments={assignments} vacations={vacations}
                         setAssignments={setAssignments} visible={visible} setVisible={setVisible} openPerson={openPerson} />;
      } else if(tab==="team"){
        page = <TeamPage people={people} setPeople={setPeople} />;
      } else if(tab==="projects"){
        page = <ProjectsPage projects={projects} setProjects={setProjects} people={people} teams={teams} setTeams={setTeams} />;
      } else if(tab==="person"){
        page = <PersonPage personId={personId} back={()=>setTab("load")}
                           people={people} projects={projects} assignments={assignments} setAssignments={setAssignments}
                           vacations={vacations} setVacations={setVacations} visible={visible} setVisible={setVisible} />;
      }

      return (
        <div>
          <AppHeader tab={tab} setTab={setTab} onAddProject={onAddProject} onAddPerson={onAddPerson} />
          {page}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
