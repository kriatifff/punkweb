<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Панквеб FTE Planner</title>

  <!-- React & Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root {
      --header-height: 56px;
      --left-col-width: 220px;
      --right-col-width: 72px;
    }

    .hide-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
    .hide-scrollbar::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 8px; }
    .hide-scrollbar { scrollbar-width: thin; }

    /* Sticky settings for elements */
    .sticky { position: sticky; top: 0; z-index: 10; }
  </style>
</head>
<body class="bg-[#F7F8FA] text-neutral-900 font-sans">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef, Fragment } = React;

    // ---------- Config ----------
    const MAX_FTE = 1.2;
    const WEEK_COL_PX = 72;
    const TEAM_BAR_COLOR = "#22c55e";
    const VISIBLE_WEEKS = 16;

    // ---------- Persistence (local) ----------
    const LS_KEY = "fteplanner.v1";
    function loadJSON(key, fallback) {
      try {
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return fallback;
        const all = JSON.parse(raw);
        return key in all ? all[key] : fallback;
      } catch { return fallback; }
    }

    function saveJSON(patch) {
      try {
        const all = JSON.parse(localStorage.getItem(LS_KEY) || "{}");
        localStorage.setItem(LS_KEY, JSON.stringify({ ...all, ...patch }));
      } catch {}
    }

    const seedPeople = [
      { id: "p1", name: "Саша", role: "manager", capacityPerWeek: 1, active: true },
      { id: "p2", name: "Катя К.", role: "designer", capacityPerWeek: 1, active: true },
    ];

    const seedProjects = [
      { id: "pr1", name: "HR Подкасты", status: "active", color: "#3b82f6" },
      { id: "pr2", name: "Арктика Медиа", status: "active", color: "#f43f5e" },
      { id: "pr3", name: "Падел-теннис", status: "planned", color: "#06b6d4" },
    ];

    const initialWeeks = Array.from({ length: 24 }, (_, i) => new Date(2025, 0, 1 + i * 7).toISOString().slice(0, 10));

    const [people, setPeople] = useState(loadJSON("people", seedPeople));
    const [projects, setProjects] = useState(loadJSON("projects", seedProjects));
    const [weeksState, setWeeksState] = useState(loadJSON("weeks", initialWeeks));

    useEffect(() => {
      saveJSON({ people });
      saveJSON({ projects });
      saveJSON({ weeks: weeksState });
    }, [people, projects, weeksState]);

    const onTeamScroll = (e) => {
      const teamScrollRef = e.target;
      if (teamScrollRef.scrollLeft > teamScrollRef.scrollWidth - teamScrollRef.clientWidth - 200) {
        const lastWeek = new Date(weeksState[weeksState.length - 1]);
        const newWeeks = Array.from({ length: 8 }, (_, i) => new Date(lastWeek.setDate(lastWeek.getDate() + 7)).toISOString().slice(0, 10));
        setWeeksState(prev => [...prev, ...newWeeks]);
      }
    };

    const deletePerson = (pid) => {
      if (!confirm("Удалить сотрудника?")) return;
      setPeople(prev => prev.filter(p => p.id !== pid));
    };

    const deleteProject = (prid) => {
      if (!confirm("Удалить проект?")) return;
      setProjects(prev => prev.filter(p => p.id !== prid));
    };

    return (
      <div className="min-h-screen bg-[#F7F8FA] text-neutral-900 font-sans">
        <header className="sticky top-0 z-50 bg-white border-b border-neutral-200">
          <div className="max-w-screen-2xl mx-auto px-4 py-3 flex items-center gap-3">
            <div className="text-lg font-semibold tracking-tight text-green-600">Панквеб FTE Planner</div>
            <div className="ml-4 flex items-center gap-1 bg-neutral-100 border border-neutral-200 rounded-2xl p-1 shadow-sm">
              <button className="px-3 py-1 rounded-xl transition">Команда</button>
              <button className="px-3 py-1 rounded-xl transition">Проекты</button>
            </div>
            <div className="ml-auto flex items-center gap-2">
              <button onClick={() => setCreateProjectOpen(true)} className="rounded-xl border border-neutral-300 px-3 py-1 bg-white shadow-sm hover:shadow transition">+ Проект</button>
              <button onClick={() => setCreatePersonOpen(true)} className="rounded-xl border border-neutral-300 px-3 py-1 bg-white shadow-sm hover:shadow transition">+ Сотрудник</button>
            </div>
          </div>
        </header>

        <main className="max-w-screen-2xl mx-auto p-4">
          <div className="mb-3 flex items-center gap-3">
            <label className="text-sm text-neutral-700">Фильтр роли</label>
            <select className="border border-neutral-300 rounded-xl px-2 py-1 text-sm">
              <option value="all">Все</option>
              <option value="manager">Менеджеры</option>
              <option value="designer">Дизайнеры</option>
              <option value="developer">Разработчики</option>
            </select>
          </div>

          <div ref={teamScrollRef} onScroll={onTeamScroll} className="overflow-x-auto hide-scrollbar">
            <div className="grid" style={{ gridTemplateColumns: `220px repeat(${weeksState.length}, ${WEEK_COL_PX}px)` }}>
              <div className="sticky left-0 z-30 bg-[#F7F8FA] backdrop-blur border-r border-neutral-200 p-2 text-sm font-medium" />
              {weeksState.map(w => (<div key={w} className="border-b border-neutral-200"><div>{w}</div></div>))}
              {people.map((person) => (
                <div key={person.id} className="flex items-center">
                  <div>{person.name}</div>
                  <div>{person.role}</div>
                </div>
              ))}
            </div>
          </div>
        </main>
      </div>
    );
  }

    // Render App
    ReactDOM.render(<App />, document.getElementById("root"));
  </script>
</body>
</html>
